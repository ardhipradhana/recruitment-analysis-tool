<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MontPro - Recruitment Analysis Tool</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <!-- Add this after your other script tags -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Add this with your other script tags in the <head> section -->
    <script src="https://app.midtrans.com/snap/snap.js" data-client-key="Mid-client-CNEBcdeUWpDvMVXD"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .drag-area {
            border: 2px dashed #cbd5e1;
            border-radius: 0.75rem;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .drag-area.active {
            border-color: #3b82f6;
            background-color: #f0f9ff;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
        }
        
        .file-item:hover {
            background-color: #f8fafc;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .spinner {
            border: 3px solid rgba(59, 130, 246, 0.1);
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .btn-primary:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
        }
        
        .auth-form {
            background: linear-gradient(145deg, #ffffff, #f9fafb);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .score-circle {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: conic-gradient(#3b82f6 0%, #3b82f6 var(--score-percent), #e2e8f0 var(--score-percent), #e2e8f0 100%);
        position: relative;
    }
    
    .score-circle::before {
        content: '';
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background-color: white;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    
    .score-value {
        position: relative;
        z-index: 1;
        font-weight: bold;
        font-size: 28px;
        color: #1e40af;
        order: 2;
    }
    
    .score-label {
        position: relative;
        z-index: 1;
        font-size: 14px;
        color: #64748b;
        order: 1;
        margin-bottom: 2px;
    }
    
    /* Typing effect for loading animation */
    .typingEffect::after {
        content: '...';
        animation: dots 1.5s infinite;
        display: inline-block;
        width: 24px;
    }
    
    @keyframes dots {
        0%, 20% { content: '.'; }
        40% { content: '..'; }
        60%, 100% { content: '...'; }
    }
    
    /* Loading shimmer effect */
    @keyframes shimmer {
        0% { background-position: -1000px 0; }
        100% { background-position: 1000px 0; }
    }
    
    .loading-shimmer {
        background: linear-gradient(90deg, #f3f4f6 0%, #e5e7eb 50%, #f3f4f6 100%);
        background-size: 1000px 100%;
        animation: shimmer 2s infinite linear;
    }
        
/* Background Animation Styles */
.animated-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    overflow: hidden;
    z-index: 0;
}

.floating-card {
    position: absolute;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    animation: float 8s ease-in-out infinite;
}

.resume-card {
    width: 280px;
    padding: 20px;
    animation-delay: var(--delay);
}

.stats-card {
    width: 200px;
    padding: 16px;
    animation-delay: var(--delay);
}

.skill-floating {
    display: inline-block;
    background: linear-gradient(45deg, #3b82f6, #8b5cf6);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    margin: 2px;
    animation: skillPulse 3s ease-in-out infinite;
    animation-delay: var(--skill-delay);
}

.score-ring {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: conic-gradient(#10b981 0%, #10b981 var(--score), #e5e7eb var(--score), #e5e7eb 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.score-ring::before {
    content: '';
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: white;
    position: absolute;
}

.score-text {
    position: relative;
    z-index: 1;
    font-weight: bold;
    font-size: 14px;
    color: #059669;
}

@keyframes float {
    0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.7; }
    25% { transform: translateY(-20px) rotate(1deg); opacity: 1; }
    50% { transform: translateY(-10px) rotate(-1deg); opacity: 0.8; }
    75% { transform: translateY(-15px) rotate(0.5deg); opacity: 1; }
}

@keyframes skillPulse {
    0%, 100% { transform: scale(1); opacity: 0.8; }
    50% { transform: scale(1.05); opacity: 1; }
}

@keyframes slideIn {
    0% { transform: translateX(-100%); opacity: 0; }
    100% { transform: translateX(0); opacity: 1; }
}

@keyframes fadeInUp {
    0% { transform: translateY(20px); opacity: 0; }
    100% { transform: translateY(0); opacity: 1; }
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
    20%, 40%, 60%, 80% { transform: translateX(10px); }
}
        
.animate-slide-in {
    animation: slideIn 0.8s ease-out forwards;
    animation-delay: var(--anim-delay);
}

.animate-fade-up {
    animation: fadeInUp 0.6s ease-out forwards;
    animation-delay: var(--anim-delay);
}

/* Auth form styles */
.auth-container {
    position: relative;
    z-index: 10;
}
/* Multiple Candidates Layout */
.candidates-overview {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 24px;
    align-items: start;
    margin-left: 24px;
    margin-right: 24px;
}

.candidates-sidebar {
    position: sticky;
    top: 20px;
}

.candidate-summary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    text-align: center;
}

.sort-btn {
    transition: all 0.2s ease;
    font-weight: 500;
}

.sort-btn.active {
    background: rgba(255, 255, 255, 0.4) !important;
    font-weight: 600;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.sort-btn:hover {
    transform: translateY(-1px);
}

.candidate-grid {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 60vh;
    overflow-y: auto;
    padding-right: 8px;
}

/* Scrollbar styling for the candidate list */
.candidate-grid::-webkit-scrollbar {
    width: 6px;
}

.candidate-grid::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
}

.candidate-grid::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

.candidate-grid::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

.candidate-mini-card {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.candidate-mini-card:hover {
    border-color: #3b82f6;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    transform: translateY(-2px);
}

.candidate-mini-card.active {
    border-color: #3b82f6;
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
}

.candidate-mini-card.active::before {
    content: '';
    position: absolute;
    left: 0;
    top: 4px;
    bottom: 4px;
    width: 4px;
    background: #3b82f6;
    border-radius: 0 4px 4px 0;
}

.mini-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
}

.mini-card-info h4 {
    font-weight: 600;
    font-size: 14px;
    color: #1f2937;
    margin: 0 0 2px 0;
}

.mini-card-info p {
    font-size: 12px;
    color: #6b7280;
    margin: 0;
}

.mini-score-ring {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: conic-gradient(#10b981 0%, #10b981 var(--score), #e5e7eb var(--score), #e5e7eb 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    flex-shrink: 0;
}

.mini-score-ring::before {
    content: '';
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: white;
    position: absolute;
}

.mini-score-text {
    position: relative;
    z-index: 1;
    font-weight: bold;
    font-size: 11px;
    color: #059669;
}

.mini-skills {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
}

.mini-skill-tag {
    background: linear-gradient(45deg, #3b82f6, #8b5cf6);
    color: white;
    padding: 3px 10px;
    border-radius: 15px;
    font-size: 10px;
    font-weight: 500;
    display: inline-block;
    margin: 1px;
    box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
}

/* Search and Filter Styles */
.filter-section {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 16px;
}

.filter-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    font-size: 14px;
}

.filter-input::placeholder {
    color: rgba(255, 255, 255, 0.7);
}

.filter-input:focus {
    outline: none;
    border-color: rgba(255, 255, 255, 0.6);
    background: rgba(255, 255, 255, 0.15);
}

.score-range-slider {
    width: 100%;
    margin: 8px 0;
}

.filter-results-count {
    font-size: 11px;
    opacity: 0.8;
    margin-top: 8px;
}
        
.candidate-detail-view {
    flex: 1;
}

/* Progress bar styles */
.progress-bar {
    width: 100%;
    height: 8px;
    background-color: #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
}

.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #3b82f6, #8b5cf6);
    border-radius: 4px;
    transition: width 0.3s ease;
}

/* Single candidate view margins */
#single-candidate-view {
    margin-left: 24px;
    margin-right: 24px;
}
.connection-status {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        font-weight: 500;
    }

    .connection-status.online {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }

    .connection-status.offline {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
    }
        
/* Responsive design */
@media (max-width: 1024px) {
    .candidates-overview {
        grid-template-columns: 1fr;
        gap: 16px;
        margin-left: 20px;
        margin-right: 20px;
    }
    
    .candidates-sidebar {
        position: static;
        order: 2;
    }
    
    .candidate-detail-view {
        order: 1;
    }
    
    .candidate-grid {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 50vh;
    overflow-y: auto;
    }
    
    /* Responsive margins for single candidate view */
    #single-candidate-view {
        margin-left: 20px;
        margin-right: 20px;
    }
    /* Enhanced Error Handling Styles */
    .montpro-notification {
        position: fixed;
        top: 70px;
        right: 20px;
        z-index: 9999;
        max-width: 400px;
        transform: translateX(calc(100% + 20px));
        transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        border-radius: 12px;
    }

    .montpro-notification.show { transform: translateX(0); }
    .montpro-notification.success { background: linear-gradient(135deg, #10b981, #059669); }
    .montpro-notification.error { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .montpro-notification.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .montpro-notification.info { 
    background: linear-gradient(135deg, #3b82f6, #2563eb); 
    }

    .field-error-shake {
        animation: shake 0.5s ease-in-out;
        border: 2px solid #ef4444 !important;
        background: #fef2f2 !important;
    }
}

.support-page-hidden {
    display: none;
}
        
/* Enhanced Progress Styles */
.enhanced-loading {
    position: relative;
    overflow: hidden;
}

.enhanced-spinner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1;
}

.enhanced-progress-bar {
    background: linear-gradient(90deg, #e5e7eb 0%, #f3f4f6 50%, #e5e7eb 100%);
    background-size: 200% 100%;
    animation: shimmer 2s infinite linear;
}

.enhanced-progress-bar-fill {
    background: linear-gradient(90deg, #3b82f6, #8b5cf6);
    box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
    transition: all 0.3s ease;
}

.progress-modal-overlay {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Button loading states */
.btn-loading {
    position: relative;
    color: transparent !important;
}

.btn-loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top: 2px solid white;
    animation: spin 1s linear infinite;
}
</style>
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-purple-50 min-h-screen">
    <!-- Animated Background -->
    <div class="animated-background">
        <!-- Resume Card 1 -->
        <div class="floating-card resume-card" style="--delay: 0s; top: 10%; left: 5%;">
            <div class="flex items-start justify-between mb-3">
                <div>
                    <h3 class="font-semibold text-gray-800 text-sm">Sarah Johnson</h3>
                    <p class="text-xs text-gray-500">Software Engineer</p>
                </div>
                <div class="score-ring" style="--score: 85%;">
                    <span class="score-text">85</span>
                </div>
            </div>
            <div class="mb-2">
                <span class="skill-floating" style="--skill-delay: 0.5s;">React</span>
                <span class="skill-floating" style="--skill-delay: 1s;">Python</span>
                <span class="skill-floating" style="--skill-delay: 1.5s;">AWS</span>
            </div>
            <div class="text-xs text-gray-600">
                <div class="flex items-center mb-1">
                    <i class="fas fa-briefcase text-blue-500 mr-2"></i>
                    <span>5+ years experience</span>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-graduation-cap text-green-500 mr-2"></i>
                    <span>CS Degree</span>
                </div>
            </div>
        </div>

        <!-- Resume Card 2 -->
        <div class="floating-card resume-card" style="--delay: 2s; top: 60%; right: 8%;">
            <div class="flex items-start justify-between mb-3">
                <div>
                    <h3 class="font-semibold text-gray-800 text-sm">Michael Chen</h3>
                    <p class="text-xs text-gray-500">Product Manager</p>
                </div>
                <div class="score-ring" style="--score: 92%;">
                    <span class="score-text">92</span>
                </div>
            </div>
            <div class="mb-2">
                <span class="skill-floating" style="--skill-delay: 0.3s;">Strategy</span>
                <span class="skill-floating" style="--skill-delay: 0.8s;">Analytics</span>
                <span class="skill-floating" style="--skill-delay: 1.3s;">Leadership</span>
            </div>
            <div class="text-xs text-gray-600">
                <div class="flex items-center mb-1">
                    <i class="fas fa-briefcase text-blue-500 mr-2"></i>
                    <span>8+ years experience</span>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-star text-yellow-500 mr-2"></i>
                    <span>Top 10% match</span>
                </div>
            </div>
        </div>

        <!-- Stats Card 1 -->
        <div class="floating-card stats-card" style="--delay: 1s; top: 20%; right: 15%;">
            <div class="text-center">
                <div class="text-2xl font-bold text-blue-600 mb-1">247</div>
                <div class="text-xs text-gray-600 mb-2">Resumes Analyzed</div>
                <div class="w-full bg-gray-200 h-2 rounded-full">
                    <div class="bg-blue-500 h-2 rounded-full" style="width: 73%; animation: slideIn 2s ease-out;"></div>
                </div>
            </div>
        </div>

        <!-- Stats Card 2 -->
        <div class="floating-card stats-card" style="--delay: 3s; bottom: 30%; left: 10%;">
            <div class="text-center">
                <div class="text-2xl font-bold text-green-600 mb-1">94%</div>
                <div class="text-xs text-gray-600 mb-2">Accuracy Rate</div>
                <div class="flex justify-center">
                    <i class="fas fa-check-circle text-green-500 mr-1"></i>
                    <span class="text-xs text-gray-600">AI Verified</span>
                </div>
            </div>
        </div>

        <!-- Resume Card 3 -->
        <div class="floating-card resume-card" style="--delay: 4s; bottom: 5%; left: 15%;">
            <div class="flex items-start justify-between mb-3">
                <div>
                    <h3 class="font-semibold text-gray-800 text-sm">Emma Rodriguez</h3>
                    <p class="text-xs text-gray-500">UX Designer</p>
                </div>
                <div class="score-ring" style="--score: 78%;">
                    <span class="score-text">78</span>
                </div>
            </div>
            <div class="mb-2">
                <span class="skill-floating" style="--skill-delay: 0.7s;">Figma</span>
                <span class="skill-floating" style="--skill-delay: 1.2s;">UI/UX</span>
                <span class="skill-floating" style="--skill-delay: 1.7s;">Research</span>
            </div>
            <div class="text-xs text-gray-600">
                <div class="flex items-center mb-1">
                    <i class="fas fa-palette text-purple-500 mr-2"></i>
                    <span>Design Portfolio</span>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-users text-blue-500 mr-2"></i>
                    <span>Team Lead</span>
                </div>
            </div>
        </div>

        <!-- Filter Dropdown Animation -->
        <div class="floating-card" style="--delay: 1.5s; top: 40%; left: 3%; width: 180px; padding: 12px;">
            <div class="text-xs font-medium text-gray-700 mb-2">Quick Filters</div>
            <div class="space-y-1">
                <div class="flex items-center animate-fade-up" style="--anim-delay: 0.2s;">
                    <input type="checkbox" class="mr-2" checked>
                    <span class="text-xs text-gray-600">5+ Years Exp</span>
                </div>
                <div class="flex items-center animate-fade-up" style="--anim-delay: 0.4s;">
                    <input type="checkbox" class="mr-2">
                    <span class="text-xs text-gray-600">Remote OK</span>
                </div>
                <div class="flex items-center animate-fade-up" style="--anim-delay: 0.6s;">
                    <input type="checkbox" class="mr-2" checked>
                    <span class="text-xs text-gray-600">Tech Skills</span>
                </div>
            </div>
        </div>

        <!-- Search Results Preview -->
        <div class="floating-card" style="--delay: 2.5s; top: 35%; left: 70%; width: 200px; padding: 16px;">
            <div class="flex items-center mb-2">
                <i class="fas fa-search text-blue-500 mr-2"></i>
                <span class="text-xs font-medium text-gray-700">Search Results</span>
            </div>
            <div class="space-y-2">
                <div class="animate-slide-in" style="--anim-delay: 0.5s;">
                    <div class="text-xs text-gray-800 font-medium">Frontend Developer</div>
                    <div class="text-xs text-green-600">12 matches found</div>
                </div>
                <div class="animate-slide-in" style="--anim-delay: 1s;">
                    <div class="text-xs text-gray-800 font-medium">Product Manager</div>
                    <div class="text-xs text-blue-600">8 matches found</div>
                </div>
            </div>
        </div>
    </div>
    <!-- Authentication Box -->
    <div class="auth-container">
    <div id="auth-box" class="max-w-md mx-auto my-16 p-8 rounded-xl auth-form relative z-10">
        <div class="flex justify-center mb-6">
            <img src="MontPro_logo_with_words-removebg-preview.png" alt="MontPro Logo" class="h-16 w-auto" />
        </div>
        <h2 class="text-2xl font-bold mb-2 text-center text-gray-800">Sign in to MontPro</h2>
        <p class="text-center text-gray-600 mb-6 text-sm">Unlock AI-powered recruitment insights</p>
        <div class="space-y-4">
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email address</label>
                <input id="email" type="email" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="name@company.com" required />
            </div>
            <button id="magic-btn" class="w-full py-3 px-4 btn-primary font-medium rounded-lg flex items-center justify-center">
                <i class="fas fa-magic mr-2"></i>
                <span>Send Magic Link</span>
            </button>
            <div id="auth-msg" class="text-center text-sm font-medium"></div>
        </div>
        
        <!-- Feature Preview -->
        <div class="mt-6 pt-6 border-t border-gray-200">
            <div class="text-center text-xs text-gray-500 mb-3">What you'll get inside:</div>
            <div class="grid grid-cols-2 gap-3 text-xs">
                <div class="flex items-center">
                    <div class="w-4 flex justify-center mr-2">
                        <i class="fas fa-robot text-blue-500"></i>
                    </div>
                    <span class="text-gray-600">AI Analysis</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 flex justify-center mr-2">
                        <i class="fas fa-chart-line text-green-500"></i>
                    </div>
                    <span class="text-gray-600">Match Scoring</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 flex justify-center mr-2">
                        <i class="fas fa-tags text-purple-500"></i>
                    </div>
                    <span class="text-gray-600">Skill Extraction</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 flex justify-center mr-2">
                        <i class="fas fa-users text-orange-500"></i>
                    </div>
                    <span class="text-gray-600">Batch Processing</span>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Main App (hidden until authenticated) -->
    <div id="main-app" class="max-w-5xl mx-auto p-6" style="display: none;">
        <!-- Header with Logo and Logout button -->
        <header class="flex justify-between items-center mb-8 pb-4 border-b border-gray-200">
            <div class="flex items-center space-x-4">
                <img src="MontPro_logo_with_words-removebg-preview.png" alt="MontPro Logo" class="h-12 w-auto" />
                <h1 class="text-2xl font-bold text-gray-800">Recruitment Analysis Tool</h1>
            </div>
            <div class="flex items-center gap-3">
            <!-- History Button -->
            <button id="history-btn" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white rounded-lg border border-gray-300 hover:bg-gray-50 hover:text-gray-900 transition-colors shadow-sm">
                <i class="fas fa-history mr-2"></i>
                <span>Recent Analyses</span>
                <span id="history-count" class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full hidden">0</span>
            </button>
            <!-- Add this BEFORE the logout button -->
            <div class="flex items-center gap-3">
                <div id="usage-display" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white rounded-lg border border-gray-300 shadow-sm">
                    <i class="fas fa-chart-pie mr-2 text-blue-500"></i>
                    <span id="usage-text">Loading...</span>
                </div>
                <!-- Upgrade Button (shows only for free users or when credits are low) -->
                <button id="upgrade-btn" class="hidden px-3 py-2 text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg hover:from-blue-700 hover:to-purple-700 transition-colors shadow-sm" onclick="showPricingPage()">
                    <i class="fas fa-arrow-up mr-1"></i>
                    Upgrade
                </button>
            </div>
            
            <button id="logout-btn" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white rounded-lg border border-gray-300 hover:bg-gray-50 hover:text-gray-900 transition-colors shadow-sm">
                <span>Log Out</span>
                <i class="fas fa-sign-out-alt ml-2"></i>
            </button>
        </header>

        

        <div id="upload-interface" class="bg-white rounded-xl shadow-sm p-8 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-2">Upload Candidate Documents</h2>
            <p class="text-gray-600 mb-6">Upload resumes and CVs for automated analysis and candidate evaluation</p>

            <!-- Hidden File Input -->
            <input type="file" id="file-input" multiple accept=".pdf,.jpg,.jpeg,.png" class="hidden">

            <!-- File Upload Area -->
            <div id="drag-area" class="drag-area bg-gray-50 hover:bg-gray-100 mb-6" tabindex="0">
                <i class="fas fa-cloud-upload-alt text-blue-500 text-4xl mb-4"></i>
                <h3 class="text-lg font-medium mb-1">Drag & drop files or click to browse</h3>
                <p class="text-sm text-gray-500">Supported formats: PDF</p>
            </div>

            <!-- Job Description Input (add this AFTER the drag-area div) -->
            <div id="job-description-section" class="mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-medium text-gray-800">Job Description (Optional)</h3>
                    <span id="jd-feature-badge" class="px-2 py-1 bg-gradient-to-r from-purple-500 to-pink-600 text-white text-xs font-medium rounded shadow-sm">
                        <i class="fas fa-crown mr-1"></i>ULTRA Feature
                    </span>
                </div>
    
                <textarea 
                    id="job-description" 
                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition-all resize-none"
                    rows="6"
                    placeholder="Paste the job description here to get AI-powered candidate matching analysis...

            Example:
            - Required: 5+ years React experience
            - Preferred: Leadership experience
            - Must have: Strong communication skills"
                    disabled
                ></textarea>
    
                <div class="mt-2 text-sm text-gray-500 flex items-center">
                    <i class="fas fa-info-circle mr-2"></i>
                    <span id="jd-info-text">Upgrade to ULTRA to unlock job description matching</span>
                </div>
            </div>
            
            <!-- File List -->
            <div id="file-list-container" class="mb-6 hidden">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-medium">Uploaded Documents (<span id="file-count">0</span>)</h3>
                    <button id="clear-all" class="text-sm text-gray-600 hover:text-red-600">
                        <i class="fas fa-trash-alt mr-1"></i> Clear all
                    </button>
                </div>
                <div id="file-list" class="space-y-2 max-h-64 overflow-y-auto pr-2"></div>
            </div>
            
            <!-- Error Message -->
            <div id="error-message" class="p-4 mb-4 bg-red-50 border-l-4 border-red-500 rounded-lg flex items-start hidden">
                <i class="fas fa-exclamation-circle text-red-500 mr-3 mt-0.5"></i>
                <div class="flex-1">
                    <p id="error-text" class="text-red-700 text-sm mb-3"></p>
                    <button id="retry-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg flex items-center hover:bg-red-700 transition-colors text-sm hidden">
                        <i class="fas fa-redo mr-2"></i>
                        Retry Analysis
                    </button>
                </div>
            </div>
            
            <!-- Status Message -->
            <div id="status-message" class="p-4 mb-4 bg-blue-50 border-l-4 border-blue-500 rounded-lg flex items-start hidden">
                <div id="status-icon" class="mr-3 mt-0.5">
                    <div class="spinner"></div>
                </div>
                <p id="status-text" class="text-blue-700 text-sm"></p>
            </div>
            
            <!-- Start Analysis Button -->
            <button id="start-button" class="w-full py-3.5 px-4 btn-primary font-medium rounded-lg flex items-center justify-center disabled:opacity-70 disabled:cursor-not-allowed transition-all" disabled>
                <i class="fas fa-chart-line mr-2"></i>
                <span>Start Analysis</span>
            </button>

            <div class="text-center text-sm text-gray-500 mt-8">
                <p>This tool will analyze your candidate documents and extract relevant information for recruitment purposes.</p>
                <p class="mt-1">Â© 2025 MontPro. All rights reserved.</p>
            </div>
        </div>
    </div>

    <!-- Pricing Page (add this RIGHT AFTER the main-app div) -->
    <div id="pricing-page" class="max-w-4xl mx-auto p-6" style="display: none;">
        <!-- Header -->
        <header class="text-center mb-12">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">Pilih Paket yang Tepat untuk Anda</h1>
            <p class="text-gray-600">Tingkatkan proses rekrutmen dengan analisis AI yang powerful</p>
        </header>

        <!-- Pricing Cards -->
        <div class="grid md:grid-cols-3 gap-6 max-w-6xl mx-auto">
        
            <!-- FREE TIER -->
            <div class="bg-white rounded-xl shadow-lg p-8 border border-gray-200 relative">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Gratis</h2>
                    <div class="text-4xl font-bold text-gray-600 mb-2">Rp 0</div>
                    <p class="text-gray-500">3 analisis per bulan</p>
                </div>
            
                <ul class="space-y-3 mb-8">
                    <li class="flex items-center">
                        <i class="fas fa-check text-green-500 mr-3"></i>
                        <span>Skor Kandidat Otomatis</span>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check text-green-500 mr-3"></i>
                        <span>Ringkasan Eksekutif</span>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check text-green-500 mr-3"></i>
                        <span>Kompetensi Inti</span>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check text-green-500 mr-3"></i>
                        <span>Export PDF Dasar</span>
                    </li>
                    <li class="flex items-center text-gray-400">
                        <i class="fas fa-times text-gray-400 mr-3"></i>
                        <span>Analisis Mendalam</span>
                    </li>
                    <li class="flex items-center text-gray-400">
                        <i class="fas fa-times text-gray-400 mr-3"></i>
                        <span>Red Flags Detection</span>
                    </li>
                </ul>
            
                <button id="current-plan-btn" class="w-full py-3 px-4 bg-gray-200 text-gray-700 font-medium rounded-lg cursor-not-allowed">
                    <i class="fas fa-check mr-2"></i>
                    Paket Aktif
                </button>
            </div>

            <!-- PROFESIONAL TIER -->
            <div class="bg-white rounded-xl shadow-lg p-8 border-2 border-blue-500 relative">
                <!-- Recommended Badge -->
                <div class="absolute -top-4 left-1/2 transform -translate-x-1/2">
                    <span class="bg-blue-500 text-white px-4 py-1 rounded-full text-sm font-medium">Rekomendasi</span>
                </div>
            
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Profesional</h2>
                    <div class="text-4xl font-bold text-blue-600 mb-2">Rp 599.000</div>
                    <p class="text-gray-500">30 Credits (tidak expired)</p>
                    <p class="text-xs text-gray-400 mt-1">Rp 19.967 per analisis</p>
                </div>
            
                <ul class="space-y-3 mb-8">
                    <li class="flex items-center">
                        <i class="fas fa-check text-green-500 mr-3"></i>
                        <span class="font-medium">Semua fitur Gratis</span>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check text-green-500 mr-3"></i>
                        <span>Role Alignment & Potential Fit</span>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check text-green-500 mr-3"></i>
                        <span>Education & Certifications</span>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check text-green-500 mr-3"></i>
                        <span>Communication Quality Analysis</span>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check text-green-500 mr-3"></i>
                        <span>Red Flags & Risk Detection</span>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check text-green-500 mr-3"></i>
                        <span>Strategic Recommendations</span>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check text-green-500 mr-3"></i>
                        <span>Detailed Candidate Scorecard</span>
                    </li>
                    <li class="flex items-center text-blue-600 font-medium">
                        <i class="fas fa-infinity text-blue-500 mr-3"></i>
                        <span>Credits Tidak Pernah Expired</span>
                    </li>
                </ul>
            
                <button id="upgrade-profesional-btn" class="w-full py-3 px-4 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-rocket mr-2"></i>
                    Beli 30 Credits - Rp 599.000
                </button>
            
                <p class="text-xs text-gray-500 text-center mt-3">
                    Pembayaran aman via Midtrans â€¢ Credits langsung masuk
                </p>
            </div>

            <!-- ULTRA TIER -->
            <div class="bg-white rounded-xl shadow-lg p-8 border-2 border-purple-500 relative">
                <!-- Recommended Badge -->
                <div class="absolute -top-4 left-1/2 transform -translate-x-1/2">
                    <span class="bg-gradient-to-r from-purple-500 to-pink-600 text-white px-4 py-1 rounded-full text-sm font-medium">Most Powerful</span>
                </div>

                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Ultra</h2>
                    <div class="text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-2">Rp 999.000</div>
                    <p class="text-gray-500">20 Credits (tidak expired)</p>
                    <p class="text-xs text-gray-400 mt-1">Rp 49.950 per analisis</p>
                </div>

                <ul class="space-y-3 mb-8">
                    <li class="flex items-center">
                        <i class="fas fa-check text-green-500 mr-3"></i>
                        <span class="font-medium">Semua fitur Profesional</span>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-target text-purple-500 mr-3"></i>
                        <span class="font-weight-bold">Job Description Matching</span>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-percentage text-purple-500 mr-3"></i>
                        <span>Match Percentage & Reasoning</span>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-lightbulb text-purple-500 mr-3"></i>
                        <span>Gap Analysis & Recommendations</span>
                    </li>
                    <li class="flex items-center text-purple-600 font-medium">
                        <i class="fas fa-crown text-purple-500 mr-3"></i>
                        <span>Premium AI Analysis</span>
                    </li>
                </ul>

                <button id="upgrade-ultra-btn" class="w-full py-3 px-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-medium rounded-lg hover:from-purple-700 hover:to-pink-700 transition-colors">
                    <i class="fas fa-rocket mr-2"></i>
                    <span id="ultra-btn-text">Upgrade to Ultra - Rp 999.000</span>
                </button>

                <p class="text-xs text-gray-500 text-center mt-3">
                    Premium job matching â€¢ Credits tidak expired
                </p>
            </div>
        </div>
    
        <!-- Value Proposition -->
        <div class="mt-12 bg-gray-50 rounded-xl p-6">
            <h3 class="text-lg font-semibold text-center mb-4">Mengapa Profesional?</h3>
            <div class="grid md:grid-cols-3 gap-6 text-center">
                <div>
                    <i class="fas fa-clock text-blue-500 text-2xl mb-3"></i>
                    <h4 class="font-medium mb-2">Hemat Waktu</h4>
                    <p class="text-sm text-gray-600">15+ jam screening manual menjadi 2 menit per kandidat</p>
                </div>
                <div>
                    <i class="fas fa-eye text-green-500 text-2xl mb-3"></i>
                    <h4 class="font-medium mb-2">Insight Mendalam</h4>
                    <p class="text-sm text-gray-600">Analisis komprehensif yang tidak terlihat di screening manual</p>
                </div>
                <div>
                    <i class="fas fa-shield-alt text-purple-500 text-2xl mb-3"></i>
                    <h4 class="font-medium mb-2">Hindari Bad Hire</h4>
                    <p class="text-sm text-gray-600">Red flags detection mencegah kesalahan rekrutmen</p>
                </div>
            </div>
        </div>
    
        <!-- Back Button -->
        <div class="text-center mt-12">
            <button id="back-to-app-btn" class="px-6 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>
                Kembali ke Aplikasi
            </button>
        </div>
    </div>

     <!-- Support/Contact Page -->
<div id="support-page" class="max-w-4xl mx-auto p-6 support-page-hidden">
    <header class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">Bantuan & Dukungan</h1>
        <p class="text-gray-600">Kami siap membantu Anda mengoptimalkan proses rekrutmen</p>
    </header>

    <div class="grid md:grid-cols-2 gap-8">
        <!-- Contact Information -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-envelope text-blue-500 mr-3"></i>
                Hubungi Kami
            </h2>
            
            <div class="space-y-4">
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">Email Support</h3>
                    <a href="mailto:support@aapgrp.com" class="text-blue-600 hover:text-blue-800">
                        support@aapgrp.com
                    </a>
                    <p class="text-sm text-gray-500 mt-1">
                        Respon dalam 24 jam (hari kerja)
                    </p>
                </div>
                
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">Konsultasi Khusus</h3>
                    <a href="https://calendly.com/ardhipradhana/montpro_discovery" class="text-purple-600 hover:text-purple-800" target="_blank">
                        Jadwalkan Meeting
                    </a>
                    <p class="text-sm text-gray-500 mt-1">
                        Untuk kebutuhan enterprise & customization
                    </p>
                </div>
            </div>
        </div>

        <!-- Quick Help -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-question-circle text-green-500 mr-3"></i>
                Bantuan Cepat
            </h2>
            
            <div class="space-y-4">
                <div class="p-3 bg-blue-50 rounded-lg">
                    <h3 class="font-semibold text-blue-800 mb-1">Masalah Pembayaran?</h3>
                    <p class="text-sm text-blue-600">
                        Sertakan Order ID atau screenshot error untuk respon lebih cepat.
                    </p>
                </div>
                
                <div class="p-3 bg-green-50 rounded-lg">
                    <h3 class="font-semibold text-green-800 mb-1">Credits Tidak Masuk?</h3>
                    <p class="text-sm text-green-600">
                        Refresh halaman atau logout-login kembali. Jika masih bermasalah, hubungi kami.
                    </p>
                </div>
                
                <div class="p-3 bg-purple-50 rounded-lg">
                    <h3 class="font-semibold text-purple-800 mb-1">Hasil Analisis Tidak Akurat?</h3>
                    <p class="text-sm text-purple-600">
                        Pastikan file CV dalam format PDF berkualitas baik dan tidak terpassword.
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="text-center mt-8">
        <button id="back-from-support" class="px-6 py-2 text-gray-600 hover:text-gray-800 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>Kembali ke Aplikasi
        </button>
    </div>
</div>

<!-- FAQ Page -->
<div id="faq-page" class="max-w-4xl mx-auto p-6 support-page-hidden">
    <header class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">FAQ - Pertanyaan Umum</h1>
        <p class="text-gray-600">Jawaban untuk pertanyaan yang sering diajukan</p>
    </header>

    <div class="space-y-6">
        <!-- Credit System -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold text-blue-600 mb-4">ðŸ’³ Sistem Credits</h2>
            
            <div class="space-y-4">
                <div>
                    <h3 class="font-semibold text-gray-800 mb-2">Bagaimana sistem credits bekerja?</h3>
                    <p class="text-gray-600 text-sm">
                        Setiap analisis CV menggunakan 1 credit. Paket Gratis memberikan 3 analisis per bulan. 
                        Paket Profesional memberikan 30 credits yang tidak pernah expired.
                    </p>
                </div>
                
                <div>
                    <h3 class="font-semibold text-gray-800 mb-2">Apakah credits bisa expired?</h3>
                    <p class="text-gray-600 text-sm">
                        Tidak! Credits Profesional tidak pernah expired. Anda bisa menggunakannya kapan saja.
                    </p>
                </div>
            </div>
        </div>

        <!-- Analysis -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold text-green-600 mb-4">ðŸ¤– Analisis CV</h2>
            
            <div class="space-y-4">
                <div>
                    <h3 class="font-semibold text-gray-800 mb-2">Format file apa yang didukung?</h3>
                    <p class="text-gray-600 text-sm">
                        Saat ini kami mendukung file PDF. Pastikan file tidak terpassword dan berkualitas baik.
                    </p>
                </div>
                
                <div>
                    <h3 class="font-semibold text-gray-800 mb-2">Berapa lama proses analisis?</h3>
                    <p class="text-gray-600 text-sm">
                        Biasanya 30-60 detik per CV. Waktu bisa lebih lama jika file besar atau traffic tinggi.
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="text-center mt-8">
        <button id="back-from-faq" class="px-6 py-2 text-gray-600 hover:text-gray-800 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>Kembali ke Aplikasi
        </button>
    </div>
</div>

<!-- Terms Page -->
<div id="terms-page" class="max-w-4xl mx-auto p-6 support-page-hidden">
    <header class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">Syarat & Ketentuan</h1>
        <p class="text-gray-600">Terakhir diperbarui: 27 Mei 2025</p>
    </header>

    <div class="bg-white rounded-xl shadow-lg p-8">
        <div class="prose max-w-none">
            <h2 class="text-xl font-bold text-gray-800 mb-4">1. Penggunaan Layanan</h2>
            <p class="text-gray-600 mb-4">
                Dengan menggunakan MontPro, Anda setuju untuk menggunakan layanan ini secara bertanggung jawab 
                dan sesuai dengan hukum yang berlaku di Indonesia.
            </p>

            <h2 class="text-xl font-bold text-gray-800 mb-4">2. Akun dan Keamanan</h2>
            <p class="text-gray-600 mb-4">
                Anda bertanggung jawab untuk menjaga keamanan akun dan password Anda. 
                Segera laporkan jika ada penggunaan yang tidak sah.
            </p>

            <h2 class="text-xl font-bold text-gray-800 mb-4">3. Pembayaran dan Refund</h2>
            <p class="text-gray-600 mb-4">
                Semua pembayaran bersifat final. Credits yang sudah dibeli tidak dapat dikembalikan, 
                kecuali dalam kasus kesalahan sistem yang dapat dibuktikan.
            </p>

            <h2 class="text-xl font-bold text-gray-800 mb-4">4. Privasi Data</h2>
            <p class="text-gray-600 mb-4">
                Kami menghormati privasi Anda. File CV yang diupload hanya digunakan untuk analisis 
                dan tidak disimpan setelah proses selesai. Data analisis disimpan dalam akun Anda 
                untuk referensi dan dapat dihapus sewaktu-waktu.
            </p>

            <h2 class="text-xl font-bold text-gray-800 mb-4">5. Batasan Tanggung Jawab</h2>
            <p class="text-gray-600 mb-4">
                Hasil analisis MontPro adalah untuk referensi dan tidak menggantikan penilaian profesional 
                dalam proses rekrutmen. Keputusan hiring tetap menjadi tanggung jawab pengguna.
            </p>

            <h2 class="text-xl font-bold text-gray-800 mb-4">6. Kontak</h2>
            <p class="text-gray-600 mb-4">
                Untuk pertanyaan tentang syarat dan ketentuan ini, hubungi kami di 
                <a href="mailto:support@aapgrp.com" class="text-blue-600">support@aapgrp.com</a>
            </p>
        </div>
    </div>
    
    <div class="text-center mt-8">
        <button id="back-from-terms" class="px-6 py-2 text-gray-600 hover:text-gray-800 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>Kembali ke Aplikasi
        </button>
    </div>
</div>

<!-- Privacy Policy Page -->
<div id="privacy-page" class="max-w-4xl mx-auto p-6 support-page-hidden">
    <header class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">Kebijakan Privasi</h1>
        <p class="text-gray-600">Terakhir diperbarui: 27 Mei 2025</p>
    </header>

    <div class="bg-white rounded-xl shadow-lg p-8">
        <div class="prose max-w-none">
            <h2 class="text-xl font-bold text-gray-800 mb-4">1. Informasi yang Kami Kumpulkan</h2>
            <p class="text-gray-600 mb-4">
                Kami mengumpulkan informasi yang Anda berikan secara langsung, seperti alamat email untuk login 
                dan file CV yang Anda upload untuk analisis.
            </p>

            <h2 class="text-xl font-bold text-gray-800 mb-4">2. Penggunaan Informasi</h2>
            <p class="text-gray-600 mb-4">
                Informasi yang kami kumpulkan digunakan untuk menyediakan layanan analisis CV, 
                mengelola akun Anda, dan berkomunikasi dengan Anda tentang layanan kami.
            </p>

            <h2 class="text-xl font-bold text-gray-800 mb-4">3. Penyimpanan Data</h2>
            <p class="text-gray-600 mb-4">
                File CV yang diupload diproses secara real-time dan tidak disimpan di server kami. 
                Hasil analisis disimpan dalam akun Anda dan dapat dihapus kapan saja.
            </p>

            <h2 class="text-xl font-bold text-gray-800 mb-4">4. Keamanan Data</h2>
            <p class="text-gray-600 mb-4">
                Kami menggunakan teknologi enkripsi dan praktik keamanan standar industri 
                untuk melindungi informasi pribadi Anda.
            </p>

            <h2 class="text-xl font-bold text-gray-800 mb-4">5. Kontak</h2>
            <p class="text-gray-600 mb-4">
                Jika Anda memiliki pertanyaan tentang kebijakan privasi ini, hubungi kami di 
                <a href="mailto:support@aapgrp.com" class="text-blue-600">support@aapgrp.com</a>
            </p>
        </div>
    </div>
    
    <div class="text-center mt-8">
        <button id="back-from-privacy" class="px-6 py-2 text-gray-600 hover:text-gray-800 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>Kembali ke Aplikasi
        </button>
    </div>
</div>

    <!-- 1. Add the loading UI section right after your upload-interface section -->
<div id="analysis-loading" class="hidden">
    <div class="bg-white rounded-xl shadow-sm p-8 mb-8 text-center">
        <div class="mb-6">
            <div class="w-24 h-24 mx-auto mb-6 flex items-center justify-center relative">
                <!-- Outer ring animation -->
                <div class="absolute inset-0 border-4 border-blue-100 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-transparent border-t-blue-500 rounded-full animate-spin"></div>
                
                <!-- Inner icon -->
                <i class="fas fa-robot text-blue-500 text-3xl"></i>
            </div>
            <h2 class="text-xl font-semibold text-gray-800 mb-2">AI Analyzing Resume</h2>
            <p class="text-gray-600 typingEffect">Processing candidate information</p>
        </div>
        
        <div class="max-w-md mx-auto mb-8">
            <div class="flex justify-between text-sm text-gray-600 mb-1">
                <span id="loading-step">Extracting qualifications</span>
                <span id="loading-percent">25%</span>
            </div>
            <div class="progress-bar">
                <div id="progress-bar-fill" class="progress-bar-fill" style="width: 25%"></div>
            </div>
        </div>
        
        <div class="text-center text-sm text-gray-500 space-y-3">
            <div class="flex items-center justify-center">
                <div class="w-4 h-4 bg-green-500 rounded-full mr-2 flex items-center justify-center">
                    <i class="fas fa-check text-white text-xs"></i>
                </div>
                <span>Document uploaded successfully</span>
            </div>
            <div class="flex items-center justify-center">
                <div class="w-4 h-4 bg-green-500 rounded-full mr-2 flex items-center justify-center">
                    <i class="fas fa-check text-white text-xs"></i>
                </div>
                <span>Text extraction complete</span>
            </div>
            <div class="flex items-center justify-center">
                <div class="w-4 h-4 bg-blue-500 rounded-full mr-2 flex items-center justify-center animate-pulse">
                    <div class="w-2 h-2 bg-white rounded-full"></div>
                </div>
                <span>Skills and experience analysis in progress</span>
            </div>
            <div class="flex items-center justify-center opacity-50">
                <div class="w-4 h-4 border border-gray-300 rounded-full mr-2"></div>
                <span>Generating outputs</span>
            </div>
        </div>
    </div>
</div>

<!-- Replace your existing analysis-results div with this -->
<div id="analysis-results" class="hidden">
    <!-- Single Candidate View (existing) -->
    <div id="single-candidate-view">
        <!-- Your existing single candidate HTML stays exactly the same -->
        <!-- Candidate Overview -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-center md:items-start gap-6">
                <div>
                    <div class="flex items-center mb-2">
                        <h2 id="candidate-name" class="text-2xl font-bold text-gray-800">Candidate Name</h2>
                        <span id="user-tier-badge" class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded">Free Trial</span>
                    </div>
                    
                    <div class="flex flex-wrap gap-2 mt-2">
                        <span class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded-md">Resume Analysis</span>
                        <span class="text-xs bg-green-50 text-green-700 px-2 py-1 rounded-md">AI-Powered</span>
                        <span id="analysis-date" class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded-md">May 21, 2025</span>
                    </div>
                </div>
                
                <div class="text-center">
                    <div class="score-circle" style="--score-percent: 75%">
                        <div class="score-label">Score</div>
                        <div class="score-value" id="candidate-score">75</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Executive Summary -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex items-center mb-4">
                <i class="fas fa-file-alt text-blue-500 mr-3"></i>
                <h3 class="text-lg font-semibold">Executive Summary</h3>
            </div>
            <div id="executive-summary" class="text-gray-700">
                <!-- Executive summary will be inserted here -->
            </div>
        </div>
        
        <!-- Core Competencies Preview -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <i class="fas fa-brain text-blue-500 mr-3"></i>
                    <h3 class="text-lg font-semibold">Core Competencies</h3>
                </div>
                <span class="text-sm text-gray-500">Top Skills Preview</span>
            </div>
            <div id="core-competencies" class="flex flex-wrap gap-1.5">
                <!-- Top skills will be inserted here -->
            </div>
        </div>
        
        <!-- Upgrade CTA -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl p-6 text-white mb-6">
            <div class="md:flex justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <h3 class="font-bold text-xl mb-2">Take Your Recruitment Process to the Next Level</h3>
                    <p class="opacity-90 mb-2">Unlock advanced customization options and powerful features:</p>
                    <ul class="list-disc pl-5 text-sm opacity-90 space-y-1">
                        <li>Custom metrics tracking tailored to your hiring needs</li>
                        <li>Batch upload via Google Drive for efficient processing</li>
                        <li>Flexible output formats (Google Docs, Slides, Sheets, PDF)</li>
                        <li>Personalized report templates to match your brand</li>
                        <li>Match candidates against your specific job requirements</li>
                    </ul>
                </div>
                <div class="mt-4 md:mt-0 flex-shrink-0 text-center">
                    <p class="text-sm italic text-white opacity-80 mb-2">You've tried it, now make it yours.</p>
                    <a href="https://calendly.com/ardhipradhana/montpro_discovery" class="inline-block px-6 py-3 bg-white text-purple-700 font-medium rounded-lg hover:bg-gray-100 transition-colors shadow-md">
                        <i class="fas fa-magic mr-2"></i>
                        Get My Tailored Version
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Multiple Candidates View (new) -->
    <div id="multiple-candidates-view" class="hidden">
        <div class="candidates-overview">
            <!-- Candidates Sidebar -->
            <div class="candidates-sidebar">
                <!-- Summary Header -->
                <div class="candidate-summary">
                    <div class="text-2xl font-bold mb-1" id="total-candidates">5</div>
                    <div class="text-sm opacity-90">Candidates Analyzed</div>
                    <div class="mt-3 text-xs opacity-75" id="analysis-timestamp">
                        Analysis completed on May 22, 2025
                    </div>

                    <div class="mt-4 pt-3 border-t border-white/30">
                        <div class="text-xs opacity-75 mb-2">Sort by:</div>
                        <div class="flex gap-2">
                            <button id="sort-score" class="sort-btn active px-2 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors">
                                Score â†“
                            </button>
                            <button id="sort-name" class="sort-btn px-2 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors">
                                Name
                            </button>
                        </div>
                    </div>
                    <!-- ADD THIS NEW SECTION -->
                    <div class="filter-section mt-4 pt-3 border-t border-white/30">
                        <div class="text-xs opacity-75 mb-2">Search & Filter:</div>
    
                        <!-- Search Input -->
                        <input type="text" id="candidate-search" class="filter-input mb-3" 
                               placeholder="Search names, titles, skills..." 
                               style="width: 100%; padding: 8px 12px; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; background: rgba(255,255,255,0.1); color: white; font-size: 14px;">
    
                        <!-- Score section (you already have this working) -->
                        <div class="text-xs opacity-75 mb-1">Min Score: <span id="score-display">0</span></div>
                        <input type="range" id="score-range" class="score-range-slider" min="0" max="100" value="0">
    
                        <!-- Results counter -->
                        <div id="filter-results" class="filter-results-count text-xs opacity-75 mt-2">
                            Showing all candidates
                        </div>
                    </div>
                </div>

                <!-- Candidate Cards Grid -->
                <div class="candidate-grid" id="candidate-cards">
                    <!-- Cards will be dynamically inserted here -->
                </div>
            </div>

            <!-- Detailed View -->
            <div class="candidate-detail-view">
                <div id="selected-candidate-detail">
                    <!-- Selected candidate details will be shown here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Actions -->
    <div id="analysis-actions" class="flex flex-col md:flex-row justify-between gap-4 mt-6 hidden" style="margin-left: 20px; margin-bottom: 20px; margin-right: 20px;">
        <button id="new-analysis-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg flex items-center justify-center hover:bg-gray-300 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>
            Analyze Another Resume
        </button>
    
        <div class="flex flex-col md:flex-row gap-3">
            <!-- Export Dropdown -->
            <div class="relative">
                <button id="export-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg flex items-center justify-center hover:bg-green-700 transition-colors">
                    <i class="fas fa-download mr-2"></i>
                    Export Results
                    <i class="fas fa-chevron-down ml-2 text-xs"></i>
                </button>
            
                <!-- Dropdown Menu -->
                <div id="export-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-10 hidden">
                    <button id="export-csv" class="w-full px-4 py-2 text-left hover:bg-gray-50 rounded-t-lg flex items-center">
                        <i class="fas fa-file-csv text-green-600 mr-3"></i>
                        Export to CSV
                    </button>
                    <button id="copy-results" class="w-full px-4 py-2 text-left hover:bg-gray-50 flex items-center">
                        <i class="fas fa-copy text-blue-600 mr-3"></i>
                        Copy to Clipboard
                    </button>
                    <button id="email-results" class="w-full px-4 py-2 text-left hover:bg-gray-50 rounded-b-lg flex items-center">
                        <i class="fas fa-envelope text-purple-600 mr-3"></i>
                        Email Results
                    </button>
                </div>
            </div>
        
            <button id="download-pdf-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg flex items-center justify-center hover:bg-blue-700 transition-colors">
                <i class="fas fa-file-pdf mr-2"></i>
                Download PDF
            </button>
        </div>
    </div>

    <!-- Footer text also here for results page with bottom margin -->
    <div id="results-footer" class="text-center text-sm text-gray-500 mt-8 mb-8 hidden">
        <p>Results are provided for recruitment guidance only. Final hiring decisions should consider multiple factors beyond this analysis.</p>
        <p class="mt-1">Â© 2025 MontPro. All rights reserved.</p>
    </div>
</div>

    <script>
        class MontProFeedback {
    constructor() {
        this.retryAttempts = new Map();
        this.maxRetries = 3;
        this.setupConnectionMonitoring();
    }
    
    showNotification(message, type = 'info', duration = 5000) {
        const notification = document.createElement('div');
        notification.className = `montpro-notification ${type} text-white p-4`;
        
        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };
        
        notification.innerHTML = `
            <div class="flex items-start">
                <i class="fas ${icons[type]} text-xl mr-3 mt-0.5"></i>
                <div class="flex-1">
                    <div class="text-sm">${message}</div>
                </div>
                <button class="ml-3 text-white/70 hover:text-white" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        document.body.appendChild(notification);
        requestAnimationFrame(() => notification.classList.add('show'));
        
        if (duration > 0) {
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 400);
            }, duration);
        }
    }
    // Add these methods inside your MontProFeedback class

validateFile(file, options = {}) {
    const {
        maxSize = 10 * 1024 * 1024, // 10MB default
        allowedTypes = ['application/pdf', 'image/jpeg', 'image/png'],
        allowedExtensions = ['.pdf', '.jpg', '.jpeg', '.png']
    } = options;
    
    const errors = [];
    
    // Size validation
    if (file.size > maxSize) {
        errors.push(`File "${file.name}" is too large (${this.formatFileSize(file.size)}). Maximum size allowed: ${this.formatFileSize(maxSize)}`);
    }
    
    // Type validation
    if (!allowedTypes.includes(file.type)) {
        errors.push(`File "${file.name}" has unsupported format. Supported formats: PDF`);
    }
    
    // Extension validation
    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
    if (!allowedExtensions.includes(fileExtension)) {
        errors.push(`File "${file.name}" has invalid extension "${fileExtension}"`);
    }
    
    // Empty file check
    if (file.size === 0) {
        errors.push(`File "${file.name}" appears to be empty`);
    }
    
    // Corrupted file check (basic)
    if (file.name.includes('~') || file.name.startsWith('.')) {
        errors.push(`File "${file.name}" may be corrupted or is a system file`);
    }
    
    return {
        valid: errors.length === 0,
        errors,
        file
    };
}

formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1048576).toFixed(1) + ' MB';
}

showFieldError(fieldElement, message) {
    fieldElement.classList.add('field-error-shake');
    
    // Remove existing error message
    const existingError = fieldElement.parentNode.querySelector('.field-error-message');
    if (existingError) existingError.remove();
    
    // Add error message below the field
    const errorDiv = document.createElement('div');
    errorDiv.className = 'field-error-message text-red-600 text-sm mt-2 flex items-center';
    errorDiv.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${message}`;
    fieldElement.parentNode.appendChild(errorDiv);
    
    // Remove shake animation after it completes
    setTimeout(() => fieldElement.classList.remove('field-error-shake'), 500);
}

clearFieldError(fieldElement) {
    fieldElement.classList.remove('field-error-shake');
    const errorDiv = fieldElement.parentNode.querySelector('.field-error-message');
    if (errorDiv) errorDiv.remove();
}
// Add inside your MontProFeedback class

async makeRequest(url, options = {}) {
    const {
        timeout = 30000,
        retries = this.maxRetries,
        retryDelay = 2000,
        onRetry = null
    } = options;
    
    const requestKey = url + JSON.stringify(options.body || {});
    let attempt = this.retryAttempts.get(requestKey) || 0;
    
    try {
        // Create timeout promise
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);
        
        // Make request with timeout
        const response = await fetch(url, {
            ...options,
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error(`Server error: ${response.status} ${response.statusText}`);
        }
        
        // Reset retry counter on success
        this.retryAttempts.delete(requestKey);
        return response;
        
    } catch (error) {
        attempt++;
        this.retryAttempts.set(requestKey, attempt);
        
        // Determine error type
        const errorType = this.categorizeError(error);
        
        if (attempt <= retries && errorType.retryable) {
            if (onRetry) onRetry(attempt, retries + 1, error);
            
            // Show retry notification
            this.showNotification(
                `${errorType.message} (attempt ${attempt}/${retries + 1}). Retrying in ${retryDelay/1000}s...`,
                'warning',
                retryDelay
            );
            
            await new Promise(resolve => setTimeout(resolve, retryDelay));
            return this.makeRequest(url, options);
        } else {
            this.retryAttempts.delete(requestKey);
            throw new Error(`${errorType.message}${attempt > retries ? ` (failed after ${retries + 1} attempts)` : ''}`);
        }
    }
}

categorizeError(error) {
    if (error.name === 'AbortError') {
        return {
            message: 'Request timed out',
            retryable: true,
            type: 'timeout'
        };
    } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
        return {
            message: 'Network connection failed',
            retryable: true,
            type: 'network'
        };
    } else if (error.message.includes('Server error: 5')) {
        return {
            message: 'Server temporarily unavailable',
            retryable: true,
            type: 'server'
        };
    } else if (error.message.includes('Server error: 4')) {
        return {
            message: 'Request error - please check your data',
            retryable: false,
            type: 'client'
        };
    } else {
        return {
            message: error.message || 'Unknown error occurred',
            retryable: true,
            type: 'unknown'
        };
    }
}
    
    setupConnectionMonitoring() {
    // Monitor online/offline status
    window.addEventListener('online', () => {
        this.showNotification('Connection restored', 'success', 3000);
        this.updateConnectionStatus(true);
    });
    
    window.addEventListener('offline', () => {
        this.showNotification('Connection lost - working in offline mode', 'warning', 0);
        this.updateConnectionStatus(false);
    });
    
    // Initial status
    this.updateConnectionStatus(navigator.onLine);
}

updateConnectionStatus(isOnline) {
    let statusElement = document.getElementById('connection-status');
    
    if (!statusElement) {
        statusElement = document.createElement('div');
        statusElement.id = 'connection-status';
        statusElement.className = 'connection-status';
        document.body.appendChild(statusElement);
    }
    
    if (isOnline) {
        statusElement.className = 'connection-status online';
        statusElement.innerHTML = '<i class="fas fa-wifi mr-2"></i>Online';
    } else {
        statusElement.className = 'connection-status offline';
        statusElement.innerHTML = '<i class="fas fa-wifi-slash mr-2"></i>Offline';
    }
}
// Add inside your MontProFeedback class

createProgressTracker(containerId, options = {}) {
    const {
        title = 'Processing...',
        steps = ['Initializing...'],
        showPercentage = true,
        showTimeEstimate = false
    } = options;
    
    const container = document.getElementById(containerId);
    if (!container) return null;
    
    const tracker = {
        container,
        currentStep: 0,
        totalSteps: steps.length,
        startTime: Date.now(),
        progress: 0,
        
        update: function(stepIndex, customMessage = null, progressPercent = null) {
            this.currentStep = stepIndex;
            this.progress = progressPercent !== null ? progressPercent : Math.round((stepIndex / this.totalSteps) * 100);
            
            const message = customMessage || steps[stepIndex] || 'Processing...';
            const progressBar = container.querySelector('.enhanced-progress-bar-fill');
            const progressText = container.querySelector('.enhanced-progress-text');
            const progressPercentElement = container.querySelector('.enhanced-progress-percent');
            const timeEstimate = container.querySelector('.enhanced-time-estimate');

            if (progressBar) progressBar.style.width = `${this.progress}%`;
            if (progressText) progressText.textContent = message;
            if (progressPercentElement && showPercentage) progressPercentElement.textContent = `${this.progress}%`;
            
            if (timeEstimate && showTimeEstimate && this.progress > 10) {
                const elapsed = Date.now() - this.startTime;
                const estimated = (elapsed / this.progress) * (100 - this.progress);
                const minutes = Math.floor(estimated / 60000);
                const seconds = Math.floor((estimated % 60000) / 1000);
                timeEstimate.textContent = minutes > 0 ? `~${minutes}m ${seconds}s remaining` : `~${seconds}s remaining`;
            }
        },
        
        complete: function(message = 'Complete!') {
            this.update(this.totalSteps - 1, message, 100);
            setTimeout(() => {
                const progressBar = container.querySelector('.enhanced-progress-bar-fill');
                if (progressBar) progressBar.style.backgroundColor = '#10b981';
            }, 200);
        },
        
        error: function(message = 'Error occurred') {
            const progressBar = container.querySelector('.enhanced-progress-bar-fill');
            const progressText = container.querySelector('.enhanced-progress-text');
            
            if (progressBar) progressBar.style.backgroundColor = '#ef4444';
            if (progressText) progressText.textContent = message;
        }
    };
    
    return tracker;
}

enhanceLoadingState(elementId, options = {}) {
    const {
        pulseColor = '#3b82f6',
        showSpinner = true,
        showShimmer = true
    } = options;
    
    const element = document.getElementById(elementId);
    if (!element) return;
    
    // Add enhanced loading classes
    element.classList.add('enhanced-loading');
    
    if (showShimmer) {
        element.style.background = `linear-gradient(90deg, #f3f4f6 0%, #e5e7eb 50%, #f3f4f6 100%)`;
        element.style.backgroundSize = '200% 100%';
        element.style.animation = 'shimmer 1.5s infinite linear';
    }
    
    if (showSpinner) {
        const spinner = document.createElement('div');
        spinner.className = 'enhanced-spinner';
        spinner.innerHTML = '<div class="spinner"></div>';
        element.appendChild(spinner);
    }
}

removeLoadingState(elementId) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    element.classList.remove('enhanced-loading');
    element.style.background = '';
    element.style.backgroundSize = '';
    element.style.animation = '';
    
    const spinner = element.querySelector('.enhanced-spinner');
    if (spinner) spinner.remove();
}

showProgressModal(title, steps, onCancel = null) {
    // Create modal overlay
    const overlay = document.createElement('div');
    overlay.className = 'progress-modal-overlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
    `;
    
    // Create modal content
    const modal = document.createElement('div');
    modal.className = 'progress-modal';
    modal.style.cssText = `
        background: white;
        border-radius: 16px;
        padding: 32px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    `;
    
    modal.innerHTML = `
        <div class="text-center mb-6">
            <div class="w-16 h-16 mx-auto mb-4 flex items-center justify-center relative">
                <div class="absolute inset-0 border-4 border-blue-100 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-transparent border-t-blue-500 rounded-full animate-spin"></div>
                <i class="fas fa-cog text-blue-500 text-2xl"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">${title}</h3>
        </div>
        
        <div class="mb-6">
            <div class="flex justify-between text-sm text-gray-600 mb-2">
                <span class="enhanced-progress-text">Initializing...</span>
                <span class="enhanced-progress-percent">0%</span>
            </div>
            <div class="enhanced-progress-bar w-full h-3 bg-gray-200 rounded-full overflow-hidden">
                <div class="enhanced-progress-bar-fill h-full bg-blue-500 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <div class="enhanced-time-estimate text-xs text-gray-500 mt-1 text-center"></div>
        </div>
        
        ${onCancel ? '<div class="text-center"><button class="cancel-btn px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">Cancel</button></div>' : ''}
    `;
    
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    
    // Set up cancel functionality
    if (onCancel) {
        const cancelBtn = modal.querySelector('.cancel-btn');
        cancelBtn.addEventListener('click', () => {
            onCancel();
            document.body.removeChild(overlay);
        });
    }
    
    // Create and return progress tracker
    const tracker = this.createProgressTracker('progress-modal', {
        title,
        steps,
        showPercentage: true,
        showTimeEstimate: true
    });
    
    tracker.close = () => {
        if (document.body.contains(overlay)) {
            document.body.removeChild(overlay);
        }
    };
    
    return tracker;
}
}

// History Management System
class AnalysisHistory {
    constructor() {
        this.storageKey = 'montpro_analysis_history';
        this.maxHistoryItems = 50; // Limit to prevent localStorage bloat
    }

    // Add these methods:
    calculateAverageScore(candidates) {
        const scores = candidates.map(c => parseInt(c.candidateScore) || 0);
        return scores.length ? Math.round(scores.reduce((a, b) => a + b) / scores.length) : 0;
    }

    extractTopSkills(candidates) {
        const skillFrequency = {};
    
        candidates.forEach(candidate => {
            const skills = this.extractSkillsFromCandidate(candidate);
            skills.forEach(skill => {
                skillFrequency[skill] = (skillFrequency[skill] || 0) + 1;
            });
        });
    
        return Object.entries(skillFrequency)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 5)
            .map(([skill]) => skill);
    }

    extractSkillsFromCandidate(candidate) {
        if (!candidate.coreCompetencies) return [];
    
        if (Array.isArray(candidate.coreCompetencies)) {
            return candidate.coreCompetencies;
        }
    
        // Extract from string format
        return candidate.coreCompetencies
            .split(/[,\nâ€¢-]/)
            .map(skill => skill.trim())
            .filter(skill => skill.length > 0)
            .slice(0, 10); // Limit per candidate
    }

    searchHistory(query) {
        const history = this.getHistory();
        const searchTerm = query.toLowerCase();
    
        return history.filter(analysis => 
            analysis.candidates.some(candidate => 
                (candidate.candidateName || '').toLowerCase().includes(searchTerm) ||
                (candidate.executiveSummary || '').toLowerCase().includes(searchTerm) ||
                (candidate.coreCompetencies || '').toString().toLowerCase().includes(searchTerm)
            )
        );
    }
    
    // Save analysis to history
    saveAnalysis(candidatesData, analysisMetadata = {}) {
        try {
            const historyItem = {
                id: this.generateId(),
                timestamp: new Date().toISOString(),
                analysisDate: new Date().toLocaleDateString(),
                candidates: candidatesData,
                totalCandidates: candidatesData.length,
                averageScore: this.calculateAverageScore(candidatesData),
                topSkills: this.extractTopSkills(candidatesData),
                analysisType: candidatesData.length > 1 ? 'batch' : 'single',
                metadata: {
                    userAgent: navigator.userAgent.split(' ')[0], // Simple browser detection
                    ...analysisMetadata
                }
            };
            
            let history = this.getHistory();
            
            // Add new item to beginning of array
            history.unshift(historyItem);
            
            // Limit history size
            if (history.length > this.maxHistoryItems) {
                history = history.slice(0, this.maxHistoryItems);
            }
            
            localStorage.setItem(this.storageKey, JSON.stringify(history));
            console.log('Analysis saved to history:', historyItem.id);
            return historyItem.id;
            
        } catch (error) {
            console.error('Failed to save analysis to history:', error);
            return null;
        }
    }
    
    // Get all history
    getHistory() {
        try {
            const history = localStorage.getItem(this.storageKey);
            return history ? JSON.parse(history) : [];
        } catch (error) {
            console.error('Failed to retrieve history:', error);
            return [];
        }
    }
    
    // Get specific analysis by ID
    getAnalysisById(id) {
        const history = this.getHistory();
        return history.find(item => item.id === id) || null;
    }
    
    // Generate unique ID for analysis
    generateId() {
        return 'analysis_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    // Get history statistics
    getHistoryStats() {
        const history = this.getHistory();
        return {
            totalAnalyses: history.length,
            lastAnalysis: history[0]?.timestamp || null,
            totalCandidates: history.reduce((sum, item) => sum + item.totalCandidates, 0)
        };
    }
}

// Credit Management System
class CreditManager {
    constructor() {
        this.currentUser = null;
        this.userTier = 'FREE';
        this.creditBalance = 0;
        this.freeAnalysesUsed = 0;
        
        // Pricing configuration
        this.pricing = {
            FREE: {
                name: 'Gratis',
                monthlyLimit: 3,
                price: 0
            },
            PROFESIONAL: {
                name: 'Profesional',
                creditsPerPurchase: 30,
                price: 599000,
                priceFormatted: 'Rp 599.000'
            },
            ULTRA: {
                name: 'Ultra',
                creditsPerPurchase: 20,
                price: 999000,
                priceFormatted: 'Rp 999.000'
            }
        };
    }

    async initialize() {
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
            this.currentUser = user;
            await this.loadUserData();
        }
    }

    async loadUserData() {
        try {
            // Try to get existing profile
            let { data, error } = await supabase
                .from('user_profiles')
                .select('*')
                .eq('id', this.currentUser.id)
                .single();

            if (error && error.code === 'PGRST116') {
                // Profile doesn't exist, create it
                await this.createUserProfile();
                // Load again after creating
                ({ data, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('id', this.currentUser.id)
                    .single());
            }

            if (data) {
                this.userTier = data.user_tier || 'FREE';
                this.creditBalance = data.credit_balance || 0;
                this.freeAnalysesUsed = data.free_analyses_used || 0;
                
                // Check if we need to reset free analyses (monthly)
                await this.checkFreeReset(data.free_reset_date);
            }
        } catch (error) {
            console.error('Error loading user data:', error);
        }
    }

    async createUserProfile() {
        try {
            const { error } = await supabase
                .from('user_profiles')
                .insert({
                    id: this.currentUser.id,
                    user_tier: 'FREE',
                    credit_balance: 0,
                    free_analyses_used: 0,
                    free_reset_date: new Date().toISOString().split('T')[0]
                });

            if (error) {
                console.error('Error creating user profile:', error);
            }
        } catch (error) {
            console.error('Error creating user profile:', error);
        }
    }

    async checkFreeReset(lastResetDate) {
        const now = new Date();
        const resetDate = new Date(lastResetDate);
        
        // If it's a new month, reset free analyses
        if (now.getMonth() !== resetDate.getMonth() || now.getFullYear() !== resetDate.getFullYear()) {
            await this.resetFreeAnalyses();
        }
    }

    async resetFreeAnalyses() {
        try {
            const { error } = await supabase
                .from('user_profiles')
                .update({ 
                    free_analyses_used: 0,
                    free_reset_date: new Date().toISOString().split('T')[0]
                })
                .eq('id', this.currentUser.id);

            if (!error) {
                this.freeAnalysesUsed = 0;
            }
        } catch (error) {
            console.error('Error resetting free analyses:', error);
        }
    }

    canAnalyze() {
        if (this.userTier === 'FREE') {
            return this.freeAnalysesUsed < this.pricing.FREE.monthlyLimit;
        } else {
            return this.creditBalance > 0;
        }
    }

    getRemainingAnalyses() {
        if (this.userTier === 'FREE') {
            return Math.max(0, this.pricing.FREE.monthlyLimit - this.freeAnalysesUsed);
        } else {
            return this.creditBalance;
        }
    }

    getStatus() {
        return {
            tier: this.userTier,
            remaining: this.getRemainingAnalyses(),
            canAnalyze: this.canAnalyze(),
            isFreeTier: this.userTier === 'FREE',
            isUltraTier: this.userTier === 'ULTRA',
            creditsBalance: this.creditBalance,
            freeUsed: this.freeAnalysesUsed
        };
    }

    async useAnalysis() {
        if (!this.canAnalyze()) {
            throw new Error('No analyses remaining');
        }

        try {
            if (this.userTier === 'FREE') {
                this.freeAnalysesUsed++;
                await supabase
                    .from('user_profiles')
                    .update({ 
                        free_analyses_used: this.freeAnalysesUsed,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', this.currentUser.id);
            } else {
                this.creditBalance--;
                await supabase
                    .from('user_profiles')
                    .update({ 
                        credit_balance: this.creditBalance,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', this.currentUser.id);
            }
            console.log('Analysis used. Remaining:', this.getRemainingAnalyses());
        } catch (error) {
            console.error('Error using analysis:', error);
            throw error;
        }
    }

    async addCredits(amount) {
        try {
            this.creditBalance += amount;
        
            // Update database
            await supabase
                .from('user_profiles')
                .update({ 
                    credit_balance: this.creditBalance,
                    user_tier: 'PROFESIONAL',  // Automatically upgrade to professional
                    updated_at: new Date().toISOString()
                })
                .eq('id', this.currentUser.id);

            // Log purchase in credit_purchases table
            await supabase
                .from('credit_purchases')
                .insert({
                    user_id: this.currentUser.id,
                    credits_purchased: amount,
                    amount_paid: this.pricing.PROFESIONAL.price
                });

            this.userTier = 'PROFESIONAL';
            console.log(`Added ${amount} credits. New balance: ${this.creditBalance}`);
            return true;
        } catch (error) {
            console.error('Error adding credits:', error);
            return false;
        }
    }
    
    calculateCreditConversion() {
        if (this.userTier !== 'PROFESIONAL') return null;
    
        const proValuePerCredit = 19967; // 599k/30
        const ultraValuePerCredit = 49950; // 999k/20
    
        const totalProValue = this.creditBalance * proValuePerCredit;
        const fullUltraCredits = Math.floor(totalProValue / ultraValuePerCredit);
        const remainder = totalProValue % ultraValuePerCredit;
    
        // If remainder > 40% of ultra credit value, give bonus credit
        const bonusCredit = remainder > (ultraValuePerCredit * 0.4) ? 1 : 0;
        const totalUltraCredits = fullUltraCredits + bonusCredit;
    
        return {
            currentProCredits: this.creditBalance,
            currentProValue: totalProValue,
            newUltraCredits: totalUltraCredits,
            fullCredits: fullUltraCredits,
            bonusCredits: bonusCredit,
            remainder: remainder,
            savings: bonusCredit > 0 ? (ultraValuePerCredit - remainder) : 0
        };
    }

    async convertToUltra() {
        const conversion = this.calculateCreditConversion();
        if (!conversion) return false;
    
        try {
            // Update to ULTRA tier with converted credits
            await supabase
                .from('user_profiles')
                .update({ 
                    user_tier: 'ULTRA',
                    credit_balance: conversion.newUltraCredits,
                    updated_at: new Date().toISOString()
                })
                .eq('id', this.currentUser.id);

            this.userTier = 'ULTRA';
            this.creditBalance = conversion.newUltraCredits;
        
            return conversion;
        } catch (error) {
            console.error('Error converting to ULTRA:', error);
            return false;
        }
    }
}

// Midtrans Payment Handler
// Temporary Test Version - Replace your PaymentHandler class
// REPLACE your existing PaymentHandler class with this:
class PaymentHandler {
    constructor() {
        this.isProduction = true; // Sandbox mode
        this.serverUrl = 'https://montpro.app.n8n.cloud/webhook/create-payment'; // Your n8n webhook URL
    }

    async createPayment(amount, credits, userEmail) {
        try {
            console.log('Creating payment request...');
            
            // Create payment request to your n8n backend
            const response = await fetch(this.serverUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    amount: amount,
                    credits: credits,
                    user_email: userEmail,
                    user_id: creditManager.currentUser.id
                })
            });

            console.log('Backend response status:', response.status);
            const data = await response.json();
            console.log('Backend response data:', data);
            
            if (data.success && data.token) {
                // Open Midtrans popup
                this.openPaymentPopup(data.token, credits);
            } else {
                throw new Error('Failed to create payment token: ' + JSON.stringify(data));
            }
        } catch (error) {
            console.error('Payment creation failed:', error);
            showError('Tidak dapat membuat pembayaran: ' + error.message);
        }
    }

    openPaymentPopup(snapToken, credits) {
        console.log('Opening Midtrans popup with token:', snapToken);
        
        window.snap.pay(snapToken, {
            onSuccess: async (result) => {
                console.log('Payment success:', result);
                showSuccess('Pembayaran berhasil!');
                await this.handlePaymentSuccess(credits);
            },
            onPending: (result) => {
                console.log('Payment pending:', result);
                showWarning('Pembayaran sedang diproses. Credits akan ditambahkan setelah konfirmasi.');
            },
            onError: (result) => {
                console.log('Payment error:', result);
                showError('Pembayaran gagal. Silakan coba lagi.');
            },
            onClose: () => {
                console.log('Payment popup closed by user');
                showWarning('Pembayaran dibatalkan.');
            }
        });
    }

    async handlePaymentSuccess(credits) {
        try {
            const success = await creditManager.addCredits(credits);
            
            if (success) {
                showSuccess(`${credits} credits telah ditambahkan ke akun Anda!`);
                updateUsageDisplay();
                
                setTimeout(() => {
                    hidePricingPage();
                }, 2000);
            } else {
                showError('Gagal menambahkan credits. Hubungi support.');
            }
        } catch (error) {
            console.error('Error handling payment success:', error);
            showError('Terjadi kesalahan. Hubungi support.');
        }
    }
}
        
// Candidate Filter System
class CandidateFilter {
    constructor() {
        this.originalCandidates = [];
        this.filteredCandidates = [];
        this.activeFilters = {
            searchQuery: '',
            minScore: 0
        };
    }
    
    setCandidates(candidates) {
        this.originalCandidates = [...candidates];
        this.filteredCandidates = [...candidates];
        return this;
    }
    
    applySearchFilter(query) {
        this.activeFilters.searchQuery = query.toLowerCase();
        this.updateFilteredResults();
        return this;
    }
    
    applyScoreFilter(minScore) {
        this.activeFilters.minScore = parseInt(minScore);
        this.updateFilteredResults();
        return this;
    }
    
    updateFilteredResults() {
        this.filteredCandidates = this.originalCandidates.filter(candidate => {
            // Search filter
            if (this.activeFilters.searchQuery) {
                const searchFields = [
                    candidate.candidateName || '',
                    candidate.executiveSummary || '',
                    (candidate.coreCompetencies || '').toString(),
                    extractTitleFromSummary(candidate) || ''
                ].join(' ').toLowerCase();
                
                if (!searchFields.includes(this.activeFilters.searchQuery)) {
                    return false;
                }
            }
            
            // Score filter
            const candidateScore = parseInt(candidate.candidateScore) || 0;
            if (candidateScore < this.activeFilters.minScore) {
                return false;
            }
            
            return true;
        });
        
        return this;
    }
    
    getFilteredCandidates() {
        return this.filteredCandidates;
    }
    
    getFilterStats() {
        return {
            total: this.originalCandidates.length,
            filtered: this.filteredCandidates.length,
            hidden: this.originalCandidates.length - this.filteredCandidates.length
        };
    }
}

// Initialize history manager
const historyManager = new AnalysisHistory();
    // More methods will be added in next steps...

// Initialize feedback manager
const feedback = new MontProFeedback();
const supabaseUrl = 'https://saiwhkhgnsgakvbohwym.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNhaXdoa2hnbnNnYWt2Ym9od3ltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MzIxMjIsImV4cCI6MjA2MzMwODEyMn0.4MUgz7sYll0MYV30mwbAAYkLDs2MtPpSykgvWE10KuU';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// Global variables
let files = [];
let fileInput;
let dragArea;
let fileListContainer;
let fileList;
let fileCount;
let startButton;
let errorMessage;
let errorText;
let statusMessage;
let statusText;
let statusIcon;
let clearAllBtn;
let allowedTypes;
let typeNames;
let typeIcons;
let candidateFilter = new CandidateFilter();
let paymentHandler = new PaymentHandler();

function updateUsageDisplay() {
    const status = creditManager.getStatus();
    const usageElement = document.getElementById('usage-text');
    const upgradeBtn = document.getElementById('upgrade-btn');
    
    if (!usageElement) {
        console.log('Usage display element not found yet');
        return;
    }
    
    if (status.isFreeTier) {
        usageElement.textContent = `${status.remaining}/3 gratis tersisa`;
        if (status.remaining === 0) {
            usageElement.className = 'text-red-600 font-medium';
        } else if (status.remaining === 1) {
            usageElement.className = 'text-orange-600 font-medium';
        } else {
            usageElement.className = 'text-gray-700';
        }
        // Show upgrade button for free users
        if (upgradeBtn) {
            upgradeBtn.classList.remove('hidden');
            upgradeBtn.innerHTML = '<i class="fas fa-arrow-up mr-1"></i>Upgrade';
        }
        
    } else {
        usageElement.textContent = `${status.remaining} credits`;
        if (status.remaining < 5) {
            usageElement.className = 'text-orange-600 font-medium';
            // Show top-up button when credits are low
            if (upgradeBtn) {
                upgradeBtn.classList.remove('hidden');
                upgradeBtn.innerHTML = '<i class="fas fa-plus mr-1"></i>Top Up';
            }
        } else {
            usageElement.className = 'text-green-600 font-medium';
            // Hide button when credits are sufficient
            if (upgradeBtn) {
                upgradeBtn.classList.add('hidden');
            }
        }
    }
}

function updateJobDescriptionAccess() {
    const status = creditManager.getStatus();
    const jobDescriptionTextarea = document.getElementById('job-description');
    const jdInfoText = document.getElementById('jd-info-text');
    const jdFeatureBadge = document.getElementById('jd-feature-badge');
    
    if (status.isUltraTier) {
        // Enable for ULTRA users
        jobDescriptionTextarea.disabled = false;
        jobDescriptionTextarea.classList.remove('bg-gray-100');
        jdInfoText.textContent = 'AI will match candidates against this job description';
        jdFeatureBadge.innerHTML = '<i class="fas fa-crown mr-1"></i>ULTRA Active';
    } else if (!status.isFreeTier) {
        // PRO users see upgrade prompt
        jobDescriptionTextarea.disabled = true;
        jobDescriptionTextarea.classList.add('bg-gray-100');
        jdInfoText.innerHTML = 'Upgrade to ULTRA for job description matching â€¢ <a href="#" onclick="showPricingPage()" class="text-purple-600 hover:text-purple-800">Upgrade Now</a>';
    } else {
        // Free users see basic message
        jobDescriptionTextarea.disabled = true;
        jobDescriptionTextarea.classList.add('bg-gray-100');
        jdInfoText.textContent = 'Upgrade to ULTRA to unlock job description matching';
    }
}
        
// Pricing Page Navigation Functions
function showPricingPage() {
    console.log('Showing pricing page...');
    hideAllPages(); // Use the new unified function
    
    const pricingPage = document.getElementById('pricing-page');
    if (pricingPage) {
        pricingPage.style.display = 'block';
        pricingPage.style.position = 'relative'; // Ensure proper positioning
        pricingPage.style.zIndex = '1';
        console.log('Pricing page shown');
    }
    
    // Update button text based on current tier
    updatePricingPageForUser();
    updateUltraButtonForProUser();
}

function hidePricingPage() {
    document.getElementById('pricing-page').style.display = 'none';
    document.getElementById('main-app').style.display = 'block';
    
    // Always show analysis results if they exist
    const analysisResults = document.getElementById('analysis-results');
    if (analysisResults && !analysisResults.classList.contains('hidden')) {
        // Keep showing results
    } else {
        // Show upload interface if no results
        document.getElementById('upload-interface').classList.remove('hidden');
    }
}

// Support Pages Navigation Functions
// Support Pages Navigation Functions (with debug)
function showSupportPage() {
    console.log('Showing support page...');
    hideAllPages();
    const supportPage = document.getElementById('support-page');
    if (supportPage) {
        supportPage.style.display = 'block';
        console.log('Support page shown');
    } else {
        console.error('Support page element not found!');
    }
}

function showFAQPage() {
    console.log('Showing FAQ page...');
    hideAllPages();
    
    const faqPage = document.getElementById('faq-page');
    if (faqPage) {
        faqPage.style.display = 'block';
        
        // Enhanced debugging
        console.log('FAQ page element:', faqPage);
        console.log('FAQ page display:', faqPage.style.display);
        console.log('FAQ page computed style:', window.getComputedStyle(faqPage).display);
        console.log('FAQ page visibility:', window.getComputedStyle(faqPage).visibility);
        console.log('FAQ page height:', faqPage.offsetHeight);
        console.log('FAQ page width:', faqPage.offsetWidth);
        
        // Force positioning
        faqPage.style.position = 'relative';
        faqPage.style.zIndex = '999';
        faqPage.style.backgroundColor = 'white';
        faqPage.style.minHeight = '100vh';
        
        console.log('FAQ page shown with forced styles');
    } else {
        console.error('FAQ page element not found!');
    }
}

function showTermsPage() {
    console.log('Showing terms page...');
    hideAllPages();
    const termsPage = document.getElementById('terms-page');
    if (termsPage) {
        termsPage.style.display = 'block';
        console.log('Terms page shown');
    } else {
        console.error('Terms page element not found!');
    }
}

function showPrivacyPage() {
    console.log('Showing privacy page...');
    hideAllPages();
    const privacyPage = document.getElementById('privacy-page');
    if (privacyPage) {
        privacyPage.style.display = 'block';
        console.log('Privacy page shown');
    } else {
        console.error('Privacy page element not found!');
    }
}

function hideAllPages() {
    // Hide main app components
    const mainApp = document.getElementById('main-app');
    const analysisResults = document.getElementById('analysis-results');
    const pricingPage = document.getElementById('pricing-page');
    
    if (mainApp) mainApp.style.display = 'none';
    if (analysisResults) analysisResults.classList.add('hidden');
    if (pricingPage) pricingPage.style.display = 'none';
    
    // Hide support pages
    const supportPage = document.getElementById('support-page');
    const faqPage = document.getElementById('faq-page');
    const termsPage = document.getElementById('terms-page');
    const privacyPage = document.getElementById('privacy-page');
    
    if (supportPage) supportPage.style.display = 'none';
    if (faqPage) faqPage.style.display = 'none';
    if (termsPage) termsPage.style.display = 'none';
    if (privacyPage) privacyPage.style.display = 'none';
}

function hideAllSupportPages() {
    console.log('Hiding all support pages...');
    hideAllPages();
    
    // Show main app
    const mainApp = document.getElementById('main-app');
    if (mainApp) {
        mainApp.style.display = 'block';
        console.log('Main app restored');
    }
    
    // Show appropriate content
    const analysisResults = document.getElementById('analysis-results');
    const uploadInterface = document.getElementById('upload-interface');
    
    if (analysisResults && !analysisResults.classList.contains('hidden')) {
        // Keep showing results if they exist
        console.log('Showing analysis results');
    } else if (uploadInterface) {
        // Show upload interface if no results
        uploadInterface.classList.remove('hidden');
        console.log('Showing upload interface');
    }
}

function updatePricingPageForUser() {
    const status = creditManager.getStatus();
    const currentPlanBtn = document.getElementById('current-plan-btn');
    const upgradeBtn = document.getElementById('upgrade-profesional-btn');
    
    if (status.isFreeTier) {
        currentPlanBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Paket Aktif';
        upgradeBtn.innerHTML = '<i class="fas fa-rocket mr-2"></i>Beli 30 Credits - Rp 599.000';
    } else {
        currentPlanBtn.innerHTML = '<i class="fas fa-arrow-up mr-2"></i>Upgrade ke Profesional';
        upgradeBtn.innerHTML = `<i class="fas fa-plus mr-2"></i>Beli 30 Credits Tambahan`;
    }
}

function updateUltraButtonForProUser() {
    const status = creditManager.getStatus();
    const ultraBtn = document.getElementById('upgrade-ultra-btn');
    const ultraBtnText = document.getElementById('ultra-btn-text');
    
    if (status.tier === 'PROFESIONAL' && status.remaining > 0) {
        const conversion = creditManager.calculateCreditConversion();
        if (conversion) {
            ultraBtnText.innerHTML = `Convert ${conversion.currentProCredits} Credits â†’ ${conversion.newUltraCredits} ULTRA Credits`;
            
            // Remove existing help text if any
            const existingHelp = ultraBtn.parentNode.querySelector('.conversion-help');
            if (existingHelp) existingHelp.remove();
            
            // Add helpful text below button
            const helpText = document.createElement('p');
            helpText.className = 'conversion-help text-xs text-green-600 text-center mt-2';
            helpText.innerHTML = `Your ${conversion.currentProCredits} PRO credits = ${conversion.newUltraCredits} ULTRA credits${conversion.bonusCredits > 0 ? ' (+' + conversion.bonusCredits + ' bonus!)' : ''}`;
            ultraBtn.parentNode.appendChild(helpText);
        }
    }
}

async function convertCreditsToUltra() {
    const conversion = creditManager.calculateCreditConversion();
    if (!conversion) {
        showError('No conversion available');
        return;
    }
    
    // Show confirmation
    const confirmMsg = `Convert ${conversion.currentProCredits} PRO credits to ${conversion.newUltraCredits} ULTRA credits${conversion.bonusCredits > 0 ? ' (including ' + conversion.bonusCredits + ' bonus credit)' : ''}?`;
    
    if (!confirm(confirmMsg)) return;
    
    const result = await creditManager.convertToUltra();
    if (result) {
        showSuccess(`Converted to ULTRA! You now have ${result.newUltraCredits} ULTRA credits${result.bonusCredits > 0 ? ' (including ' + result.bonusCredits + ' bonus credit!)' : ''}`);
        updateUsageDisplay();
        updateJobDescriptionAccess();
        hidePricingPage();
    } else {
        showError('Conversion failed. Please try again.');
    }
}
        
async function showMainApp() {
    document.getElementById('auth-box').style.display = 'none';
    document.getElementById('main-app').style.display = '';
    
    // Hide the animated background when logged in
    const animatedBg = document.querySelector('.animated-background');
    if (animatedBg) {
        animatedBg.style.display = 'none';
    }
    
    // Initialize credit management
    await creditManager.initialize();
    updateUsageDisplay();
    updateJobDescriptionAccess();
}
        
function showAuthBox() {
    document.getElementById('auth-box').style.display = '';
    document.getElementById('main-app').style.display = 'none';
    // Show the animated background when back to login
    const animatedBg = document.querySelector('.animated-background');
    if (animatedBg) {
        animatedBg.style.display = '';
    }
}
function showError(message, persistent = false) {
    const duration = persistent ? 0 : 7000;
    feedback.showNotification(message, 'error', duration);
    
    // Also update the inline error display
    errorText.textContent = message;
    errorMessage.classList.remove('hidden');
}

function hideError() {
    errorMessage.classList.add('hidden');
}    
        
function showSuccess(message) {
    feedback.showNotification(message, 'success', 4000);
}

function showWarning(message) {
    feedback.showNotification(message, 'warning', 6000);
}

function hideStatus() {
    statusMessage.classList.add('hidden');
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    else return (bytes / 1048576).toFixed(1) + ' MB';
}

function handleFileSelect(e) {
    handleFiles(e.target.files);
}

function handleFiles(selectedFiles) {
    const fileArray = Array.from(selectedFiles);
    const validFiles = [];
    const errors = [];
    
    // Validate each file
    fileArray.forEach(file => {
        const validation = feedback.validateFile(file);
        
        if (validation.valid) {
            validFiles.push(file);
        } else {
            errors.push(...validation.errors);
        }
    });
    
    // Show validation results
    if (errors.length > 0) {
        // Show first error as main error
        showError(errors[0]);
        
        // If there are multiple errors, show them in a detailed notification
        if (errors.length > 1) {
            const errorList = errors.slice(1, 4).map(err => `â€¢ ${err}`).join('\n');
            feedback.showNotification(
                `Multiple file validation errors:\n${errorList}${errors.length > 4 ? '\nâ€¢ ...' : ''}`,
                'error',
                10000
            );
        }
        
        // Shake the drag area
        dragArea.classList.add('field-error-shake');
        setTimeout(() => dragArea.classList.remove('field-error-shake'), 500);
    }
    
    if (validFiles.length > 0) {
        hideError();
        showSuccess(`${validFiles.length} file${validFiles.length > 1 ? 's' : ''} validated successfully`);
        
        // Clear any field errors
        feedback.clearFieldError(dragArea);
    }
    
    // Add valid files to the list
    files = [...files, ...validFiles];
    updateFileList();
}

function updateFileList() {
    if (files.length > 0) {
        fileListContainer.classList.remove('hidden');
        fileCount.textContent = files.length;
        startButton.disabled = false;
        fileList.innerHTML = '';
        
        files.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            
            const fileInfo = document.createElement('div');
            fileInfo.className = 'flex items-center';
            
            const fileTypeIcon = typeIcons[file.type] || 'fa-file';
            const icon = document.createElement('i');
            icon.className = `fas ${fileTypeIcon} text-blue-500 mr-3`;
            fileInfo.appendChild(icon);
            
            const details = document.createElement('div');
            details.innerHTML = `
                <p class="font-medium text-sm truncate max-w-xs">${file.name}</p>
                <p class="text-xs text-gray-500">
                    ${typeNames[file.type] || 'File'} Â· ${formatFileSize(file.size)}
                </p>
            `;
            fileInfo.appendChild(details);
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'text-gray-500 hover:text-red-500 transition-colors';
            removeBtn.innerHTML = '<i class="fas fa-times-circle"></i>';
            removeBtn.addEventListener('click', function() {
                removeFile(index);
            });
            
            fileItem.appendChild(fileInfo);
            fileItem.appendChild(removeBtn);
            fileList.appendChild(fileItem);
        });
    } else {
        fileListContainer.classList.add('hidden');
        startButton.disabled = true;
    }
}

function removeFile(index) {
    files = files.filter((_, i) => i !== index);
    updateFileList();
}

// Analysis functions
async function startAnalysis() {
    if (files.length === 0) {
        showError('Please upload at least one file before starting analysis.');
        return;
    }

    // ADD THIS CREDIT CHECK
    if (!creditManager.canAnalyze()) {
        const status = creditManager.getStatus();
        if (status.isFreeTier) {
            showError('Anda telah menggunakan 3 analisis gratis bulan ini. Upgrade untuk analisis lebih banyak!');
            // Auto-show pricing page after 2 seconds
            setTimeout(() => {
                showPricingPage();
            }, 2000);
        } else {
            showError('Credits habis! Silakan beli credits tambahan.');
            // Auto-show pricing page after 2 seconds
            setTimeout(() => {
                showPricingPage();
            }, 2000);
        }
        return;
    }
    // ADD THIS NEW CHECK: Make sure user has enough credits for all files
    const remainingAnalyses = creditManager.getRemainingAnalyses();
    const filesCount = files.length;

    if (remainingAnalyses < filesCount) {
        const status = creditManager.getStatus();
        if (status.isFreeTier) {
            showError(`Anda memiliki ${remainingAnalyses} analisis gratis tersisa, tapi ingin menganalisis ${filesCount} resume. Silakan kurangi jumlah file atau upgrade ke Profesional.`);
            setTimeout(() => {
                showPricingPage();
            }, 3000);
        } else {
            showError(`Anda memiliki ${remainingAnalyses} credits tersisa, tapi ingin menganalisis ${filesCount} resume. Silakan beli credits tambahan atau kurangi jumlah file.`);
            setTimeout(() => {
                showPricingPage();
            }, 3000);
        }
        return;
    }

    console.log('=== STARTING ANALYSIS ===');
    console.log('Number of files:', files.length);

    startButton.disabled = true;
    hideError();
    showAnalysisLoading();

    try {
        const formData = new FormData();
        files.forEach(file => {
            formData.append('files', file);
        });

        console.log('Sending request to backend...');

        // Use enhanced request method with retry logic
        const response = await feedback.makeRequest(
            'https://montpro.app.n8n.cloud/webhook/recruitment-analysis',
            {
                method: 'POST',
                body: formData,
                timeout: 60000, // 60 seconds for file upload
                retries: 2,
                retryDelay: 3000,
                onRetry: (attempt, maxAttempts, error) => {
                    console.log(`Retry attempt ${attempt}/${maxAttempts}:`, error.message);
                    // Update loading message during retry
                    document.getElementById('loading-step').textContent = `Retrying... (${attempt}/${maxAttempts})`;
                }
            }
        );

        console.log('Response received, status:', response.status);

        let data;
        const contentType = response.headers.get("content-type");
        const raw = await response.text();

        console.log('Raw response text:', raw);

        if (!raw || raw.trim().length === 0) {
            throw new Error("Empty response from server");
        }

        if (contentType && contentType.includes("application/json")) {
            data = JSON.parse(raw);
            console.log('=== PARSED DATA DEBUG ===');
            console.log('Parsed data:', data);
            console.log('========================');
        } else {
            throw new Error("Invalid content-type or response format");
        }

        sessionStorage.setItem('analysisResults', JSON.stringify(data));
        showSuccess('Analysis completed successfully!');
        showAnalysisResults(data);

    } catch (err) {
        console.error("Analysis failed:", err);
        
        // Enhanced error handling
        if (err.message.includes('timeout')) {
            showError('Analysis timed out. Your files may be too large or complex. Please try with smaller files or check your connection.', true);
        } else if (err.message.includes('Network')) {
            showError('Network error occurred. Please check your internet connection and try again.', true);
        } else if (err.message.includes('Server')) {
            showError('Server is temporarily unavailable. Please try again in a few minutes.', true);
        } else {
            showError(`Analysis failed: ${err.message}. Please try again.`, true);
        }
        
        showRetryButton();
        hideAnalysisLoading();
    }
}

function showRetryButton() {
    const retryBtn = document.getElementById('retry-btn');
    if (retryBtn) {
        retryBtn.classList.remove('hidden');
        retryBtn.onclick = () => {
            retryBtn.classList.add('hidden');
            startAnalysis();
        };
    }
}

function showAnalysisLoading() {
    document.getElementById('upload-interface').classList.add('hidden');
    document.getElementById('analysis-loading').classList.remove('hidden');
    
    // Create enhanced progress tracker
    const steps = [
        'Uploading files...',
        'Extracting text content...',
        'Analyzing qualifications...',
        'Processing skills and experience...',
        'Evaluating candidate fit...',
        'Generating final results...'
    ];
    
    const progressTracker = feedback.createProgressTracker('analysis-loading', {
        title: 'AI Analysis in Progress',
        steps: steps,
        showPercentage: true,
        showTimeEstimate: true
    });
    
    // Enhanced progress simulation
    const baseTime = 2000; // 2 seconds per step base
    const timePerFile = 1500; // 1.5 seconds per additional file
    const totalTime = baseTime * steps.length + (files.length - 1) * timePerFile;
    
    let currentStep = 0;
    let progress = 0;
    
    const updateProgress = () => {
        if (progress < 100) {
            // More realistic progress increments
            const increment = Math.floor(Math.random() * 4) + 1; // 1-4% increments
            progress = Math.min(progress + increment, 100);
            
            // Update step based on progress
            const newStep = Math.floor((progress / 100) * steps.length);
            if (newStep !== currentStep && newStep < steps.length) {
                currentStep = newStep;
            }
            
            // Update progress display
            progressTracker.update(currentStep, steps[currentStep], progress);
            
            // Also update the existing progress elements for compatibility
            const progressBar = document.getElementById('progress-bar-fill');
            const percentText = document.getElementById('loading-percent');
            const stepText = document.getElementById('loading-step');
            
            if (progressBar) progressBar.style.width = `${progress}%`;
            if (percentText) percentText.textContent = `${progress}%`;
            if (stepText) stepText.textContent = steps[currentStep] || 'Processing...';
            
            // Dynamic timing - slower at start, faster near end
            const baseInterval = (totalTime / 100) * (1.8 - progress/100);
            const randomVariation = baseInterval * (0.8 + Math.random() * 0.4);
            
            setTimeout(updateProgress, randomVariation);
        }
    };
    
    // Start the enhanced progress
    updateProgress();
    
    // Store tracker for cleanup
    window.currentProgressTracker = progressTracker;
}

function hideAnalysisLoading() {
    document.getElementById('analysis-loading').classList.add('hidden');
    
    // Complete the progress tracker
    if (window.currentProgressTracker) {
        window.currentProgressTracker.complete('Analysis complete!');
        setTimeout(() => {
            window.currentProgressTracker = null;
        }, 1000);
    }
    
    // Clear any running progress interval
    if (window.progressInterval) {
        clearInterval(window.progressInterval);
    }
}

function showAnalysisResults(data) {
    // ðŸ” TEMPORARY DEBUG - Remove after we understand the data structure
    console.log('=== FULL BACKEND DATA DEBUG ===');
    console.log('Complete data structure:', data);
    
    if (Array.isArray(data) && data.length > 0) {
        console.log('First candidate full data:', data[0]);
        console.log('Available keys in first candidate:', Object.keys(data[0]));
        
        // Log each property to see what's available
        Object.keys(data[0]).forEach(key => {
            console.log(`${key}:`, data[0][key]);
        });
    }
    console.log('=== END DEBUG ===');
    
    // Use the new multiple candidates handler
    showMultipleCandidatesResults(data);

    // Show the action buttons
    document.getElementById('analysis-actions').classList.remove('hidden');

    // Show the results footer
    document.getElementById('results-footer').classList.remove('hidden');

    // Set up PDF download after showing results
    setupDownloadPDF();

    // Set up export options
    setupExportOptions();

    // âœ¨ NEW: Auto-save to history
    saveCurrentAnalysisToHistory();

     // âœ¨ NEW: Add this at the very end of the function
    useAnalysisCredit();
}

// ADD this new function right after showAnalysisResults
async function useAnalysisCredit() {
    try {
        const numberOfResumes = files.length; // Count how many files were analyzed
        console.log(`Using ${numberOfResumes} credits for ${numberOfResumes} resumes`);
        
        // Use credit for each resume
        for (let i = 0; i < numberOfResumes; i++) {
            await creditManager.useAnalysis();
        }
        
        updateUsageDisplay();
        showSuccess(`Berhasil menganalisis ${numberOfResumes} resume. Credits digunakan: ${numberOfResumes}`);
    } catch (error) {
        console.error('Error using credits:', error);
        showError('Terjadi kesalahan saat menggunakan credits.');
    }
}
function setupDownloadPDF() {
    const downloadBtn = document.querySelector('#download-pdf-btn');
    if (downloadBtn) {
        downloadBtn.addEventListener('click', function() {
            const originalBtnHtml = downloadBtn.innerHTML;
            
            try {
                // Show loading state
                downloadBtn.innerHTML = '<div class="spinner mr-2"></div> Generating PDF...';
                downloadBtn.disabled = true;
                
                // Get analysis data from the current view
                const candidateData = getCurrentCandidateData();
                
                // Generate PDF
                generatePDF(candidateData);
                
                // Show success state
                downloadBtn.innerHTML = '<i class="fas fa-check mr-2"></i> Downloaded!';
                setTimeout(() => {
                    downloadBtn.innerHTML = originalBtnHtml;
                    downloadBtn.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('PDF generation failed:', error);
                
                // Show error state
                downloadBtn.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i> Failed';
                downloadBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                downloadBtn.classList.add('bg-red-600');
                
                setTimeout(() => {
                    downloadBtn.innerHTML = originalBtnHtml;
                    downloadBtn.disabled = false;
                    downloadBtn.classList.remove('bg-red-600');
                    downloadBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }, 3000);
            }
        });
    }
}

function getCurrentCandidateData() {
    // For multiple candidates view
    if (!document.getElementById('multiple-candidates-view').classList.contains('hidden')) {
        const candidate = candidatesData[selectedCandidateIndex];
        return {
            name: candidate.candidateName || `Candidate ${selectedCandidateIndex + 1}`,
            score: candidate.candidateScore || '75',
            title: extractTitleFromSummary(candidate) || 'Professional',
            executiveSummary: candidate.executiveSummary || 'No executive summary available.',
            coreCompetencies: candidate.coreCompetencies || 'No competencies data available.',
            isMultiple: true,
            candidateNumber: selectedCandidateIndex + 1,
            totalCandidates: candidatesData.length
        };
    } 
    // For single candidate view
    else {
        const currentData = candidatesData && candidatesData.length > 0 ? candidatesData[0] : null;
        return {
            name: document.getElementById('candidate-name')?.textContent || 'Candidate Name',
            score: document.getElementById('candidate-score')?.textContent || '75',
            title: currentData ? extractTitleFromSummary(currentData) : 'Professional',
            executiveSummary: document.getElementById('executive-summary')?.textContent || 'No executive summary available.',
            coreCompetencies: currentData ? currentData.coreCompetencies : 'No competencies data available.',
            isMultiple: false
        };
    }
}

function extractTitleFromSummary(candidate) {
    // First try direct title fields
    let title = candidate.candidateTitle || candidate.position || candidate.jobTitle;
    
    if (!title && candidate.executiveSummary) {
        const summaryText = candidate.executiveSummary;
        
        // Enhanced title extraction patterns
        const titlePatterns = [
            /is (?:an?|the) ([^.]+?) with/i,
            /(?:seasoned|experienced|accomplished) ([^.]+?) with/i,
            /(?:as|is) (?:an?|the) ([^.]+?)\./i,
            /expertise in ([^.]+?)\./i,
            /leader in ([^.]+?)\./i,
            /specialist in ([^.]+?)\./i,
            /background in ([^.]+?)\./i
        ];
        
        for (let pattern of titlePatterns) {
            const match = summaryText.match(pattern);
            if (match && match[1]) {
                title = match[1].trim();
                // Clean up and format
                title = title.replace(/\b(leader|professional|expert|individual|and)\b/gi, '')
                            .replace(/\s+/g, ' ')
                            .trim();
                if (title.length > 0 && title.length < 60) {
                    // Capitalize properly
                    title = title.split(' ')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                        .join(' ');
                    break;
                }
            }
        }
    }
    
    return title || 'Professional';
}

function generatePDF(data) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Set up colors
    const primaryColor = [59, 130, 246]; // Blue
    const grayColor = [107, 114, 128];
    const darkColor = [31, 41, 55];
    
    let yPosition = 20;
    
    // Header Card with better spacing
    doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
    doc.roundedRect(15, yPosition, 180, 40, 5, 5, 'F');
    
    // MontPro Logo/Title
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(20);
    doc.setFont(undefined, 'bold');
    doc.text('MontPro', 20, yPosition + 18);
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    doc.text('Recruitment Analysis Report', 20, yPosition + 28);
    
    // Date with better spacing
    doc.setFontSize(10);
    doc.text(`Generated on ${new Date().toLocaleDateString()}`, 20, yPosition + 38);
    
    // Score section - properly centered
    doc.setFontSize(24);
    doc.setFont(undefined, 'bold');
    const scoreText = `${data.score}`;
    const scoreWidth = doc.getTextWidth(scoreText);
    const scoreX = 170; // Base position
    
    // Center the score number
    doc.text(scoreText, scoreX, yPosition + 30);
    
    // Center the "Score" label above the number
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    const labelWidth = doc.getTextWidth('Score');
    const labelX = scoreX + (scoreWidth - labelWidth) / 2; // Center relative to score number
    doc.text('Score', labelX, yPosition + 20);
    
    yPosition += 55; // More space after header
    
    // Candidate Information
    doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text(data.name, 20, yPosition);
    
    yPosition += 10;
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(grayColor[0], grayColor[1], grayColor[2]);
    doc.text(data.title, 20, yPosition); // Now using dynamic title
    
    if (data.isMultiple) {
        doc.text(`Candidate ${data.candidateNumber} of ${data.totalCandidates}`, 140, yPosition);
    }
    
    yPosition += 15; // 15 spacing before Executive Summary
    
    // Executive Summary Section
    doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('Executive Summary', 20, yPosition);
    
    yPosition += 10;
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
    
    // Split long text into multiple lines with proper margins
    const summaryLines = doc.splitTextToSize(data.executiveSummary, 170); // Keep 20px margins (210-20-20=170)
    doc.text(summaryLines, 20, yPosition);
    yPosition += summaryLines.length * 5 + 6; // Reduced spacing before Core Competencies (from 10 to 6)
    
    // Core Competencies Section - Enhanced with bullet formatting
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('Core Competencies', 20, yPosition);
    
    yPosition += 10;
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    
    // Handle competencies with better formatting and optimized page usage
    if (data.coreCompetencies && typeof data.coreCompetencies === 'string') {
        // Split by bullet points or line breaks
        const competencies = data.coreCompetencies
            .split(/[â€¢\n]/)
            .map(item => item.replace(/^[-â€¢]\s*/, '').trim())
            .filter(item => item.length > 0);
        
        competencies.forEach((competency, index) => {
            if (competency.length > 0) {
                // Calculate space needed for this competency
                const competencyLines = doc.splitTextToSize(competency, 165); // Keep 20px left + 5px for bullet + 20px right margins
                const competencyHeight = competencyLines.length * 5 + 2;
                
                // More aggressive page usage - only break if really necessary
                // Leave space for footer (15) + some buffer (5) = 20
                if (yPosition + competencyHeight > 280) {
                    // Not enough space, start a new page
                    doc.addPage();
                    yPosition = 20;
                }
                
                // Add bullet point
                doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                doc.circle(22, yPosition - 1, 1, 'F');
                
                // Add competency text with proper wrapping
                doc.text(competencyLines, 27, yPosition);
                yPosition += competencyHeight; // Tighter spacing between bullet points
            }
        });
    } else {
        const competenciesText = 'Core competencies data available in detailed view.';
        const competenciesLines = doc.splitTextToSize(competenciesText, 170);
        doc.text(competenciesLines, 20, yPosition);
        yPosition += competenciesLines.length * 5;
    }
    
    // Ensure footer has enough space but use more of the page
    if (yPosition > 275) {
        doc.addPage();
        yPosition = 275; // Position footer near bottom of new page
    } else {
        yPosition = Math.max(yPosition + 10, 275); // Minimal gap before footer
    }
    
    // Footer
    doc.setFontSize(8);
    doc.setTextColor(grayColor[0], grayColor[1], grayColor[2]);
    doc.text('This analysis is provided for recruitment guidance only.', 20, yPosition);
    doc.text('Â© 2025 MontPro. All rights reserved.', 20, yPosition + 5);
    
    // Save the PDF
    const fileName = `${data.name.replace(/\s+/g, '_')}_Analysis_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(fileName);
}

// Export functionality
function setupExportOptions() {
    const exportBtn = document.getElementById('export-btn');
    const exportDropdown = document.getElementById('export-dropdown');
    const exportCsv = document.getElementById('export-csv');
    const copyResults = document.getElementById('copy-results');
    const emailResults = document.getElementById('email-results');

    // Toggle dropdown
    exportBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        exportDropdown.classList.toggle('hidden');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', () => {
        exportDropdown.classList.add('hidden');
    });

    // Export to CSV
    exportCsv.addEventListener('click', () => {
        exportToCSV();
        exportDropdown.classList.add('hidden');
    });

    // Copy to clipboard
    copyResults.addEventListener('click', () => {
        copyToClipboard();
        exportDropdown.classList.add('hidden');
    });

    // Email results
    emailResults.addEventListener('click', () => {
        emailResults_();
        exportDropdown.classList.add('hidden');
    });
}

function exportToCSV() {
    const csvBtn = document.getElementById('export-csv');
    const originalHtml = csvBtn.innerHTML;
    
    try {
        csvBtn.innerHTML = '<i class="fas fa-spinner fa-spin text-green-600 mr-3"></i>Generating...';
        
        let csvData = [];
        
        if (candidatesData.length > 1) {
            // Multiple candidates
            csvData = candidatesData.map((candidate, index) => {
                const userStatus = creditManager.getStatus();
                const baseData = {
                    'Candidate Name': candidate.candidateName || `Candidate ${index + 1}`,
                    'Score': candidate.candidateScore || 'N/A',
                    'Title/Position': extractTitleFromSummary(candidate) || 'Professional',
                    'Executive Summary': candidate.executiveSummary ? candidate.executiveSummary.replace(/"/g, '""') : 'N/A',
                    'Core Competencies': candidate.coreCompetencies ? 
                        (typeof candidate.coreCompetencies === 'string' ? 
                            (candidate.coreCompetencies.startsWith('-') ? "'" + candidate.coreCompetencies.replace(/"/g, '""') : candidate.coreCompetencies.replace(/"/g, '""')) : 
                            candidate.coreCompetencies.join('; ')) : 'N/A',
                    'Analysis Date': new Date().toLocaleDateString()
                };

                // Add PRO fields if user is professional
                if (!userStatus.isFreeTier) {
                    baseData['Role Alignment'] = candidate.roleAlignment ? candidate.roleAlignment.replace(/"/g, '""') : 'N/A';
                    baseData['Education & Certifications'] = candidate.educationCertifications ? candidate.educationCertifications.replace(/"/g, '""') : 'N/A';
                    baseData['Communication Quality'] = candidate.communication ? candidate.communication.replace(/"/g, '""') : 'N/A';
                    baseData['Red Flags'] = candidate.redFlags ? candidate.redFlags.replace(/"/g, '""') : 'N/A';
                    baseData['Strategic Recommendations'] = candidate.strategicRecommendations ? candidate.strategicRecommendations.replace(/"/g, '""') : 'N/A';
                    baseData['Candidate Scorecard'] = candidate.candidateScorecard ? candidate.candidateScorecard.replace(/"/g, '""') : 'N/A';
                }

                return baseData;
            });
        } else {
            // Single candidate
            const candidate = candidatesData[0];
            const userStatus = creditManager.getStatus();
            const baseData = {
                'Candidate Name': candidate.candidateName || 'Candidate',
                'Score': candidate.candidateScore || 'N/A',
                'Title/Position': extractTitleFromSummary(candidate) || 'Professional',
                'Executive Summary': candidate.executiveSummary ? candidate.executiveSummary.replace(/"/g, '""') : 'N/A',
                'Core Competencies': candidate.coreCompetencies ? 
                    (typeof candidate.coreCompetencies === 'string' ? 
                        (candidate.coreCompetencies.startsWith('-') ? "'" + candidate.coreCompetencies.replace(/"/g, '""') : candidate.coreCompetencies.replace(/"/g, '""')) : 
                        candidate.coreCompetencies.join('; ')) : 'N/A',
                'Analysis Date': new Date().toLocaleDateString()
            };

            // Add PRO fields if user is professional
            if (!userStatus.isFreeTier) {
                baseData['Role Alignment'] = candidate.roleAlignment ? candidate.roleAlignment.replace(/"/g, '""') : 'N/A';
                baseData['Education & Certifications'] = candidate.educationCertifications ? candidate.educationCertifications.replace(/"/g, '""') : 'N/A';
                baseData['Communication Quality'] = candidate.communication ? candidate.communication.replace(/"/g, '""') : 'N/A';
                baseData['Red Flags'] = candidate.redFlags ? candidate.redFlags.replace(/"/g, '""') : 'N/A';
                baseData['Strategic Recommendations'] = candidate.strategicRecommendations ? candidate.strategicRecommendations.replace(/"/g, '""') : 'N/A';
                baseData['Candidate Scorecard'] = candidate.candidateScorecard ? candidate.candidateScorecard.replace(/"/g, '""') : 'N/A';
            }

            csvData = [baseData];
        }
        
        // Convert to CSV
        const headers = Object.keys(csvData[0]);
        const csvContent = [
            headers.join(','),
            ...csvData.map(row => headers.map(header => `"${row[header]}"`).join(','))
        ].join('\n');
        
        // Download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `MontPro_Analysis_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        
        // Success state
        csvBtn.innerHTML = '<i class="fas fa-check text-green-600 mr-3"></i>Downloaded!';
        showSuccess('CSV exported successfully!');
        
        setTimeout(() => {
            csvBtn.innerHTML = originalHtml;
        }, 2000);
        
    } catch (error) {
        console.error('CSV export failed:', error);
        csvBtn.innerHTML = '<i class="fas fa-exclamation-circle text-red-600 mr-3"></i>Failed';
        showError('Failed to export CSV. Please try again.');
        
        setTimeout(() => {
            csvBtn.innerHTML = originalHtml;
        }, 3000);
    }
}

function copyToClipboard() {
    const copyBtn = document.getElementById('copy-results');
    const originalHtml = copyBtn.innerHTML;
    
    try {
        copyBtn.innerHTML = '<i class="fas fa-spinner fa-spin text-blue-600 mr-3"></i>Copying...';
        
        let textContent = '';
        
        if (candidatesData.length > 1) {
            textContent = `MontPro Analysis Results - ${candidatesData.length} Candidates\n`;
            textContent += `Analysis Date: ${new Date().toLocaleDateString()}\n\n`;
            
            candidatesData.forEach((candidate, index) => {
                textContent += `--- CANDIDATE ${index + 1} ---\n`;
                textContent += `Name: ${candidate.candidateName || `Candidate ${index + 1}`}\n`;
                textContent += `Score: ${candidate.candidateScore || 'N/A'}\n`;
                textContent += `Title: ${extractTitleFromSummary(candidate) || 'Professional'}\n`;
                textContent += `Summary: ${candidate.executiveSummary || 'N/A'}\n`;
                textContent += `Skills: ${candidate.coreCompetencies ? (typeof candidate.coreCompetencies === 'string' ? candidate.coreCompetencies : candidate.coreCompetencies.join(', ')) : 'N/A'}\n\n`;
            });
        } else {
            const candidate = candidatesData[0];
            textContent = `MontPro Analysis Results\n`;
            textContent += `Analysis Date: ${new Date().toLocaleDateString()}\n\n`;
            textContent += `Name: ${candidate.candidateName || 'Candidate'}\n`;
            textContent += `Score: ${candidate.candidateScore || 'N/A'}\n`;
            textContent += `Title: ${extractTitleFromSummary(candidate) || 'Professional'}\n`;
            textContent += `Summary: ${candidate.executiveSummary || 'N/A'}\n`;
            textContent += `Skills: ${candidate.coreCompetencies ? (typeof candidate.coreCompetencies === 'string' ? candidate.coreCompetencies : candidate.coreCompetencies.join(', ')) : 'N/A'}\n`;
        }
        
        textContent += `\n--- \nGenerated by MontPro Recruitment Analysis Tool`;
        
        navigator.clipboard.writeText(textContent).then(() => {
            copyBtn.innerHTML = '<i class="fas fa-check text-blue-600 mr-3"></i>Copied!';
            showSuccess('Results copied to clipboard!');
            
            setTimeout(() => {
                copyBtn.innerHTML = originalHtml;
            }, 2000);
        });
        
    } catch (error) {
        console.error('Copy failed:', error);
        copyBtn.innerHTML = '<i class="fas fa-exclamation-circle text-red-600 mr-3"></i>Failed';
        showError('Failed to copy. Please try again.');
        
        setTimeout(() => {
            copyBtn.innerHTML = originalHtml;
        }, 3000);
    }
}

function emailResults_() {
    const emailBtn = document.getElementById('email-results');
    const originalHtml = emailBtn.innerHTML;
    
    // Get user's email address
    const userEmail = prompt('Enter your email address to receive the analysis results:');
    
    if (!userEmail) {
        return; // User cancelled
    }
    
    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(userEmail)) {
        showError('Please enter a valid email address.');
        return;
    }
    
    try {
        emailBtn.innerHTML = '<i class="fas fa-spinner fa-spin text-purple-600 mr-3"></i>Sending...';
        
        // Get the currently displayed/selected candidate
        let currentCandidate;
        let candidateDisplayName;
        
        if (!document.getElementById('multiple-candidates-view').classList.contains('hidden')) {
            // Multiple candidates view - get the selected one
            currentCandidate = candidatesData[selectedCandidateIndex];
            candidateDisplayName = currentCandidate.candidateName || `Candidate ${selectedCandidateIndex + 1}`;
        } else {
            // Single candidate view - get the only candidate
            currentCandidate = candidatesData[0];
            candidateDisplayName = currentCandidate.candidateName || 'Candidate';
        }
        
        // Prepare email data for ONLY the current candidate
        const emailData = {
            to: userEmail,
            candidates: [currentCandidate], // Send only the selected candidate
            analysisDate: new Date().toLocaleDateString(),
            totalCandidates: 1, // Always 1 since we're sending only current candidate
            selectedCandidate: candidateDisplayName // For better email subject/content
        };
        
        console.log('Sending email for candidate:', candidateDisplayName);
        console.log('Email data:', emailData);
        
        // Send to your backend
        sendEmailViaBackend(emailData)
            .then((result) => {
                console.log('Email sent successfully:', result);
                emailBtn.innerHTML = '<i class="fas fa-check text-purple-600 mr-3"></i>Sent!';
                showSuccess(`Analysis for ${candidateDisplayName} sent to ${userEmail}!`);
                
                setTimeout(() => {
                    emailBtn.innerHTML = originalHtml;
                }, 3000);
            })
            .catch((error) => {
                console.error('Email sending failed:', error);
                
                // Fallback to clipboard
                const subject = `MontPro Analysis Results - ${candidateDisplayName}`;
                let body = generateEmailBodyForCandidate(currentCandidate);
                
                navigator.clipboard.writeText(`Subject: ${subject}\n\n${body}`).then(() => {
                    emailBtn.innerHTML = '<i class="fas fa-copy text-purple-600 mr-3"></i>Copied!';
                    showWarning(`Could not send email. Analysis for ${candidateDisplayName} copied to clipboard instead.`);
                    
                    setTimeout(() => {
                        emailBtn.innerHTML = originalHtml;
                    }, 3000);
                }).catch(() => {
                    emailBtn.innerHTML = '<i class="fas fa-exclamation-circle text-red-600 mr-3"></i>Failed';
                    showError('Email sending failed and clipboard copy failed. Please try the CSV export instead.');
                    
                    setTimeout(() => {
                        emailBtn.innerHTML = originalHtml;
                    }, 3000);
                });
            });
        
    } catch (error) {
        console.error('Email preparation failed:', error);
        emailBtn.innerHTML = originalHtml;
        showError('Failed to prepare email. Please try again.');
    }
}

// Helper function to generate email body for a single candidate
function generateEmailBodyForCandidate(candidate) {
    const candidateName = candidate.candidateName || 'Candidate';
    const candidateTitle = extractTitleFromSummary(candidate) || 'Professional';
    
    let body = `MontPro Analysis Results - ${candidateName}

Analysis Date: ${new Date().toLocaleDateString()}

--- CANDIDATE ANALYSIS ---
Name: ${candidateName}
Score: ${candidate.candidateScore || 'N/A'}/5
Title: ${candidateTitle}

Executive Summary:
${candidate.executiveSummary || 'N/A'}

Core Competencies:
${candidate.coreCompetencies ? (typeof candidate.coreCompetencies === 'string' ? candidate.coreCompetencies : candidate.coreCompetencies.join(', ')) : 'N/A'}

Generated by MontPro Recruitment Analysis Tool`;
    
    return body;
}

// Helper function to send email via your backend
async function sendEmailViaBackend(emailData) {
    try {
        const response = await fetch('https://montpro.app.n8n.cloud/webhook/send-recruitment-analysis-email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(emailData)
        });
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('Response data:', result);
        
        // Check if the backend indicates success
        if (result.success === false) {
            throw new Error(result.message || 'Email sending failed');
        }
        
        return result;
        
    } catch (error) {
        console.error('Email sending error:', error);
        throw error;
    }
}

// Helper function to generate email body
function generateEmailBody() {
    let body = `Performance Review Summary

Analysis Date: ${new Date().toLocaleDateString()}
Total Candidates: ${candidatesData.length}

`;
    
    if (candidatesData.length > 1) {
        candidatesData.forEach((candidate, index) => {
            body += `--- CANDIDATE ${index + 1} ---
Name: ${candidate.candidateName || `Candidate ${index + 1}`}
Score: ${candidate.candidateScore || 'N/A'}/5
Title: ${extractTitleFromSummary(candidate) || 'Professional'}

Executive Summary:
${candidate.executiveSummary || 'N/A'}

Core Competencies:
${candidate.coreCompetencies ? (typeof candidate.coreCompetencies === 'string' ? candidate.coreCompetencies : candidate.coreCompetencies.join(', ')) : 'N/A'}

`;
        });
    } else {
        const candidate = candidatesData[0];
        body += `Employee: ${candidate.candidateName || 'Candidate'}
Score: ${candidate.candidateScore || 'N/A'}/5
Title: ${extractTitleFromSummary(candidate) || 'Professional'}

Executive Summary:
${candidate.executiveSummary || 'N/A'}

Core Competencies:
${candidate.coreCompetencies ? (typeof candidate.coreCompetencies === 'string' ? candidate.coreCompetencies : candidate.coreCompetencies.join(', ')) : 'N/A'}

`;
    }
    
    body += `Generated by MontPro Recruitment Analysis Tool`;
    return body;
}
        
async function signIn() {
    const emailEl = document.getElementById('email');
    const authMsg = document.getElementById('auth-msg');
    const email = emailEl.value.trim();
    
    if (!email) {
        authMsg.textContent = "Please enter your email address.";
        authMsg.className = "text-center text-sm font-medium text-red-600 mt-2";
        emailEl.focus();
        return;
    }
    
    // Email validation regex
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        authMsg.textContent = "Please enter a valid email address.";
        authMsg.className = "text-center text-sm font-medium text-red-600 mt-2";
        emailEl.focus();
        return;
    }
    
    const magicBtn = document.getElementById('magic-btn');
    const originalBtnHtml = magicBtn.innerHTML;
    
    // Update button to show loading state
    magicBtn.innerHTML = '<div class="spinner mr-2"></div> Sending...';
    magicBtn.disabled = true;
    
    authMsg.textContent = "";
    
    try {
        let { error } = await supabase.auth.signInWithOtp({ email });
        
        if (error) {
            authMsg.textContent = "Error: " + error.message;
            authMsg.className = "text-center text-sm font-medium text-red-600 mt-2";
            
            // Reset button
            magicBtn.innerHTML = originalBtnHtml;
            magicBtn.disabled = false;
        } else {
            authMsg.textContent = "Check your email for the sign-in link.";
            authMsg.className = "text-center text-sm font-medium text-green-600 mt-2";
            
            // Keep button disabled but change text
            magicBtn.innerHTML = '<i class="fas fa-check mr-2"></i> Link Sent';
            
            // Enable the button after 30 seconds
            setTimeout(() => {
                magicBtn.innerHTML = originalBtnHtml;
                magicBtn.disabled = false;
            }, 30000);
        }
    } catch (e) {
        authMsg.textContent = "Something went wrong. Please try again.";
        authMsg.className = "text-center text-sm font-medium text-red-600 mt-2";
        console.error(e);
        
        // Reset button
        magicBtn.innerHTML = originalBtnHtml;
        magicBtn.disabled = false;
    }
}

// Multiple Candidates Handling Functions
let candidatesData = [];
let selectedCandidateIndex = 0;
let creditManager = new CreditManager();

// Filter Control Functions
function addFilterControlsToSidebar() {
    // Initialize filter with current candidates
    candidateFilter.setCandidates(candidatesData);
    
    // Search input handler
    const searchInput = document.getElementById('candidate-search');
    if (searchInput) {
        searchInput.addEventListener('input', debounce((e) => {
            handleSearchFilter(e.target.value);
        }, 300));
    }
    
    // Score range handler
    const scoreRange = document.getElementById('score-range');
    const scoreDisplay = document.getElementById('score-display');
    if (scoreRange && scoreDisplay) {
        scoreRange.addEventListener('input', (e) => {
            const value = e.target.value;
            scoreDisplay.textContent = value;
            handleScoreFilter(value);
        });
    }
}

function handleSearchFilter(query) {
    candidateFilter.applySearchFilter(query);
    updateCandidateDisplay();
}

function handleScoreFilter(minScore) {
    candidateFilter.applyScoreFilter(minScore);
    updateCandidateDisplay();
}

function updateCandidateDisplay() {
    const filteredCandidates = candidateFilter.getFilteredCandidates();
    const stats = candidateFilter.getFilterStats();
    
    // Update the candidate cards with filtered results
    generateFilteredCandidateCards(filteredCandidates);
    
    // Update results counter
    const resultsElement = document.getElementById('filter-results');
    if (resultsElement) {
        if (stats.filtered === stats.total) {
            resultsElement.textContent = `Showing all ${stats.total} candidates`;
        } else {
            resultsElement.textContent = `Showing ${stats.filtered} of ${stats.total} candidates`;
        }
    }
    
    // Auto-select first candidate if current selection is filtered out
    if (filteredCandidates.length > 0) {
        const currentCandidate = candidatesData[selectedCandidateIndex];
        const isCurrentVisible = filteredCandidates.includes(currentCandidate);
        
        if (!isCurrentVisible) {
            // Find the index of the first filtered candidate in the original array
            const firstFilteredIndex = candidatesData.indexOf(filteredCandidates[0]);
            showCandidateDetail(firstFilteredIndex);
        }
    }
}

// Debounce function for search
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
        
function showMultipleCandidatesResults(data) {
    console.log('=== showMultipleCandidatesResults called ===');
    console.log('Data received:', data);
    
    hideAnalysisLoading();
    document.getElementById('analysis-results').classList.remove('hidden');
    
    // Check if data has candidates array nested inside
    let candidatesArray = null;
    
    if (Array.isArray(data)) {
        console.log('Data is already an array');
        candidatesArray = data;
    } else if (data && Array.isArray(data.candidates)) {
        console.log('Found candidates array in data.candidates');
        // Extract the JSON objects from the candidates array
        candidatesArray = data.candidates.map(item => item.json || item);
    } else if (data && Array.isArray(data.data)) {
        console.log('Found candidates array in data.data');
        candidatesArray = data.data;
    } else if (data && typeof data === 'object') {
        // Check if data has any property that is an array
        for (let key in data) {
            if (Array.isArray(data[key]) && data[key].length > 0) {
                console.log(`Found candidates array in data.${key}`);
                // Check if items have nested json property
                candidatesArray = data[key].map(item => item.json || item);
                break;
            }
        }
    }
    
    if (candidatesArray && candidatesArray.length > 1) {
        console.log('MULTIPLE CANDIDATES DETECTED - Array with', candidatesArray.length, 'items');
        console.log('First candidate structure:', candidatesArray[0]);
        console.log('Keys in first candidate:', Object.keys(candidatesArray[0]));
        candidatesData = candidatesArray;
        showMultipleCandidatesView();
    } else if (candidatesArray && candidatesArray.length === 1) {
        console.log('SINGLE CANDIDATE IN ARRAY - Using single view');
        candidatesData = candidatesArray;
        showSingleCandidateView(candidatesArray[0]);
    } else {
        console.log('SINGLE CANDIDATE OBJECT - Using single view');
        candidatesData = [data];
        showSingleCandidateView(data);
    }
}

function showMultipleCandidatesView() {
    document.getElementById('single-candidate-view').classList.add('hidden');
    document.getElementById('multiple-candidates-view').classList.remove('hidden');
    
    // Update summary
    document.getElementById('total-candidates').textContent = candidatesData.length;
    document.getElementById('analysis-timestamp').textContent = 
        `Analysis completed on ${new Date().toLocaleDateString()}`;

    // Add filter controls to sidebar
    addFilterControlsToSidebar();
    
    // Generate candidate cards
    generateCandidateCards();
    
    // Show first candidate by default
    showCandidateDetail(0);

    // Set up sorting
    document.getElementById('sort-score').onclick = () => sortCandidates('score');
    document.getElementById('sort-name').onclick = () => sortCandidates('name');
}

function generateCandidateCards() {
    const cardsContainer = document.getElementById('candidate-cards');
    cardsContainer.innerHTML = '';
    
    candidatesData.forEach((candidate, index) => {
        const card = createCandidateCard(candidate, index);
        cardsContainer.appendChild(card);
    });
}

// Add this NEW function right after generateCandidateCards
function generateFilteredCandidateCards(filteredCandidates) {
    const cardsContainer = document.getElementById('candidate-cards');
    cardsContainer.innerHTML = '';
    
    filteredCandidates.forEach((candidate) => {
        // Find the original index of this candidate
        const originalIndex = candidatesData.indexOf(candidate);
        const card = createCandidateCard(candidate, originalIndex);
        cardsContainer.appendChild(card);
    });
}

function sortCandidates(sortBy) {
    if (sortBy === 'score') {
        candidatesData.sort((a, b) => (parseInt(b.candidateScore) || 0) - (parseInt(a.candidateScore) || 0));
    } else if (sortBy === 'name') {
        candidatesData.sort((a, b) => {
            const nameA = (a.candidateName || `Candidate ${candidatesData.indexOf(a) + 1}`).toLowerCase();
            const nameB = (b.candidateName || `Candidate ${candidatesData.indexOf(b) + 1}`).toLowerCase();
            return nameA.localeCompare(nameB);
        });
    }
    
    // Regenerate cards and reset selection
    generateCandidateCards();
    showCandidateDetail(0);
    
    // Update active button
    document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`sort-${sortBy}`).classList.add('active');
}

function createCandidateCard(candidate, index) {
    const card = document.createElement('div');
    card.className = `candidate-mini-card ${index === selectedCandidateIndex ? 'active' : ''}`;
    card.onclick = () => showCandidateDetail(index);
    
    // Extract and format top 3 skills for preview
    const topSkills = extractAndFormatSkills(candidate.coreCompetencies);
    
    const score = parseInt(candidate.candidateScore) || 75;
const name = candidate.candidateName || `Candidate ${index + 1}`;

// Extract job title from executive summary if not directly available
let title = candidate.candidateTitle || candidate.position || candidate.jobTitle;

if (!title && candidate.executiveSummary) {
    // Try to extract title from executive summary
    const summaryText = candidate.executiveSummary;
    
    // Look for common title patterns
    const titlePatterns = [
        /is (?:an?|the) ([^.]+?) with/i,  // "is a Senior Manager with"
        /(?:seasoned|experienced|accomplished) ([^.]+?) with/i,  // "seasoned Finance Director with"
        /(?:as|is) (?:an?|the) ([^.]+?)\./i,  // "as a Product Manager."
        /his role as ([^.]+?)\./i,  // "his role as CFO."
        /working as (?:an?|the) ([^.]+?)\./i  // "working as a Team Lead."
    ];
    
    for (let pattern of titlePatterns) {
        const match = summaryText.match(pattern);
        if (match && match[1]) {
            title = match[1].trim();
            // Clean up common words and make it more title-like
            title = title.replace(/\b(leader|professional|expert|individual)\b/gi, '')
                        .replace(/\s+/g, ' ')
                        .trim();
            if (title.length > 0 && title.length < 50) {
                break;
            }
        }
    }
}

// Fallback if no title found
if (!title || title.length === 0) {
    title = 'Professional';
}

// Format the title properly (capitalize first letters)
title = title.split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join(' ');
    
    card.innerHTML = `
        <div class="mini-card-header">
            <div class="mini-card-info">
                <h4>${name}</h4>
                <p>${title}</p>
            </div>
            <div class="mini-score-ring" style="--score: ${score}%;">
                <span class="mini-score-text">${score}</span>
            </div>
        </div>
        <div class="mini-skills">
            ${topSkills.map(skill => `<span class="mini-skill-tag">${skill}</span>`).join('')}
        </div>
    `;
    
    return card;
}

function showCandidateDetail(index) {
    selectedCandidateIndex = index;
    const candidate = candidatesData[index];
    
    // Update active card
    document.querySelectorAll('.candidate-mini-card').forEach((card, i) => {
        if (i === index) {
            card.classList.add('active');
        } else {
            card.classList.remove('active');
        }
    });
    
    // Generate detailed view
    const detailContainer = document.getElementById('selected-candidate-detail');
    detailContainer.innerHTML = generateCandidateDetailHTML(candidate, index);

    updateUserTierBadgeMultiple();
}

function generateCandidateDetailHTML(candidate, index) {
    const score = parseInt(candidate.candidateScore) || 75;
    const name = candidate.candidateName || `Candidate ${index + 1}`;
    const title = extractTitleFromSummary(candidate) || 'Professional';
    
    // Base HTML structure
    let detailHTML = `
        <!-- Candidate Overview -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-center md:items-start gap-6">
                <div>
                    <div class="flex items-center mb-2">
                        <h2 class="text-2xl font-bold text-gray-800">${name}</h2>
                        <span id="user-tier-badge-multiple" class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded">Candidate ${index + 1}</span>
                    </div>
                    
                    <div class="flex flex-wrap gap-2 mt-2">
                        <span class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded-md">${title}</span>
                        <span class="text-xs bg-green-50 text-green-700 px-2 py-1 rounded-md">AI-Powered</span>
                        <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded-md">${new Date().toLocaleDateString()}</span>
                    </div>
                </div>
                
                <div class="text-center">
                    <div class="score-circle" style="--score-percent: ${score}%">
                        <div class="score-label">Score</div>
                        <div class="score-value">${score}</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Executive Summary -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex items-center mb-4">
                <i class="fas fa-file-alt text-blue-500 mr-3"></i>
                <h3 class="text-lg font-semibold">Executive Summary</h3>
            </div>
            <div class="text-gray-700">
                ${candidate.executiveSummary ? `<p>${candidate.executiveSummary}</p>` : '<p>Executive summary not available.</p>'}
            </div>
        </div>
        
        <!-- Core Competencies -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <i class="fas fa-brain text-blue-500 mr-3"></i>
                    <h3 class="text-lg font-semibold">Core Competencies</h3>
                </div>
            </div>
            <div class="text-gray-700">
                ${generateCompetenciesHTML(candidate.coreCompetencies)}
            </div>
        </div>
    `;
    
    // Add premium sections or upgrade prompt based on user tier
    const userStatus = creditManager.getStatus();
    if (!userStatus.isFreeTier) {
        // PROFESSIONAL user - add premium sections
        detailHTML += generatePremiumSectionsHTML(candidate);
    } else {
        // FREE user - add upgrade prompt
        detailHTML += generateUpgradePromptHTML();
    }
    
    // Add upgrade CTA at the end
    detailHTML += `
        <!-- Upgrade CTA -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl p-6 text-white mb-6">
            <div class="md:flex justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <h3 class="font-bold text-xl mb-2">Take Your Recruitment Process to the Next Level</h3>
                    <p class="opacity-90 mb-2">Unlock advanced customization options and powerful features:</p>
                    <ul class="list-disc pl-5 text-sm opacity-90 space-y-1">
                        <li>Custom metrics tracking tailored to your hiring needs</li>
                        <li>Batch upload via Google Drive for efficient processing</li>
                        <li>Flexible output formats (Google Docs, Slides, Sheets, PDF)</li>
                        <li>Personalized report templates to match your brand</li>
                        <li>Match candidates against your specific job requirements</li>
                    </ul>
                </div>
                <div class="mt-4 md:mt-0 flex-shrink-0 text-center">
                    <p class="text-sm italic text-white opacity-80 mb-2">Customize multiple candidates analysis</p>
                    <a href="https://calendly.com/ardhipradhana/montpro_discovery" class="inline-block px-6 py-3 bg-white text-purple-700 font-medium rounded-lg hover:bg-gray-100 transition-colors shadow-md">
                        <i class="fas fa-magic mr-2"></i>
                        Get My Tailored Version
                    </a>
                </div>
            </div>
        </div>
    `;
    
    return detailHTML;
}

function generatePremiumSectionsHTML(candidate) {
    let premiumHTML = '';
    
    // Role Alignment Section
    if (candidate.roleAlignment) {
        premiumHTML += createPremiumSectionHTML(
            'fas fa-crosshairs',
            'Role Alignment & Potential Fit',
            candidate.roleAlignment
        );
    }
    
    // Education & Certifications
    if (candidate.educationCertifications) {
        premiumHTML += createPremiumSectionHTML(
            'fas fa-graduation-cap',
            'Education & Certifications',
            candidate.educationCertifications
        );
    }
    
    // Communication Quality
    if (candidate.communication) {
        premiumHTML += createPremiumSectionHTML(
            'fas fa-comments',
            'Communication & Presentation Quality',
            candidate.communication
        );
    }
    
    // Red Flags
    if (candidate.redFlags) {
        premiumHTML += createPremiumSectionHTML(
            'fas fa-exclamation-triangle',
            'Red Flags & Risk Analysis',
            candidate.redFlags,
            'text-red-600'
        );
    }
    
    // Strategic Recommendations
    if (candidate.strategicRecommendations) {
        premiumHTML += createPremiumSectionHTML(
            'fas fa-lightbulb',
            'Strategic Recommendations',
            candidate.strategicRecommendations,
            'text-green-600'
        );
    }
    
    // Candidate Scorecard
    if (candidate.candidateScorecard) {
        premiumHTML += createPremiumSectionHTML(
            'fas fa-chart-bar',
            'Detailed Candidate Scorecard',
            candidate.candidateScorecard,
            'text-blue-600'
        );
    }
    
    return premiumHTML;
}

function createPremiumSectionHTML(iconClass, title, content, iconColor = 'text-blue-500') {
    return `
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex items-center mb-4">
                <i class="${iconClass} ${iconColor} mr-3"></i>
                <h3 class="text-lg font-semibold">${title}</h3>
                <span class="ml-2 px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded">PRO</span>
            </div>
            <div class="text-gray-700">
                ${formatPremiumContentHTML(content)}
            </div>
        </div>
    `;
}

function formatPremiumContentHTML(content) {
    if (!content) return '<p>No data available.</p>';
    
    // Convert bullet points and line breaks to proper HTML
    return content
        .replace(/\n/g, '<br>')
        .replace(/^- /gm, 'â€¢ ')
        .replace(/\n\n/g, '<br><br>');
}

function generateUpgradePromptHTML() {
    return `
        <div class="bg-gradient-to-r from-gray-100 to-gray-200 rounded-xl p-6 mb-6 border-2 border-dashed border-gray-300">
            <div class="text-center">
                <i class="fas fa-lock text-gray-400 text-3xl mb-3"></i>
                <h3 class="text-lg font-semibold text-gray-600 mb-2">Premium Analysis Available</h3>
                <p class="text-gray-500 mb-4">Role Alignment, Education Analysis, Red Flags Detection, Strategic Recommendations, and Detailed Scorecard</p>
                <button onclick="showPricingPage()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-arrow-up mr-2"></i>
                    Upgrade untuk Analisis Lengkap
                </button>
            </div>
        </div>
    `;
}

function generateCompetenciesHTML(competencies) {
    if (!competencies) return '<p>No competencies data available.</p>';
    
    if (Array.isArray(competencies)) {
        return competencies.map(skill => 
            `<span class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm mr-2 mb-2">${skill}</span>`
        ).join('');
    } else if (typeof competencies === 'string') {
        return competencies.replace(/\n/g, '<br>').replace(/- /g, 'â€¢ ');
    }
    
    return '<p>Competencies data format not recognized.</p>';
}

function showSingleCandidateView(data) {
    document.getElementById('multiple-candidates-view').classList.add('hidden');
    document.getElementById('single-candidate-view').classList.remove('hidden');
    
    // Use existing single candidate display logic
    if (data.candidateName) {
        document.getElementById('candidate-name').textContent = data.candidateName;
    }
    
    if (data.candidateScore) {
        const scoreValue = parseInt(data.candidateScore);
        document.getElementById('candidate-score').textContent = `${scoreValue}`;
        document.querySelector('.score-circle').style.setProperty('--score-percent', `${scoreValue}%`);
    }
    
    if (data.executiveSummary) {
        document.getElementById('executive-summary').innerHTML = `<p>${data.executiveSummary}</p>`;
    }

    // ADD PROFESSIONAL-ONLY SECTIONS
    const userStatus = creditManager.getStatus();
        if (!userStatus.isFreeTier) {
    // User is PROFESSIONAL - show additional sections
        addProfessionalSections(data);
    } else {
        // User is FREE - show upgrade prompts where premium content would be
        addUpgradePrompts();
    }
    
    if (data.coreCompetencies) {
        const skillsContainer = document.getElementById('core-competencies');
        skillsContainer.innerHTML = generateCompetenciesHTML(data.coreCompetencies);
    }
    
    const today = new Date();
    document.getElementById('analysis-date').textContent = today.toLocaleDateString();

    updateUserTierBadge();
}

function updateUserTierBadge() {
    const userStatus = creditManager.getStatus();
    const badgeElement = document.getElementById('user-tier-badge');
    
    if (badgeElement) {
        if (userStatus.isFreeTier) {
            badgeElement.className = 'ml-2 px-2 py-1 bg-gray-100 text-gray-600 text-xs font-medium rounded';
            badgeElement.innerHTML = 'Free Plan';
        } else {
            badgeElement.className = 'ml-2 px-2 py-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white text-xs font-medium rounded shadow-sm';
            badgeElement.innerHTML = '<i class="fas fa-crown mr-1"></i>PRO';
        }
    }
}

function updateUserTierBadgeMultiple() {
    const userStatus = creditManager.getStatus();
    const badgeElement = document.getElementById('user-tier-badge-multiple');
    
    if (badgeElement) {
        if (userStatus.isFreeTier) {
            badgeElement.className = 'ml-2 px-2 py-1 bg-gray-100 text-gray-600 text-xs font-medium rounded';
            badgeElement.innerHTML = 'Free Plan';
        } else {
            badgeElement.className = 'ml-2 px-2 py-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white text-xs font-medium rounded shadow-sm';
            badgeElement.innerHTML = '<i class="fas fa-crown mr-1"></i>PRO';
        }
    }
}

function addProfessionalSections(data) {
    const coreCompetenciesContainer = document.getElementById('core-competencies').parentElement;
    
    // Role Alignment Section
    if (data.roleAlignment) {
        const roleSection = createPremiumSection(
            'fas fa-crosshairs',
            'Role Alignment & Potential Fit',
            data.roleAlignment
        );
        coreCompetenciesContainer.insertAdjacentHTML('afterend', roleSection);
    }
    
    // Education & Certifications
    if (data.educationCertifications) {
        const educationSection = createPremiumSection(
            'fas fa-graduation-cap',
            'Education & Certifications',
            data.educationCertifications
        );
        coreCompetenciesContainer.insertAdjacentHTML('afterend', educationSection);
    }
    
    // Communication Quality
    if (data.communication) {
        const commSection = createPremiumSection(
            'fas fa-comments',
            'Communication & Presentation Quality',
            data.communication
        );
        coreCompetenciesContainer.insertAdjacentHTML('afterend', commSection);
    }
    
    // Red Flags
    if (data.redFlags) {
        const redFlagsSection = createPremiumSection(
            'fas fa-exclamation-triangle',
            'Red Flags & Risk Analysis',
            data.redFlags,
            'text-red-600'
        );
        coreCompetenciesContainer.insertAdjacentHTML('afterend', redFlagsSection);
    }
    
    // Strategic Recommendations
    if (data.strategicRecommendations) {
        const strategicSection = createPremiumSection(
            'fas fa-lightbulb',
            'Strategic Recommendations',
            data.strategicRecommendations,
            'text-green-600'
        );
        coreCompetenciesContainer.insertAdjacentHTML('afterend', strategicSection);
    }
    
    // Candidate Scorecard
    if (data.candidateScorecard) {
        const scorecardSection = createPremiumSection(
            'fas fa-chart-bar',
            'Detailed Candidate Scorecard',
            data.candidateScorecard,
            'text-blue-600'
        );
        coreCompetenciesContainer.insertAdjacentHTML('afterend', scorecardSection);
    }
}

function createPremiumSection(iconClass, title, content, iconColor = 'text-blue-500') {
    return `
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex items-center mb-4">
                <i class="${iconClass} ${iconColor} mr-3"></i>
                <h3 class="text-lg font-semibold">${title}</h3>
                <span class="ml-2 px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded">PRO</span>
            </div>
            <div class="text-gray-700">
                ${formatPremiumContent(content)}
            </div>
        </div>
    `;
}

function formatPremiumContent(content) {
    if (!content) return '<p>No data available.</p>';
    
    // Convert bullet points and line breaks to proper HTML
    return content
        .replace(/\n/g, '<br>')
        .replace(/^- /gm, 'â€¢ ')
        .replace(/\n\n/g, '<br><br>');
}

function addUpgradePrompts() {
    const coreCompetenciesContainer = document.getElementById('core-competencies').parentElement;
    
    const upgradePrompt = `
        <div class="bg-gradient-to-r from-gray-100 to-gray-200 rounded-xl p-6 mb-6 border-2 border-dashed border-gray-300">
            <div class="text-center">
                <i class="fas fa-lock text-gray-400 text-3xl mb-3"></i>
                <h3 class="text-lg font-semibold text-gray-600 mb-2">Premium Analysis Available</h3>
                <p class="text-gray-500 mb-4">Role Alignment, Education Analysis, Red Flags Detection, Strategic Recommendations, and Detailed Scorecard</p>
                <button onclick="showPricingPage()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-arrow-up mr-2"></i>
                    Upgrade untuk Analisis Lengkap
                </button>
            </div>
        </div>
    `;
    
    coreCompetenciesContainer.insertAdjacentHTML('afterend', upgradePrompt);
}
        
// Skill formatting functions
function formatSkillText(skill) {
    // Words that should remain lowercase (except at the beginning)
    const lowercaseWords = ['and', 'of', 'in', 'the', 'a', 'an', 'to', 'for', 'with', 'by', 'on', 'at'];
    
    return skill.toLowerCase()
        .split(' ')
        .map((word, index) => {
            // Always capitalize the first word
            if (index === 0) {
                return word.charAt(0).toUpperCase() + word.slice(1);
            }
            // Keep lowercase words lowercase unless they're the first word
            if (lowercaseWords.includes(word)) {
                return word;
            }
            // Capitalize other words
            return word.charAt(0).toUpperCase() + word.slice(1);
        })
        .join(' ');
}

function extractAndFormatSkills(competencies) {
    if (!competencies) return [];
    
    let skills = [];
    if (Array.isArray(competencies)) {
        skills = competencies.slice(0, 3);
    } else if (typeof competencies === 'string') {
        // Extract skills from text - look for bullet points or comma-separated items
        const lines = competencies.split('\n');
        for (let line of lines) {
            if (line.includes('-') || line.includes('â€¢')) {
                // Extract text after bullet point
                const skillText = line.replace(/^[-â€¢]\s*/, '').trim();
                if (skillText && skillText.length > 0) {
                    // Take first few words as skill name
                    const shortSkill = skillText.split(' ').slice(0, 4).join(' ');
                    skills.push(shortSkill);
                    if (skills.length >= 3) break;
                }
            }
        }
        
        // If no bullet points found, try to extract key phrases
        if (skills.length === 0) {
            const phrases = competencies.match(/[A-Z][a-z]+(?:\s+[a-z]+)*(?:\s+[A-Z][a-z]+)*/g) || [];
            skills = phrases.slice(0, 3);
        }
    }
    
    // Format each skill with proper capitalization
    return skills.map(skill => formatSkillText(skill));
}

// History Management Functions
function saveCurrentAnalysisToHistory() {
    if (candidatesData && candidatesData.length > 0) {
        const analysisId = historyManager.saveAnalysis(candidatesData, {
            analysisType: candidatesData.length > 1 ? 'multiple' : 'single',
            selectedCandidateIndex: selectedCandidateIndex || 0,
            fileNames: files.map(f => f.name),
            fileCount: files.length
        });
        
        updateHistoryCounter();
        return analysisId;
    }
}

function updateHistoryCounter() {
    const stats = historyManager.getHistoryStats();
    const counterElement = document.getElementById('history-count');
    
    if (stats.totalAnalyses > 0) {
        counterElement.textContent = stats.totalAnalyses;
        counterElement.classList.remove('hidden');
    } else {
        counterElement.classList.add('hidden');
    }
}

function showHistoryModal() {
    const modal = document.getElementById('history-modal');
    const historyList = document.getElementById('history-list');
    const emptyState = document.getElementById('history-empty');
    
    // Update stats
    const stats = historyManager.getHistoryStats();
    document.getElementById('total-analyses').textContent = stats.totalAnalyses;
    document.getElementById('total-candidates-analyzed').textContent = stats.totalCandidates;
    document.getElementById('last-analysis-date').textContent = 
        stats.lastAnalysis ? new Date(stats.lastAnalysis).toLocaleDateString() : 'Never';
    
    // Load history items
    const history = historyManager.getHistory();
    
    if (history.length === 0) {
        historyList.classList.add('hidden');
        emptyState.classList.remove('hidden');
    } else {
        historyList.classList.remove('hidden');
        emptyState.classList.add('hidden');
        renderHistoryList(history);
    }
    
    modal.classList.remove('hidden');
}

function deleteHistoryItem(analysisId) {
    if (confirm('Are you sure you want to delete this analysis from history?')) {
        try {
            let history = historyManager.getHistory();
            history = history.filter(item => item.id !== analysisId);
            localStorage.setItem(historyManager.storageKey, JSON.stringify(history));
            
            // Refresh the modal display
            showHistoryModal();
            updateHistoryCounter();
            showSuccess('Analysis deleted from history!');
        } catch (error) {
            console.error('Failed to delete history item:', error);
            showError('Failed to delete analysis from history.');
        }
    }
}

// Export History to CSV
function exportHistoryToCSV() {
    const exportBtn = document.getElementById('export-history-btn');
    const originalHtml = exportBtn.innerHTML;
    
    try {
        exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Exporting...';
        
        const history = historyManager.getHistory();
        if (history.length === 0) {
            showWarning('No history to export.');
            exportBtn.innerHTML = originalHtml;
            return;
        }
        
        // Create CSV data
        const csvData = [];
        history.forEach(analysis => {
            analysis.candidates.forEach((candidate, index) => {
                csvData.push({
                    'Analysis Date': analysis.analysisDate,
                    'Analysis Time': new Date(analysis.timestamp).toLocaleTimeString(),
                    'Candidate Name': candidate.candidateName || `Candidate ${index + 1}`,
                    'Score': candidate.candidateScore || 'N/A',
                    'Title': extractTitleFromSummary(candidate) || 'Professional',
                    'Executive Summary': candidate.executiveSummary ? candidate.executiveSummary.replace(/"/g, '""') : 'N/A',
                    'Core Competencies': candidate.coreCompetencies ? 
                        (typeof candidate.coreCompetencies === 'string' ? 
                            "'" + candidate.coreCompetencies.replace(/"/g, '""') : 
                            "'" + candidate.coreCompetencies.join('; ')) : 'N/A'
                });
            });
        });
        
        // Convert to CSV
        const headers = Object.keys(csvData[0]);
        const csvContent = [
            headers.join(','),
            ...csvData.map(row => headers.map(header => `"${row[header]}"`).join(','))
        ].join('\n');
        
        // Download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `MontPro_History_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        
        exportBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Exported!';
        showSuccess('History exported successfully!');
        
        setTimeout(() => {
            exportBtn.innerHTML = originalHtml;
        }, 2000);
        
    } catch (error) {
        console.error('Export failed:', error);
        exportBtn.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>Failed';
        showError('Failed to export history.');
        
        setTimeout(() => {
            exportBtn.innerHTML = originalHtml;
        }, 3000);
    }
}

// Clear All History
function clearAllHistory() {
    if (confirm('Are you sure you want to clear all analysis history? This action cannot be undone.')) {
        try {
            localStorage.removeItem(historyManager.storageKey);
            updateHistoryCounter();
            showHistoryModal(); // Refresh modal to show empty state
            showSuccess('All history cleared successfully!');
        } catch (error) {
            console.error('Failed to clear history:', error);
            showError('Failed to clear history.');
        }
    }
}
        
function renderHistoryList(history) {
    const historyList = document.getElementById('history-list');
    
    historyList.innerHTML = history.map((item, index) => `
        <div class="bg-gray-50 rounded-lg p-4 mb-3 hover:bg-gray-100 transition-colors cursor-pointer" onclick="loadAnalysisFromHistory('${item.id}')">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <h4 class="font-medium text-gray-800 mb-1">
                        ${item.totalCandidates} Candidate${item.totalCandidates > 1 ? 's' : ''} Analysis
                    </h4>
                    <p class="text-sm text-gray-600 mb-2">
                        ${item.candidates.map(c => c.candidateName || 'Unnamed Candidate').join(', ')}
                    </p>
                    <div class="flex gap-4 text-xs text-gray-500">
                        <span><i class="fas fa-calendar mr-1"></i>${item.analysisDate}</span>
                        <span><i class="fas fa-clock mr-1"></i>${new Date(item.timestamp).toLocaleTimeString()}</span>
                    </div>
                </div>
                <div class="flex flex-col items-end gap-2">
                    <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                        ${item.totalCandidates} candidate${item.totalCandidates > 1 ? 's' : ''}
                    </span>
                    <button onclick="event.stopPropagation(); deleteHistoryItem('${item.id}')" class="text-red-500 hover:text-red-700 text-xs">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

function loadAnalysisFromHistory(analysisId) {
    const analysis = historyManager.getAnalysisById(analysisId);
    
    if (!analysis) {
        showError('Analysis not found in history.');
        return;
    }
    
    if (!analysis.candidates || analysis.candidates.length === 0) {
        showError('Analysis data appears to be corrupted.');
        return;
    }
    
    // Load the analysis data
    candidatesData = analysis.candidates;
    selectedCandidateIndex = analysis.metadata?.selectedCandidateIndex || 0;
    
    // Show the results
    showAnalysisResults(analysis.candidates);
    
    // Close the modal
    document.getElementById('history-modal').classList.add('hidden');
    
    showSuccess('Analysis loaded from history!');
}

// Event Listeners for History
document.addEventListener('DOMContentLoaded', function() {
    // Update counter on page load
    updateHistoryCounter();

    // Add these lines inside your existing DOMContentLoaded function
    document.getElementById('export-history-btn').addEventListener('click', exportHistoryToCSV);
    document.getElementById('clear-history-btn').addEventListener('click', clearAllHistory);
    
    // History button
    document.getElementById('history-btn').addEventListener('click', showHistoryModal);

    // Add to your DOMContentLoaded
    document.getElementById('history-search')?.addEventListener('input', debounce((e) => {
        const query = e.target.value;
        const filteredHistory = query ? historyManager.searchHistory(query) : historyManager.getHistory();
        renderHistoryList(filteredHistory);
    }, 300));

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // Close modal
    document.getElementById('close-history-modal').addEventListener('click', () => {
    document.getElementById('history-modal').classList.add('hidden');
    });
    
    // Close modal when clicking outside
    document.getElementById('history-modal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
            document.getElementById('history-modal').classList.add('hidden');
        }
    });

    // Add these lines inside your existing DOMContentLoaded function
    document.getElementById('back-to-app-btn').addEventListener('click', hidePricingPage);

    document.getElementById('back-from-support').addEventListener('click', hideAllSupportPages);
    document.getElementById('back-from-faq').addEventListener('click', hideAllSupportPages);
    document.getElementById('back-from-terms').addEventListener('click', hideAllSupportPages);
    document.getElementById('back-from-privacy').addEventListener('click', hideAllSupportPages);

    // REPLACE your existing upgrade button listener with this:
    document.getElementById('upgrade-profesional-btn').addEventListener('click', async function() {
        const status = creditManager.getStatus();
        const userEmail = creditManager.currentUser.email;
    
        // Show loading state
        this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Memproses...';
        this.disabled = true;
    
        try {
            await paymentHandler.createPayment(599000, 30, userEmail);
        } catch (error) {
            console.error('Payment initiation failed:', error);
            showError('Gagal memulai pembayaran. Silakan coba lagi.');
        } finally {
            // Reset button
            setTimeout(() => {
                this.innerHTML = '<i class="fas fa-rocket mr-2"></i>Beli 30 Credits - Rp 599.000';
                this.disabled = false;
            }, 2000);
        }
    });

    // ADD this right after the existing upgrade-profesional-btn listener:
    document.getElementById('upgrade-ultra-btn').addEventListener('click', async function() {
        const status = creditManager.getStatus();
    
        if (status.tier === 'PROFESIONAL' && status.remaining > 0) {
            // PRO user converting credits
            await convertCreditsToUltra();
        } else {
            // New ULTRA purchase
            const userEmail = creditManager.currentUser.email;
        
            this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Memproses...';
            this.disabled = true;
        
            try {
                await paymentHandler.createPayment(999000, 20, userEmail);
            } catch (error) {
                console.error('Payment initiation failed:', error);
                showError('Gagal memulai pembayaran. Silakan coba lagi.');
            } finally {
                setTimeout(() => {
                    this.innerHTML = '<i class="fas fa-rocket mr-2"></i>Upgrade to Ultra - Rp 999.000';
                    this.disabled = false;
                }, 2000);
            }
        }
    });
});
        
document.addEventListener("DOMContentLoaded", async function() {
    // 1. Process magic link
    await supabase.auth.getSession();

    // 2. Check if user is already logged in
    supabase.auth.getSession().then(({ data: { session } }) => {
        if (session) {
            showMainApp();
        } else {
            showAuthBox();
        }
    });

    // 3. Listen for auth state changes
    supabase.auth.onAuthStateChange((event, session) => {
        if (session) {
            showMainApp();
        }
    });

    // 4. Wire up the button after DOM is ready
    document.getElementById("magic-btn").onclick = signIn;
    document.getElementById('logout-btn').onclick = async function() {
        try {
            await supabase.auth.signOut();
            showAuthBox();
        } catch (error) {
            console.error("Error signing out:", error);
            showError("Failed to log out. Please try again.");
        }
    };

    // ---- File Handling and Analysis Logic ----
    fileInput = document.getElementById('file-input');
    dragArea = document.getElementById('drag-area');
    fileListContainer = document.getElementById('file-list-container');
    fileList = document.getElementById('file-list');
    fileCount = document.getElementById('file-count');
    startButton = document.getElementById('start-button');
    errorMessage = document.getElementById('error-message');
    errorText = document.getElementById('error-text');
    statusMessage = document.getElementById('status-message');
    statusText = document.getElementById('status-text');
    statusIcon = document.getElementById('status-icon');
    clearAllBtn = document.getElementById('clear-all');

    allowedTypes = ['application/pdf', 'image/jpeg', 'image/png'];
    typeNames = {
        'application/pdf': 'PDF',
        'image/jpeg': 'JPEG',
        'image/png': 'PNG'
    };
    
    typeIcons = {
        'application/pdf': 'fa-file-pdf',
        'image/jpeg': 'fa-file-image',
        'image/png': 'fa-file-image'
    };

    dragArea.addEventListener('click', function(e) {
        fileInput.value = '';
        fileInput.click();
    });

    dragArea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
            fileInput.value = '';
            fileInput.click();
            e.preventDefault();
        }
    });

    fileInput.addEventListener('change', handleFileSelect);

    dragArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dragArea.classList.add('active');
    });

    dragArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dragArea.classList.remove('active');
    });

    dragArea.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dragArea.classList.remove('active');
        if (e.dataTransfer.files.length) {
            handleFiles(e.dataTransfer.files);
        }
    });

    startButton.addEventListener('click', startAnalysis);
    
    clearAllBtn.addEventListener('click', function() {
        files = [];
        updateFileList();
    });

    // Set up the "Analyze Another Resume" button handler
document.getElementById('new-analysis-btn').addEventListener('click', function() {
    // Hide results, show upload interface
    document.getElementById('analysis-results').classList.add('hidden');
    document.getElementById('upload-interface').classList.remove('hidden');
    
    // Reset files array and update the UI
    files = [];
    updateFileList();
    
    // Re-enable the start button (though updateFileList should handle this)
    startButton.disabled = false;
    
    // Clear any error or status messages
    hideError();
    hideStatus();
});
});
    </script>

<!-- History Modal -->
<div id="history-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 flex-shrink-0">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold">Recent Analyses</h2>
                        <p class="text-blue-100 text-sm mt-1">Your analysis history and insights</p>
                    </div>
                    <button id="close-history-modal" class="text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <!-- History Stats -->
                <div class="mt-4 flex gap-6 text-sm">
                    <div class="bg-white/20 rounded-lg px-3 py-2">
                        <div class="font-semibold" id="total-analyses">0</div>
                        <div class="text-blue-100">Total Analyses</div>
                    </div>
                    <div class="bg-white/20 rounded-lg px-3 py-2">
                        <div class="font-semibold" id="total-candidates-analyzed">0</div>
                        <div class="text-blue-100">Candidates</div>
                    </div>
                    <div class="bg-white/20 rounded-lg px-3 py-2">
                        <div class="font-semibold" id="last-analysis-date">Never</div>
                        <div class="text-blue-100">Last Analysis</div>
                    </div>
                </div>

                <!-- Add after the stats section -->
                <div class="mt-4">
                    <input type="text" id="history-search" placeholder="Search analyses..." 
                           class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/70">
                </div>
            </div>
            
            <!-- Modal Content -->
            <div class="p-6 max-h-64 overflow-y-auto">
                <div id="history-list">
                    <!-- History items will be inserted here -->
                </div>
                
                <!-- Empty State -->
                <div id="history-empty" class="text-center py-12 hidden">
                    <i class="fas fa-history text-gray-300 text-4xl mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-600 mb-2">No Analyses Yet</h3>
                    <p class="text-gray-500 text-sm">Your analysis history will appear here after you analyze candidates.</p>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="bg-gray-50 px-6 py-4 flex justify-between items-center border-t flex-shrink-0">
                <div class="text-sm text-gray-500">
                    History is stored locally in your browser
                </div>
                <div class="flex gap-3">
                    <button id="export-history-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                        <i class="fas fa-download mr-2"></i>Export History
                    </button>
                    <button id="clear-history-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">
                        <i class="fas fa-trash mr-2"></i>Clear All
                    </button>
                </div>
            </div>
            
        </div>
    </div>
</div>

<!-- Footer with Support Links -->
<footer id="app-footer" class="bg-gray-50 border-t border-gray-200 py-8 mt-12">
    <div class="max-w-6xl mx-auto px-6">
        <div class="grid md:grid-cols-4 gap-8">
            <!-- Company Info -->
            <div>
                <img src="MontPro_logo_with_words-removebg-preview.png" alt="MontPro" class="h-8 mb-4">
                <p class="text-sm text-gray-600">
                    AI-powered recruitment analysis untuk mempercepat proses hiring Anda.
                </p>
            </div>
            
            <!-- Product -->
            <div>
                <h3 class="font-semibold text-gray-800 mb-3">Produk</h3>
                <ul class="space-y-2 text-sm text-gray-600">
                    <li><a href="#" onclick="showPricingPage()" class="hover:text-blue-600">Harga</a></li>
                    <li><a href="#" onclick="showFAQPage()" class="hover:text-blue-600">FAQ</a></li>
                    <li><a href="https://calendly.com/ardhipradhana/montpro_discovery" target="_blank" class="hover:text-blue-600">Demo</a></li>
                </ul>
            </div>
            
            <!-- Support -->
            <div>
                <h3 class="font-semibold text-gray-800 mb-3">Bantuan</h3>
                <ul class="space-y-2 text-sm text-gray-600">
                    <li><a href="#" onclick="showSupportPage()" class="hover:text-blue-600">Hubungi Kami</a></li>
                    <li><a href="#" onclick="showFAQPage()" class="hover:text-blue-600">FAQ</a></li>
                    <li><a href="mailto:support@aapgrp.com" class="hover:text-blue-600">Email Support</a></li>
                </ul>
            </div>
            
            <!-- Legal -->
            <div>
                <h3 class="font-semibold text-gray-800 mb-3">Legal</h3>
                <ul class="space-y-2 text-sm text-gray-600">
                    <li><a href="#" onclick="showTermsPage()" class="hover:text-blue-600">Syarat & Ketentuan</a></li>
                    <li><a href="#" onclick="showPrivacyPage()" class="hover:text-blue-600">Kebijakan Privasi</a></li>
                </ul>
            </div>
        </div>
        
        <div class="border-t border-gray-200 mt-8 pt-6 text-center text-sm text-gray-500">
            <p>&copy; 2025 MontPro. All rights reserved. Made with â¤ï¸ in Indonesia.</p>
        </div>
    </div>
</footer>
    
</body>
</html>
