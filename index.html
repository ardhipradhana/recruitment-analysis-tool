<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MontPro - Recruitment Analysis Tool</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .drag-area {
            border: 2px dashed #cbd5e1;
            border-radius: 0.75rem;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .drag-area.active {
            border-color: #3b82f6;
            background-color: #f0f9ff;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
        }
        
        .file-item:hover {
            background-color: #f8fafc;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .spinner {
            border: 3px solid rgba(59, 130, 246, 0.1);
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .btn-primary:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
        }
        
        .auth-form {
            background: linear-gradient(145deg, #ffffff, #f9fafb);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .score-circle {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: conic-gradient(#3b82f6 0%, #3b82f6 var(--score-percent), #e2e8f0 var(--score-percent), #e2e8f0 100%);
        position: relative;
    }
    
    .score-circle::before {
        content: '';
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background-color: white;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    
    .score-value {
        position: relative;
        z-index: 1;
        font-weight: bold;
        font-size: 28px;
        color: #1e40af;
        order: 2;
    }
    
    .score-label {
        position: relative;
        z-index: 1;
        font-size: 14px;
        color: #64748b;
        order: 1;
        margin-bottom: 2px;
    }
    
    /* Typing effect for loading animation */
    .typingEffect::after {
        content: '...';
        animation: dots 1.5s infinite;
        display: inline-block;
        width: 24px;
    }
    
    @keyframes dots {
        0%, 20% { content: '.'; }
        40% { content: '..'; }
        60%, 100% { content: '...'; }
    }
    
    /* Loading shimmer effect */
    @keyframes shimmer {
        0% { background-position: -1000px 0; }
        100% { background-position: 1000px 0; }
    }
    
    .loading-shimmer {
        background: linear-gradient(90deg, #f3f4f6 0%, #e5e7eb 50%, #f3f4f6 100%);
        background-size: 1000px 100%;
        animation: shimmer 2s infinite linear;
    }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Authentication Box -->
    <div id="auth-box" class="max-w-md mx-auto my-16 p-8 rounded-xl auth-form">
        <div class="flex justify-center mb-6">
            <img src="MontPro_logo_with_words-removebg-preview.png" alt="MontPro Logo" class="h-16 w-auto" />
        </div>
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Sign in to MontPro</h2>
        <div class="space-y-4">
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email address</label>
                <input id="email" type="email" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="name@company.com" required />
            </div>
            <button id="magic-btn" class="w-full py-3 px-4 btn-primary font-medium rounded-lg flex items-center justify-center">
                <i class="fas fa-magic mr-2"></i>
                <span>Send Magic Link</span>
            </button>
            <div id="auth-msg" class="text-center text-sm font-medium"></div>
        </div>
    </div>

    <!-- Main App (hidden until authenticated) -->
    <div id="main-app" class="max-w-5xl mx-auto p-6" style="display: none;">
        <!-- Header with Logo and Logout button -->
        <header class="flex justify-between items-center mb-8 pb-4 border-b border-gray-200">
            <div class="flex items-center space-x-4">
                <img src="MontPro_logo_with_words-removebg-preview.png" alt="MontPro Logo" class="h-12 w-auto" />
                <h1 class="text-2xl font-bold text-gray-800">Recruitment Analysis Tool</h1>
            </div>
            <button id="logout-btn" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white rounded-lg border border-gray-300 hover:bg-gray-50 hover:text-gray-900 transition-colors shadow-sm">
                <span>Log Out</span>
                <i class="fas fa-sign-out-alt ml-2"></i>
            </button>
        </header>

        <div id="upload-interface" class="bg-white rounded-xl shadow-sm p-8 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-2">Upload Candidate Documents</h2>
            <p class="text-gray-600 mb-6">Upload resumes and CVs for automated analysis and candidate evaluation</p>

            <!-- Hidden File Input -->
            <input type="file" id="file-input" multiple accept=".pdf,.jpg,.jpeg,.png" class="hidden">

            <!-- File Upload Area -->
            <div id="drag-area" class="drag-area bg-gray-50 hover:bg-gray-100 mb-6" tabindex="0">
                <i class="fas fa-cloud-upload-alt text-blue-500 text-4xl mb-4"></i>
                <h3 class="text-lg font-medium mb-1">Drag & drop files or click to browse</h3>
                <p class="text-sm text-gray-500">Supported formats: PDF</p>
            </div>
            
            <!-- File List -->
            <div id="file-list-container" class="mb-6 hidden">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-medium">Uploaded Documents (<span id="file-count">0</span>)</h3>
                    <button id="clear-all" class="text-sm text-gray-600 hover:text-red-600">
                        <i class="fas fa-trash-alt mr-1"></i> Clear all
                    </button>
                </div>
                <div id="file-list" class="space-y-2 max-h-64 overflow-y-auto pr-2"></div>
            </div>
            
            <!-- Error Message -->
            <div id="error-message" class="p-4 mb-4 bg-red-50 border-l-4 border-red-500 rounded-lg flex items-start hidden">
                <i class="fas fa-exclamation-circle text-red-500 mr-3 mt-0.5"></i>
                <p id="error-text" class="text-red-700 text-sm"></p>
            </div>
            
            <!-- Status Message -->
            <div id="status-message" class="p-4 mb-4 bg-blue-50 border-l-4 border-blue-500 rounded-lg flex items-start hidden">
                <div id="status-icon" class="mr-3 mt-0.5">
                    <div class="spinner"></div>
                </div>
                <p id="status-text" class="text-blue-700 text-sm"></p>
            </div>
            
            <!-- Start Analysis Button -->
            <button id="start-button" class="w-full py-3.5 px-4 btn-primary font-medium rounded-lg flex items-center justify-center disabled:opacity-70 disabled:cursor-not-allowed transition-all" disabled>
                <i class="fas fa-chart-line mr-2"></i>
                <span>Start Analysis</span>
            </button>
        </div>
        
        <div class="text-center text-sm text-gray-500">
            <p>This tool will analyze your candidate documents and extract relevant information for recruitment purposes.</p>
            <p class="mt-1">Â© 2025 MontPro. All rights reserved.</p>
        </div>
    </div>

    <!-- 1. Add the loading UI section right after your upload-interface section -->
<div id="analysis-loading" class="hidden">
    <div class="bg-white rounded-xl shadow-sm p-8 mb-8 text-center">
        <div class="mb-6">
            <div class="w-24 h-24 mx-auto mb-6 flex items-center justify-center relative">
                <!-- Outer ring animation -->
                <div class="absolute inset-0 border-4 border-blue-100 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-transparent border-t-blue-500 rounded-full animate-spin"></div>
                
                <!-- Inner icon -->
                <i class="fas fa-robot text-blue-500 text-3xl"></i>
            </div>
            <h2 class="text-xl font-semibold text-gray-800 mb-2">AI Analyzing Resume</h2>
            <p class="text-gray-600 typingEffect">Processing candidate information</p>
        </div>
        
        <div class="max-w-md mx-auto mb-8">
            <div class="flex justify-between text-sm text-gray-600 mb-1">
                <span id="loading-step">Extracting qualifications</span>
                <span id="loading-percent">25%</span>
            </div>
            <div class="progress-bar">
                <div id="progress-bar-fill" class="progress-bar-fill" style="width: 25%"></div>
            </div>
        </div>
        
        <div class="text-center text-sm text-gray-500 space-y-3">
            <div class="flex items-center justify-center">
                <div class="w-4 h-4 bg-green-500 rounded-full mr-2 flex items-center justify-center">
                    <i class="fas fa-check text-white text-xs"></i>
                </div>
                <span>Document uploaded successfully</span>
            </div>
            <div class="flex items-center justify-center">
                <div class="w-4 h-4 bg-green-500 rounded-full mr-2 flex items-center justify-center">
                    <i class="fas fa-check text-white text-xs"></i>
                </div>
                <span>Text extraction complete</span>
            </div>
            <div class="flex items-center justify-center">
                <div class="w-4 h-4 bg-blue-500 rounded-full mr-2 flex items-center justify-center animate-pulse">
                    <div class="w-2 h-2 bg-white rounded-full"></div>
                </div>
                <span>Skills and experience analysis in progress</span>
            </div>
            <div class="flex items-center justify-center opacity-50">
                <div class="w-4 h-4 border border-gray-300 rounded-full mr-2"></div>
                <span>Generating recommendations</span>
            </div>
        </div>
    </div>
</div>

<!-- 2. Add a simplified results section -->
<div id="analysis-results" class="hidden">
    <!-- Candidate Overview -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
        <div class="flex flex-col md:flex-row justify-between items-center md:items-start gap-6">
            <div>
                <div class="flex items-center mb-2">
                    <h2 id="candidate-name" class="text-2xl font-bold text-gray-800">Candidate Name</h2>
                    <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded">Free Trial</span>
                </div>
                
                <div class="flex flex-wrap gap-2 mt-2">
                    <span class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded-md">Resume Analysis</span>
                    <span class="text-xs bg-green-50 text-green-700 px-2 py-1 rounded-md">AI-Powered</span>
                    <span id="analysis-date" class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded-md">May 21, 2025</span>
                </div>
            </div>
            
            <div class="text-center">
                <div class="score-circle" style="--score-percent: 75%">
                    <div class="score-label">Score</div>
                    <div class="score-value" id="candidate-score">75</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Executive Summary -->
    <div class="analysis-card p-6 mb-6">
        <div class="flex items-center mb-4">
            <i class="fas fa-file-alt text-blue-500 mr-3"></i>
            <h3 class="text-lg font-semibold">Executive Summary</h3>
        </div>
        <div id="executive-summary" class="text-gray-700">
            <!-- Executive summary will be inserted here -->
        </div>
    </div>
    
    <!-- Core Competencies Preview -->
    <div class="analysis-card p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center">
                <i class="fas fa-brain text-blue-500 mr-3"></i>
                <h3 class="text-lg font-semibold">Core Competencies</h3>
            </div>
            <span class="text-sm text-gray-500">Top Skills Preview</span>
        </div>
        <div id="core-competencies" class="flex flex-wrap gap-1.5">
            <!-- Top skills will be inserted here -->
        </div>
    </div>
    
    <!-- Upgrade CTA -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl p-6 text-white mb-6">
    <div class="md:flex justify-between items-center">
        <div class="mb-4 md:mb-0">
            <h3 class="font-bold text-xl mb-2">Take Your Recruitment Process to the Next Level</h3>
            <p class="opacity-90 mb-2">Unlock advanced customization options and powerful features:</p>
            <ul class="list-disc pl-5 text-sm opacity-90 space-y-1">
                <li>Custom metrics tracking tailored to your hiring needs</li>
                <li>Batch upload via Google Drive for efficient processing</li>
                <li>Flexible output formats (Google Docs, Slides, Sheets, PDF)</li>
                <li>Personalized report templates to match your brand</li>
                <li>Match candidates against your specific job requirements</li>
            </ul>
        </div>
        <div class="mt-4 md:mt-0 flex-shrink-0 text-center">
            <p class="text-sm italic text-white opacity-80 mb-2">You've tried it, now make it yours.</p>
            <a href="https://calendly.com/ardhipradhana/montpro_discovery" class="inline-block px-6 py-3 bg-white text-purple-700 font-medium rounded-lg hover:bg-gray-100 transition-colors shadow-md">
                <i class="fas fa-magic mr-2"></i>
                Get My Tailored Version
            </a>
        </div>
    </div>
</div>
    
    <!-- Actions -->
    <div class="flex flex-col md:flex-row justify-between gap-4 mt-6">
        <button id="new-analysis-btn" class="px-4 py-2 btn-secondary rounded-lg flex items-center justify-center">
            <i class="fas fa-arrow-left mr-2"></i>
            Analyze Another Resume
        </button>
    </div>
</div>

    <script>
const supabaseUrl = 'https://saiwhkhgnsgakvbohwym.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNhaXdoa2hnbnNnYWt2Ym9od3ltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MzIxMjIsImV4cCI6MjA2MzMwODEyMn0.4MUgz7sYll0MYV30mwbAAYkLDs2MtPpSykgvWE10KuU';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// Global variables
let files = [];
let fileInput;
let dragArea;
let fileListContainer;
let fileList;
let fileCount;
let startButton;
let errorMessage;
let errorText;
let statusMessage;
let statusText;
let statusIcon;
let clearAllBtn;
let allowedTypes;
let typeNames;
let typeIcons;

function showMainApp() {
    document.getElementById('auth-box').style.display = 'none';
    document.getElementById('main-app').style.display = '';
}
function showAuthBox() {
    document.getElementById('auth-box').style.display = '';
    document.getElementById('main-app').style.display = 'none';
}
function showError(message) {
    errorText.textContent = message;
    errorMessage.classList.remove('hidden');
}

function hideError() {
    errorMessage.classList.add('hidden');
}

function showStatus(message, isComplete = false) {
    statusText.textContent = message;
    if (isComplete) {
        statusIcon.innerHTML = '<i class="fas fa-check-circle text-green-500 text-lg"></i>';
        statusMessage.classList.remove('bg-blue-50', 'border-blue-500');
        statusMessage.classList.add('bg-green-50', 'border-green-500');
        statusText.classList.remove('text-blue-700');
        statusText.classList.add('text-green-700');
    } else {
        statusIcon.innerHTML = '<div class="spinner"></div>';
        statusMessage.classList.add('bg-blue-50', 'border-blue-500');
        statusMessage.classList.remove('bg-green-50', 'border-green-500');
        statusText.classList.add('text-blue-700');
        statusText.classList.remove('text-green-700');
    }
    statusMessage.classList.remove('hidden');
}

function hideStatus() {
    statusMessage.classList.add('hidden');
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    else return (bytes / 1048576).toFixed(1) + ' MB';
}

function handleFileSelect(e) {
    handleFiles(e.target.files);
}

function handleFiles(selectedFiles) {
    const fileArray = Array.from(selectedFiles);
    const validFiles = fileArray.filter(file => allowedTypes.includes(file.type));
    
    if (validFiles.length < fileArray.length) {
        showError('Some files were not added. Only PDF, JPG and PNG formats are supported.');
    }
    
    if (validFiles.length > 0) {
        hideError();
        hideStatus();
    }
    
    files = [...files, ...validFiles];
    updateFileList();
}

function updateFileList() {
    if (files.length > 0) {
        fileListContainer.classList.remove('hidden');
        fileCount.textContent = files.length;
        startButton.disabled = false;
        fileList.innerHTML = '';
        
        files.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            
            const fileInfo = document.createElement('div');
            fileInfo.className = 'flex items-center';
            
            const fileTypeIcon = typeIcons[file.type] || 'fa-file';
            const icon = document.createElement('i');
            icon.className = `fas ${fileTypeIcon} text-blue-500 mr-3`;
            fileInfo.appendChild(icon);
            
            const details = document.createElement('div');
            details.innerHTML = `
                <p class="font-medium text-sm truncate max-w-xs">${file.name}</p>
                <p class="text-xs text-gray-500">
                    ${typeNames[file.type] || 'File'} Â· ${formatFileSize(file.size)}
                </p>
            `;
            fileInfo.appendChild(details);
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'text-gray-500 hover:text-red-500 transition-colors';
            removeBtn.innerHTML = '<i class="fas fa-times-circle"></i>';
            removeBtn.addEventListener('click', function() {
                removeFile(index);
            });
            
            fileItem.appendChild(fileInfo);
            fileItem.appendChild(removeBtn);
            fileList.appendChild(fileItem);
        });
    } else {
        fileListContainer.classList.add('hidden');
        startButton.disabled = true;
    }
}

function removeFile(index) {
    files = files.filter((_, i) => i !== index);
    updateFileList();
}

// Analysis functions
async function startAnalysis() {
    if (files.length === 0) {
        showError('Please upload at least one file before starting analysis.');
        return;
    }

    startButton.disabled = true;
    hideError();
    showAnalysisLoading();

    try {
        const formData = new FormData();
        files.forEach(file => {
            formData.append('files', file);
        });

        const response = await fetch('https://montpro.app.n8n.cloud/webhook/recruitment-analysis', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            throw new Error('Failed to process files. Server returned status: ' + response.status);
        }

        let data;
        const contentType = response.headers.get("content-type");
        const raw = await response.text();

        if (!raw || raw.trim().length === 0) {
            throw new Error("Empty response from server");
        }

        if (contentType && contentType.includes("application/json")) {
            data = JSON.parse(raw);
        } else {
            throw new Error("Invalid content-type or response format");
        }

        sessionStorage.setItem('analysisResults', JSON.stringify(data));
        showAnalysisResults(data);

    } catch (err) {
        console.error("Failed to handle JSON:", err);
        showError("An error occurred while handling the response. Please try again.");
        startButton.disabled = false;
        hideAnalysisLoading();
    }
}


function showAnalysisLoading() {
    document.getElementById('upload-interface').classList.add('hidden');
    document.getElementById('analysis-loading').classList.remove('hidden');
    
    // Simulate progress updates
    let progress = 0;
    const progressBar = document.getElementById('progress-bar-fill');
    const percentText = document.getElementById('loading-percent');
    const stepText = document.getElementById('loading-step');
    
    const progressInterval = setInterval(() => {
        progress += 5;
        
        if (progress <= 100) {
            progressBar.style.width = `${progress}%`;
            percentText.textContent = `${progress}%`;
            
            // Update loading step text based on progress
            if (progress < 30) {
                stepText.textContent = 'Extracting qualifications';
            } else if (progress < 60) {
                stepText.textContent = 'Analyzing skills and experience';
            } else if (progress < 90) {
                stepText.textContent = 'Evaluating candidate fit';
            } else {
                stepText.textContent = 'Finalizing results';
            }
        } else {
            clearInterval(progressInterval);
        }
    }, 300);
    
    // Store interval ID so we can clear it if needed
    window.progressInterval = progressInterval;
}

function hideAnalysisLoading() {
    document.getElementById('analysis-loading').classList.add('hidden');
    
    // Clear any running progress interval
    if (window.progressInterval) {
        clearInterval(window.progressInterval);
    }
}

function showAnalysisResults(data) {
    hideAnalysisLoading();
    document.getElementById('analysis-results').classList.remove('hidden');
    
    // Update candidate name if available
    if (data.candidateName) {
        document.getElementById('candidate-name').textContent = data.candidateName;
    }
    
    // Update score if available
    if (data.candidateScore) {
        const scoreValue = parseInt(data.candidateScore);
        document.getElementById('candidate-score').textContent = `${scoreValue}`;
        document.querySelector('.score-circle').style.setProperty('--score-percent', `${scoreValue}%`);
    }
    
    // Update executive summary
    if (data.executiveSummary) {
        document.getElementById('executive-summary').innerHTML = `<p>${data.executiveSummary}</p>`;
    }
    
    // Show core competencies preview
if (data.coreCompetencies) {
    const skillsContainer = document.getElementById('core-competencies');
    skillsContainer.innerHTML = '';
    
    // Parse skills - assuming coreCompetencies might be a string or an array
    let skills = [];
    if (Array.isArray(data.coreCompetencies)) {
        skills = data.coreCompetencies;
    } else if (typeof data.coreCompetencies === 'string') {
        // Format the text as paragraphs with bullet points preserved
        skillsContainer.innerHTML = data.coreCompetencies
            .replace(/\n/g, '<br>')
            .replace(/- /g, 'â¢ ');
        return; // Exit early as we've directly set the HTML
    }
    
    // If it's an array, show all skills
    skills.forEach(skill => {
        const badge = document.createElement('span');
        badge.className = 'skill-badge';
        badge.textContent = skill;
        skillsContainer.appendChild(badge);
    });
}
    
    // Update analysis date
    const today = new Date();
    document.getElementById('analysis-date').textContent = today.toLocaleDateString();
    
}

function setupDownloadPDF() {
    const downloadBtn = document.querySelector('#download-pdf-btn');
    if (downloadBtn) {
        downloadBtn.addEventListener('click', function() {
            // Get stored analysis results
            const analysisData = JSON.parse(sessionStorage.getItem('analysisResults') || '{}');
            
            // Generate a simple download or redirect to a PDF generation endpoint
            window.location.href = `https://montpro.app.n8n.cloud/webhook/generate-pdf?analysisId=${analysisData.analysisId || 'latest'}`;
            
            // Alternatively, show a success message
            showStatus('Your PDF report is being generated and will download shortly.', true);
            setTimeout(hideStatus, 5000);
        });
    }
}
async function signIn() {
    const emailEl = document.getElementById('email');
    const authMsg = document.getElementById('auth-msg');
    const email = emailEl.value.trim();
    
    if (!email) {
        authMsg.textContent = "Please enter your email address.";
        authMsg.className = "text-center text-sm font-medium text-red-600 mt-2";
        emailEl.focus();
        return;
    }
    
    // Email validation regex
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        authMsg.textContent = "Please enter a valid email address.";
        authMsg.className = "text-center text-sm font-medium text-red-600 mt-2";
        emailEl.focus();
        return;
    }
    
    const magicBtn = document.getElementById('magic-btn');
    const originalBtnHtml = magicBtn.innerHTML;
    
    // Update button to show loading state
    magicBtn.innerHTML = '<div class="spinner mr-2"></div> Sending...';
    magicBtn.disabled = true;
    
    authMsg.textContent = "";
    
    try {
        let { error } = await supabase.auth.signInWithOtp({ email });
        
        if (error) {
            authMsg.textContent = "Error: " + error.message;
            authMsg.className = "text-center text-sm font-medium text-red-600 mt-2";
            
            // Reset button
            magicBtn.innerHTML = originalBtnHtml;
            magicBtn.disabled = false;
        } else {
            authMsg.textContent = "Check your email for the sign-in link.";
            authMsg.className = "text-center text-sm font-medium text-green-600 mt-2";
            
            // Keep button disabled but change text
            magicBtn.innerHTML = '<i class="fas fa-check mr-2"></i> Link Sent';
            
            // Enable the button after 30 seconds
            setTimeout(() => {
                magicBtn.innerHTML = originalBtnHtml;
                magicBtn.disabled = false;
            }, 30000);
        }
    } catch (e) {
        authMsg.textContent = "Something went wrong. Please try again.";
        authMsg.className = "text-center text-sm font-medium text-red-600 mt-2";
        console.error(e);
        
        // Reset button
        magicBtn.innerHTML = originalBtnHtml;
        magicBtn.disabled = false;
    }
}

document.addEventListener("DOMContentLoaded", async function() {
    // 1. Process magic link
    await supabase.auth.getSession();

    // 2. Check if user is already logged in
    supabase.auth.getSession().then(({ data: { session } }) => {
        if (session) {
            showMainApp();
        } else {
            showAuthBox();
        }
    });

    // 3. Listen for auth state changes
    supabase.auth.onAuthStateChange((event, session) => {
        if (session) {
            showMainApp();
        }
    });

    // 4. Wire up the button after DOM is ready
    document.getElementById("magic-btn").onclick = signIn;
    document.getElementById('logout-btn').onclick = async function() {
        try {
            await supabase.auth.signOut();
            showAuthBox();
        } catch (error) {
            console.error("Error signing out:", error);
            showError("Failed to log out. Please try again.");
        }
    };

    // ---- File Handling and Analysis Logic ----
    fileInput = document.getElementById('file-input');
    dragArea = document.getElementById('drag-area');
    fileListContainer = document.getElementById('file-list-container');
    fileList = document.getElementById('file-list');
    fileCount = document.getElementById('file-count');
    startButton = document.getElementById('start-button');
    errorMessage = document.getElementById('error-message');
    errorText = document.getElementById('error-text');
    statusMessage = document.getElementById('status-message');
    statusText = document.getElementById('status-text');
    statusIcon = document.getElementById('status-icon');
    clearAllBtn = document.getElementById('clear-all');

    allowedTypes = ['application/pdf', 'image/jpeg', 'image/png'];
    typeNames = {
        'application/pdf': 'PDF',
        'image/jpeg': 'JPEG',
        'image/png': 'PNG'
    };
    
    typeIcons = {
        'application/pdf': 'fa-file-pdf',
        'image/jpeg': 'fa-file-image',
        'image/png': 'fa-file-image'
    };

    dragArea.addEventListener('click', function(e) {
        fileInput.value = '';
        fileInput.click();
    });

    dragArea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
            fileInput.value = '';
            fileInput.click();
            e.preventDefault();
        }
    });

    fileInput.addEventListener('change', handleFileSelect);

    dragArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dragArea.classList.add('active');
    });

    dragArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dragArea.classList.remove('active');
    });

    dragArea.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dragArea.classList.remove('active');
        if (e.dataTransfer.files.length) {
            handleFiles(e.dataTransfer.files);
        }
    });

    startButton.addEventListener('click', startAnalysis);
    
    clearAllBtn.addEventListener('click', function() {
        files = [];
        updateFileList();
    });

// Add PDF download setup
    setupDownloadPDF();

    // Set up the "Analyze Another Resume" button handler
document.getElementById('new-analysis-btn').addEventListener('click', function() {
    // Hide results, show upload interface
    document.getElementById('analysis-results').classList.add('hidden');
    document.getElementById('upload-interface').classList.remove('hidden');
    
    // Reset files array and update the UI
    files = [];
    updateFileList();
    
    // Re-enable the start button (though updateFileList should handle this)
    startButton.disabled = false;
    
    // Clear any error or status messages
    hideError();
    hideStatus();
});
});
    </script>
</body>
</html>
