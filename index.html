<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MontPro - Recruitment Engine</title>
    <link rel="icon" type="image/png" href="LinkedIn_Image_Template__15_-removebg-preview.png">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <!-- Add this after your other script tags -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Add this with your other script tags in the <head> section -->
    <script src="https://app.midtrans.com/snap/snap.js" data-client-key="Mid-client-CNEBcdeUWpDvMVXD"></script>
    <!-- Chart.js for radar charts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .drag-area {
            border: 2px dashed #cbd5e1;
            border-radius: 0.75rem;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .drag-area.active {
            border-color: #3b82f6;
            background-color: #f0f9ff;
            transform: scale(1.02); /* Add subtle scale */
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
        }
        
        .file-item:hover {
            background-color: #f8fafc;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .spinner {
            border: 3px solid rgba(59, 130, 246, 0.1);
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: linear-gradient(135deg, #1d4ed8, #1e40af);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .btn-primary:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
        }
        
        .auth-form {
            background: linear-gradient(145deg, #ffffff, #f9fafb);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }
        .score-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: conic-gradient(#3b82f6 0%, #3b82f6 var(--score-percent), #e2e8f0 var(--score-percent), #e2e8f0 100%);
            position: relative;
        }
    
        .score-circle::before {
            content: '';
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .score-value {
            position: relative;
            z-index: 1;
            font-weight: bold;
            font-size: 28px;
            color: #1e40af;
            order: 2;
        }
        
        .score-label {
            position: relative;
            z-index: 1;
            font-size: 14px;
            color: #64748b;
            order: 1;
            margin-bottom: 2px;
        }
        
        /* Typing effect for loading animation */
        .typingEffect::after {
            content: '...';
            animation: dots 1.5s infinite;
            display: inline-block;
            width: 24px;
        }
    
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        /* Loading shimmer effect */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        .loading-shimmer {
            background: linear-gradient(90deg, #f3f4f6 0%, #e5e7eb 50%, #f3f4f6 100%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite linear;
        }
        
/* Background Animation Styles */
.animated-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    overflow: hidden;
    z-index: 0;
}

.floating-card {
    position: absolute;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    animation: float 8s ease-in-out infinite;
}

.resume-card {
    width: 280px;
    padding: 20px;
    animation-delay: var(--delay);
}

.stats-card {
    width: 200px;
    padding: 16px;
    animation-delay: var(--delay);
}

.skill-floating {
    display: inline-block;
    background: linear-gradient(45deg, #3b82f6, #8b5cf6);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    margin: 2px;
    animation: skillPulse 3s ease-in-out infinite;
    animation-delay: var(--skill-delay);
}

.score-ring {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: conic-gradient(#10b981 0%, #10b981 var(--score), #e5e7eb var(--score), #e5e7eb 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.score-ring::before {
    content: '';
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: white;
    position: absolute;
}

.score-text {
    position: relative;
    z-index: 1;
    font-weight: bold;
    font-size: 14px;
    color: #059669;
}

@keyframes float {
    0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.7; }
    25% { transform: translateY(-20px) rotate(1deg); opacity: 1; }
    50% { transform: translateY(-10px) rotate(-1deg); opacity: 0.8; }
    75% { transform: translateY(-15px) rotate(0.5deg); opacity: 1; }
}

@keyframes skillPulse {
    0%, 100% { transform: scale(1); opacity: 0.8; }
    50% { transform: scale(1.05); opacity: 1; }
}

@keyframes slideIn {
    0% { transform: translateX(-100%); opacity: 0; }
    100% { transform: translateX(0); opacity: 1; }
}

@keyframes fadeInUp {
    0% { transform: translateY(20px); opacity: 0; }
    100% { transform: translateY(0); opacity: 1; }
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
    20%, 40%, 60%, 80% { transform: translateX(10px); }
}
        
.animate-slide-in {
    animation: slideIn 0.8s ease-out forwards;
    animation-delay: var(--anim-delay);
}

.animate-fade-up {
    animation: fadeInUp 0.6s ease-out forwards;
    animation-delay: var(--anim-delay);
}

/* Auth form styles */
.auth-container {
    position: relative;
    z-index: 10;
}
/* Multiple Candidates Layout */
.candidates-overview {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 24px;
    align-items: start;
    margin-left: 0;
    margin-right: 0;
    max-width: 100%;
    width: 100%;
}

.candidates-sidebar {
    position: sticky;
    top: 20px;
}

.candidate-summary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    text-align: center;
}

.sort-btn {
    transition: all 0.2s ease;
    font-weight: 500;
}

.sort-btn.active {
    background: rgba(255, 255, 255, 0.4) !important;
    font-weight: 600;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.sort-btn:hover {
    transform: translateY(-1px);
}

.candidate-grid {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 60vh;
    overflow-y: auto;
    padding-right: 8px;
}

/* Scrollbar styling for the candidate list */
.candidate-grid::-webkit-scrollbar {
    width: 6px;
}

.candidate-grid::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
}

.candidate-grid::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

.candidate-grid::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

.candidate-mini-card {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.candidate-mini-card:hover {
    border-color: #3b82f6;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    transform: translateY(-2px);
}

.candidate-mini-card.active {
    border-color: #3b82f6;
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
}

.candidate-mini-card.active::before {
    content: '';
    position: absolute;
    left: 0;
    top: 4px;
    bottom: 4px;
    width: 4px;
    background: #3b82f6;
    border-radius: 0 4px 4px 0;
}

.mini-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
}

.mini-card-info h4 {
    font-weight: 600;
    font-size: 14px;
    color: #1f2937;
    margin: 0 0 2px 0;
}

.mini-card-info p {
    font-size: 12px;
    color: #6b7280;
    margin: 0;
}

.mini-score-ring {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: conic-gradient(#10b981 0%, #10b981 var(--score), #e5e7eb var(--score), #e5e7eb 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    flex-shrink: 0;
}

.mini-score-ring::before {
    content: '';
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: white;
    position: absolute;
}

.mini-score-text {
    position: relative;
    z-index: 1;
    font-weight: bold;
    font-size: 11px;
    color: #059669;
}

.mini-skills {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
}

.mini-skill-tag {
    background: linear-gradient(45deg, #3b82f6, #8b5cf6);
    color: white;
    padding: 3px 10px;
    border-radius: 15px;
    font-size: 10px;
    font-weight: 500;
    display: inline-block;
    margin: 1px;
    box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
}

/* Search and Filter Styles */
.filter-section {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 16px;
}

.filter-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    font-size: 14px;
}

.filter-input::placeholder {
    color: rgba(255, 255, 255, 0.7);
}

.filter-input:focus {
    outline: none;
    border-color: rgba(255, 255, 255, 0.6);
    background: rgba(255, 255, 255, 0.15);
}

.score-range-slider {
    width: 100%;
    margin: 8px 0;
}

.filter-results-count {
    font-size: 11px;
    opacity: 0.8;
    margin-top: 8px;
}
        
.candidate-detail-view {
    flex: 1;
}

/* Progress bar styles */
.progress-bar {
    width: 100%;
    height: 8px;
    background-color: #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
}

.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #3b82f6, #8b5cf6);
    border-radius: 4px;
    transition: width 0.3s ease;
}

/* Single candidate view margins */
#single-candidate-view {
    margin-left: 24px;
    margin-right: 24px;
}
.connection-status {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        font-weight: 500;
    }

    .connection-status.online {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }

    .connection-status.offline {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
    }
        
/* Responsive design */
@media (max-width: 1024px) {
    .candidates-overview {
        grid-template-columns: 1fr;
        gap: 16px;
        margin-left: 20px;
        margin-right: 20px;
    }
    
    .candidates-sidebar {
        position: static;
        order: 2;
    }
    
    .candidate-detail-view {
        order: 1;
    }
    
    .candidate-grid {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 50vh;
    overflow-y: auto;
    }
    
    /* Responsive margins for single candidate view */
    #single-candidate-view {
        margin-left: 20px;
        margin-right: 20px;
    }
    /* Enhanced Error Handling Styles */
    .montpro-notification {
        position: fixed;
        top: 70px;
        right: 20px;
        z-index: 9999;
        max-width: 400px;
        transform: translateX(calc(100% + 20px));
        transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        border-radius: 12px;
        overflow: hidden;
    }

    .montpro-notification.show { 
        transform: translateX(0);
        animation: successBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    .montpro-notification.success { 
        background: linear-gradient(135deg, #10b981, #059669);
        position: relative;
    }

    .montpro-notification.success::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        animation: shimmerSuccess 2s ease-in-out;
    }
                                                                                        
    .montpro-notification.error { 
        background: linear-gradient(135deg, #ef4444, #dc2626);
        animation: errorShake 0.5s ease-in-out;
    }
    
    .montpro-notification.warning { 
        background: linear-gradient(135deg, #f59e0b, #d97706);
    }
    
    .montpro-notification.info { 
        background: linear-gradient(135deg, #3b82f6, #2563eb);
    }

    /* Success Animation Keyframes */
    @keyframes successBounce {
        0% { 
            transform: translateX(calc(100% + 20px)) scale(0.8);
            opacity: 0;
        }
        50% { 
            transform: translateX(-10px) scale(1.05);
            opacity: 1;
        }
        70% { 
            transform: translateX(5px) scale(0.98);
        }
        100% { 
            transform: translateX(0) scale(1);
            opacity: 1;
        }
    }
    
    @keyframes shimmerSuccess {
        0% { left: -100%; }
        50% { left: 100%; }
        100% { left: 100%; }
    }
    
    @keyframes errorShake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
        20%, 40%, 60%, 80% { transform: translateX(3px); }
    }
    
    /* Animated Checkmark for Success */
    .success-checkmark {
        display: inline-block;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        position: relative;
        margin-right: 8px;
        animation: checkmarkPulse 0.6s ease-in-out;
    }
    
    .success-checkmark::after {
        content: '‚úì';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-weight: bold;
        font-size: 12px;
        animation: checkmarkAppear 0.3s ease-in-out 0.2s both;
    }
    
    @keyframes checkmarkPulse {
        0% { transform: scale(0); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }
    
    @keyframes checkmarkAppear {
        0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
        100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }
    
    /* Enhanced button success states */
    .btn-success-pulse {
        animation: successPulse 0.6s ease-in-out;
    }
    
    @keyframes successPulse {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
        70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }

    @keyframes slideOut {
        0% { 
            transform: translateX(0) scale(1);
            opacity: 1;
        }
        100% { 
            transform: translateX(calc(100% + 20px)) scale(0.9);
            opacity: 0;
        }
    }

    .field-error-shake {
        animation: shake 0.5s ease-in-out;
        border: 2px solid #ef4444 !important;
        background: #fef2f2 !important;
    }
}

.support-page-hidden {
    display: none;
}
        
/* Enhanced Progress Styles */
.enhanced-loading {
    position: relative;
    overflow: hidden;
}

.enhanced-spinner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1;
}

.enhanced-progress-bar {
    background: linear-gradient(90deg, #e5e7eb 0%, #f3f4f6 50%, #e5e7eb 100%);
    background-size: 200% 100%;
    animation: shimmer 2s infinite linear;
}

.enhanced-progress-bar-fill {
    background: linear-gradient(90deg, #3b82f6, #8b5cf6);
    box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
    transition: all 0.3s ease;
}

.progress-modal-overlay {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Button loading states */
.btn-loading {
    position: relative;
    color: transparent !important;
}

.btn-loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top: 2px solid white;
    animation: spin 1s linear infinite;
}

/* Custom Confirmation Modal */
.batch-confirm-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
}

.batch-confirm-modal {
    background: white;
    border-radius: 16px;
    padding: 32px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    animation: modalSlideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

@keyframes modalSlideIn {
    from {
        transform: scale(0.8) translateY(-20px);
        opacity: 0;
    }
    to {
        transform: scale(1) translateY(0);
        opacity: 1;
    }
}
        
</style>
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-purple-50 min-h-screen">
    <!-- Animated Background -->
    <div class="animated-background">
        <!-- Resume Card 1 -->
        <div class="floating-card resume-card" style="--delay: 0s; top: 10%; left: 5%;">
            <div class="flex items-start justify-between mb-3">
                <div>
                    <h3 class="font-semibold text-gray-800 text-sm">Sarah Johnson</h3>
                    <p class="text-xs text-gray-500">Software Engineer</p>
                </div>
                <div class="score-ring" style="--score: 85%;">
                    <span class="score-text">85</span>
                </div>
            </div>
            <div class="mb-2">
                <span class="skill-floating" style="--skill-delay: 0.5s;">React</span>
                <span class="skill-floating" style="--skill-delay: 1s;">Python</span>
                <span class="skill-floating" style="--skill-delay: 1.5s;">AWS</span>
            </div>
            <div class="text-xs text-gray-600">
                <div class="flex items-center mb-1">
                    <i class="fas fa-briefcase text-blue-500 mr-2"></i>
                    <span>5+ years experience</span>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-graduation-cap text-green-500 mr-2"></i>
                    <span>CS Degree</span>
                </div>
            </div>
        </div>

        <!-- Resume Card 2 -->
        <div class="floating-card resume-card" style="--delay: 2s; top: 60%; right: 8%;">
            <div class="flex items-start justify-between mb-3">
                <div>
                    <h3 class="font-semibold text-gray-800 text-sm">Michael Chen</h3>
                    <p class="text-xs text-gray-500">Product Manager</p>
                </div>
                <div class="score-ring" style="--score: 92%;">
                    <span class="score-text">92</span>
                </div>
            </div>
            <div class="mb-2">
                <span class="skill-floating" style="--skill-delay: 0.3s;">Strategy</span>
                <span class="skill-floating" style="--skill-delay: 0.8s;">Analytics</span>
                <span class="skill-floating" style="--skill-delay: 1.3s;">Leadership</span>
            </div>
            <div class="text-xs text-gray-600">
                <div class="flex items-center mb-1">
                    <i class="fas fa-briefcase text-blue-500 mr-2"></i>
                    <span>8+ years experience</span>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-star text-yellow-500 mr-2"></i>
                    <span>Top 10% match</span>
                </div>
            </div>
        </div>

        <!-- Stats Card 1 -->
        <div class="floating-card stats-card" style="--delay: 1s; top: 20%; right: 15%;">
            <div class="text-center">
                <div class="text-2xl font-bold text-blue-600 mb-1">247</div>
                <div class="text-xs text-gray-600 mb-2">Resumes Analyzed</div>
                <div class="w-full bg-gray-200 h-2 rounded-full">
                    <div class="bg-blue-500 h-2 rounded-full" style="width: 73%; animation: slideIn 2s ease-out;"></div>
                </div>
            </div>
        </div>

        <!-- Stats Card 2 -->
        <div class="floating-card stats-card" style="--delay: 3s; bottom: 30%; left: 10%;">
            <div class="text-center">
                <div class="text-2xl font-bold text-green-600 mb-1">94%</div>
                <div class="text-xs text-gray-600 mb-2">Accuracy Rate</div>
                <div class="flex justify-center">
                    <i class="fas fa-check-circle text-green-500 mr-1"></i>
                    <span class="text-xs text-gray-600">AI Verified</span>
                </div>
            </div>
        </div>

        <!-- Resume Card 3 -->
        <div class="floating-card resume-card" style="--delay: 4s; bottom: 5%; left: 15%;">
            <div class="flex items-start justify-between mb-3">
                <div>
                    <h3 class="font-semibold text-gray-800 text-sm">Emma Rodriguez</h3>
                    <p class="text-xs text-gray-500">UX Designer</p>
                </div>
                <div class="score-ring" style="--score: 78%;">
                    <span class="score-text">78</span>
                </div>
            </div>
            <div class="mb-2">
                <span class="skill-floating" style="--skill-delay: 0.7s;">Figma</span>
                <span class="skill-floating" style="--skill-delay: 1.2s;">UI/UX</span>
                <span class="skill-floating" style="--skill-delay: 1.7s;">Research</span>
            </div>
            <div class="text-xs text-gray-600">
                <div class="flex items-center mb-1">
                    <i class="fas fa-palette text-purple-500 mr-2"></i>
                    <span>Design Portfolio</span>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-users text-blue-500 mr-2"></i>
                    <span>Team Lead</span>
                </div>
            </div>
        </div>

        <!-- Filter Dropdown Animation -->
        <div class="floating-card" style="--delay: 1.5s; top: 40%; left: 3%; width: 180px; padding: 12px;">
            <div class="text-xs font-medium text-gray-700 mb-2">Quick Filters</div>
            <div class="space-y-1">
                <div class="flex items-center animate-fade-up" style="--anim-delay: 0.2s;">
                    <input type="checkbox" class="mr-2" checked>
                    <span class="text-xs text-gray-600">5+ Years Exp</span>
                </div>
                <div class="flex items-center animate-fade-up" style="--anim-delay: 0.4s;">
                    <input type="checkbox" class="mr-2">
                    <span class="text-xs text-gray-600">Remote OK</span>
                </div>
                <div class="flex items-center animate-fade-up" style="--anim-delay: 0.6s;">
                    <input type="checkbox" class="mr-2" checked>
                    <span class="text-xs text-gray-600">Tech Skills</span>
                </div>
            </div>
        </div>

        <!-- Search Results Preview -->
        <div class="floating-card" style="--delay: 2.5s; top: 35%; left: 70%; width: 200px; padding: 16px;">
            <div class="flex items-center mb-2">
                <i class="fas fa-search text-blue-500 mr-2"></i>
                <span class="text-xs font-medium text-gray-700">Search Results</span>
            </div>
            <div class="space-y-2">
                <div class="animate-slide-in" style="--anim-delay: 0.5s;">
                    <div class="text-xs text-gray-800 font-medium">Frontend Developer</div>
                    <div class="text-xs text-green-600">12 matches found</div>
                </div>
                <div class="animate-slide-in" style="--anim-delay: 1s;">
                    <div class="text-xs text-gray-800 font-medium">Product Manager</div>
                    <div class="text-xs text-blue-600">8 matches found</div>
                </div>
            </div>
        </div>
    </div>
    <!-- Authentication Box -->
    <div class="auth-container">
    <div id="auth-box" class="max-w-md mx-auto my-16 p-8 rounded-xl auth-form relative z-10">
        <div class="flex justify-center mb-6">
            <img src="MontPro_logo_with_words-removebg-preview.png" alt="MontPro Logo" class="h-16 w-auto" />
        </div>
        
        <!-- NEW: Value-focused headline -->
        <div class="text-center mb-6">
            <h2 class="text-2xl font-bold mb-3 text-gray-800">Transform Hours of Resume Screening Into Minutes</h2>
            <p class="text-gray-600 text-sm leading-relaxed">The recruitment engine that turns overwhelming resume stacks into clear hiring decisions</p>
        </div>
        
        <!-- NEW: Quick wins preview -->
        <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 mb-6">
            <div class="text-center">
                <div class="text-2xl font-bold text-blue-600 mb-1">90%</div>
                <div class="text-xs text-gray-600 mb-3">Time Saved on Initial Screening</div>
                <div class="flex justify-center items-center text-xs text-gray-500">
                    <i class="fas fa-clock mr-1"></i>
                    <span>From 2 hours to 15 minutes per candidate</span>
                </div>
            </div>
        </div>
        
        <div class="space-y-4">
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Work email address</label>
                <input id="email" type="email" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="your.name@company.com" required />
            </div>
            <button id="magic-btn" class="w-full py-3 px-4 btn-primary font-medium rounded-lg flex items-center justify-center">
                <i class="fas fa-zap mr-2"></i>
                <span>Get Instant Access</span>
            </button>
            <!-- Google Sign In -->
            <div class="relative my-4">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-white text-gray-500">Or</span>
                </div>
            </div>
    
            <button id="google-signin-btn" class="w-full py-3 px-4 bg-white border border-gray-300 rounded-lg flex items-center justify-center hover:bg-gray-50 transition-colors">
                <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span class="font-medium text-gray-700">Continue with Google</span>
            </button>
            
            <!-- NEW: Trust signals -->
            <div class="text-center">
                <p class="text-xs text-gray-500 mb-2">
                    <i class="fas fa-shield-check mr-1 text-emerald-500"></i>
                    Secure ‚Ä¢ No spam ‚Ä¢ Cancel anytime
                </p>
            </div>
            
            <div id="auth-msg" class="text-center text-sm font-medium"></div>
        </div>
        
        <!-- Feature Preview -->
        <div class="mt-6 pt-6 border-t border-gray-200">
            <div class="text-center text-xs text-gray-500 mb-3">What you'll unlock instantly:</div>
            <div class="grid grid-cols-2 gap-3 text-xs">
                <div class="flex items-center">
                    <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center mr-2">
                        <i class="fas fa-robot text-blue-600 text-xs"></i>
                    </div>
                    <span class="text-gray-700">AI Analysis</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 bg-emerald-100 rounded-full flex items-center justify-center mr-2">
                        <i class="fas fa-bullseye text-emerald-600 text-xs"></i>
                    </div>
                    <span class="text-gray-700">Match Scoring</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center mr-2">
                        <i class="fas fa-search text-purple-600 text-xs"></i>
                    </div>
                    <span class="text-gray-700">Red Flag Detection</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 bg-orange-100 rounded-full flex items-center justify-center mr-2">
                        <i class="fas fa-users text-orange-600 text-xs"></i>
                    </div>
                    <span class="text-gray-700">Batch Processing</span>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Main App (hidden until authenticated) -->
    <div id="main-app" class="max-w-5xl mx-auto p-6 pt-28" style="display: none;">
        <!-- Header with Logo and Logout button -->
        <header class="fixed top-0 left-0 right-0 z-50 bg-white shadow-sm flex justify-between items-center px-6 py-4 border-b border-gray-200">
            <div class="flex items-center space-x-4 cursor-pointer hover:opacity-80 transition-opacity" onclick="goToHome()">
                <img src="MontPro_logo_with_words-removebg-preview.png" alt="MontPro Logo" class="h-12 w-auto" />
                <h1 class="text-2xl font-bold text-gray-800">Recruitment Engine</h1>
            </div>
            <div class="flex items-center gap-3 mr-28">
            <!-- History Button -->
            <button id="history-btn" class="flex items-center px-3 py-2 text-sm font-medium text-white bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg hover:from-blue-600 hover:to-blue-700 transition-colors shadow-sm">
                <i class="fas fa-history mr-2"></i>
                <span>Recent Analyses</span>
                <span id="history-count" class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full hidden">0</span>
            </button>

            <!-- Saved Candidates Button -->
            <button id="saved-candidates-btn" class="flex items-center px-3 py-2 text-sm font-medium text-white bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-lg hover:from-yellow-600 hover:to-yellow-700 transition-colors shadow-sm">
                <i class="fas fa-bookmark mr-2"></i>
                <span>Saved</span>
                <span id="saved-count" class="ml-2 px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full hidden">0</span>
            </button>
                
            <!-- Add this BEFORE the logout button -->
            <div class="flex items-center gap-3">
                <div id="usage-display" class="flex items-center px-3 py-2 text-sm font-medium bg-gradient-to-r from-gray-100 to-gray-200 rounded-lg shadow-sm">
                    <i class="fas fa-coins mr-2 text-gray-600"></i>
                    <span id="usage-text">Loading...</span>
                </div>
                <!-- Upgrade Button (shows only for free users or when credits are low) -->
                <button id="upgrade-btn" class="hidden px-3 py-2 text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg hover:from-blue-700 hover:to-purple-700 transition-colors shadow-sm" onclick="showPricingPage()">
                    <i class="fas fa-arrow-up mr-1"></i>
                    Upgrade
                </button>
            </div>
            
            <button id="logout-btn" class="flex items-center px-3 py-2 text-sm font-medium text-white bg-gradient-to-r from-gray-400 to-gray-500 rounded-lg hover:from-gray-500 hover:to-gray-600 transition-colors shadow-sm">
                <span>Log Out</span>
                <i class="fas fa-sign-out-alt ml-2"></i>
            </button>
        </header>

        <div id="upload-interface" class="bg-white rounded-xl shadow-sm p-8 mb-8">
            <!-- NEW: Engaging header section -->
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full mb-4">
                    <i class="fas fa-magic text-white text-2xl"></i>
                </div>
                <h2 class="text-2xl font-semibold text-gray-800 mb-2">Ready to Discover Hidden Talent?</h2>
                <p class="text-gray-600 max-w-md mx-auto">Upload resumes and watch our AI reveal insights that would take hours to uncover manually</p>
            </div>
        
            <!-- NEW: Quick benefits bar -->
            <div class="flex justify-center mb-8">
                <div class="grid grid-cols-3 gap-6 text-center">
                    <div class="flex flex-col items-center">
                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mb-2">
                            <i class="fas fa-bolt text-green-600 text-sm"></i>
                        </div>
                        <span class="text-xs text-gray-600">Instant Analysis</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mb-2">
                            <i class="fas fa-eye text-blue-600 text-sm"></i>
                        </div>
                        <span class="text-xs text-gray-600">Hidden Insights</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mb-2">
                            <i class="fas fa-bullseye text-purple-600 text-sm"></i>
                        </div>
                        <span class="text-xs text-gray-600">Perfect Matches</span>
                    </div>
                </div>
            </div>
        
            <!-- Hidden File Input -->
            <input type="file" id="file-input" multiple accept=".pdf,.jpg,.jpeg,.png" class="hidden">
        
            <!-- Enhanced File Upload Area -->
            <div id="drag-area" class="drag-area bg-gradient-to-br from-blue-50 to-purple-50 hover:from-blue-100 hover:to-purple-100 border-2 border-dashed border-blue-300 mb-6" tabindex="0">
                <div class="flex flex-col items-center">
                    <i class="fas fa-cloud-upload-alt text-blue-500 text-4xl mb-4"></i>
                    <h3 class="text-lg font-medium mb-2 text-gray-800">Drop your resumes here or click to browse</h3>
                    <p class="text-sm text-gray-500 mb-3">PDF files work best for accurate analysis</p>
                    <!-- NEW: Visual confidence booster -->
                    <div class="flex items-center text-xs text-gray-400">
                        <i class="fas fa-shield-check mr-1 text-emerald-500"></i>
                        <span>Your files are processed securely and never stored</span>
                    </div>
                </div>
            </div>
        
            <!-- Enhanced Sample Resume Section -->
            <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-6 mb-6 border border-green-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-play text-green-600"></i>
                        </div>
                        <div>
                            <h3 class="font-medium text-gray-800">New to MontPro? Try it instantly!</h3>
                            <p class="text-sm text-gray-600">See the magic with our sample resume - no upload needed</p>
                        </div>
                    </div>
                    <button id="sample-resume-btn" class="px-4 py-2 bg-green-500 text-white rounded-lg shadow-md hover:bg-green-600 hover:shadow-lg transition-all duration-200 flex items-center gap-2 whitespace-nowrap">
                        <i class="fas fa-rocket"></i>
                        <span>Try Demo</span>
                    </button>
                </div>
            </div>

            <!-- Job Description Input (update this section) -->
            <div id="job-description-section" class="mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-medium text-gray-800">Job Description (Optional)</h3>
                    <div class="flex items-center gap-2">
                        <span id="jd-feature-badge" class="px-2 py-1 bg-gradient-to-r from-purple-500 to-pink-600 text-white text-xs font-medium rounded shadow-sm">
                            <i class="fas fa-crown mr-1"></i>ULTRA Feature
                        </span>
                    </div>
                </div>

                <div class="relative">
                    <textarea 
                        id="job-description" 
                        class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition-all resize-none"
                        rows="6"
                        placeholder="Paste the job description here to get AI-powered candidate matching analysis...

            Example:
            - Required: 5+ years React experience
            - Preferred: Leadership experience
            - Must have: Strong communication skills"
                        disabled
                    ></textarea>
        
                    <!-- Clear Button (NEW) -->
                    <button 
                        id="clear-jd-btn" 
                        class="absolute top-2 right-2 p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors hidden"
                        title="Clear job description"
                        type="button"
                    >
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="mt-2 flex justify-between items-center text-sm text-gray-500">
                    <div class="flex items-center">
                        <i class="fas fa-info-circle mr-2"></i>
                        <span id="jd-info-text">Upgrade to ULTRA to unlock job description matching</span>
                    </div>
                    <span id="jd-char-count" class="text-xs text-gray-400 hidden">0 characters</span>
                </div>
            </div>
            
            <!-- File List -->
            <div id="file-list-container" class="mb-6 hidden">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-medium">Uploaded Documents (<span id="file-count">0</span>)</h3>
                    <button id="clear-all" class="text-sm text-gray-600 hover:text-red-600">
                        <i class="fas fa-trash-alt mr-1"></i> Clear all
                    </button>
                </div>
                <div id="file-list" class="space-y-2 max-h-64 overflow-y-auto pr-2"></div>
            </div>

            <div id="queue-info" class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg hidden">
                <!-- Queue status will be inserted here -->
            </div>
            
            <!-- Error Message -->
            <div id="error-message" class="p-4 mb-4 bg-red-50 border-l-4 border-red-500 rounded-lg flex items-start hidden">
                <i class="fas fa-exclamation-circle text-red-500 mr-3 mt-0.5"></i>
                <div class="flex-1">
                    <p id="error-text" class="text-red-700 text-sm mb-3"></p>
                    <button id="retry-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg flex items-center hover:bg-red-700 transition-colors text-sm hidden">
                        <i class="fas fa-redo mr-2"></i>
                        Retry Analysis
                    </button>
                </div>
            </div>
            
            <!-- Status Message -->
            <div id="status-message" class="p-4 mb-4 bg-blue-50 border-l-4 border-blue-500 rounded-lg flex items-start hidden">
                <div id="status-icon" class="mr-3 mt-0.5">
                    <div class="spinner"></div>
                </div>
                <p id="status-text" class="text-blue-700 text-sm"></p>
            </div>
            
            <!-- Start Analysis Button -->
            <button id="start-button" class="w-full py-3.5 px-4 btn-primary font-medium rounded-lg flex items-center justify-center disabled:opacity-70 disabled:cursor-not-allowed transition-all" disabled>
                <i class="fas fa-chart-line mr-2"></i>
                <span>Start Analysis</span>
            </button>

            <div class="text-center text-sm text-gray-500 mt-8">
                <p>This tool will analyze your candidate documents and extract relevant information for recruitment purposes.</p>
                <p class="mt-1">¬© 2025 MontPro. All rights reserved.</p>
            </div>
        </div>

        <div id="analysis-loading" class="hidden">
            <div class="bg-white rounded-xl shadow-sm p-8 mb-8 text-center">
                <div class="mb-6">
                    <!-- Enhanced loading animation -->
                    <div class="w-24 h-24 mx-auto mb-6 flex items-center justify-center relative">
                        <!-- Outer ring animation -->
                        <div class="absolute inset-0 border-4 border-blue-100 rounded-full"></div>
                        <div class="absolute inset-0 border-4 border-transparent border-t-blue-500 rounded-full animate-spin"></div>
                        
                        <!-- Inner icon with subtle pulse -->
                        <i class="fas fa-brain text-blue-500 text-3xl animate-pulse"></i>
                    </div>
                    
                    <!-- NEW: Engaging headlines -->
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">üîç Uncovering Hidden Talent...</h2>
                    <p class="text-gray-600 typingEffect">Our AI is reading between the lines to find what others miss</p>
                </div>
                
                <div class="max-w-md mx-auto mb-8">
                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                        <span id="loading-step">Extracting qualifications</span>
                        <span id="loading-percent">25%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progress-bar-fill" class="progress-bar-fill" style="width: 25%"></div>
                    </div>
                </div>
                
                <!-- NEW: Exciting step descriptions -->
                <div class="text-center text-sm text-gray-500 space-y-3" id="loading-checklist">
                    <div class="flex items-center justify-center">
                        <div class="w-4 h-4 bg-green-500 rounded-full mr-2 flex items-center justify-center">
                            <i class="fas fa-check text-white text-xs"></i>
                        </div>
                        <span>Resume received and secured</span>
                    </div>
                    <div class="flex items-center justify-center">
                        <div class="w-4 h-4 bg-green-500 rounded-full mr-2 flex items-center justify-center">
                            <i class="fas fa-check text-white text-xs"></i>
                        </div>
                        <span>Smart text extraction complete</span>
                    </div>
                    <div class="flex items-center justify-center">
                        <div class="w-4 h-4 bg-blue-500 rounded-full mr-2 flex items-center justify-center animate-pulse">
                            <div class="w-2 h-2 bg-white rounded-full"></div>
                        </div>
                        <span id="current-analysis-step">üß† Analyzing experience patterns and skill depth</span>
                    </div>
                    <div class="flex items-center justify-center opacity-50">
                        <div class="w-4 h-4 border border-gray-300 rounded-full mr-2"></div>
                        <span>üéØ Calculating compatibility scores</span>
                    </div>
                    <div class="flex items-center justify-center opacity-50">
                        <div class="w-4 h-4 border border-gray-300 rounded-full mr-2"></div>
                        <span>üìä Generating insights report</span>
                    </div>
                </div>
                
                <!-- NEW: Anticipation builder -->
                <div class="mt-8 p-4 bg-blue-50 rounded-lg">
                    <p class="text-sm text-blue-700 font-medium">üí° Pro Tip</p>
                    <p class="text-xs text-blue-600 mt-1">While we analyze, our AI is discovering skills and experiences that traditional keyword searches miss entirely.</p>
                </div>
            </div>
        </div>
        
        <!-- Replace your existing analysis-results div with this -->
        <div id="analysis-results" class="hidden">
            <!-- Single Candidate View (existing) -->
            <div id="single-candidate-view" style="max-width: none;">
                <!-- Your existing single candidate HTML stays exactly the same -->
                <!-- Candidate Overview -->
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <!-- Compact results header -->
                    <div class="text-center mb-4">
                        <div class="inline-flex items-center justify-center w-10 h-10 bg-green-100 rounded-full mb-2">
                            <i class="fas fa-magic text-green-600"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-1">‚ú® Analysis Complete!</h3>
                        <p class="text-sm text-gray-600">Here's what our AI discovered about this candidate</p>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <h2 id="candidate-name" class="text-2xl font-bold text-gray-800">Candidate Name</h2>
                                <span id="user-tier-badge" class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded">Free Trial</span>
                            </div>
                            
                            <div class="flex flex-wrap gap-2">
                                <span class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded-md">Resume Analysis</span>
                                <span class="text-xs bg-green-50 text-green-700 px-2 py-1 rounded-md">AI-Powered</span>
                                <span id="analysis-date" class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded-md">May 21, 2025</span>
                            </div>
                        </div>
                        
                        <!-- Compact score section -->
                        <div class="text-center relative ml-6">
                            <button class="save-candidate-btn absolute -top-2 -left-2 w-7 h-7 bg-transparent hover:bg-gray-100 text-gray-400 hover:text-gray-600 rounded-full flex items-center justify-center transition-colors z-10 border border-gray-300" 
                                    data-candidate-index="0"
                                    onclick="toggleSaveCandidate(0, event)" 
                                    title="Save candidate">
                                <i class="far fa-bookmark text-xs"></i>
                            </button>
                            
                            <!-- Simplified score circle -->
                            <div class="w-20 h-20 rounded-full bg-conic-gradient flex items-center justify-center mb-2 mx-auto" style="background: conic-gradient(#3b82f6 0%, #3b82f6 75%, #e2e8f0 75%, #e2e8f0 100%);">
                                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center">
                                    <span id="candidate-score" class="text-2xl font-bold text-blue-600">88</span>
                                </div>
                            </div>
                            
                            <!-- Centered info below -->
                            <div class="flex flex-col items-center space-y-1">
                                <span id="score-badge" class="px-2 py-1 bg-emerald-100 text-emerald-800 text-xs font-medium rounded-full">
                                    üéØ Strong Match
                                </span>
                                <div class="text-xs text-gray-500 flex items-center">
                                    <i class="fas fa-clock mr-1"></i>
                                    <span id="analysis-time">26s</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Executive Summary -->
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-file-alt text-blue-500 mr-3"></i>
                        <h3 class="text-lg font-semibold">Executive Summary</h3>
                    </div>
                    <div id="executive-summary" class="text-gray-700">
                        <!-- Executive summary will be inserted here -->
                    </div>
                </div>
                
                <!-- Core Competencies Preview -->
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <i class="fas fa-brain text-blue-500 mr-3"></i>
                            <h3 class="text-lg font-semibold">Core Competencies</h3>
                        </div>
                        <span class="text-sm text-gray-500">Top Skills Preview</span>
                    </div>
                    <div id="core-competencies" class="flex flex-wrap gap-1.5">
                        <!-- Top skills will be inserted here -->
                    </div>
                </div>
                
                <!-- Upgrade CTA -->
                <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl p-6 text-white mb-6">
                    <div class="md:flex justify-between items-center">
                        <div class="mb-4 md:mb-0">
                            <h3 class="font-bold text-xl mb-2">Take Your Recruitment Process to the Next Level</h3>
                            <p class="opacity-90 mb-2">Unlock advanced customization options and powerful features:</p>
                            <ul class="list-disc pl-5 text-sm opacity-90 space-y-1">
                                <li>Custom metrics tracking tailored to your hiring needs</li>
                                <li>Batch upload via Google Drive for efficient processing</li>
                                <li>Flexible output formats (Google Docs, Slides, Sheets, PDF)</li>
                                <li>Personalized report templates to match your brand</li>
                                <li>Match candidates against your specific job requirements</li>
                            </ul>
                        </div>
                        <div class="mt-4 md:mt-0 flex-shrink-0 text-center">
                            <p class="text-sm italic text-white opacity-80 mb-2">You've tried it, now make it yours.</p>
                            <a href="https://calendly.com/ardhipradhana/montpro_discovery" class="inline-block px-6 py-3 bg-white text-purple-700 font-medium rounded-lg hover:bg-gray-100 transition-colors shadow-md">
                                <i class="fas fa-magic mr-2"></i>
                                Get My Tailored Version
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        
            <!-- Multiple Candidates View (new) -->
            <div id="multiple-candidates-view" style="max-width: none;">
                <div class="candidates-overview">
                    <!-- Candidates Sidebar -->
                    <div class="candidates-sidebar">
                        <!-- Summary Header -->
                        <div class="candidate-summary">
                            <div class="text-2xl font-bold mb-1" id="total-candidates">5</div>
                            <div class="text-sm opacity-90">Candidates Analyzed</div>
                            <div class="mt-3 text-xs opacity-75" id="analysis-timestamp">
                                Analysis completed on May 22, 2025
                            </div>
        
                            <div class="mt-4 pt-3 border-t border-white/30">
                                <div class="text-xs opacity-75 mb-2">Sort by:</div>
                                <div class="flex gap-2">
                                    <button id="sort-score" class="sort-btn active px-2 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors">
                                        Score ‚Üì
                                    </button>
                                    <button id="sort-name" class="sort-btn px-2 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors">
                                        Name
                                    </button>
                                </div>
                            </div>
                            <!-- ADD THIS NEW SECTION -->
                            <div class="filter-section mt-4 pt-3 border-t border-white/30">
                                <div class="text-xs opacity-75 mb-2">Search & Filter:</div>
            
                                <!-- Search Input -->
                                <input type="text" id="candidate-search" class="filter-input mb-3" 
                                       placeholder="Search names, titles, skills..." 
                                       style="width: 100%; padding: 8px 12px; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; background: rgba(255,255,255,0.1); color: white; font-size: 14px;">
            
                                <!-- Score section (you already have this working) -->
                                <div class="text-xs opacity-75 mb-1">Min Score: <span id="score-display">0</span></div>
                                <input type="range" id="score-range" class="score-range-slider" min="0" max="100" value="0">
            
                                <!-- Results counter -->
                                <div id="filter-results" class="filter-results-count text-xs opacity-75 mt-2">
                                    Showing all candidates
                                </div>
                            </div>
                        </div>
        
                        <!-- Candidate Cards Grid -->
                        <div class="candidate-grid" id="candidate-cards">
                            <!-- Cards will be dynamically inserted here -->
                        </div>
                    </div>
        
                    <!-- Detailed View -->
                    <div class="candidate-detail-view">
                        <div id="selected-candidate-detail">
                            <!-- Selected candidate details will be shown here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Actions -->
            <div id="analysis-actions" class="flex flex-col md:flex-row justify-between gap-4 mt-6 hidden" style="margin-left: 20px; margin-bottom: 20px; margin-right: 20px;">
                <button id="new-analysis-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg flex items-center justify-center hover:bg-gray-300 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Analyze Another Resume
                </button>
            
                <div class="flex flex-col md:flex-row gap-3">
                    <!-- Export Dropdown -->
                    <div class="relative">
                        <button id="export-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg flex items-center justify-center hover:bg-green-700 transition-colors">
                            <i class="fas fa-download mr-2"></i>
                            Export Results
                            <i class="fas fa-chevron-down ml-2 text-xs"></i>
                        </button>
                    
                        <!-- Dropdown Menu -->
                        <div id="export-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-10 hidden">
                            <button id="export-csv" class="w-full px-4 py-2 text-left hover:bg-gray-50 rounded-t-lg flex items-center">
                                <i class="fas fa-file-csv text-green-600 mr-3"></i>
                                Export to CSV
                            </button>
                            <button id="copy-results" class="w-full px-4 py-2 text-left hover:bg-gray-50 flex items-center">
                                <i class="fas fa-copy text-blue-600 mr-3"></i>
                                Copy to Clipboard
                            </button>
                            <button id="email-results" class="w-full px-4 py-2 text-left hover:bg-gray-50 rounded-b-lg flex items-center">
                                <i class="fas fa-envelope text-purple-600 mr-3"></i>
                                Email Results
                            </button>
                        </div>
                    </div>
                
                    <button id="download-pdf-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg flex items-center justify-center hover:bg-blue-700 transition-colors">
                        <i class="fas fa-file-pdf mr-2"></i>
                        Download PDF
                    </button>
                </div>
            </div>
        
            <!-- Footer text also here for results page with bottom margin -->
            <div class="text-center mt-8 mb-8">
                <div class="inline-flex items-center bg-blue-50 border border-blue-200 rounded-lg px-4 py-3 max-w-2xl">
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                        <i class="fas fa-lightbulb text-blue-600 text-sm"></i>
                    </div>
                    <p class="text-sm text-blue-800 font-medium">
                        AI-powered insights to support your hiring expertise. Use alongside your professional judgment for optimal outcomes.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Pricing Page (add this RIGHT AFTER the main-app div) -->
    <div id="pricing-page" class="max-w-7xl mx-auto p-6" style="display: none;">
        <!-- Header -->
        <header class="text-center mb-12 mt-12">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">Become the Recruiter Who Never Misses Hidden Talent</h1>
            <p class="text-gray-600">Pick the analysis depth that matches your ambition</p>
        </header>

        <!-- Pricing Cards -->
        <div class="grid md:grid-cols-3 gap-8 max-w-7xl mx-auto">
        
            <!-- FREE TIER -->
            <div class="bg-white rounded-xl shadow-lg p-8 border border-gray-200 relative">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Starter</h2>
                    <div class="text-4xl font-bold text-gray-600 mb-2">Free</div>
                    <p class="text-gray-500">Discover your first hidden talents</p>
                </div>
            
                <ul class="space-y-3 mb-8">
                    <li class="flex items-center">
                        <i class="fas fa-check text-green-500 mr-3"></i>
                        <span>Automatic Candidate Score</span>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check text-green-500 mr-3"></i>
                        <span>Executive Summary</span>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check text-green-500 mr-3"></i>
                        <span>Core Competencies</span>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check text-green-500 mr-3"></i>
                        <span>Export Basic PDF</span>
                    </li>
                    <li class="flex items-center text-gray-400">
                        <i class="fas fa-times text-gray-400 mr-3"></i>
                        <span>Deep Analysis</span>
                    </li>
                    <li class="flex items-center text-gray-400">
                        <i class="fas fa-times text-gray-400 mr-3"></i>
                        <span>Red Flags Detection</span>
                    </li>
                </ul>
            
                <div class="w-full py-3 px-4 bg-orange-50 border border-orange-200 text-orange-700 font-medium rounded-lg text-center">
                    <i class="fas fa-hourglass-half mr-2"></i>
                    Limited to 3 analyses per month
                </div>
            </div>

            <!-- PROFESSIONAL TIER -->
            <div class="bg-white rounded-xl shadow-lg p-8 border-2 border-blue-500 relative">
                <!-- Recommended Badge -->
                <div class="absolute -top-4 left-1/2 transform -translate-x-1/2">
                    <span class="bg-blue-500 text-white px-4 py-1 rounded-full text-sm font-medium">Recommendation</span>
                </div>
            
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Professional</h2>
                    <div class="text-4xl font-bold text-blue-600 mb-2">Rp 599,000</div>
                    <p class="text-gray-500">30 Credits That Never Expire</p>
                    <p class="text-xs text-blue-600 mt-1 font-medium">Rp 19,967 per game-changing hire decision</p>
                </div>
            
                <ul class="space-y-3 mb-8">
                    <li class="flex items-center">
                        <div class="w-6 flex justify-start mr-3">
                            <i class="fas fa-exclamation-triangle text-red-500"></i>
                        </div>
                        <span>Red Flags & Risk Detection</span>
                    </li>
                    <li class="flex items-center">
                        <div class="w-6 flex justify-start mr-3">
                            <i class="fas fa-crosshairs text-gray-700"></i>
                        </div>
                        <span>Role Alignment & Potential Fit</span>
                    </li>
                    <li class="flex items-center">
                        <div class="w-6 flex justify-start mr-3">
                            <i class="fas fa-graduation-cap text-gray-700"></i>
                        </div>
                        <span>Education & Certifications Analysis</span>
                    </li>
                    <li class="flex items-center">
                        <div class="w-6 flex justify-start mr-3">
                            <i class="fas fa-comments text-gray-700"></i>
                        </div>
                        <span>Communication Quality Assessment</span>
                    </li>
                    <li class="flex items-center">
                        <div class="w-6 flex justify-start mr-3">
                            <i class="fas fa-lightbulb text-gray-700"></i>
                        </div>
                        <span>Strategic Hiring Recommendations</span>
                    </li>
                    <li class="flex items-center">
                        <div class="w-6 flex justify-start mr-3">
                            <i class="fas fa-chart-bar text-gray-700"></i>
                        </div>
                        <span>Detailed Candidate Scorecard</span>
                    </li>
                    <li class="flex items-center">
                        <div class="w-6 flex justify-start mr-3">
                            <i class="fas fa-check text-green-500"></i>
                        </div>
                        <span>Plus All Starter Features</span>
                    </li>
                    <li class="flex items-center text-blue-600 font-medium">
                        <div class="w-6 flex justify-start mr-3">
                            <i class="fas fa-infinity text-blue-500"></i>
                        </div>
                        <span>Credits Never Expire</span>
                    </li>
                </ul>
            
                <button id="upgrade-professional-btn" class="w-full py-3 px-4 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-rocket mr-2"></i>
                    Unlock PRO Power Now
                </button>
            
                <p class="text-xs text-gray-500 text-center mt-3">
                    Secure payment ‚Ä¢ Instant access ‚Ä¢ Start immediately
                </p>
            </div>

            <!-- ULTRA TIER -->
            <div class="bg-white rounded-xl shadow-lg p-8 border-2 border-purple-500 relative">
                <!-- Recommended Badge -->
                <div class="absolute -top-4 left-1/2 transform -translate-x-1/2">
                    <span class="bg-gradient-to-r from-purple-500 to-pink-600 text-white px-4 py-1 rounded-full text-sm font-medium">Most Powerful</span>
                </div>

                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Ultra</h2>
                    <div class="text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-2">Rp 999,000</div>
                    <p class="text-gray-500">20 Elite Analyses + Smart Job Matching</p>
                    <p class="text-xs text-purple-600 mt-1 font-medium">Rp 49,950 per perfect role-candidate fit</p>
                </div>

                <ul class="space-y-3 mb-8">
                    <li class="flex items-center">
                        <div class="w-6 flex justify-start mr-3">
                            <i class="fas fa-check text-green-500"></i>
                        </div>
                        <span class="font-medium">All Professional Features</span>
                    </li>
                    <li class="flex items-center">
                        <div class="w-6 flex justify-start mr-3">
                            <i class="fas fa-bullseye text-purple-500"></i>
                        </div>
                        <span class="font-weight-bold">Job Description Matching</span>
                    </li>
                    <li class="flex items-center">
                        <div class="w-6 flex justify-start mr-3">
                            <i class="fas fa-percentage text-purple-500"></i>
                        </div>
                        <span>Match Percentage & Reasoning</span>
                    </li>
                    <li class="flex items-center">
                        <div class="w-6 flex justify-start mr-3">
                            <i class="fas fa-lightbulb text-purple-500"></i>
                        </div>
                        <span>Gap Analysis & Recommendations</span>
                    </li>
                    <li class="flex items-center">
                        <div class="w-6 flex justify-start mr-3">
                            <i class="fas fa-chart-line text-purple-500"></i>
                        </div>
                        <span>Advanced Compatibility Scoring</span>
                    </li>
                    <li class="flex items-center">
                        <div class="w-6 flex justify-start mr-3">
                            <i class="fas fa-crosshairs text-purple-500"></i>
                        </div>
                        <span>Precise Role-Fit Analysis</span>
                    </li>
                    <li class="flex items-center text-purple-600 font-medium">
                        <div class="w-6 flex justify-start mr-3">
                            <i class="fas fa-crown text-purple-500"></i>
                        </div>
                        <span>Premium AI Analysis</span>
                    </li>
                    <li class="flex items-center text-purple-600 font-medium">
                        <div class="w-6 flex justify-start mr-3">
                            <i class="fas fa-infinity text-purple-500"></i>
                        </div>
                        <span>Credits Never Expire</span>
                    </li>
                </ul>

                <button id="upgrade-ultra-btn" class="w-full py-3 px-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-medium rounded-lg hover:from-purple-700 hover:to-pink-700 transition-colors">
                    <i class="fas fa-crown mr-2"></i>
                    <span id="ultra-btn-text">Unlock ULTRA Precision</span>
                </button>

                <p class="text-xs text-purple-600 text-center mt-3 font-medium">
                    Perfect job matching ‚Ä¢ Advanced AI ‚Ä¢ Instant access
                </p>
            </div>
        </div>

        <!-- Unified Middle Sections - Seamless Design -->
        <!-- Single Unified Container for Both Sections -->
        <div class="mt-12 bg-gradient-to-br from-gray-50 via-blue-50 to-purple-50 rounded-3xl p-8 shadow-xl border border-gray-100">
            
            <!-- Section 1: What Manual Screening Costs (Top Half) -->
            <div class="text-center mb-12">
                <!-- Warning Icon & Title -->
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-red-500 to-orange-500 rounded-full mb-6 shadow-lg">
                    <i class="fas fa-exclamation-triangle text-white text-2xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-3">What Manual Screening Actually Costs You</h3>
                <div class="w-24 h-1 bg-gradient-to-r from-red-500 to-orange-500 rounded-full mx-auto mb-8"></div>
                
                <!-- Stats Grid - More Elegant Layout -->
                <div class="max-w-4xl mx-auto">
                    <div class="grid md:grid-cols-3 gap-8 mb-6">
                        <div class="bg-white/70 backdrop-blur-sm rounded-2xl p-6 shadow-md border border-red-100">
                            <div class="text-3xl font-black text-red-600 mb-2">2-3 hours</div>
                            <div class="text-gray-600 text-sm">Per candidate review</div>
                        </div>
                        <div class="bg-white/70 backdrop-blur-sm rounded-2xl p-6 shadow-md border border-red-100">
                            <div class="text-3xl font-black text-red-600 mb-2">1 in 3</div>
                            <div class="text-gray-600 text-sm">Good candidates overlooked</div>
                        </div>
                        <div class="bg-white/70 backdrop-blur-sm rounded-2xl p-6 shadow-md border border-red-100">
                            <div class="text-3xl font-black text-red-600 mb-2">3-5x salary</div>
                            <div class="text-gray-600 text-sm">Bad hire total cost</div>
                        </div>
                    </div>
                    
                    <!-- Quote -->
                    <div class="bg-white/50 backdrop-blur-sm rounded-xl p-4 border border-orange-100">
                        <p class="text-sm text-gray-600 italic">
                            "Every hour spent manually screening is an hour NOT building relationships with top talent"
                        </p>
                    </div>
                </div>
            </div>
        
            <!-- Visual Separator/Transition -->
            <div class="flex items-center justify-center mb-12">
                <div class="flex-1 h-px bg-gradient-to-r from-transparent via-gray-300 to-transparent"></div>
                <div class="mx-6 w-12 h-12 bg-gradient-to-r from-slate-600 to-slate-800 rounded-full flex items-center justify-center shadow-lg">
                    <i class="fas fa-chevron-down text-white"></i>
                </div>
                <div class="flex-1 h-px bg-gradient-to-r from-transparent via-gray-300 to-transparent"></div>
            </div>
        
            <!-- Section 2: Your Productivity Transformation (Bottom Half) -->
            <div class="text-center">
                <!-- Success Icon & Title -->
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-green-500 to-blue-500 rounded-full mb-6 shadow-lg">
                    <i class="fas fa-bolt text-white text-2xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-3">Your Productivity Transformation in Numbers</h3>
                <div class="w-24 h-1 bg-gradient-to-r from-green-500 to-blue-500 rounded-full mx-auto mb-8"></div>
                
                <!-- VS Battle - More Integrated -->
                <div class="relative max-w-4xl mx-auto mb-8">
                    <!-- VS Badge -->
                    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-10">
                        <div class="bg-gradient-to-r from-red-500 to-green-500 text-white font-bold px-4 py-2 rounded-full shadow-lg text-sm">
                            VS
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-8">
                        <!-- Manual Screening (Problem) -->
                        <div class="bg-white/70 backdrop-blur-sm border-2 border-red-200 rounded-2xl p-6 text-center shadow-md">
                            <div class="w-12 h-12 bg-red-500 rounded-xl flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-clock text-white text-xl"></i>
                            </div>
                            <h4 class="font-bold text-gray-800 mb-3">Manual Screening</h4>
                            <div class="text-3xl font-black text-red-600 mb-2">Rp 43,650,000</div>
                            <div class="text-sm text-gray-600 bg-white/80 rounded-lg px-3 py-2">
                                30 candidates: 75 hours + bad hire risk
                            </div>
                        </div>
                        
                        <!-- MontPro Professional (Solution) -->
                        <div class="bg-white/70 backdrop-blur-sm border-2 border-green-200 rounded-2xl p-6 text-center shadow-md">
                            <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-rocket text-white text-xl"></i>
                            </div>
                            <h4 class="font-bold text-gray-800 mb-3">MontPro Professional</h4>
                            <div class="text-3xl font-black text-green-600 mb-2">Rp 599,000</div>
                            <div class="text-sm text-gray-600 bg-white/80 rounded-lg px-3 py-2">
                                30 analyses: 1 hour + better decisions
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Results Showcase - Integrated Style -->
                <div class="bg-gradient-to-r from-green-500 to-blue-600 rounded-2xl p-6 text-white shadow-xl max-w-4xl mx-auto mb-8">
                    <div class="flex items-center justify-center mb-4">
                        <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-chart-line text-white"></i>
                        </div>
                        <h4 class="text-xl font-bold">Your Transformation Results</h4>
                    </div>
                    
                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="bg-white/15 backdrop-blur-sm rounded-xl p-4">
                            <div class="text-2xl font-black mb-1">Rp 43,051,000</div>
                            <div class="text-sm opacity-90">Total Savings</div>
                        </div>
                        <div class="bg-white/15 backdrop-blur-sm rounded-xl p-4">
                            <div class="text-2xl font-black mb-1">7,280%</div>
                            <div class="text-sm opacity-90">ROI</div>
                        </div>
                        <div class="bg-white/15 backdrop-blur-sm rounded-xl p-4">
                            <div class="text-2xl font-black mb-1">10+x</div>
                            <div class="text-sm opacity-90">Increased Productivity</div>
                        </div>
                    </div>
                </div>
        
                <!-- Source Credibility - Integrated -->
                <div class="text-center">
                    <div class="inline-flex items-center bg-white/60 backdrop-blur-sm rounded-full px-4 py-2 text-xs text-gray-500 border border-gray-200">
                        <i class="fas fa-shield-check text-green-500 mr-2"></i>
                        <span>*Based on PayScale HR Manager salary data (Rp 175M/year) & Indonesian recruitment studies</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-2">
                        Sources: PayScale Indonesia, Glassdoor ID, McKinsey automation reports
                    </div>
                </div>
            </div>
        </div>
    
        <!-- What You Get Beyond Savings Section -->
        <div class="mt-12 bg-gradient-to-br from-gray-50 to-blue-50 rounded-2xl p-8">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full mb-4 shadow-lg">
                    <i class="fas fa-heart text-white text-2xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">What You Get Beyond Savings</h3>
                <p class="text-gray-600 max-w-2xl mx-auto">The numbers tell one story. The peace of mind tells another.</p>
                <div class="w-20 h-1 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full mx-auto mt-3"></div>
            </div>
        
            <div class="grid md:grid-cols-3 gap-8">
                
                <!-- Peace of Mind -->
                <div class="text-center">
                    <div class="w-16 h-16 bg-gradient-to-br from-green-400 to-emerald-500 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                        <i class="fas fa-moon text-white text-xl"></i>
                    </div>
                    <h4 class="text-lg font-bold text-gray-800 mb-3">Sleep Better at Night</h4>
                    <p class="text-gray-600 text-sm leading-relaxed">
                        No more anxiety about missing the perfect candidate or hiring the wrong person. 
                        <strong class="text-green-600">AI-powered confidence</strong> in every hiring decision.
                    </p>
                </div>
        
                <!-- Professional Confidence -->
                <div class="text-center">
                    <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                        <i class="fas fa-crown text-white text-xl"></i>
                    </div>
                    <h4 class="text-lg font-bold text-gray-800 mb-3">Lead with Data-Driven Insights</h4>
                    <p class="text-gray-600 text-sm leading-relaxed">
                        Present <strong class="text-purple-600">data-driven insights</strong> that impress leadership. 
                        Turn hiring meetings into strategic discussions, not guesswork sessions.
                    </p>
                </div>
        
                <!-- Specific Features -->
                <div class="text-center">
                    <div class="w-16 h-16 bg-gradient-to-br from-orange-400 to-red-500 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                        <i class="fas fa-magic text-white text-xl"></i>
                    </div>
                    <h4 class="text-lg font-bold text-gray-800 mb-3">Discover Hidden Talents</h4>
                    <p class="text-gray-600 text-sm leading-relaxed">
                        Uncover <strong class="text-orange-600">soft skills, leadership potential, and cultural fit</strong> 
                        that traditional screening completely misses.
                    </p>
                </div>
            </div>
        </div>
    
        <!-- Back Button -->
        <div class="text-center mt-12">
            <button id="back-to-app-btn" class="inline-flex items-center px-6 py-3 border-2 border-gray-300 text-gray-700 font-medium rounded-xl hover:border-blue-500 hover:text-blue-600 hover:bg-blue-50 transition-all duration-300 group">
                <i class="fas fa-arrow-left mr-2 group-hover:transform group-hover:-translate-x-1 transition-transform"></i>
                <span>Back to Upload & Analyze</span>
            </button>
        </div>
    </div>

     <!-- Support/Contact Page -->
<div id="support-page" class="max-w-4xl mx-auto p-6 support-page-hidden">
    <!-- Hero Section with Confidence Building -->
    <header class="text-center mb-12">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full mb-6">
            <i class="fas fa-headset text-white text-2xl"></i>
        </div>
        <h1 class="text-3xl font-bold text-gray-800 mb-4">We're Here to Help You Succeed</h1>
        <p class="text-gray-600 max-w-2xl mx-auto">
            Got a question? Need assistance? Our founder personally handles every support request to ensure you get the best recruitment analysis experience.
        </p>
        
        <!-- Quick Stats for Confidence -->
        <div class="mt-8 grid grid-cols-3 gap-6 max-w-md mx-auto">
            <div class="text-center">
                <div class="text-2xl font-bold text-blue-600">< 24h</div>
                <div class="text-xs text-gray-500">Response Time</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-green-600">100%</div>
                <div class="text-xs text-gray-500">Issues Resolved</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-purple-600">1:1</div>
                <div class="text-xs text-gray-500">Personal Support</div>
            </div>
        </div>
    </header>

    <div class="grid lg:grid-cols-2 gap-8">
        <!-- Quick Solutions First (Reduces Support Load) -->
        <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-6 border border-green-100">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-bolt text-green-500 mr-3"></i>
                Quick Solutions
            </h2>
            <p class="text-gray-600 text-sm mb-6">Try these first - most issues resolve instantly:</p>
            
            <div class="space-y-4">
                <div class="bg-white rounded-lg p-4 border border-green-200">
                    <h3 class="font-semibold text-green-800 mb-2 flex items-center">
                        <i class="fas fa-credit-card mr-2"></i>Credits Not Showing?
                    </h3>
                    <p class="text-sm text-green-700 mb-2">
                        <strong>Try this:</strong> Refresh the page or logout ‚Üí login again
                    </p>
                    <p class="text-xs text-green-600">Works 95% of the time ‚Ä¢ Takes 30 seconds</p>
                </div>
                
                <div class="bg-white rounded-lg p-4 border border-green-200">
                    <h3 class="font-semibold text-green-800 mb-2 flex items-center">
                        <i class="fas fa-file-pdf mr-2"></i>Analysis Not Working?
                    </h3>
                    <p class="text-sm text-green-700 mb-2">
                        <strong>Check:</strong> PDF is unprotected, under 10MB, good quality scan
                    </p>
                    <p class="text-xs text-green-600">Most common cause ‚Ä¢ Easy fix</p>
                </div>
                
                <div class="bg-white rounded-lg p-4 border border-green-200">
                    <h3 class="font-semibold text-green-800 mb-2 flex items-center">
                        <i class="fas fa-clock mr-2"></i>Analysis Taking Too Long?
                    </h3>
                    <p class="text-sm text-green-700 mb-2">
                        <strong>Normal:</strong> 1-2 minutes per resume ‚Ä¢ Keep tab open
                    </p>
                    <p class="text-xs text-green-600">Patience pays off ‚Ä¢ Premium analysis takes time</p>
                </div>
            </div>
        </div>

        <!-- Contact Information -->
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-envelope text-blue-500 mr-3"></i>
                Still Need Help?
            </h2>
            <p class="text-gray-600 text-sm mb-6">I personally read and respond to every message:</p>
            
            <div class="space-y-6">
                <!-- Email Support -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center mb-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-envelope text-blue-600"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-700">Email Support</h3>
                            <p class="text-xs text-gray-500">For all questions & issues</p>
                        </div>
                    </div>
                    <a href="mailto:support@aapgrp.com" 
                       class="text-blue-600 hover:text-blue-800 font-medium block mb-2">
                        support@aapgrp.com
                    </a>
                    <div class="bg-blue-50 rounded-lg p-3">
                        <p class="text-xs text-blue-700">
                            <i class="fas fa-clock mr-1"></i>
                            <strong>Response within 24 hours</strong> (Mon-Fri, Jakarta time)
                        </p>
                    </div>
                </div>
                
                <!-- Consultation Booking -->
                <div class="border border-purple-200 rounded-lg p-4 bg-purple-50">
                    <div class="flex items-center mb-3">
                        <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-video text-purple-600"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-700">30-Min Strategy Call</h3>
                            <p class="text-xs text-gray-500">For custom needs & enterprise</p>
                        </div>
                    </div>
                    <a href="https://calendly.com/ardhipradhana/montpro_discovery" 
                       class="text-purple-600 hover:text-purple-800 font-medium block mb-2" 
                       target="_blank">
                        Book Free Consultation
                    </a>
                    <p class="text-xs text-purple-700">
                        <i class="fas fa-star mr-1"></i>
                        Perfect for teams, custom features, or bulk processing needs
                    </p>
                </div>
                
                <!-- Pro Tip for Better Support -->
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <h4 class="font-semibold text-yellow-800 mb-2">
                        <i class="fas fa-lightbulb mr-2"></i>Pro Tip for Faster Help
                    </h4>
                    <p class="text-sm text-yellow-700">Include these details in your message:</p>
                    <ul class="text-xs text-yellow-600 mt-2 space-y-1">
                        <li>‚Ä¢ Your account email</li>
                        <li>‚Ä¢ What you were trying to do</li>
                        <li>‚Ä¢ Screenshot of any error (if applicable)</li>
                        <li>‚Ä¢ Your browser (Chrome, Safari, etc.)</li>
                    </ul>
                    <p class="text-xs text-yellow-600 mt-2 italic">
                        This helps me solve your issue faster! üöÄ
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Back Button -->
    <div class="text-center mt-12">
        <button id="back-from-support" class="inline-flex items-center px-6 py-3 border-2 border-gray-300 text-gray-700 font-medium rounded-xl hover:border-blue-500 hover:text-blue-600 hover:bg-blue-50 transition-all duration-300 group">
            <i class="fas fa-arrow-left mr-2 group-hover:transform group-hover:-translate-x-1 transition-transform"></i>
            <span>Back to Analysis</span>
        </button>
    </div>
</div>

<!-- FAQ Page -->
<div id="faq-page" class="max-w-4xl mx-auto p-6 support-page-hidden">
    <!-- Hero Section -->
    <header class="text-center mb-12">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-emerald-500 to-teal-600 rounded-full mb-6">
            <i class="fas fa-question-circle text-white text-2xl"></i>
        </div>
        <h1 class="text-3xl font-bold text-gray-800 mb-4">Frequently Asked Questions</h1>
        <p class="text-gray-600 max-w-2xl mx-auto">
            Everything you need to know about MontPro. Can't find your answer? 
            <a href="#" onclick="showSupportPage()" class="text-blue-600 hover:text-blue-800 font-medium">We're here to help</a>.
        </p>
    </header>

    <!-- FAQ Categories with Psychology-First Organization -->
    <div class="space-y-8">
        
        <!-- Getting Started (Reduces Initial Anxiety) -->
        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-100">
            <h2 class="text-xl font-bold text-blue-800 mb-6 flex items-center">
                <i class="fas fa-rocket mr-3"></i>Getting Started
            </h2>
            
            <div class="space-y-6">
                <div class="bg-white rounded-lg p-4 border border-blue-200">
                    <h3 class="font-semibold text-gray-800 mb-2">How quickly can I see results?</h3>
                    <p class="text-gray-600 text-sm mb-2">
                        <strong>Instantly!</strong> Upload a resume and get AI analysis in 1-2 minutes. No setup, no training required.
                    </p>
                    <div class="bg-green-50 rounded-lg p-2 mt-2">
                        <p class="text-xs text-green-700">
                            <i class="fas fa-zap mr-1"></i>Pro tip: Try our sample resume for an immediate demo
                        </p>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg p-4 border border-blue-200">
                    <h3 class="font-semibold text-gray-800 mb-2">What file formats work best?</h3>
                    <p class="text-gray-600 text-sm mb-2">
                        PDF files give the most accurate results. We support JPG/PNG too, but PDFs are recommended for professional analysis.
                    </p>
                    <p class="text-xs text-blue-600">
                        <i class="fas fa-shield-check mr-1"></i>All files are processed securely and never stored permanently
                    </p>
                </div>

                <div class="bg-white rounded-lg p-4 border border-blue-200">
                    <h3 class="font-semibold text-gray-800 mb-2">Is my data safe and private?</h3>
                    <p class="text-gray-600 text-sm mb-2">
                        <strong>Absolutely.</strong> Your files are processed in real-time and automatically deleted after analysis. We never store candidate data.
                    </p>
                    <p class="text-xs text-emerald-600">
                        <i class="fas fa-lock mr-1"></i>Bank-level encryption ‚Ä¢ GDPR compliant ‚Ä¢ No data retention
                    </p>
                </div>
            </div>
        </div>

        <!-- Credits & Billing (Addresses Money Concerns) -->
        <div class="bg-gradient-to-br from-emerald-50 to-green-50 rounded-xl p-6 border border-emerald-100">
            <h2 class="text-xl font-bold text-emerald-800 mb-6 flex items-center">
                <i class="fas fa-credit-card mr-3"></i>Credits & Billing
            </h2>
            
            <div class="space-y-6">
                <div class="bg-white rounded-lg p-4 border border-emerald-200">
                    <h3 class="font-semibold text-gray-800 mb-2">How do credits work?</h3>
                    <p class="text-gray-600 text-sm mb-2">
                        Simple: <strong>1 credit = 1 resume analysis</strong>. Free users get 3 per month. PRO/ULTRA credits never expire.
                    </p>
                    <div class="grid grid-cols-2 gap-2 mt-3">
                        <div class="bg-gray-50 rounded p-2 text-center">
                            <div class="text-lg font-bold text-gray-600">3</div>
                            <div class="text-xs text-gray-500">Free Monthly</div>
                        </div>
                        <div class="bg-emerald-50 rounded p-2 text-center">
                            <div class="text-lg font-bold text-emerald-600">‚àû</div>
                            <div class="text-xs text-emerald-600">Never Expire</div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg p-4 border border-emerald-200">
                    <h3 class="font-semibold text-gray-800 mb-2">What if credits don't appear after payment?</h3>
                    <p class="text-gray-600 text-sm mb-2">
                        <strong>First, try:</strong> Refresh the page or logout ‚Üí login. This fixes 95% of credit issues instantly.
                    </p>
                    <p class="text-xs text-emerald-600">
                        <i class="fas fa-headset mr-1"></i>Still not showing? Email us with your order ID for immediate help
                    </p>
                </div>

                <div class="bg-white rounded-lg p-4 border border-emerald-200">
                    <h3 class="font-semibold text-gray-800 mb-2">Can I get a refund?</h3>
                    <p class="text-gray-600 text-sm mb-2">
                        We offer refunds for technical issues or system errors within 7 days. Since credits never expire, there's no rush to use them.
                    </p>
                    <p class="text-xs text-blue-600">
                        <i class="fas fa-clock mr-1"></i>Try the free plan first to ensure MontPro fits your needs
                    </p>
                </div>
            </div>
        </div>

        <!-- Analysis Quality (Builds Trust in AI) -->
        <div class="bg-gradient-to-br from-purple-50 to-violet-50 rounded-xl p-6 border border-purple-100">
            <h2 class="text-xl font-bold text-purple-800 mb-6 flex items-center">
                <i class="fas fa-brain mr-3"></i>Analysis Quality
            </h2>
            
            <div class="space-y-6">
                <div class="bg-white rounded-lg p-4 border border-purple-200">
                    <h3 class="font-semibold text-gray-800 mb-2">How accurate is the AI analysis?</h3>
                    <p class="text-gray-600 text-sm mb-2">
                        Our AI is trained on thousands of successful hiring decisions. It spots patterns humans miss and provides consistent evaluation criteria.
                    </p>
                    <p class="text-xs text-purple-600">
                        <i class="fas fa-chart-line mr-1"></i>Continuous learning ‚Ä¢ Bias-free scoring ‚Ä¢ Professional HR standards
                    </p>
                </div>
                
                <div class="bg-white rounded-lg p-4 border border-purple-200">
                    <h3 class="font-semibold text-gray-800 mb-2">What if the analysis seems inaccurate?</h3>
                    <p class="text-gray-600 text-sm mb-2">
                        AI provides objective insights, but you're the hiring expert. Use our analysis as a <strong>starting point</strong> for deeper evaluation.
                    </p>
                    <div class="bg-yellow-50 rounded-lg p-2 mt-2">
                        <p class="text-xs text-yellow-700">
                            <i class="fas fa-lightbulb mr-1"></i>Best practice: Combine AI insights with interviews and reference checks
                        </p>
                    </div>
                </div>

                <div class="bg-white rounded-lg p-4 border border-purple-200">
                    <h3 class="font-semibold text-gray-800 mb-2">Why do PRO/ULTRA analyses provide more insights?</h3>
                    <p class="text-gray-600 text-sm mb-2">
                        Advanced tiers use more sophisticated AI models that analyze communication style, detect red flags, and provide strategic hiring recommendations.
                    </p>
                    <p class="text-xs text-purple-600">
                        <i class="fas fa-crown mr-1"></i>Think of it as the difference between a quick scan and a comprehensive evaluation
                    </p>
                </div>
            </div>
        </div>

        <!-- Technical Issues (Reduces Frustration) -->
        <div class="bg-gradient-to-br from-orange-50 to-red-50 rounded-xl p-6 border border-orange-100">
            <h2 class="text-xl font-bold text-orange-800 mb-6 flex items-center">
                <i class="fas fa-cog mr-3"></i>Technical Support
            </h2>
            
            <div class="space-y-6">
                <div class="bg-white rounded-lg p-4 border border-orange-200">
                    <h3 class="font-semibold text-gray-800 mb-2">Analysis is taking forever. What's wrong?</h3>
                    <p class="text-gray-600 text-sm mb-2">
                        <strong>Normal processing:</strong> 1-2 minutes per resume. Keep the tab open and avoid refreshing during analysis.
                    </p>
                    <p class="text-xs text-orange-600">
                        <i class="fas fa-clock mr-1"></i>Multiple files? Processing happens in batches for better quality
                    </p>
                </div>
                
                <div class="bg-white rounded-lg p-4 border border-orange-200">
                    <h3 class="font-semibold text-gray-800 mb-2">What browsers work best?</h3>
                    <p class="text-gray-600 text-sm mb-2">
                        Chrome, Safari, Firefox, and Edge all work perfectly. Make sure JavaScript is enabled and you're using a recent browser version.
                    </p>
                    <p class="text-xs text-blue-600">
                        <i class="fas fa-mobile-alt mr-1"></i>Mobile browsers work too, but desktop provides the best experience
                    </p>
                </div>

                <div class="bg-white rounded-lg p-4 border border-orange-200">
                    <h3 class="font-semibold text-gray-800 mb-2">Can I analyze password-protected PDFs?</h3>
                    <p class="text-gray-600 text-sm mb-2">
                        No, protected PDFs can't be processed. You'll need an unprotected version for analysis.
                    </p>
                    <p class="text-xs text-gray-500">
                        <i class="fas fa-unlock mr-1"></i>Most PDF editors can remove password protection easily
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Still Have Questions CTA -->
    <div class="mt-12 bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl p-8 text-white text-center">
        <h3 class="text-xl font-bold mb-2">Still Have Questions?</h3>
        <p class="mb-4 opacity-90">I personally respond to every message within 24 hours</p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <button onclick="showSupportPage()" class="px-6 py-3 bg-white text-blue-600 font-medium rounded-lg hover:bg-gray-50 transition-colors">
                <i class="fas fa-envelope mr-2"></i>Contact Support
            </button>
            <a href="https://calendly.com/ardhipradhana/montpro_discovery" target="_blank" class="px-6 py-3 bg-white/20 text-white font-medium rounded-lg hover:bg-white/30 transition-colors border border-white/30">
                <i class="fas fa-video mr-2"></i>Book 30-Min Call
            </a>
        </div>
    </div>
    
    <!-- Back Button -->
    <div class="text-center mt-8">
        <button id="back-from-faq" class="inline-flex items-center px-6 py-3 border-2 border-gray-300 text-gray-700 font-medium rounded-xl hover:border-blue-500 hover:text-blue-600 hover:bg-blue-50 transition-all duration-300 group">
            <i class="fas fa-arrow-left mr-2 group-hover:transform group-hover:-translate-x-1 transition-transform"></i>
            <span>Back to Analysis</span>
        </button>
    </div>
</div>

<!-- Terms Page -->
<div id="terms-page" class="max-w-4xl mx-auto p-6 support-page-hidden">
    <!-- Hero Section -->
    <header class="text-center mb-8">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full mb-6">
            <i class="fas fa-handshake text-white text-2xl"></i>
        </div>
        <h1 class="text-3xl font-bold text-gray-800 mb-4">Terms & Conditions</h1>
        <p class="text-gray-600 max-w-2xl mx-auto">
            Our commitment to you, explained in plain English. These terms protect both of us and ensure you get the best MontPro experience.
        </p>
        <div class="mt-4 text-sm text-gray-500">
            Last updated: June 2025 ‚Ä¢ 
            <a href="#" onclick="showSupportPage()" class="text-blue-600 hover:text-blue-800">Questions? Ask us anything</a>
        </div>
    </header>

    <!-- Summary Cards (Key Points First) -->
    <div class="grid md:grid-cols-3 gap-6 mb-8">
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
            <i class="fas fa-shield-check text-green-500 text-2xl mb-2"></i>
            <h3 class="font-semibold text-green-800 mb-1">Your Data is Safe</h3>
            <p class="text-xs text-green-700">We never store your candidate files permanently</p>
        </div>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
            <i class="fas fa-heart text-blue-500 text-2xl mb-2"></i>
            <h3 class="font-semibold text-blue-800 mb-1">Fair & Transparent</h3>
            <p class="text-xs text-blue-700">No hidden fees, clear refund policy</p>
        </div>
        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center">
            <i class="fas fa-users text-purple-500 text-2xl mb-2"></i>
            <h3 class="font-semibold text-purple-800 mb-1">You're in Control</h3>
            <p class="text-xs text-purple-700">Cancel anytime, keep your credits</p>
        </div>
    </div>

    <!-- Main Terms Content -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-100">
        <div class="p-8">
            
            <!-- Section 1: Service Usage -->
            <div class="mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-play-circle text-blue-500 mr-3"></i>
                    How You Can Use MontPro
                </h2>
                <div class="bg-blue-50 rounded-lg p-4 mb-4">
                    <p class="text-sm text-blue-800 mb-2">
                        <strong>What this means for you:</strong> Use MontPro for legitimate recruitment purposes. Be respectful of candidate privacy.
                    </p>
                </div>
                <div class="prose text-gray-600 text-sm">
                    <p class="mb-3">
                        By using MontPro, you agree to use our service responsibly and in compliance with applicable Indonesian law. This includes:
                    </p>
                    <ul class="list-disc pl-5 space-y-1">
                        <li>Using the service only for legitimate recruitment and hiring purposes</li>
                        <li>Respecting candidate privacy and data protection laws</li>
                        <li>Not attempting to reverse-engineer or misuse our AI technology</li>
                        <li>Following our community guidelines and treating all users respectfully</li>
                    </ul>
                </div>
            </div>

            <!-- Section 2: Account Security -->
            <div class="mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-lock text-green-500 mr-3"></i>
                    Your Account & Security
                </h2>
                <div class="bg-green-50 rounded-lg p-4 mb-4">
                    <p class="text-sm text-green-800 mb-2">
                        <strong>What this means for you:</strong> Keep your login secure. Report any suspicious activity immediately.
                    </p>
                </div>
                <div class="prose text-gray-600 text-sm">
                    <p class="mb-3">
                        You are responsible for maintaining the security of your account and password:
                    </p>
                    <ul class="list-disc pl-5 space-y-1">
                        <li>Use a strong, unique password for your MontPro account</li>
                        <li>Never share your login credentials with others</li>
                        <li>Report any unauthorized access immediately to support@aapgrp.com</li>
                        <li>You're responsible for all activity under your account</li>
                    </ul>
                </div>
            </div>

            <!-- Section 3: Payment & Refunds -->
            <div class="mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-credit-card text-purple-500 mr-3"></i>
                    Payments & Refunds
                </h2>
                <div class="bg-purple-50 rounded-lg p-4 mb-4">
                    <p class="text-sm text-purple-800 mb-2">
                        <strong>What this means for you:</strong> Credits never expire. Refunds available for technical issues within 7 days.
                    </p>
                </div>
                <div class="prose text-gray-600 text-sm">
                    <p class="mb-3">Our payment terms are designed to be fair and transparent:</p>
                    <ul class="list-disc pl-5 space-y-1">
                        <li><strong>Credits never expire</strong> - use them at your own pace</li>
                        <li>Refunds available within 7 days for technical issues or system errors</li>
                        <li>No refunds for used credits, but since they don't expire, there's no rush</li>
                        <li>All payments are processed securely through certified payment providers</li>
                        <li>Prices are clearly displayed before purchase with no hidden fees</li>
                    </ul>
                </div>
            </div>

            <!-- Section 4: Data Privacy -->
            <div class="mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-shield-alt text-emerald-500 mr-3"></i>
                    Your Data & Privacy
                </h2>
                <div class="bg-emerald-50 rounded-lg p-4 mb-4">
                    <p class="text-sm text-emerald-800 mb-2">
                        <strong>What this means for you:</strong> Your uploaded files are never stored permanently. Analysis results are yours to control.
                    </p>
                </div>
                <div class="prose text-gray-600 text-sm">
                    <p class="mb-3">We take your privacy seriously and handle data responsibly:</p>
                    <ul class="list-disc pl-5 space-y-1">
                        <li>Uploaded files are processed in real-time and automatically deleted</li>
                        <li>Analysis results are stored securely and can be deleted anytime</li>
                        <li>We never share your data with third parties</li>
                        <li>You retain full ownership of your recruitment data</li>
                        <li>GDPR compliant with industry-standard security measures</li>
                    </ul>
                </div>
            </div>

            <!-- Section 5: Service Limitations -->
            <div class="mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-exclamation-triangle text-yellow-500 mr-3"></i>
                    Important Limitations
                </h2>
                <div class="bg-yellow-50 rounded-lg p-4 mb-4">
                    <p class="text-sm text-yellow-800 mb-2">
                        <strong>What this means for you:</strong> Our AI provides insights to guide your decisions, but final hiring choices are always yours.
                    </p>
                </div>
                <div class="prose text-gray-600 text-sm">
                    <p class="mb-3">
                        MontPro analysis results are for reference and guidance only:
                    </p>
                    <ul class="list-disc pl-5 space-y-1">
                        <li>AI analysis does not replace professional judgment in recruitment</li>
                        <li>Final hiring decisions remain your responsibility</li>
                        <li>Results should be combined with interviews and reference checks</li>
                        <li>We cannot guarantee specific hiring outcomes</li>
                        <li>Service availability may vary during maintenance periods</li>
                    </ul>
                </div>
            </div>

            <!-- Contact Information -->
            <div class="bg-gray-50 rounded-lg p-6">
                <h3 class="font-bold text-gray-800 mb-3">Questions About These Terms?</h3>
                <p class="text-gray-600 text-sm mb-4">
                    We believe in transparency. If anything isn't clear, please ask! These terms are meant to protect both of us, not confuse you.
                </p>
                <div class="flex flex-col sm:flex-row gap-3">
                    <a href="mailto:support@aapgrp.com" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                        <i class="fas fa-envelope mr-2"></i>Email Us
                    </a>
                    <a href="https://calendly.com/ardhipradhana/montpro_discovery" target="_blank" class="inline-flex items-center px-4 py-2 border border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50 transition-colors text-sm">
                        <i class="fas fa-video mr-2"></i>Schedule Call
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Back Button -->
    <div class="text-center mt-8">
        <button id="back-from-terms" class="inline-flex items-center px-6 py-3 border-2 border-gray-300 text-gray-700 font-medium rounded-xl hover:border-blue-500 hover:text-blue-600 hover:bg-blue-50 transition-all duration-300 group">
            <i class="fas fa-arrow-left mr-2 group-hover:transform group-hover:-translate-x-1 transition-transform"></i>
            <span>Back to Analysis</span>
        </button>
    </div>
</div>

<!-- Privacy Policy Page -->
<div id="privacy-page" class="max-w-4xl mx-auto p-6 support-page-hidden">
    <!-- Hero Section -->
    <header class="text-center mb-8">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-emerald-500 to-teal-600 rounded-full mb-6">
            <i class="fas fa-user-shield text-white text-2xl"></i>
        </div>
        <h1 class="text-3xl font-bold text-gray-800 mb-4">Privacy Policy</h1>
        <p class="text-gray-600 max-w-2xl mx-auto">
            Your privacy is our priority. Here's exactly how we protect your data and respect your trust when you use MontPro.
        </p>
        <div class="mt-4 text-sm text-gray-500">
            Last updated: June 2025 ‚Ä¢ 
            <a href="#" onclick="showSupportPage()" class="text-blue-600 hover:text-blue-800">Privacy questions? Contact us</a>
        </div>
    </header>

    <!-- Privacy Promise Cards -->
    <div class="grid md:grid-cols-4 gap-4 mb-8">
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
            <i class="fas fa-trash text-green-500 text-xl mb-2"></i>
            <h3 class="font-semibold text-green-800 text-sm mb-1">Auto-Delete</h3>
            <p class="text-xs text-green-700">Files deleted after processing</p>
        </div>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
            <i class="fas fa-ban text-blue-500 text-xl mb-2"></i>
            <h3 class="font-semibold text-blue-800 text-sm mb-1">No Sharing</h3>
            <p class="text-xs text-blue-700">Never sold or shared</p>
        </div>
        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center">
            <i class="fas fa-lock text-purple-500 text-xl mb-2"></i>
            <h3 class="font-semibold text-purple-800 text-sm mb-1">Encrypted</h3>
            <p class="text-xs text-purple-700">Bank-level security</p>
        </div>
        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 text-center">
            <i class="fas fa-user-check text-orange-500 text-xl mb-2"></i>
            <h3 class="font-semibold text-orange-800 text-sm mb-1">Your Control</h3>
            <p class="text-xs text-orange-700">Delete anytime</p>
        </div>
    </div>

    <!-- Main Privacy Content -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-100">
        <div class="p-8">
            
            <!-- Section 1: What We Collect -->
            <div class="mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-list text-blue-500 mr-3"></i>
                    What Information We Collect
                </h2>
                <div class="bg-blue-50 rounded-lg p-4 mb-4">
                    <p class="text-sm text-blue-800 mb-2">
                        <strong>Bottom line:</strong> Only what's necessary to provide AI analysis and manage your account. No unnecessary tracking.
                    </p>
                </div>
                
                <div class="space-y-4">
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
                            <i class="fas fa-envelope text-blue-500 mr-2"></i>
                            Account Information
                        </h4>
                        <ul class="text-sm text-gray-600 list-disc pl-5 space-y-1">
                            <li>Email address (for login and communication)</li>
                            <li>Account preferences and settings</li>
                            <li>Usage statistics (to improve our service)</li>
                        </ul>
                    </div>
                    
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
                            <i class="fas fa-file-upload text-purple-500 mr-2"></i>
                            Files You Upload
                        </h4>
                        <ul class="text-sm text-gray-600 list-disc pl-5 space-y-1">
                            <li>Resume/CV files (processed in real-time, then automatically deleted)</li>
                            <li>Job descriptions (if you use ULTRA features)</li>
                        </ul>
                        <div class="mt-3 bg-green-50 rounded p-3">
                            <p class="text-xs text-green-700">
                                <i class="fas fa-shield-check mr-1"></i>
                                <strong>Important:</strong> Original files are never stored permanently on our servers
                            </p>
                        </div>
                    </div>
                    
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
                            <i class="fas fa-chart-bar text-emerald-500 mr-2"></i>
                            Analysis Results
                        </h4>
                        <ul class="text-sm text-gray-600 list-disc pl-5 space-y-1">
                            <li>AI-generated analysis summaries and scores</li>
                            <li>Your saved candidates and comparisons</li>
                            <li>Export history and preferences</li>
                        </ul>
                        <div class="mt-3 bg-blue-50 rounded p-3">
                            <p class="text-xs text-blue-700">
                                <i class="fas fa-user-check mr-1"></i>
                                <strong>Your control:</strong> You can delete all analysis results anytime from your account
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 2: How We Use Information -->
            <div class="mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-cogs text-purple-500 mr-3"></i>
                    How We Use Your Information
                </h2>
                <div class="bg-purple-50 rounded-lg p-4 mb-4">
                    <p class="text-sm text-purple-800 mb-2">
                        <strong>Simple purpose:</strong> To provide AI analysis and improve our service. We never use your data for advertising or sell it to others.
                    </p>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="border border-green-200 bg-green-50 rounded-lg p-4">
                        <h4 class="font-semibold text-green-800 mb-2">‚úÖ What We Do</h4>
                        <ul class="text-sm text-green-700 space-y-1">
                            <li>‚Ä¢ Process resumes for AI analysis</li>
                            <li>‚Ä¢ Store your analysis results securely</li>
                            <li>‚Ä¢ Send service updates and support responses</li>
                            <li>‚Ä¢ Improve our AI models (anonymously)</li>
                            <li>‚Ä¢ Provide customer support</li>
                        </ul>
                    </div>
                    
                    <div class="border border-red-200 bg-red-50 rounded-lg p-4">
                        <h4 class="font-semibold text-red-800 mb-2">‚ùå What We Never Do</h4>
                        <ul class="text-sm text-red-700 space-y-1">
                            <li>‚Ä¢ Sell your data to third parties</li>
                            <li>‚Ä¢ Use your data for advertising</li>
                            <li>‚Ä¢ Share candidate information</li>
                            <li>‚Ä¢ Store uploaded files permanently</li>
                            <li>‚Ä¢ Send marketing emails without permission</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Section 3: Data Security -->
            <div class="mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-shield-alt text-emerald-500 mr-3"></i>
                    How We Protect Your Data
                </h2>
                <div class="bg-emerald-50 rounded-lg p-4 mb-4">
                    <p class="text-sm text-emerald-800 mb-2">
                        <strong>Enterprise-grade security:</strong> We use the same encryption and security measures as major banks and tech companies.
                    </p>
                </div>
                
                <div class="space-y-4">
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-lock text-blue-500 mr-2"></i>
                            Encryption & Security
                        </h4>
                        <div class="grid md:grid-cols-2 gap-4 text-sm text-gray-600">
                            <div>
                                <ul class="space-y-1">
                                    <li>‚Ä¢ SSL/TLS encryption for all data transfers</li>
                                    <li>‚Ä¢ AES-256 encryption for stored data</li>
                                    <li>‚Ä¢ Regular security audits and updates</li>
                                </ul>
                            </div>
                            <div>
                                <ul class="space-y-1">
                                    <li>‚Ä¢ Secure cloud infrastructure (AWS/Google)</li>
                                    <li>‚Ä¢ Access controls and monitoring</li>
                                    <li>‚Ä¢ GDPR compliant data handling</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-clock text-purple-500 mr-2"></i>
                            Automatic Data Deletion
                        </h4>
                        <div class="text-sm text-gray-600">
                            <p class="mb-2">We automatically delete sensitive data to minimize risk:</p>
                            <ul class="space-y-1 list-disc pl-5">
                                <li><strong>Uploaded files:</strong> Deleted immediately after processing (within minutes)</li>
                                <li><strong>Temporary processing data:</strong> Cleared every 24 hours</li>
                                <li><strong>Saved candidates:</strong> Cleaned up after 6 months of inactivity</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 4: Your Privacy Rights -->
            <div class="mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-user-cog text-orange-500 mr-3"></i>
                    Your Privacy Rights & Control
                </h2>
                <div class="bg-orange-50 rounded-lg p-4 mb-4">
                    <p class="text-sm text-orange-800 mb-2">
                        <strong>You're in control:</strong> Access, modify, or delete your data anytime. No questions asked.
                    </p>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="space-y-3">
                        <div class="border border-blue-200 rounded-lg p-3">
                            <h4 class="font-semibold text-blue-800 text-sm mb-1">üì• Access Your Data</h4>
                            <p class="text-xs text-blue-700">Download all your analysis results and account data</p>
                        </div>
                        <div class="border border-purple-200 rounded-lg p-3">
                            <h4 class="font-semibold text-purple-800 text-sm mb-1">‚úèÔ∏è Modify Information</h4>
                            <p class="text-xs text-purple-700">Update account details and preferences anytime</p>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="border border-red-200 rounded-lg p-3">
                            <h4 class="font-semibold text-red-800 text-sm mb-1">üóëÔ∏è Delete Everything</h4>
                            <p class="text-xs text-red-700">Completely remove your account and all associated data</p>
                        </div>
                        <div class="border border-green-200 rounded-lg p-3">
                            <h4 class="font-semibold text-green-800 text-sm mb-1">üõë Opt-Out Anytime</h4>
                            <p class="text-xs text-green-700">Unsubscribe from communications with one click</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 5: Third-Party Services -->
            <div class="mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-handshake text-indigo-500 mr-3"></i>
                    Third-Party Services We Use
                </h2>
                <div class="bg-indigo-50 rounded-lg p-4 mb-4">
                    <p class="text-sm text-indigo-800 mb-2">
                        <strong>Transparency first:</strong> We work with trusted partners who meet our privacy standards.
                    </p>
                </div>
                
                <div class="space-y-3">
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 mb-2">üîê Authentication & Payments</h4>
                        <div class="text-sm text-gray-600">
                            <p class="mb-2">We use industry-standard services for security:</p>
                            <ul class="list-disc pl-5 space-y-1">
                                <li><strong>Supabase:</strong> Secure user authentication and database</li>
                                <li><strong>Midtrans:</strong> Payment processing (they never see your analysis data)</li>
                                <li><strong>Google/AWS:</strong> Cloud infrastructure with enterprise security</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <p class="text-xs text-yellow-800">
                            <i class="fas fa-info-circle mr-1"></i>
                            <strong>Important:</strong> These partners only receive the minimum data necessary for their specific function (like processing payments). They never access your recruitment data or analysis results.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Contact & Updates Section -->
            <div class="bg-gray-50 rounded-lg p-6">
                <h3 class="font-bold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-envelope text-blue-500 mr-2"></i>
                    Questions About Your Privacy?
                </h3>
                <p class="text-gray-600 text-sm mb-4">
                    Privacy shouldn't be confusing. If you have any questions about how we handle your data, please ask! We're committed to complete transparency.
                </p>
                
                <div class="space-y-3">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <a href="mailto:support@aapgrp.com" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                            <i class="fas fa-envelope mr-2"></i>Email Privacy Questions
                        </a>
                        <a href="mailto:support@aapgrp.com?subject=Delete%20My%20Data" class="inline-flex items-center px-4 py-2 border border-red-600 text-red-600 rounded-lg hover:bg-red-50 transition-colors text-sm">
                            <i class="fas fa-trash mr-2"></i>Request Data Deletion
                        </a>
                    </div>
                    
                    <div class="text-xs text-gray-500">
                        <p><strong>Policy Updates:</strong> We'll notify you of any significant privacy policy changes via email. Minor updates will be posted here with the updated date.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Back Button -->
    <div class="text-center mt-8">
        <button id="back-from-privacy" class="inline-flex items-center px-6 py-3 border-2 border-gray-300 text-gray-700 font-medium rounded-xl hover:border-blue-500 hover:text-blue-600 hover:bg-blue-50 transition-all duration-300 group">
            <i class="fas fa-arrow-left mr-2 group-hover:transform group-hover:-translate-x-1 transition-transform"></i>
            <span>Back to Analysis</span>
        </button>
    </div>
</div>

<!-- Saved Candidates Page -->
<div id="saved-candidates-page" class="mx-auto px-6 py-6 support-page-hidden">
   <!-- Main App Header (replicated for consistency) -->
   <header class="flex justify-between items-center mb-8 pb-4 border-b border-gray-200">
       <div class="flex items-center space-x-4 cursor-pointer hover:opacity-80 transition-opacity" onclick="goToHome()">
           <img src="MontPro_logo_with_words-removebg-preview.png" alt="MontPro Logo" class="h-12 w-auto" />
           <div>
               <h1 class="text-2xl font-bold text-gray-800">Recruitment Engine</h1>
               <div class="flex items-center text-sm text-gray-500 mt-1">
                   <span>Home</span>
                   <i class="fas fa-chevron-right mx-2 text-xs"></i>
                   <span class="text-yellow-600 font-medium">Saved Candidates</span>
               </div>
           </div>
       </div>
       <div class="flex items-center gap-3 mr-28">
           <!-- History Button -->
           <button id="history-btn-saved" class="flex items-center px-3 py-2 text-sm font-medium text-white bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg hover:from-blue-600 hover:to-blue-700 transition-colors shadow-sm">
               <i class="fas fa-history mr-2"></i>
               <span>Recent Analyses</span>
               <span id="history-count-saved" class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full hidden">0</span>
           </button>

           <!-- Usage Display -->
           <div id="usage-display-saved" class="flex items-center px-3 py-2 text-sm font-medium bg-gradient-to-r from-gray-100 to-gray-200 rounded-lg shadow-sm">
               <i class="fas fa-coins mr-2 text-gray-600"></i>
               <span id="usage-text-saved">Loading...</span>
           </div>
           
           <button id="logout-btn-saved" class="flex items-center px-3 py-2 text-sm font-medium text-white bg-gradient-to-r from-gray-400 to-gray-500 rounded-lg hover:from-gray-500 hover:to-gray-600 transition-colors shadow-sm">
               <span>Log Out</span>
               <i class="fas fa-sign-out-alt ml-2"></i>
           </button>
       </div>
   </header>

   <!-- Page Title Section (enhanced) -->
   <div class="bg-gradient-to-r from-yellow-50 to-amber-50 rounded-xl p-6 mb-8 border border-yellow-200">
       <div class="flex items-center justify-between">
           <div>
               <div class="flex items-center mb-2">
                   <div class="w-10 h-10 bg-gradient-to-r from-yellow-500 to-amber-600 rounded-full flex items-center justify-center mr-3">
                       <i class="fas fa-bookmark text-white"></i>
                   </div>
                   <h1 class="text-2xl font-bold text-gray-800">Your Talent Pipeline</h1>
               </div>
               <p class="text-gray-600">Your curated shortlist - ready for deep comparison and strategic decisions</p>
           </div>
           <div class="text-right">
               <div class="text-3xl font-bold text-yellow-600" id="total-saved-display">0</div>
               <div class="text-sm text-gray-500">Candidates Saved</div>
               <div class="text-xs text-gray-400 mt-1" id="saved-pipeline-status">Building your dream team</div>
           </div>
       </div>
   </div>

   <!-- Clean Top Filters and Sorting Section -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6 border border-gray-100">
        <div class="grid lg:grid-cols-12 gap-6">
            
            <!-- Left Side: Search (4 columns) -->
            <div class="lg:col-span-4">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-search text-white"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800">Find Your Ideal Candidates</h3>
                </div>
                
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input type="text" 
                           id="saved-keywords-filter-top" 
                           class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-gray-700 placeholder-gray-500 bg-gray-50 focus:bg-white" 
                           placeholder="Search names, titles, skills, experience...">
                </div>
            </div>
            
            <!-- Center: Quick Filters (4 columns) -->
            <div class="lg:col-span-4">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-gradient-to-r from-green-500 to-emerald-600 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-filter text-white"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800">Quick Filters</h3>
                </div>
                
                <div class="space-y-4">
                    <!-- Score Filter -->
                    <div class="space-y-2">
                        <div class="flex items-center justify-between">
                            <label class="text-sm font-medium text-gray-700">Minimum Score</label>
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 text-sm font-semibold rounded" id="saved-score-display-top">0%</span>
                        </div>
                        <input type="range" 
                               id="saved-score-range-top" 
                               class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider" 
                               min="0" max="100" value="0">
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>0%</span>
                            <span>50%</span>
                            <span>100%</span>
                        </div>
                    </div>
                    
                    <!-- Date Filter -->
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-gray-700">Saved Within</label>
                        <select id="saved-date-filter-top" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white">
                            <option value="all">All Time</option>
                            <option value="week">Last Week</option>
                            <option value="month">Last Month</option>
                            <option value="3months">Last 3 Months</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Right Side: Organize & Compare (4 columns) -->
            <div class="lg:col-span-4">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-sort text-white"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800">Organize & Compare</h3>
                </div>
                
                <!-- Sort Options -->
                <div class="space-y-4 mb-4">
                    <div>
                        <label class="text-sm font-medium text-gray-700 mb-2 block">Sort by</label>
                        <div class="flex gap-2">
                            <button id="saved-sort-score-top" 
                                    class="sort-btn-top active flex-1 px-3 py-2 bg-blue-100 text-blue-800 rounded-lg hover:bg-blue-200 transition-colors text-sm font-medium border border-blue-200">
                                <i class="fas fa-chart-line mr-1"></i>Score ‚Üì
                            </button>
                            <button id="saved-sort-name-top" 
                                    class="sort-btn-top flex-1 px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium border border-gray-200">
                                <i class="fas fa-user mr-1"></i>Name
                            </button>
                            <button id="saved-sort-date-top" 
                                    class="sort-btn-top flex-1 px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium border border-gray-200">
                                <i class="fas fa-calendar mr-1"></i>Date
                            </button>
                        </div>
                    </div>
                    
                    <!-- Compare Section -->
                    <div>
                        <label class="text-sm font-medium text-gray-700 mb-2 block">Compare Candidates</label>
                        <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-4 border border-purple-200">
                            <button id="compare-selected-btn-top" 
                                    class="w-full py-3 px-4 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white rounded-lg transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed font-medium shadow-sm mb-2" 
                                    disabled>
                                <i class="fas fa-balance-scale mr-2"></i>
                                <span id="compare-btn-text-top">Compare Selected (3)</span>
                            </button>
                            
                            <!-- Clear Selection Button -->
                            <button id="clear-comparison-selection-btn" 
                                    class="w-full py-2 px-3 bg-white border border-purple-300 text-purple-700 rounded-lg hover:bg-purple-50 transition-colors text-sm font-medium">
                                <i class="fas fa-times mr-2"></i>
                                Clear Selection
                            </button>
                            
                            <div class="text-xs text-center text-purple-700 mt-2 opacity-75">
                                Select 2-3 candidates to unlock side-by-side comparison
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Results Overview & Actions -->
    <div class="bg-white rounded-xl shadow-sm p-4 mb-6 border border-gray-100">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="w-8 h-8 bg-gradient-to-r from-emerald-500 to-green-600 rounded-lg flex items-center justify-center mr-3">
                    <i class="fas fa-list-ul text-white text-sm"></i>
                </div>
                <div>
                    <div id="saved-filter-results-top" class="text-sm font-medium text-gray-800">
                        Showing all candidates
                    </div>
                    <div class="text-xs text-gray-500">
                        Your filtered results
                    </div>
                </div>
            </div>
            
            <button id="clear-saved-filters-top" 
                    class="flex items-center px-4 py-2 text-sm text-gray-600 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors border border-gray-200 hover:border-red-200">
                <i class="fas fa-times mr-2"></i>
                <span>Clear All Filters</span>
            </button>
        </div>
    </div>

   <!-- Saved Candidates Overview (similar to multiple candidates layout) -->
   <div id="saved-candidates-overview" class="candidates-overview">
       <!-- Clean Sidebar - Just Cards -->
       <div class="candidates-sidebar">
           <!-- Simple Header -->
           <div class="candidate-summary">
               <div class="text-center py-4">
                   <div class="text-2xl font-bold mb-1" id="total-saved-candidates">0</div>
                   <div class="text-sm opacity-90">Saved Candidates</div>
                   <div class="text-xs opacity-75 mt-2" id="saved-last-updated">
                       Last updated: Never
                   </div>
               </div>
           </div>
   
           <!-- Clean Candidate Cards List -->
           <div class="mt-2">
               <div class="flex items-center justify-between mb-3 px-2">
                   <div class="text-xs text-white/70">Your Pipeline</div>
                   <div id="filtered-count-sidebar" class="text-xs text-white/60">0 shown</div>
               </div>
               
               <div class="candidate-grid" id="saved-candidate-cards">
                   <!-- Cards will be dynamically inserted here -->
               </div>
           </div>
       </div>
   
       <!-- Detailed View -->
       <div class="candidate-detail-view">
           <div id="selected-saved-candidate-detail">
               <!-- Selected candidate details will be shown here -->
           </div>
       </div>
   </div>
   
   <!-- Empty State -->
   <div id="saved-candidates-empty" class="text-center py-16 hidden">
       <div class="max-w-md mx-auto">
           <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
               <i class="fas fa-bookmark text-gray-300 text-3xl"></i>
           </div>
           <h3 class="text-xl font-semibold text-gray-600 mb-2">Your Talent Pipeline Awaits</h3>
           <p class="text-gray-500 mb-6">Start analyzing candidates and save the promising ones to build your dream team shortlist</p>
           <button id="back-to-analysis-from-empty" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:from-blue-700 hover:to-purple-700 transition-colors font-medium shadow-md">
               <i class="fas fa-magic mr-2"></i>
               Start Discovering Talent
           </button>
       </div>
   </div>
   
   <!-- Back Button -->
   <div class="text-center mt-8">
       <button id="back-from-saved" class="inline-flex items-center px-6 py-2 text-gray-600 hover:text-gray-800 transition-colors group">
           <i class="fas fa-arrow-left mr-2 group-hover:transform group-hover:-translate-x-1 transition-transform"></i>
           Back to Analysis
       </button>
   </div>
</div>

<!-- Comparison Page - SEPARATE PAGE -->
<div id="comparison-page" class="max-w-7xl mx-auto p-6 support-page-hidden">
   <header class="text-center mb-8">
       <h1 class="text-3xl font-bold text-gray-800 mb-4">Candidate Comparison</h1>
       <p class="text-gray-600">Side-by-side analysis of your selected candidates</p>
   </header>

   <!-- Comparison Content -->
   <div id="comparison-content">
       <!-- Candidates Overview Bar -->
       <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
           <div class="flex justify-between items-center">
               <div class="flex items-center gap-4" id="comparison-candidates-list">
                   <!-- Candidate chips will be inserted here -->
               </div>
               <div class="flex items-center gap-3">
                   <button id="clear-comparison-btn" class="px-4 py-2 text-gray-600 hover:text-red-600 transition-colors">
                       <i class="fas fa-times mr-2"></i>Clear Selection
                   </button>
                   <button id="export-comparison-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                       <i class="fas fa-download mr-2"></i>Export Comparison
                   </button>
               </div>
           </div>
       </div>

       <!-- Spider Chart Section -->
       <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
           <div class="flex items-center mb-4">
               <i class="fas fa-chart-radar text-purple-500 mr-3"></i>
               <h3 class="text-lg font-semibold">Skills & Performance Radar</h3>
           </div>
           <div class="flex justify-center">
               <div style="width: 600px; height: 500px;">
                   <canvas id="comparison-radar-chart"></canvas>
               </div>
           </div>
       </div>

       <!-- Side-by-Side Comparison -->
       <div class="grid gap-6 mt-24" id="side-by-side-comparison" style="grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));">
           <!-- Candidate comparison cards will be inserted here -->
       </div>
   </div>
   
   <!-- Back Button -->
   <div class="text-center mt-8">
       <button id="back-from-comparison" class="px-6 py-2 text-gray-600 hover:text-gray-800 transition-colors">
           <i class="fas fa-arrow-left mr-2"></i>Back to Saved Candidates
       </button>
   </div>
</div>

    <script>
        class MontProFeedback {
    constructor() {
        this.retryAttempts = new Map();
        this.maxRetries = 3;
        this.setupConnectionMonitoring();
    }
    
    showNotification(message, type = 'info', duration = 5000) {
    const notification = document.createElement('div');
    notification.className = `montpro-notification ${type} text-white p-4`;
    
    const icons = {
        success: 'success-checkmark',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
    };
    
    const iconHtml = type === 'success' 
        ? '<div class="success-checkmark"></div>'
        : `<i class="fas ${icons[type]} text-xl mr-3 mt-0.5"></i>`;
    
    notification.innerHTML = `
        <div class="flex items-start">
            ${iconHtml}
            <div class="flex-1">
                <div class="text-sm font-medium">${message}</div>
            </div>
            <button class="ml-3 text-white/70 hover:text-white transition-colors" onclick="this.parentElement.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Trigger entrance animation
    requestAnimationFrame(() => {
        notification.classList.add('show');
        
        // Add success pulse to relevant buttons
        if (type === 'success') {
            this.pulseSuccessButtons();
        }
    });
    
    if (duration > 0) {
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-in-out forwards';
            setTimeout(() => notification.remove(), 300);
        }, duration);
    }
}

// Add this method to the MontProFeedback class
pulseSuccessButtons() {
    const buttons = document.querySelectorAll('.btn-primary, .save-candidate-btn');
    buttons.forEach(btn => {
        btn.classList.add('btn-success-pulse');
        setTimeout(() => btn.classList.remove('btn-success-pulse'), 600);
    });
}
    
validateFile(file, options = {}) {
    const {
        maxSize = 10 * 1024 * 1024, // 10MB default
        allowedTypes = ['application/pdf', 'image/jpeg', 'image/png'],
        allowedExtensions = ['.pdf', '.jpg', '.jpeg', '.png']
    } = options;
    
    const errors = [];
    
    // Size validation
    if (file.size > maxSize) {
        errors.push(`File "${file.name}" is too large (${this.formatFileSize(file.size)}). Maximum size allowed: ${this.formatFileSize(maxSize)}`);
    }
    
    // NEW: Very small PDF check (likely corrupted or password-protected)
    if (file.type === 'application/pdf' && file.size < 1000) {
        errors.push(`File "${file.name}" is unusually small for a PDF. It might be corrupted, password-protected, or not a valid PDF file.`);
    }

    // NEW: Password-protected PDF detection (basic heuristic)
    if (file.type === 'application/pdf' && file.name.toLowerCase().includes('password')) {
        errors.push(`File "${file.name}" appears to be password-protected. Please upload an unprotected PDF.`);
    }
    
    // Type validation
    if (!allowedTypes.includes(file.type)) {
        errors.push(`File "${file.name}" has unsupported format. Supported formats: PDF`);
    }
    
    // Extension validation
    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
    if (!allowedExtensions.includes(fileExtension)) {
        errors.push(`File "${file.name}" has invalid extension "${fileExtension}"`);
    }
    
    // Empty file check
    if (file.size === 0) {
        errors.push(`File "${file.name}" appears to be empty`);
    }
    
    // Corrupted file check (enhanced)
    if (file.name.includes('~') || file.name.startsWith('.') || file.name.includes('$')) {
        errors.push(`File "${file.name}" may be corrupted, is a system file, or has an invalid name format`);
    }
    
    return {
        valid: errors.length === 0,
        errors,
        file
    };
}

formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1048576).toFixed(1) + ' MB';
}

showFieldError(fieldElement, message) {
    fieldElement.classList.add('field-error-shake');
    
    // Remove existing error message
    const existingError = fieldElement.parentNode.querySelector('.field-error-message');
    if (existingError) existingError.remove();
    
    // Add error message below the field
    const errorDiv = document.createElement('div');
    errorDiv.className = 'field-error-message text-red-600 text-sm mt-2 flex items-center';
    errorDiv.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${message}`;
    fieldElement.parentNode.appendChild(errorDiv);
    
    // Remove shake animation after it completes
    setTimeout(() => fieldElement.classList.remove('field-error-shake'), 500);
}

clearFieldError(fieldElement) {
    fieldElement.classList.remove('field-error-shake');
    const errorDiv = fieldElement.parentNode.querySelector('.field-error-message');
    if (errorDiv) errorDiv.remove();
}
// Add inside your MontProFeedback class

async makeRequest(url, options = {}) {
    const {
        timeout = 30000,
        retries = this.maxRetries,
        retryDelay = 2000,
        onRetry = null
    } = options;
    
    const requestKey = url + JSON.stringify(options.body || {});
    let attempt = this.retryAttempts.get(requestKey) || 0;
    
    try {
        // Create timeout promise
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);
        
        // Make request with timeout
        const response = await fetch(url, {
            ...options,
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error(`Server error: ${response.status} ${response.statusText}`);
        }
        
        // Reset retry counter on success
        this.retryAttempts.delete(requestKey);
        return response;
        
    } catch (error) {
        attempt++;
        this.retryAttempts.set(requestKey, attempt);
        
        // Determine error type
        const errorType = this.categorizeError(error);
        
        if (attempt <= retries && errorType.retryable) {
            if (onRetry) onRetry(attempt, retries + 1, error);
            
            // Show retry notification
            this.showNotification(
                `${errorType.message} (attempt ${attempt}/${retries + 1}). Retrying in ${retryDelay/1000}s...`,
                'warning',
                retryDelay
            );
            
            await new Promise(resolve => setTimeout(resolve, retryDelay));
            return this.makeRequest(url, options);
        } else {
            this.retryAttempts.delete(requestKey);
            throw new Error(`${errorType.message}${attempt > retries ? ` (failed after ${retries + 1} attempts)` : ''}`);
        }
    }
}

categorizeError(error) {
    if (error.name === 'AbortError') {
        return {
            message: 'Request timed out',
            retryable: true,
            type: 'timeout'
        };
    } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
        return {
            message: 'Network connection failed',
            retryable: true,
            type: 'network'
        };
    } else if (error.message.includes('Server error: 5')) {
        return {
            message: 'Server temporarily unavailable',
            retryable: true,
            type: 'server'
        };
    } else if (error.message.includes('Server error: 4')) {
        return {
            message: 'Request error - please check your data',
            retryable: false,
            type: 'client'
        };
    } else {
        return {
            message: error.message || 'Unknown error occurred',
            retryable: true,
            type: 'unknown'
        };
    }
}
    
    setupConnectionMonitoring() {
    // Monitor online/offline status
    window.addEventListener('online', () => {
        this.showNotification('Connection restored', 'success', 3000);
        this.updateConnectionStatus(true);
    });
    
    window.addEventListener('offline', () => {
        this.showNotification('Connection lost - working in offline mode', 'warning', 0);
        this.updateConnectionStatus(false);
    });
    
    // Initial status
    this.updateConnectionStatus(navigator.onLine);
}

updateConnectionStatus(isOnline) {
    let statusElement = document.getElementById('connection-status');
    
    if (!statusElement) {
        statusElement = document.createElement('div');
        statusElement.id = 'connection-status';
        statusElement.className = 'connection-status';
        document.body.appendChild(statusElement);
    }
    
    if (isOnline) {
        statusElement.className = 'connection-status online';
        statusElement.innerHTML = '<i class="fas fa-wifi mr-2"></i>Online';
    } else {
        statusElement.className = 'connection-status offline';
        statusElement.innerHTML = '<i class="fas fa-wifi-slash mr-2"></i>Offline';
    }
}
// Add inside your MontProFeedback class

createProgressTracker(containerId, options = {}) {
    const {
        title = 'Processing...',
        steps = ['Initializing...'],
        showPercentage = true,
        showTimeEstimate = false
    } = options;
    
    const container = document.getElementById(containerId);
    if (!container) return null;
    
    const tracker = {
        container,
        currentStep: 0,
        totalSteps: steps.length,
        startTime: Date.now(),
        progress: 0,
        
        update: function(stepIndex, customMessage = null, progressPercent = null) {
            this.currentStep = stepIndex;
            this.progress = progressPercent !== null ? progressPercent : Math.round((stepIndex / this.totalSteps) * 100);
            
            const message = customMessage || steps[stepIndex] || 'Processing...';
            const progressBar = container.querySelector('.enhanced-progress-bar-fill');
            const progressText = container.querySelector('.enhanced-progress-text');
            const progressPercentElement = container.querySelector('.enhanced-progress-percent');
            const timeEstimate = container.querySelector('.enhanced-time-estimate');

            if (progressBar) progressBar.style.width = `${this.progress}%`;
            if (progressText) progressText.textContent = message;
            if (progressPercentElement && showPercentage) progressPercentElement.textContent = `${this.progress}%`;
            
            if (timeEstimate && showTimeEstimate && this.progress > 10) {
                const elapsed = Date.now() - this.startTime;
                const estimated = (elapsed / this.progress) * (100 - this.progress);
                const minutes = Math.floor(estimated / 60000);
                const seconds = Math.floor((estimated % 60000) / 1000);
                timeEstimate.textContent = minutes > 0 ? `~${minutes}m ${seconds}s remaining` : `~${seconds}s remaining`;
            }
        },
        
        complete: function(message = 'Complete!') {
            this.update(this.totalSteps - 1, message, 100);
            setTimeout(() => {
                const progressBar = container.querySelector('.enhanced-progress-bar-fill');
                if (progressBar) progressBar.style.backgroundColor = '#10b981';
            }, 200);
        },
        
        error: function(message = 'Error occurred') {
            const progressBar = container.querySelector('.enhanced-progress-bar-fill');
            const progressText = container.querySelector('.enhanced-progress-text');
            
            if (progressBar) progressBar.style.backgroundColor = '#ef4444';
            if (progressText) progressText.textContent = message;
        }
    };
    
    return tracker;
}

enhanceLoadingState(elementId, options = {}) {
    const {
        pulseColor = '#3b82f6',
        showSpinner = true,
        showShimmer = true
    } = options;
    
    const element = document.getElementById(elementId);
    if (!element) return;
    
    // Add enhanced loading classes
    element.classList.add('enhanced-loading');
    
    if (showShimmer) {
        element.style.background = `linear-gradient(90deg, #f3f4f6 0%, #e5e7eb 50%, #f3f4f6 100%)`;
        element.style.backgroundSize = '200% 100%';
        element.style.animation = 'shimmer 1.5s infinite linear';
    }
    
    if (showSpinner) {
        const spinner = document.createElement('div');
        spinner.className = 'enhanced-spinner';
        spinner.innerHTML = '<div class="spinner"></div>';
        element.appendChild(spinner);
    }
}

removeLoadingState(elementId) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    element.classList.remove('enhanced-loading');
    element.style.background = '';
    element.style.backgroundSize = '';
    element.style.animation = '';
    
    const spinner = element.querySelector('.enhanced-spinner');
    if (spinner) spinner.remove();
}

showProgressModal(title, steps, onCancel = null) {
    // Create modal overlay
    const overlay = document.createElement('div');
    overlay.className = 'progress-modal-overlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
    `;
    
    // Create modal content
    const modal = document.createElement('div');
    modal.className = 'progress-modal';
    modal.style.cssText = `
        background: white;
        border-radius: 16px;
        padding: 32px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    `;
    
    modal.innerHTML = `
        <div class="text-center mb-6">
            <div class="w-16 h-16 mx-auto mb-4 flex items-center justify-center relative">
                <div class="absolute inset-0 border-4 border-blue-100 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-transparent border-t-blue-500 rounded-full animate-spin"></div>
                <i class="fas fa-cog text-blue-500 text-2xl"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">${title}</h3>
        </div>
        
        <div class="mb-6">
            <div class="flex justify-between text-sm text-gray-600 mb-2">
                <span class="enhanced-progress-text">Initializing...</span>
                <span class="enhanced-progress-percent">0%</span>
            </div>
            <div class="enhanced-progress-bar w-full h-3 bg-gray-200 rounded-full overflow-hidden">
                <div class="enhanced-progress-bar-fill h-full bg-blue-500 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <div class="enhanced-time-estimate text-xs text-gray-500 mt-1 text-center"></div>
        </div>
        
        ${onCancel ? '<div class="text-center"><button class="cancel-btn px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">Cancel</button></div>' : ''}
    `;
    
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    
    // Set up cancel functionality
    if (onCancel) {
        const cancelBtn = modal.querySelector('.cancel-btn');
        cancelBtn.addEventListener('click', () => {
            onCancel();
            document.body.removeChild(overlay);
        });
    }
    
    // Create and return progress tracker
    const tracker = this.createProgressTracker('progress-modal', {
        title,
        steps,
        showPercentage: true,
        showTimeEstimate: true
    });
    
    tracker.close = () => {
        if (document.body.contains(overlay)) {
            document.body.removeChild(overlay);
        }
    };
    
    return tracker;
}
}

// History Management System
class AnalysisHistory {
    constructor() {
        this.storageKey = 'montpro_analysis_history';
        this.maxHistoryItems = 50; // Limit to prevent localStorage bloat
    }

    // Add these methods:
    calculateAverageScore(candidates) {
        const scores = candidates.map(c => parseInt(c.candidateScore) || 0);
        return scores.length ? Math.round(scores.reduce((a, b) => a + b) / scores.length) : 0;
    }

    extractTopSkills(candidates) {
        const skillFrequency = {};
    
        candidates.forEach(candidate => {
            const skills = this.extractSkillsFromCandidate(candidate);
            skills.forEach(skill => {
                skillFrequency[skill] = (skillFrequency[skill] || 0) + 1;
            });
        });
    
        return Object.entries(skillFrequency)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 5)
            .map(([skill]) => skill);
    }

    extractSkillsFromCandidate(candidate) {
        if (!candidate.coreCompetencies) return [];
    
        if (Array.isArray(candidate.coreCompetencies)) {
            return candidate.coreCompetencies;
        }
    
        // Extract from string format
        return candidate.coreCompetencies
            .split(/[,\n‚Ä¢-]/)
            .map(skill => skill.trim())
            .filter(skill => skill.length > 0)
            .slice(0, 10); // Limit per candidate
    }

    searchHistory(query) {
        const history = this.getHistory();
        const searchTerm = query.toLowerCase();
    
        return history.filter(analysis => 
            analysis.candidates.some(candidate => 
                (candidate.candidateName || '').toLowerCase().includes(searchTerm) ||
                (candidate.executiveSummary || '').toLowerCase().includes(searchTerm) ||
                (candidate.coreCompetencies || '').toString().toLowerCase().includes(searchTerm)
            )
        );
    }
    
    // Save analysis to history
    saveAnalysis(candidatesData, analysisMetadata = {}) {
        try {
            const historyItem = {
                id: this.generateId(),
                timestamp: new Date().toISOString(),
                analysisDate: new Date().toLocaleDateString(),
                candidates: candidatesData,
                totalCandidates: candidatesData.length,
                averageScore: this.calculateAverageScore(candidatesData),
                topSkills: this.extractTopSkills(candidatesData),
                analysisType: candidatesData.length > 1 ? 'batch' : 'single',
                metadata: {
                    userAgent: navigator.userAgent.split(' ')[0], // Simple browser detection
                    ...analysisMetadata
                }
            };
            
            let history = this.getHistory();
            
            // Add new item to beginning of array
            history.unshift(historyItem);
            
            // Limit history size
            if (history.length > this.maxHistoryItems) {
                history = history.slice(0, this.maxHistoryItems);
            }
            
            localStorage.setItem(this.storageKey, JSON.stringify(history));
            console.log('Analysis saved to history:', historyItem.id);
            return historyItem.id;
            
        } catch (error) {
            console.error('Failed to save analysis to history:', error);
            return null;
        }
    }
    
    // Get all history
    getHistory() {
        try {
            const history = localStorage.getItem(this.storageKey);
            return history ? JSON.parse(history) : [];
        } catch (error) {
            console.error('Failed to retrieve history:', error);
            return [];
        }
    }
    
    // Get specific analysis by ID
    getAnalysisById(id) {
        const history = this.getHistory();
        return history.find(item => item.id === id) || null;
    }
    
    // Generate unique ID for analysis
    generateId() {
        return 'analysis_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    // Get history statistics
    getHistoryStats() {
        const history = this.getHistory();
        return {
            totalAnalyses: history.length,
            lastAnalysis: history[0]?.timestamp || null,
            totalCandidates: history.reduce((sum, item) => sum + item.totalCandidates, 0)
        };
    }
}

// Credit Management System
class CreditManager {
    constructor() {
        this.currentUser = null;
        this.userTier = 'FREE';
        this.creditBalance = 0;
        this.freeAnalysesUsed = 0;
        this.proCredits = 0;
        this.ultraCredits = 0;
        
        // Pricing configuration
        this.pricing = {
            FREE: {
                name: 'Free',
                monthlyLimit: 3,
                price: 0
            },
            PROFESSIONAL: {
                name: 'Professional',
                creditsPerPurchase: 30,
                price: 599000,
                priceFormatted: 'Rp 599.000'
            },
            ULTRA: {
                name: 'Ultra',
                creditsPerPurchase: 20,
                price: 999000,
                priceFormatted: 'Rp 999.000'
            }
        };
    }

    async initialize() {
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
            this.currentUser = user;
            await this.loadUserData();
        }
    }

    async loadUserData() {
        try {
            // Try to get existing profile
            let { data, error } = await supabase
                .from('user_profiles')
                .select('*')
                .eq('id', this.currentUser.id)
                .single();

            if (error && error.code === 'PGRST116') {
                // Profile doesn't exist, create it
                await this.createUserProfile();
                // Load again after creating
                ({ data, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('id', this.currentUser.id)
                    .single());
            }

            if (data) {
                this.userTier = data.user_tier || 'FREE';
                this.creditBalance = data.credit_balance || 0;
                this.proCredits = data.pro_credits || 0;
                this.ultraCredits = data.ultra_credits || 0;
                this.freeAnalysesUsed = data.free_analyses_used || 0;
    
                // For backward compatibility - if creditBalance exists but no separate credits
                if (this.creditBalance > 0 && this.proCredits === 0 && this.ultraCredits === 0) {
                    if (this.userTier === 'ULTRA') {
                        this.ultraCredits = this.creditBalance;
                    } else {
                        this.proCredits = this.creditBalance;
                    }
                }
                
                // Check if we need to reset free analyses (monthly)
                await this.checkFreeReset(data.free_reset_date);
            }
        } catch (error) {
            console.error('Error loading user data:', error);
        }
    }

    async createUserProfile() {
        try {
            const { error } = await supabase
                .from('user_profiles')
                .insert({
                    id: this.currentUser.id,
                    user_tier: 'FREE',
                    credit_balance: 0,
                    free_analyses_used: 0,
                    free_reset_date: new Date().toISOString().split('T')[0]
                });

            if (error) {
                console.error('Error creating user profile:', error);
            }
        } catch (error) {
            console.error('Error creating user profile:', error);
        }
    }

    async checkFreeReset(lastResetDate) {
        const now = new Date();
        const resetDate = new Date(lastResetDate);
        
        // If it's a new month, reset free analyses
        if (now.getMonth() !== resetDate.getMonth() || now.getFullYear() !== resetDate.getFullYear()) {
            await this.resetFreeAnalyses();
        }
    }

    async resetFreeAnalyses() {
        try {
            const { error } = await supabase
                .from('user_profiles')
                .update({ 
                    free_analyses_used: 0,
                    free_reset_date: new Date().toISOString().split('T')[0]
                })
                .eq('id', this.currentUser.id);

            if (!error) {
                this.freeAnalysesUsed = 0;
            }
        } catch (error) {
            console.error('Error resetting free analyses:', error);
        }
    }

    canAnalyze() {
        if (this.userTier === 'FREE') {
            return this.freeAnalysesUsed < this.pricing.FREE.monthlyLimit;
        } else {
            return this.creditBalance > 0;
        }
    }

    getRemainingAnalyses() {
        if (this.userTier === 'FREE') {
            return Math.max(0, this.pricing.FREE.monthlyLimit - this.freeAnalysesUsed);
        } else {
            return this.creditBalance;
        }
    }

    getStatus() {
        return {
            tier: this.userTier,
            remaining: this.getRemainingAnalyses(),
            canAnalyze: this.canAnalyze(),
            isFreeTier: this.userTier === 'FREE',
            isUltraTier: this.userTier === 'ULTRA',
            creditsBalance: this.creditBalance,
            proCredits: this.proCredits,
            ultraCredits: this.ultraCredits,
            freeUsed: this.freeAnalysesUsed
        };
    }

    async useAnalysis() {
        if (!this.canAnalyze()) {
            throw new Error('No analyses remaining');
        }

        try {
            if (this.userTier === 'FREE') {
                this.freeAnalysesUsed++;
                await supabase
                    .from('user_profiles')
                    .update({ 
                        free_analyses_used: this.freeAnalysesUsed,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', this.currentUser.id);
            } else {
                this.creditBalance--;
                await supabase
                    .from('user_profiles')
                    .update({ 
                        credit_balance: this.creditBalance,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', this.currentUser.id);
            }
            console.log('Analysis used. Remaining:', this.getRemainingAnalyses());
        } catch (error) {
            console.error('Error using analysis:', error);
            throw error;
        }
    }

    async addCredits(amount) {
        try {
            // Add to PRO credits specifically
            this.proCredits += amount;
            this.creditBalance = this.proCredits + this.ultraCredits; // Update total
        
            // Update database
            await supabase
                .from('user_profiles')
                .update({ 
                    pro_credits: this.proCredits,
                    credit_balance: this.creditBalance,
                    user_tier: 'PROFESSIONAL',  // Automatically upgrade to professional
                    updated_at: new Date().toISOString()
                })
                .eq('id', this.currentUser.id);

            // Log purchase in credit_purchases table
            await supabase
                .from('credit_purchases')
                .insert({
                    user_id: this.currentUser.id,
                    credits_purchased: amount,
                    credit_type: 'PROFESSIONAL', // Add this field
                    amount_paid: this.pricing.PROFESSIONAL.price
                });

            this.userTier = 'PROFESSIONAL';
            console.log(`Added ${amount} PRO credits. New balance: ${this.proCredits}`);
            return true;
        } catch (error) {
            console.error('Error adding PRO credits:', error);
            return false;
        }
    }

    async addUltraCredits(amount) {
        try {
            this.ultraCredits += amount;
            this.creditBalance = this.proCredits + this.ultraCredits; // Update total
        
            // Update database
            await supabase
                .from('user_profiles')
                .update({ 
                    ultra_credits: this.ultraCredits,
                    credit_balance: this.creditBalance,
                    user_tier: 'ULTRA',  // Automatically upgrade to ULTRA
                    updated_at: new Date().toISOString()
                })
                .eq('id', this.currentUser.id);

            // Log purchase in credit_purchases table
            await supabase
                .from('credit_purchases')
                .insert({
                    user_id: this.currentUser.id,
                    credits_purchased: amount,
                    credit_type: 'ULTRA',
                    amount_paid: this.pricing.ULTRA.price
                });

            this.userTier = 'ULTRA';
            console.log(`Added ${amount} ULTRA credits. New balance: ${this.ultraCredits}`);
            return true;
        } catch (error) {
            console.error('Error adding ULTRA credits:', error);
            return false;
        }
    }
    
    calculateCreditConversion() {
        if (this.userTier !== 'PROFESSIONAL') return null;
    
        const proValuePerCredit = 19967; // 599k/30
        const ultraValuePerCredit = 49950; // 999k/20
    
        const totalProValue = this.creditBalance * proValuePerCredit;
        const fullUltraCredits = Math.floor(totalProValue / ultraValuePerCredit);
        const remainder = totalProValue % ultraValuePerCredit;
    
        // If remainder > 40% of ultra credit value, give bonus credit
        const bonusCredit = remainder > (ultraValuePerCredit * 0.4) ? 1 : 0;
        const totalUltraCredits = fullUltraCredits + bonusCredit;
    
        return {
            currentProCredits: this.creditBalance,
            currentProValue: totalProValue,
            newUltraCredits: totalUltraCredits,
            fullCredits: fullUltraCredits,
            bonusCredits: bonusCredit,
            remainder: remainder,
            savings: bonusCredit > 0 ? (ultraValuePerCredit - remainder) : 0
        };
    }

    async convertToUltra() {
        const conversion = this.calculateCreditConversion();
        if (!conversion) return false;
    
        try {
            // Update to ULTRA tier with converted credits
            await supabase
                .from('user_profiles')
                .update({ 
                    user_tier: 'ULTRA',
                    pro_credits: 0,
                    ultra_credits: conversion.newUltraCredits,
                    credit_balance: conversion.newUltraCredits,
                    updated_at: new Date().toISOString()
                })
                .eq('id', this.currentUser.id);

            this.userTier = 'ULTRA';
            this.proCredits = 0;
            this.ultraCredits = conversion.newUltraCredits;
            this.creditBalance = conversion.newUltraCredits;
        
            return conversion;
        } catch (error) {
            console.error('Error converting to ULTRA:', error);
            return false;
        }
    }

    hasProCredits() {
        return this.proCredits > 0;
    }

    hasUltraCredits() {
        return this.ultraCredits > 0;
    }

    canDoJobMatching() {
        return this.ultraCredits > 0;
    }

    async useProCredit() {
        if (this.proCredits <= 0) {
            throw new Error('No PRO credits remaining');
        }
    
        this.proCredits--;
        await this.updateCreditsInDatabase();
    }

    async useUltraCredit() {
        if (this.ultraCredits <= 0) {
            throw new Error('No ULTRA credits remaining');
        }
    
        this.ultraCredits--;
        await this.updateCreditsInDatabase();
    }

    async updateCreditsInDatabase() {
        try {
            await supabase
                .from('user_profiles')
                .update({ 
                    pro_credits: this.proCredits,
                    ultra_credits: this.ultraCredits,
                    credit_balance: this.proCredits + this.ultraCredits, // Keep for compatibility
                    updated_at: new Date().toISOString()
                })
                .eq('id', this.currentUser.id);
        } catch (error) {
            console.error('Error updating credits:', error);
            throw error;
        }
    }
}

// Midtrans Payment Handler
// Temporary Test Version - Replace your PaymentHandler class
// REPLACE your existing PaymentHandler class with this:
class PaymentHandler {
    constructor() {
        this.isProduction = true; // Sandbox mode
        this.serverUrl = 'https://montpro.app.n8n.cloud/webhook/create-payment'; // Your n8n webhook URL
    }

    async createPayment(amount, credits, userEmail, creditType) {
        try {
            console.log('Creating payment request...');
            
            // Create payment request to your n8n backend
            const response = await fetch(this.serverUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    amount: amount,
                    credits: credits,
                    credit_type: creditType,
                    user_email: userEmail,
                    user_id: creditManager.currentUser.id
                })
            });

            console.log('Backend response status:', response.status);
            const data = await response.json();
            console.log('Backend response data:', data);
            
            if (data.success && data.token) {
                // Open Midtrans popup
                this.openPaymentPopup(data.token, credits, creditType);
            } else {
                throw new Error('Failed to create payment token: ' + JSON.stringify(data));
            }
        } catch (error) {
            console.error('Payment creation failed:', error);
            showError('Cannot make payment: ' + error.message);
        }
    }

    openPaymentPopup(snapToken, credits) {
        console.log('Opening Midtrans popup with token:', snapToken);
        
        window.snap.pay(snapToken, {
            onSuccess: async (result) => {
                console.log('Payment success:', result);
                showSuccess('Payment Successful!');
                await this.handlePaymentSuccess(credits);
            },
            onPending: (result) => {
                console.log('Payment pending:', result);
                showWarning('Payment is being processed. Credits will be added after confirmation.');
            },
            onError: (result) => {
                console.log('Payment error:', result);
                showError('Payment Failed. Please Try Again.');
            },
            onClose: () => {
                console.log('Payment popup closed by user');
                showWarning('Payment Cancelled.');
            }
        });
    }

    async handlePaymentSuccess(credits, creditType) {
        try {
            let success = false;
            const ticketId = 'TXN-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
        
            if (creditType === 'ULTRA') {
                // For ULTRA purchases - add to ultra_credits
                success = await creditManager.addUltraCredits(credits);
            } else {
                // For PRO purchases - add to pro_credits  
                success = await creditManager.addCredits(credits);
            }
        
            if (success) {
                showSuccess(`${credits} ${creditType} credits have been added to your account!`);
                updateUsageDisplay();
            
                setTimeout(() => {
                    hidePricingPage();
                }, 2000);
            } else {
                // NEW: Give user a support ticket number
                showError(`Payment successful but failed to add credits. Support ticket: ${ticketId}. Email support@aapgrp.com with this ticket number for assistance.`, true);
            
                // Log for your reference
                console.error('Credit addition failed after successful payment:', {
                    ticketId,
                    credits,
                    creditType,
                    userId: creditManager.currentUser.id,
                    timestamp: new Date().toISOString()
                });
            }
        } catch (error) {
            const ticketId = 'TXN-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
            console.error('Error handling payment success:', error, { ticketId });
        
            showError(`An error occurred while processing payment. Support ticket: ${ticketId}. Email support@aapgrp.com with this ticket number.`, true);
        }
    }
}
        
// Candidate Filter System
class CandidateFilter {
    constructor() {
        this.originalCandidates = [];
        this.filteredCandidates = [];
        this.activeFilters = {
            searchQuery: '',
            minScore: 0
        };
    }
    
    setCandidates(candidates) {
        this.originalCandidates = [...candidates];
        this.filteredCandidates = [...candidates];
        return this;
    }
    
    applySearchFilter(query) {
        this.activeFilters.searchQuery = query.toLowerCase();
        this.updateFilteredResults();
        return this;
    }
    
    applyScoreFilter(minScore) {
        this.activeFilters.minScore = parseInt(minScore);
        this.updateFilteredResults();
        return this;
    }
    
    updateFilteredResults() {
        this.filteredCandidates = this.originalCandidates.filter(candidate => {
            // Search filter
            if (this.activeFilters.searchQuery) {
                const searchFields = [
                    candidate.candidateName || '',
                    candidate.executiveSummary || '',
                    (candidate.coreCompetencies || '').toString(),
                    extractTitleFromSummary(candidate) || ''
                ].join(' ').toLowerCase();
                
                if (!searchFields.includes(this.activeFilters.searchQuery)) {
                    return false;
                }
            }
            
            // Score filter
            const candidateScore = parseInt(candidate.candidateScore) || 0;
            if (candidateScore < this.activeFilters.minScore) {
                return false;
            }
            
            return true;
        });
        
        return this;
    }
    
    getFilteredCandidates() {
        return this.filteredCandidates;
    }
    
    getFilterStats() {
        return {
            total: this.originalCandidates.length,
            filtered: this.filteredCandidates.length,
            hidden: this.originalCandidates.length - this.filteredCandidates.length
        };
    }
}

// Saved Candidates Management System
class SavedCandidatesManager {
    constructor() {
        this.storageKey = 'montpro_saved_candidates';
        this.maxSavedCandidates = 100; // Reasonable limit
    }

    // Save a candidate
    saveCandidate(candidate, analysisMetadata = {}) {
        try {
            const savedItem = {
                id: this.generateId(),
                timestamp: new Date().toISOString(),
                savedDate: new Date().toLocaleDateString(),
                candidate: candidate,
                metadata: {
                    originalAnalysisDate: analysisMetadata.analysisDate || new Date().toLocaleDateString(),
                    ...analysisMetadata
                }
            };

            let savedCandidates = this.getSavedCandidates();
            
            // Check if candidate already exists (by name and executive summary)
            const exists = savedCandidates.some(item => 
                item.candidate.candidateName === candidate.candidateName &&
                item.candidate.executiveSummary === candidate.executiveSummary
            );

            if (exists) {
                return { success: false, message: 'Candidate already saved' };
            }

            // Add new item to beginning
            savedCandidates.unshift(savedItem);

            // Limit saved candidates
            if (savedCandidates.length > this.maxSavedCandidates) {
                savedCandidates = savedCandidates.slice(0, this.maxSavedCandidates);
            }

            localStorage.setItem(this.storageKey, JSON.stringify(savedCandidates));
            console.log('Candidate saved:', savedItem.id);
            return { success: true, message: 'Candidate saved successfully', id: savedItem.id };

        } catch (error) {
            console.error('Failed to save candidate:', error);
            return { success: false, message: 'Failed to save candidate' };
        }
    }

    // Remove a saved candidate
    removeCandidate(candidateId) {
        try {
            let savedCandidates = this.getSavedCandidates();
            const originalLength = savedCandidates.length;
            
            savedCandidates = savedCandidates.filter(item => item.id !== candidateId);
            
            if (savedCandidates.length === originalLength) {
                return { success: false, message: 'Candidate not found' };
            }

            localStorage.setItem(this.storageKey, JSON.stringify(savedCandidates));
            return { success: true, message: 'Candidate removed from saved list' };

        } catch (error) {
            console.error('Failed to remove candidate:', error);
            return { success: false, message: 'Failed to remove candidate' };
        }
    }

    // Get all saved candidates
    getSavedCandidates() {
        try {
            const saved = localStorage.getItem(this.storageKey);
            return saved ? JSON.parse(saved) : [];
        } catch (error) {
            console.error('Failed to retrieve saved candidates:', error);
            return [];
        }
    }

    // Check if candidate is saved
    isCandidateSaved(candidate) {
        const savedCandidates = this.getSavedCandidates();
        return savedCandidates.some(item => 
            item.candidate.candidateName === candidate.candidateName &&
            item.candidate.executiveSummary === candidate.executiveSummary
        );
    }

    // Generate unique ID
    generateId() {
        return 'saved_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // Get statistics
    getSavedStats() {
        const saved = this.getSavedCandidates();
        return {
            totalSaved: saved.length,
            lastSaved: saved[0]?.timestamp || null
        };
    }
}

// Data Retention Cleanup System
class DataRetentionManager {
    constructor() {
        this.savedCandidatesKey = 'montpro_saved_candidates';
        this.maxSavedCandidateAge = 6 * 30 * 24 * 60 * 60 * 1000; // 6 months in milliseconds
    }

    // Run cleanup on app startup
    performStartupCleanup() {
        console.log('Running data retention cleanup...');
        
        const cleanupResults = {
            savedCandidatesRemoved: 0,
            analysisHistoryAlreadyLimited: true // This is already handled by your existing 50-item limit
        };

        // Clean up old saved candidates
        cleanupResults.savedCandidatesRemoved = this.cleanupOldSavedCandidates();

        // Log results
        if (cleanupResults.savedCandidatesRemoved > 0) {
            console.log(`Cleanup completed: ${cleanupResults.savedCandidatesRemoved} old saved candidates removed`);
        } else {
            console.log('Cleanup completed: No old data to remove');
        }

        return cleanupResults;
    }

    cleanupOldSavedCandidates() {
        try {
            const savedCandidates = JSON.parse(localStorage.getItem(this.savedCandidatesKey) || '[]');
            const now = Date.now();
            const cutoffDate = now - this.maxSavedCandidateAge;

            // Filter out candidates older than 6 months
            const filteredCandidates = savedCandidates.filter(savedItem => {
                const savedTime = new Date(savedItem.timestamp).getTime();
                return savedTime > cutoffDate;
            });

            const removedCount = savedCandidates.length - filteredCandidates.length;

            // Save the filtered list back to localStorage
            if (removedCount > 0) {
                localStorage.setItem(this.savedCandidatesKey, JSON.stringify(filteredCandidates));
                
                // Show user notification about cleanup
                setTimeout(() => {
                    if (removedCount > 0) {
                        showSuccess(`Cleaned up ${removedCount} saved candidate${removedCount > 1 ? 's' : ''} older than 6 months`);
                    }
                }, 2000); // Delay to avoid interfering with login flow
            }

            return removedCount;

        } catch (error) {
            console.error('Error during saved candidates cleanup:', error);
            return 0;
        }
    }

    // Get cleanup statistics for user
    getCleanupStats() {
        try {
            const savedCandidates = JSON.parse(localStorage.getItem(this.savedCandidatesKey) || '[]');
            const now = Date.now();
            const cutoffDate = now - this.maxSavedCandidateAge;

            const oldCandidates = savedCandidates.filter(savedItem => {
                const savedTime = new Date(savedItem.timestamp).getTime();
                return savedTime <= cutoffDate;
            });

            return {
                totalSavedCandidates: savedCandidates.length,
                candidatesNearExpiry: oldCandidates.length,
                cleanupDate: new Date(cutoffDate).toLocaleDateString()
            };

        } catch (error) {
            console.error('Error getting cleanup stats:', error);
            return { totalSavedCandidates: 0, candidatesNearExpiry: 0, cleanupDate: 'Unknown' };
        }
    }
}

// Initialize data retention manager
const dataRetentionManager = new DataRetentionManager();

// Memory Management for Sensitive Data
class MemoryManager {
    constructor() {
        this.clearDelayTimer = null;
        this.inactivityTimer = null;
        this.inactivityDelay = 30 * 60 * 1000; // 30 minutes
        this.navigationDelay = 10 * 1000; // 10 seconds
        
        // Track user activity
        this.setupActivityTracking();
    }

    // Clear sensitive candidate data from memory
    clearSensitiveData() {
        try {
            // Clear candidate data
            if (window.candidatesData) {
                console.log('Clearing sensitive candidate data from memory');
                candidatesData = [];
                selectedCandidateIndex = 0;
                
                // Clear any chart instances
                if (window.comparisonChart) {
                    window.comparisonChart.destroy();
                    window.comparisonChart = null;
                }
                
                // Clear any progress trackers
                if (window.currentProgressTracker) {
                    window.currentProgressTracker = null;
                }
                
                // Clear session storage backup
                sessionStorage.removeItem('analysisResults');
                
                console.log('Memory cleared successfully');
            }
        } catch (error) {
            console.error('Error clearing sensitive data:', error);
        }
    }

    // Schedule memory clearing with delay
    scheduleDelayedClear(reason = 'navigation') {
        console.log(`Scheduling memory clear in ${this.navigationDelay/1000}s due to: ${reason}`);
        
        // Clear any existing timer
        if (this.clearDelayTimer) {
            clearTimeout(this.clearDelayTimer);
        }
        
        // Set new timer
        this.clearDelayTimer = setTimeout(() => {
            this.clearSensitiveData();
            this.clearDelayTimer = null;
        }, this.navigationDelay);
    }

    // Cancel scheduled clearing (if user comes back quickly)
    cancelScheduledClear() {
        if (this.clearDelayTimer) {
            console.log('Canceling scheduled memory clear');
            clearTimeout(this.clearDelayTimer);
            this.clearDelayTimer = null;
        }
    }

    // Setup inactivity tracking
    setupActivityTracking() {
        const activities = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
        
        const resetInactivityTimer = () => {
            // Clear existing timer
            if (this.inactivityTimer) {
                clearTimeout(this.inactivityTimer);
            }
            
            // Set new inactivity timer
            this.inactivityTimer = setTimeout(() => {
                console.log('30 minutes of inactivity - clearing sensitive data');
                this.clearSensitiveData();
                showSuccess('Data cleared due to inactivity for security');
            }, this.inactivityDelay);
        };

        // Add activity listeners
        activities.forEach(activity => {
            document.addEventListener(activity, resetInactivityTimer, true);
        });

        // Start initial timer
        resetInactivityTimer();
    }

    // Force immediate clear (for logout, etc.)
    forceClear(reason = 'manual') {
        console.log(`Force clearing memory due to: ${reason}`);
        
        // Cancel any scheduled clearing
        this.cancelScheduledClear();
        
        // Clear immediately
        this.clearSensitiveData();
    }
}

// Initialize memory manager
const memoryManager = new MemoryManager();

// Analysis Queue Management System
class AnalysisQueueManager {
    constructor() {
        this.currentRequest = null;
        this.queue = [];
        this.isProcessing = false;
    }

    // Create request fingerprint for duplicate detection
    createRequestFingerprint(files, jobDescription) {
        const fileFingerprint = files.map(f => `${f.name}_${f.size}_${f.lastModified}`).sort().join('|');
        const jdFingerprint = jobDescription.trim();
        return `${fileFingerprint}::${jdFingerprint}`;
    }

    // Add analysis request to queue
    async queueAnalysis(files, jobDescription = '') {
        const fingerprint = this.createRequestFingerprint(files, jobDescription);
        const hasJobDescription = jobDescription.length > 0;

        // Check if identical request is already processing
        if (this.currentRequest && this.currentRequest.fingerprint === fingerprint) {
            showWarning('Identical analysis is already in progress. Please wait for it to complete.');
            return { queued: false, reason: 'duplicate_current' };
        }

        // Check if identical request is already in queue
        const duplicateInQueue = this.queue.find(req => req.fingerprint === fingerprint);
        if (duplicateInQueue) {
            showWarning('This exact analysis is already queued. Please wait for it to process.');
            return { queued: false, reason: 'duplicate_queued' };
        }

        // Create queue item
        const queueItem = {
            id: 'queue_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            files: [...files], // Clone files array
            jobDescription: jobDescription,
            hasJobDescription: hasJobDescription,
            fingerprint: fingerprint,
            timestamp: new Date().toISOString(),
            creditType: hasJobDescription ? 'ULTRA' : 'PRO'
        };

        // If not currently processing, start immediately
        if (!this.isProcessing) {
            // Show loading animation before processing
            showAnalysisLoading();
            const result = await this.processRequest(queueItem);
            
            // Show results if successful
            if (result.success) {
                setTimeout(() => {
                    showAnalysisResults(result.result);
                }, 500);
            }
            
            return result;
        }

        // Add to queue
        this.queue.push(queueItem);
        
        // Show user feedback about queuing
        const queuePosition = this.queue.length;
        const estimatedWait = queuePosition * 60; // Assume 1 minute per queued item
        
        showSuccess(`Analysis queued! Position ${queuePosition} in queue. Estimated wait: ${estimatedWait}s`);
        this.updateQueueDisplay();

        return { queued: true, position: queuePosition, queueItem: queueItem };
    }

    // Process a single request
    async processRequest(queueItem) {
        try {
            this.isProcessing = true;
            this.currentRequest = queueItem;

            // Update UI to show current processing
            this.updateProcessingDisplay(queueItem);

            // Validate credits before processing
            const creditCheck = await this.validateCredits(queueItem);
            if (!creditCheck.valid) {
                throw new Error(creditCheck.message);
            }

            // Call the actual analysis function
            const result = await this.executeAnalysis(queueItem);

            // Analysis completed successfully
            this.currentRequest = null;
            this.isProcessing = false;

            // Process next item in queue
            setTimeout(() => {
                this.processNextInQueue();
            }, 1000);

            return { success: true, result: result };

        } catch (error) {
            console.error('Analysis failed:', error);
            
            // Clean up current request
            this.currentRequest = null;
            this.isProcessing = false;

            // Show error to user
            showError(`Analysis failed: ${error.message}`);

            // Process next item in queue after delay
            setTimeout(() => {
                this.processNextInQueue();
            }, 2000);

            return { success: false, error: error.message };
        }
    }

    // Process next item in queue
    async processNextInQueue() {
        if (this.queue.length === 0 || this.isProcessing) {
            this.updateQueueDisplay();
            return;
        }

        const nextItem = this.queue.shift();
        showSuccess(`Starting queued analysis for ${nextItem.files.length} file(s)...`);
        
        await this.processRequest(nextItem);
    }

    // Validate credits for queued request
    async validateCredits(queueItem) {
        const filesCount = queueItem.files.length;
        const hasJobDescription = queueItem.hasJobDescription;

        if (hasJobDescription) {
            if (!creditManager.canDoJobMatching()) {
                return { valid: false, message: 'Job Description matching requires ULTRA credits. Please upgrade!' };
            }
            if (creditManager.ultraCredits < filesCount) {
                return { valid: false, message: `Need ${filesCount} ULTRA credits, but only have ${creditManager.ultraCredits}` };
            }
        } else {
            const totalCredits = creditManager.proCredits + creditManager.ultraCredits + 
                               (creditManager.userTier === 'FREE' ? creditManager.getRemainingAnalyses() : 0);
            if (totalCredits < filesCount) {
                return { valid: false, message: `Need ${filesCount} credits but only have ${totalCredits}` };
            }
        }

        return { valid: true };
    }

    // Execute the actual analysis
    async executeAnalysis(queueItem) {
        // Set global files variable for existing analysis function
        window.files = queueItem.files;
        
        // Set job description
        document.getElementById('job-description').value = queueItem.jobDescription;

        // Call existing startAnalysis function but bypass queue
        return await this.directAnalysis(queueItem);
    }

    // Direct analysis bypassing queue (modified startAnalysis)
    async directAnalysis(queueItem) {
        const formData = new FormData();
        queueItem.files.forEach(file => {
            formData.append('files', file);
        });

        formData.append('requestId', queueItem.id);
        formData.append('expectedProcessingTime', Math.max(60, queueItem.files.length * 20));

        if (queueItem.hasJobDescription) {
            formData.append('jobDescription', queueItem.jobDescription);
            formData.append('analysisType', 'ULTRA');
        } else {
            formData.append('analysisType', 'PRO');
        }

        const timeoutDuration = Math.max(120000, queueItem.files.length * 40000);

        const response = await feedback.makeRequest(
            'https://montpro.app.n8n.cloud/webhook/recruitment-analysis',
            {
                method: 'POST',
                body: formData,
                timeout: timeoutDuration,
                retries: 1,
                retryDelay: 5000
            }
        );

        const contentType = response.headers.get("content-type");
        const raw = await response.text();

        if (!raw || raw.trim().length === 0) {
            throw new Error("Empty response from server");
        }

        let data;
        if (contentType && contentType.includes("application/json")) {
            data = JSON.parse(raw);
            if (data.requestId && data.requestId !== queueItem.id) {
                throw new Error('Response mismatch - please try again');
            }
        } else {
            throw new Error("Invalid content-type or response format");
        }

        return data;
    }

    // Update queue display in UI
    updateQueueDisplay() {
        const queueInfo = document.getElementById('queue-info');
        if (!queueInfo) return;

        if (this.queue.length === 0 && !this.isProcessing) {
            queueInfo.classList.add('hidden');
        } else {
            queueInfo.classList.remove('hidden');
            queueInfo.innerHTML = `
                <div class="text-sm text-gray-600 flex items-center">
                    <i class="fas fa-list mr-2"></i>
                    ${this.isProcessing ? 'Processing...' : 'Queue empty'}
                    ${this.queue.length > 0 ? ` | ${this.queue.length} queued` : ''}
                </div>
            `;
        }
    }

    // Update processing display
    updateProcessingDisplay(queueItem) {
        showSuccess(`Processing ${queueItem.files.length} file(s)${queueItem.hasJobDescription ? ' with job matching' : ''}...`);
    }

    // Clear queue (for logout, etc.)
    clearQueue() {
        this.queue = [];
        this.currentRequest = null;
        this.isProcessing = false;
        this.updateQueueDisplay();
    }

    // Get queue status
    getStatus() {
        return {
            isProcessing: this.isProcessing,
            currentRequest: this.currentRequest,
            queueLength: this.queue.length,
            queue: this.queue.map(item => ({
                id: item.id,
                fileCount: item.files.length,
                hasJobDescription: item.hasJobDescription,
                timestamp: item.timestamp
            }))
        };
    }
}

// Initialize queue manager
const analysisQueue = new AnalysisQueueManager();
        
// Saved Candidates Filter System
class SavedCandidatesFilter {
    constructor() {
        this.originalCandidates = [];
        this.filteredCandidates = [];
        this.activeFilters = {
            keywords: '',
            minScore: 0,
            dateSaved: 'all',
            hasPremiumAnalysis: false
        };
    }
    
    setCandidates(savedCandidates) {
        this.originalCandidates = [...savedCandidates];
        this.filteredCandidates = [...savedCandidates];
        return this;
    }
    
    applyKeywordsFilter(query) {
        this.activeFilters.keywords = query.toLowerCase();
        this.updateFilteredResults();
        return this;
    }
    
    applyScoreFilter(minScore) {
        this.activeFilters.minScore = parseInt(minScore);
        this.updateFilteredResults();
        return this;
    }
    
    applyDateFilter(dateRange) {
        this.activeFilters.dateSaved = dateRange;
        this.updateFilteredResults();
        return this;
    }
    
    applyPremiumAnalysisFilter(hasPremium) {
        this.activeFilters.hasPremiumAnalysis = hasPremium;
        this.updateFilteredResults();
        return this;
    }
    
    updateFilteredResults() {
        this.filteredCandidates = this.originalCandidates.filter(savedItem => {
            const candidate = savedItem.candidate;
            
            // Keywords filter
            if (this.activeFilters.keywords) {
                const searchFields = [
                    candidate.candidateName || '',
                    candidate.executiveSummary || '',
                    (candidate.coreCompetencies || '').toString(),
                    extractTitleFromSummary(candidate) || ''
                ].join(' ').toLowerCase();
                
                if (!searchFields.includes(this.activeFilters.keywords)) {
                    return false;
                }
            }
            
            // Score filter
            const candidateScore = parseInt(candidate.candidateScore) || 0;
            if (candidateScore < this.activeFilters.minScore) {
                return false;
            }
            
            // Date filter
            if (this.activeFilters.dateSaved !== 'all') {
                const savedDate = new Date(savedItem.timestamp);
                const now = new Date();
                const daysDiff = (now - savedDate) / (1000 * 60 * 60 * 24);
                
                switch (this.activeFilters.dateSaved) {
                    case 'week':
                        if (daysDiff > 7) return false;
                        break;
                    case 'month':
                        if (daysDiff > 30) return false;
                        break;
                    case '3months':
                        if (daysDiff > 90) return false;
                        break;
                }
            }
            
            // Premium analysis filter
            if (this.activeFilters.hasPremiumAnalysis) {
                const hasPremium = candidate.roleAlignment || candidate.educationCertifications || 
                                 candidate.communication || candidate.redFlags || 
                                 candidate.strategicRecommendations || candidate.candidateScorecard;
                if (!hasPremium) return false;
            }
            
            return true;
        });
        
        return this;
    }
    
    getFilteredCandidates() {
        return this.filteredCandidates;
    }
    
    getFilterStats() {
        return {
            total: this.originalCandidates.length,
            filtered: this.filteredCandidates.length,
            hidden: this.originalCandidates.length - this.filteredCandidates.length
        };
    }
    
    clearAllFilters() {
        this.activeFilters = {
            keywords: '',
            minScore: 0,
            dateSaved: 'all',
            hasPremiumAnalysis: false
        };
        this.updateFilteredResults();
        return this;
    }
}

// Candidate Comparison Management System
class CandidateComparison {
    constructor() {
        this.selectedCandidates = new Set();
        this.maxSelections = 3;
    }
    
    toggleSelection(candidateId) {
        if (this.selectedCandidates.has(candidateId)) {
            this.selectedCandidates.delete(candidateId);
        } else {
            if (this.selectedCandidates.size >= this.maxSelections) {
                return { success: false, message: `Maximum ${this.maxSelections} candidates can be selected for comparison` };
            }
            this.selectedCandidates.add(candidateId);
        }
        
        this.updateCompareButton();
        return { success: true, count: this.selectedCandidates.size };
    }
    
    clearSelections() {
        this.selectedCandidates.clear();
        this.updateCompareButton();
        this.updateCheckboxes();
    }
    
    getSelectedCandidates() {
        const savedCandidates = savedCandidatesManager.getSavedCandidates();
        return savedCandidates.filter(savedItem => 
            this.selectedCandidates.has(savedItem.id)
        );
    }
    
    canCompare() {
        return this.selectedCandidates.size >= 2;
    }
    
    updateCompareButton() {
        const compareBtn = document.getElementById('compare-selected-btn-top');
        const compareBtnText = document.getElementById('compare-btn-text-top');
        
        if (compareBtn && compareBtnText) {
            const count = this.selectedCandidates.size;
            compareBtnText.textContent = `Compare Selected (${count})`;
            
            if (this.canCompare()) {
                compareBtn.disabled = false;
                compareBtn.className = 'w-full py-2 px-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors';
            } else {
                compareBtn.disabled = true;
                compareBtn.className = 'w-full py-2 px-3 bg-gray-400 cursor-not-allowed text-white rounded-lg transition-colors';
            }
        }
    }
    
    updateCheckboxes() {
        const checkboxes = document.querySelectorAll('.candidate-selection-checkbox');
        checkboxes.forEach(checkbox => {
            const candidateId = checkbox.getAttribute('data-candidate-id');
            checkbox.checked = this.selectedCandidates.has(candidateId);
        });
    }
}

// Initialize comparison manager
const candidateComparison = new CandidateComparison();

// Add this function to create score reveal animation
function animateScoreReveal(targetScore) {
    const scoreElement = document.getElementById('candidate-score');
    const scoreCircle = document.querySelector('.score-circle');
    const scoreBadge = document.getElementById('score-badge');
    
    let currentScore = 0;
    const increment = targetScore / 30; // 30 steps for smooth animation
    
    const timer = setInterval(() => {
        currentScore += increment;
        if (currentScore >= targetScore) {
            currentScore = targetScore;
            clearInterval(timer);
            
            // Add celebration effect when complete
            scoreCircle.style.transform = 'scale(1.05)';
            setTimeout(() => {
                scoreCircle.style.transform = 'scale(1)';
            }, 200);
        }
        
        scoreElement.textContent = Math.round(currentScore);
        scoreCircle.style.setProperty('--score-percent', `${currentScore}%`);
    }, 50);
    
    // Update score badge based on score
    setTimeout(() => {
        if (targetScore >= 80) {
            scoreBadge.innerHTML = 'üèÜ Excellent Match';
            scoreBadge.className = 'px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full';
        } else if (targetScore >= 60) {
            scoreBadge.innerHTML = 'üéØ Strong Match';
            scoreBadge.className = 'px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full';
        } else {
            scoreBadge.innerHTML = '‚ö†Ô∏è Partial Match';
            scoreBadge.className = 'px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-medium rounded-full';
        }
    }, 1500);
}

// Add this to your analysis completion function
function calculateAnalysisTime(fileCount) {
    const baseTime = 20; // 20 seconds base
    const perFileTime = Math.floor(Math.random() * 10) + 20; // 20-30 seconds per file
    const totalTime = fileCount * perFileTime + Math.floor(Math.random() * 5); // Add small random variance
    
    if (totalTime < 60) {
        return `${totalTime}s`;
    } else {
        const minutes = Math.floor(totalTime / 60);
        const seconds = totalTime % 60;
        return `${minutes}m ${seconds}s`;
    }
}
        
// Selection toggle function
function toggleCandidateSelection(candidateId) {
    const result = candidateComparison.toggleSelection(candidateId);
    
    if (!result.success) {
        showWarning(result.message);
        // Uncheck the checkbox that was just clicked
        const checkbox = document.querySelector(`[data-candidate-id="${candidateId}"]`);
        if (checkbox) checkbox.checked = false;
    } else {
        if (result.count === 1) {
            showSuccess('Candidate selected for comparison');
        } else if (result.count === 2) {
            showSuccess('2 candidates selected - ready to compare!');
        } else if (result.count === 3) {
            showSuccess('3 candidates selected - maximum reached');
        } else {
            showSuccess('Candidate removed from comparison');
        }
    }
}

// Initialize saved candidates filter
const savedCandidatesFilter = new SavedCandidatesFilter();

// Initialize saved candidates manager
const savedCandidatesManager = new SavedCandidatesManager();

// Toggle save candidate function
function toggleSaveCandidate(candidateIndex, event) {
    const candidate = candidatesData[candidateIndex];
    
    if (!candidate) {
        showError('Candidate data not found');
        return;
    }

    const isAlreadySaved = savedCandidatesManager.isCandidateSaved(candidate);
    
    // GET THE ACTUAL CLICKED BUTTON
    const clickedButton = event.target.closest('.save-candidate-btn');
    
    if (isAlreadySaved) {
        // Find and remove the saved candidate
        const savedCandidates = savedCandidatesManager.getSavedCandidates();
        const savedItem = savedCandidates.find(item => 
            item.candidate.candidateName === candidate.candidateName &&
            item.candidate.executiveSummary === candidate.executiveSummary
        );
        
        if (savedItem) {
            const result = savedCandidatesManager.removeCandidate(savedItem.id);
            if (result.success) {
                showSuccess('Candidate removed from saved list');
                updateSavedCounter();
                
                // UPDATE THE ACTUAL CLICKED BUTTON TO UNSAVED STATE
                if (clickedButton) {
                    clickedButton.className = 'save-candidate-btn w-6 h-6 bg-transparent hover:bg-gray-100 text-gray-400 hover:text-gray-600 rounded-full flex items-center justify-center transition-colors border border-gray-300';
                    clickedButton.title = 'Save candidate';
                    const icon = clickedButton.querySelector('i');
                    if (icon) {
                        icon.className = 'far fa-bookmark text-xs';
                    }
                }
            } else {
                showError(result.message);
            }
        }
    } else {
        // Save the candidate
        const result = savedCandidatesManager.saveCandidate(candidate, {
            analysisDate: new Date().toLocaleDateString(),
            candidateIndex: candidateIndex
        });
        
        if (result.success) {
            showSuccess('Candidate saved successfully!');
            updateSavedCounter();
            
            // UPDATE THE ACTUAL CLICKED BUTTON TO SAVED STATE
            if (clickedButton) {
                clickedButton.className = 'save-candidate-btn w-6 h-6 bg-yellow-500 hover:bg-yellow-600 text-white rounded-full flex items-center justify-center transition-colors shadow-sm';
                clickedButton.title = 'Remove from saved';
                const icon = clickedButton.querySelector('i');
                if (icon) {
                    icon.className = 'fas fa-bookmark text-xs';
                }
            }
        } else {
            if (result.message === 'Candidate already saved') {
                showWarning('This candidate is already in your saved list');
            } else {
                showError(result.message);
            }
        }
    }
}

// New function to update specific button
function updateSpecificSaveButton(candidateIndex, isSaved) {
    // Try multiple approaches to find the correct button
    
    // Approach 1: Find by onclick attribute
    let targetButton = Array.from(document.querySelectorAll('.save-candidate-btn')).find(button => {
        const onclickAttr = button.getAttribute('onclick');
        return onclickAttr && onclickAttr.includes(`toggleSaveCandidate(${candidateIndex})`);
    });
    
    // Approach 2: If not found, try by position (fallback)
    if (!targetButton) {
        const saveButtons = document.querySelectorAll('.save-candidate-btn');
        targetButton = saveButtons[candidateIndex];
    }
    
    // Approach 3: If still not found, find by data attribute (we'll add this)
    if (!targetButton) {
        targetButton = document.querySelector(`[data-candidate-index="${candidateIndex}"]`);
    }
    
    console.log(`Updating button for candidate ${candidateIndex}, found:`, !!targetButton);
    
    if (targetButton) {
        const icon = targetButton.querySelector('i');
        
        if (isSaved) {
            // SAVED STATE: Filled gold ribbon
            targetButton.className = 'save-candidate-btn w-6 h-6 bg-yellow-500 hover:bg-yellow-600 text-white rounded-full flex items-center justify-center transition-colors shadow-sm';
            targetButton.title = 'Remove from saved';
            if (icon) {
                icon.className = 'fas fa-bookmark text-xs';
            }
        } else {
            // UNSAVED STATE: Empty ribbon, no background
            targetButton.className = 'save-candidate-btn w-6 h-6 bg-transparent hover:bg-gray-100 text-gray-400 hover:text-gray-600 rounded-full flex items-center justify-center transition-colors border border-gray-300';
            targetButton.title = 'Save candidate';
            if (icon) {
                icon.className = 'far fa-bookmark text-xs';
            }
        }
    } else {
        console.error(`Could not find save button for candidate ${candidateIndex}`);
    }
}

// Update saved counter in header
function updateSavedCounter() {
    // Update counter after any potential cleanup
    const stats = savedCandidatesManager.getSavedStats();
    const counterElement = document.getElementById('saved-count');
    
    if (stats.totalSaved > 0) {
        counterElement.textContent = stats.totalSaved;
        counterElement.classList.remove('hidden');
    } else {
        counterElement.classList.add('hidden');
    }
}

// Update save button states (filled vs outline)
function updateSaveButtonStates() {
    const saveButtons = document.querySelectorAll('.save-candidate-btn');
    
    // Handle single candidate view (only one button)
    if (!document.getElementById('single-candidate-view').classList.contains('hidden')) {
        const singleButton = saveButtons[0];
        if (singleButton && candidatesData.length > 0) {
            const isAlreadySaved = savedCandidatesManager.isCandidateSaved(candidatesData[0]);
            const icon = singleButton.querySelector('i');
            
            if (isAlreadySaved) {
                // SAVED STATE: Filled gold ribbon
                singleButton.className = 'save-candidate-btn absolute -top-2 -left-2 w-7 h-7 bg-yellow-500 hover:bg-yellow-600 text-white rounded-full flex items-center justify-center transition-colors z-10 shadow-sm';
                singleButton.title = 'Remove from saved';
                if (icon) {
                    icon.className = 'fas fa-bookmark text-xs';
                }
            } else {
                // UNSAVED STATE: Empty ribbon, no background
                singleButton.className = 'save-candidate-btn absolute -top-2 -left-2 w-7 h-7 bg-transparent hover:bg-gray-100 text-gray-400 hover:text-gray-600 rounded-full flex items-center justify-center transition-colors z-10 border border-gray-300';
                singleButton.title = 'Save candidate';
                if (icon) {
                    icon.className = 'far fa-bookmark text-xs';
                }
            }
        }
    } else {
        // Handle multiple candidates view (existing logic)
        for (let i = 0; i < candidatesData.length; i++) {
            if (saveButtons[i] && candidatesData[i]) {
                const isAlreadySaved = savedCandidatesManager.isCandidateSaved(candidatesData[i]);
                const icon = saveButtons[i].querySelector('i');
                
                if (isAlreadySaved) {
                    // SAVED STATE: Filled gold ribbon
                    saveButtons[i].className = 'save-candidate-btn w-6 h-6 bg-yellow-500 hover:bg-yellow-600 text-white rounded-full flex items-center justify-center transition-colors shadow-sm';
                    saveButtons[i].title = 'Remove from saved';
                    if (icon) {
                        icon.className = 'fas fa-bookmark text-xs';
                    }
                } else {
                    // UNSAVED STATE: Empty ribbon, no background
                    saveButtons[i].className = 'save-candidate-btn w-6 h-6 bg-transparent hover:bg-gray-100 text-gray-400 hover:text-gray-600 rounded-full flex items-center justify-center transition-colors border border-gray-300';
                    saveButtons[i].title = 'Save candidate';
                    if (icon) {
                        icon.className = 'far fa-bookmark text-xs';
                    }
                }
            }
        }
    }
}

function showSavedCandidatesView() {
    console.log('Opening saved candidates view...');

    candidateComparison.clearSelections();
    
    // Hide all other pages/content
    hideAllPages();
    
    // Show saved candidates page
    const savedCandidatesPage = document.getElementById('saved-candidates-page');
    if (savedCandidatesPage) {
        savedCandidatesPage.style.display = 'block';
        savedCandidatesPage.classList.remove('support-page-hidden');
    }
    
    // Load and display saved candidates
    loadSavedCandidatesData();

    // Setup top filters with delay to ensure DOM is ready
    setTimeout(() => {
        setupSavedCandidatesTopFilters();
    }, 200);

    // Update usage display for saved candidates page
    const status = creditManager.getStatus();
    const usageElement = document.getElementById('usage-text-saved');
    
    if (usageElement && status) {
        if (status.isFreeTier) {
            usageElement.textContent = `${status.remaining}/3 Free Left`;
        } else if (status.isUltraTier) {
            usageElement.textContent = `${status.ultraCredits} ULTRA ‚Ä¢ ${status.proCredits} PRO`;
        } else {
            usageElement.textContent = `${status.proCredits} PRO credits`;
        }
    }
}

function loadSavedCandidatesData() {
    const savedCandidates = savedCandidatesManager.getSavedCandidates();
    const emptyState = document.getElementById('saved-candidates-empty');
    const overview = document.getElementById('saved-candidates-overview');
    
    if (savedCandidates.length === 0) {
        // Show empty state
        emptyState.classList.remove('hidden');
        overview.classList.add('hidden');
    } else {
        // Show candidates
        emptyState.classList.add('hidden');
        overview.classList.remove('hidden');
        
        // Initialize filter with candidates
        savedCandidatesFilter.setCandidates(savedCandidates);
        
        // Update summary
        document.getElementById('total-saved-candidates').textContent = savedCandidates.length;
        document.getElementById('total-saved-display').textContent = savedCandidates.length;

        // NEW: Update pipeline status
        const pipelineStatus = document.getElementById('saved-pipeline-status');
        if (pipelineStatus) {
            if (savedCandidates.length >= 5) {
                pipelineStatus.textContent = 'Strong pipeline ready';
            } else if (savedCandidates.length >= 3) {
                pipelineStatus.textContent = 'Good selection building';
            } else {
                pipelineStatus.textContent = 'Growing your options';
            }
        }
        
        const lastSaved = savedCandidates[0]?.timestamp;
        document.getElementById('saved-last-updated').textContent = 
            lastSaved ? `Last updated: ${new Date(lastSaved).toLocaleDateString()}` : 'Last updated: Never';
        
        // Generate saved candidate cards
        generateSavedCandidateCards(savedCandidates);
        
        // NEW: Setup top filters with delay to ensure DOM is ready
        setTimeout(() => {
            setupSavedCandidatesTopFilters();
        }, 100);

        // NEW: Setup top filters
        setupSavedCandidatesTopFilters();
        
        // Show first candidate by default
        if (savedCandidates.length > 0) {
            showSavedCandidateDetail(0, savedCandidates);
        }
    }
}

function generateSavedCandidateCards(savedCandidates) {
    const cardsContainer = document.getElementById('saved-candidate-cards');
    cardsContainer.innerHTML = '';
    
    savedCandidates.forEach((savedItem, index) => {
        const card = createSavedCandidateCard(savedItem, index);
        cardsContainer.appendChild(card);
    });
}

function createSavedCandidateCard(savedItem, index) {
    const candidate = savedItem.candidate;
    const card = document.createElement('div');
    card.className = `candidate-mini-card ${index === 0 ? 'active' : ''}`;
    card.onclick = () => showSavedCandidateDetail(index, savedCandidatesFilter.getFilteredCandidates());
    
    // Extract and format top 3 skills for preview
    const topSkills = extractAndFormatSkills(candidate.coreCompetencies);
    
    const score = parseInt(candidate.candidateScore) || 75;
    const name = candidate.candidateName || `Candidate ${index + 1}`;
    const title = extractTitleFromSummary(candidate) || 'Professional';
    
    card.innerHTML = `
        <div class="mini-card-header relative">
            <!-- Selection Checkbox -->
            <div class="absolute top-1 left-1 z-10">
                <input type="checkbox" 
                       class="candidate-selection-checkbox w-4 h-4 text-blue-600 bg-white border-gray-300 rounded focus:ring-blue-500" 
                       data-candidate-id="${savedItem.id}"
                       onclick="event.stopPropagation(); toggleCandidateSelection('${savedItem.id}')"
                       title="Select for comparison">
            </div>
            
            <div class="mini-card-info pl-6">
                <h4>${sanitizeText(name)}</h4>
                <p>${sanitizeText(title)}</p>
                <div class="text-xs text-gray-500 mt-1">
                    Saved: ${savedItem.savedDate}
                </div>
            </div>
            <div class="flex items-start gap-1">
                <button class="remove-saved-btn w-6 h-6 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center transition-colors shadow-sm" 
                        onclick="event.stopPropagation(); removeSavedCandidate('${savedItem.id}')" 
                        title="Remove from saved">
                    <i class="fas fa-times text-xs"></i>
                </button>
                <div class="mini-score-ring" style="--score: ${score}%;">
                    <span class="mini-score-text">${score}</span>
                </div>
            </div>
        </div>
        <div class="mini-skills">
            ${topSkills.map(skill => `<span class="mini-skill-tag">${sanitizeText(skill)}</span>`).join('')}
        </div>
    `;
    
    return card;
}

function showSavedCandidateDetail(index, savedCandidates) {
    const savedItem = savedCandidates[index];
    const candidate = savedItem.candidate;
    
    // Update active card
    document.querySelectorAll('#saved-candidate-cards .candidate-mini-card').forEach((card, i) => {
        if (i === index) {
            card.classList.add('active');
        } else {
            card.classList.remove('active');
        }
    });
    
    // Generate detailed view
    const detailContainer = document.getElementById('selected-saved-candidate-detail');
    detailContainer.innerHTML = generateSavedCandidateDetailHTML(candidate, savedItem, index);
}

function generateSavedCandidateDetailHTML(candidate, savedItem, index) {
    const score = parseInt(candidate.candidateScore) || 75;
    const name = candidate.candidateName || `Candidate ${index + 1}`;
    const title = extractTitleFromSummary(candidate) || 'Professional';
    
    let detailHTML = `
        <!-- Candidate Overview -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-center md:items-start gap-6">
                <div>
                    <div class="flex items-center mb-2">
                        <h2 class="text-2xl font-bold text-gray-800">${name}</h2>
                        <span class="ml-2 px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-medium rounded">
                            <i class="fas fa-bookmark mr-1"></i>Saved
                        </span>
                    </div>
                    
                    <div class="flex flex-wrap gap-2 mt-2">
                        <span class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded-md">${title}</span>
                        <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded-md">Saved: ${savedItem.savedDate}</span>
                        <span class="text-xs bg-green-50 text-green-700 px-2 py-1 rounded-md">Original: ${savedItem.metadata.originalAnalysisDate}</span>
                    </div>
                </div>
                
                <div class="text-center relative">
                    <button class="remove-saved-btn absolute -top-2 -right-2 w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center transition-colors z-10" 
                            onclick="removeSavedCandidate('${savedItem.id}')" 
                            title="Remove from saved">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                    <div class="score-circle" style="--score-percent: ${score}%">
                        <div class="score-label">Score</div>
                        <div class="score-value">${score}</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Executive Summary -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex items-center mb-4">
                <i class="fas fa-file-alt text-blue-500 mr-3"></i>
                <h3 class="text-lg font-semibold">Executive Summary</h3>
            </div>
            <div class="text-gray-700">
                ${candidate.executiveSummary ? `<p>${candidate.executiveSummary}</p>` : '<p>Executive summary not available.</p>'}
            </div>
        </div>
        
        <!-- Core Competencies -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex items-center mb-4">
                <i class="fas fa-brain text-blue-500 mr-3"></i>
                <h3 class="text-lg font-semibold">Core Competencies</h3>
            </div>
            <div class="text-gray-700">
                ${generateCompetenciesHTML(candidate.coreCompetencies)}
            </div>
        </div>
    `;
    
    // Add PRO/ULTRA sections if they exist in the candidate data
    if (candidate.roleAlignment) {
        detailHTML += createPremiumSectionHTML(
            'fas fa-crosshairs',
            'Role Alignment & Potential Fit',
            candidate.roleAlignment,
            'text-purple-600',
            'PRO'
        );
    }
    
    if (candidate.educationCertifications) {
        detailHTML += createPremiumSectionHTML(
            'fas fa-graduation-cap',
            'Education & Certifications',
            candidate.educationCertifications,
            'text-green-600',
            'PRO'
        );
    }
    
    if (candidate.communication) {
        detailHTML += createPremiumSectionHTML(
            'fas fa-comments',
            'Communication & Presentation Quality',
            candidate.communication,
            'text-blue-600',
            'PRO'
        );
    }
    
    if (candidate.redFlags) {
        detailHTML += createPremiumSectionHTML(
            'fas fa-exclamation-triangle',
            'Red Flags & Risk Analysis',
            candidate.redFlags,
            'text-red-600',
            'PRO'
        );
    }
    
    if (candidate.strategicRecommendations) {
        detailHTML += createPremiumSectionHTML(
            'fas fa-lightbulb',
            'Strategic Recommendations',
            candidate.strategicRecommendations,
            'text-green-600',
            'PRO'
        );
    }
    
    if (candidate.candidateScorecard) {
        detailHTML += createPremiumSectionHTML(
            'fas fa-chart-bar',
            'Detailed Candidate Scorecard',
            candidate.candidateScorecard,
            'text-purple-600',
            'PRO'
        );
    }
    
    return detailHTML;
}

function removeSavedCandidate(candidateId) {
    if (confirm('Are you sure you want to remove this candidate from your saved list?')) {
        const result = savedCandidatesManager.removeCandidate(candidateId);
        
        if (result.success) {
            showSuccess('Candidate removed from saved list');
            updateSavedCounter();
            
            // Reload the saved candidates view
            loadSavedCandidatesData();
        } else {
            showError(result.message);
        }
    }
}

function setupSavedCandidatesFilters() {
    // Keywords search
    const keywordsInput = document.getElementById('saved-keywords-filter');
    if (keywordsInput) {
        keywordsInput.addEventListener('input', debounce((e) => {
            handleSavedKeywordsFilter(e.target.value);
        }, 300));
    }
    
    // Score range
    const scoreRange = document.getElementById('saved-score-range');
    const scoreDisplay = document.getElementById('saved-score-display');
    if (scoreRange && scoreDisplay) {
        scoreRange.addEventListener('input', (e) => {
            const value = e.target.value;
            scoreDisplay.textContent = value;
            handleSavedScoreFilter(value);
        });
    }
    
    // Advanced filters toggle
    const toggleAdvanced = document.getElementById('toggle-advanced-filters');
    const advancedFilters = document.getElementById('advanced-filters');
    if (toggleAdvanced && advancedFilters) {
        toggleAdvanced.addEventListener('click', () => {
            const isHidden = advancedFilters.classList.contains('hidden');
            if (isHidden) {
                advancedFilters.classList.remove('hidden');
                toggleAdvanced.innerHTML = '<i class="fas fa-chevron-up mr-1"></i>Advanced Filters';
            } else {
                advancedFilters.classList.add('hidden');
                toggleAdvanced.innerHTML = '<i class="fas fa-chevron-down mr-1"></i>Advanced Filters';
            }
        });
    }
    
    // Date filter
    const dateFilter = document.getElementById('saved-date-filter');
    if (dateFilter) {
        dateFilter.addEventListener('change', (e) => {
            handleSavedDateFilter(e.target.value);
        });
    }
    
    // Premium analysis filter
    const premiumAnalysisFilter = document.getElementById('has-premium-analysis');
    if (premiumAnalysisFilter) {
        premiumAnalysisFilter.addEventListener('change', (e) => {
            handleSavedPremiumFilter(e.target.checked);
        });
    }
    
    // Clear filters button
    const clearFilters = document.getElementById('clear-saved-filters');
    if (clearFilters) {
        clearFilters.addEventListener('click', clearSavedFilters);
    }

    // Compare button
    const compareBtn = document.getElementById('compare-selected-btn');
    if (compareBtn) {
        compareBtn.addEventListener('click', () => {
            if (candidateComparison.canCompare()) {
                showComparisonView();
            }
        });
    }
}

function handleSavedKeywordsFilter(query) {
    savedCandidatesFilter.applyKeywordsFilter(query);
    updateSavedCandidatesDisplayTop();
}

function handleSavedScoreFilter(minScore) {
    savedCandidatesFilter.applyScoreFilter(minScore);
    updateSavedCandidatesDisplayTop();
}

function handleSavedDateFilter(dateRange) {
    savedCandidatesFilter.applyDateFilter(dateRange);
    updateSavedCandidatesDisplayTop();
}

function handleSavedPremiumFilter(hasPremium) {
    savedCandidatesFilter.applyPremiumAnalysisFilter(hasPremium);
    updateSavedCandidatesDisplayTop();
}

function clearSavedFilters() {
    savedCandidatesFilter.clearAllFilters();
    
    // Reset UI elements
    document.getElementById('saved-keywords-filter-top').value = '';
    document.getElementById('saved-score-range-top').value = 0;
    document.getElementById('saved-score-display-top').textContent = 0;
    document.getElementById('saved-date-filter-top').value = 'all';

    updateSavedCandidatesDisplayTop();
    showSuccess('All filters cleared!');
}

function sortSavedCandidates(sortType) {
    console.log('Sorting by:', sortType);
    
    const savedCandidates = savedCandidatesManager.getSavedCandidates();
    let sortedCandidates;
    
    if (sortType === 'score') {
        sortedCandidates = savedCandidates.sort((a, b) => 
            (parseInt(b.candidate.candidateScore) || 0) - (parseInt(a.candidate.candidateScore) || 0)
        );
    } else if (sortType === 'name') {
        sortedCandidates = savedCandidates.sort((a, b) => 
            (a.candidate.candidateName || '').localeCompare(b.candidate.candidateName || '')
        );
    } else if (sortType === 'date') {
        sortedCandidates = savedCandidates.sort((a, b) => 
            new Date(b.timestamp) - new Date(a.timestamp)
        );
    }
    
    // Update the filter with sorted candidates and refresh display
    savedCandidatesFilter.setCandidates(sortedCandidates);
    updateSavedCandidatesDisplayTop();
}

function updateSavedCandidatesDisplay() {
    const filteredCandidates = savedCandidatesFilter.getFilteredCandidates();
    const stats = savedCandidatesFilter.getFilterStats();
    
    // Update candidate cards with filtered results
    generateFilteredSavedCandidateCards(filteredCandidates);
    
    // Update results counter
    const resultsElement = document.getElementById('saved-filter-results');
    if (resultsElement) {
        if (stats.filtered === stats.total) {
            resultsElement.textContent = `Showing all ${stats.total} candidates`;
        } else {
            resultsElement.textContent = `Showing ${stats.filtered} of ${stats.total} candidates`;
        }
    }
    
    // Auto-select first candidate if available
    if (filteredCandidates.length > 0) {
        showSavedCandidateDetail(0, filteredCandidates);
    } else {
        // Show empty state in detail view
        const detailContainer = document.getElementById('selected-saved-candidate-detail');
        detailContainer.innerHTML = `
            <div class="bg-white rounded-xl shadow-sm p-6 text-center">
                <i class="fas fa-search text-gray-300 text-4xl mb-4"></i>
                <h3 class="text-lg font-medium text-gray-600 mb-2">No candidates match your filters</h3>
                <p class="text-gray-500">Try adjusting your filter criteria</p>
            </div>
        `;
    }

    // Restore checkbox states after filtering
    setTimeout(() => {
        candidateComparison.updateCheckboxes();
    }, 50);
}

function generateFilteredSavedCandidateCards(filteredCandidates) {
    const cardsContainer = document.getElementById('saved-candidate-cards');
    cardsContainer.innerHTML = '';
    
    filteredCandidates.forEach((savedItem, index) => {
        const card = createSavedCandidateCard(savedItem, index);
        cardsContainer.appendChild(card);
    });
}

function showComparisonView() {
    const selectedCandidates = candidateComparison.getSelectedCandidates();
    
    if (selectedCandidates.length < 2) {
        showError('Please select at least 2 candidates to compare');
        return;
    }
    
    console.log('Opening comparison view for:', selectedCandidates.map(item => item.candidate.candidateName));
    
    // Hide all other pages
    hideAllPages();
    
    // Show comparison page
    const comparisonPage = document.getElementById('comparison-page');
    if (comparisonPage) {
        comparisonPage.style.display = 'block';
        comparisonPage.classList.remove('support-page-hidden');
    }
    
    // Load comparison data
    loadComparisonData(selectedCandidates);
}

function loadComparisonData(selectedCandidates) {
    // Generate candidates overview chips
    generateCandidateChips(selectedCandidates);
    
    // Generate spider chart
    generateComparisonRadarChart(selectedCandidates);
    
    // Generate side-by-side comparison
    generateSideBySideComparison(selectedCandidates);
    
    showSuccess(`Comparing ${selectedCandidates.length} candidates`);
}

function generateCandidateChips(selectedCandidates) {
    const container = document.getElementById('comparison-candidates-list');
    container.innerHTML = '';
    
    selectedCandidates.forEach((savedItem, index) => {
        const candidate = savedItem.candidate;
        const name = candidate.candidateName || `Candidate ${index + 1}`;
        const score = parseInt(candidate.candidateScore) || 75;
        
        const chip = document.createElement('div');
        chip.className = 'flex items-center bg-gray-100 rounded-full px-3 py-2';
        chip.innerHTML = `
            <div class="w-3 h-3 rounded-full mr-2 bg-${getComparisonColor(index)}-500"></div>
            <span class="text-sm font-medium">${name}</span>
            <span class="ml-2 text-xs bg-gray-200 px-2 py-1 rounded-full">${score}</span>
        `;
        container.appendChild(chip);
    });
}

function getComparisonColor(index) {
    const colors = ['blue', 'green', 'purple'];
    return colors[index % colors.length];
}

function generateComparisonRadarChart(selectedCandidates) {
    const canvas = document.getElementById('comparison-radar-chart');
    const ctx = canvas.getContext('2d');
    
    // Extract scores from candidates
    const chartData = extractRadarChartData(selectedCandidates);
    
    // Destroy existing chart if it exists
    if (window.comparisonChart) {
        window.comparisonChart.destroy();
    }
    
    // Create new radar chart
    window.comparisonChart = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: chartData.labels,
            datasets: chartData.datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Candidate Skills Comparison'
                },
                legend: {
                    position: 'bottom'
                }
            },
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    pointLabels: {
                        font: {
                            size: 12
                        }
                    },
                    ticks: {
                        stepSize: 20,
                        font: {
                            size: 10
                        }
                    }
                }
            },
            elements: {
                line: {
                    borderWidth: 3,  // Thicker lines
                    fill: false,     // Remove fill to see overlapping lines better
                    tension: 0.1
                },
                point: {
                    borderWidth: 2,
                    radius: 5       // Slightly bigger points
                }
            }
        }
    });
}

function extractRadarChartData(selectedCandidates) {
    // Define the 6 skill categories we want to compare
    const skillCategories = [
        'Overall Score',
        'Experience Relevance',
        'Skills Fit', 
        'Communication',
        'Leadership Potential',
        'Risk Profile'
    ];
    
    const datasets = selectedCandidates.map((savedItem, index) => {
        const candidate = savedItem.candidate;
        const name = candidate.candidateName || `Candidate ${index + 1}`;
        const color = getComparisonColorHex(index);
        
        // Extract scores for each category
        const scores = extractCandidateScores(candidate);
        
        return {
            label: name,
            data: [
                scores.overall,
                scores.experienceRelevance,
                scores.skillsFit,
                scores.communication,
                scores.leadershipPotential,
                scores.riskProfile
            ],
            borderColor: color,
            backgroundColor: 'transparent',
            pointBackgroundColor: color,
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: color,
            borderWidth: 3
        };
    });
    
    return {
        labels: skillCategories,
        datasets: datasets
    };
}

function getComparisonColorHex(index) {
    const colors = ['#3B82F6', '#10B981', '#8B5CF6']; // Blue, Green, Purple
    const color = colors[index % colors.length];
    console.log(`Candidate ${index} getting color:`, color); // Debug log
    return color;
}

function extractCandidateScores(candidate) {
    // Extract scores from candidateScorecard or generate based on available data
    let scores = {
        overall: parseInt(candidate.candidateScore) || 75,
        experienceRelevance: 75,
        skillsFit: 75,
        communication: 75,
        leadershipPotential: 75,
        riskProfile: 75
    };
    
    // Try to extract from detailed scorecard if available
    if (candidate.candidateScorecard) {
        const scorecard = candidate.candidateScorecard;
        
        // Look for score patterns in the scorecard text
        const experienceMatch = scorecard.match(/experience\s+relevance[^0-9]*(\d+)/i);
        const skillsMatch = scorecard.match(/skills?\s+fit[^0-9]*(\d+)/i);
        const communicationMatch = scorecard.match(/communication[^0-9]*(\d+)/i);
        const leadershipMatch = scorecard.match(/leadership\s+potential[^0-9]*(\d+)/i);
        const riskMatch = scorecard.match(/risk\s+profile[^0-9]*(\d+)/i);
        
        if (experienceMatch) scores.experienceRelevance = parseInt(experienceMatch[1]);
        if (skillsMatch) scores.skillsFit = parseInt(skillsMatch[1]);
        if (communicationMatch) scores.communication = parseInt(communicationMatch[1]);
        if (leadershipMatch) scores.leadershipPotential = parseInt(leadershipMatch[1]);
        if (riskMatch) scores.riskProfile = parseInt(riskMatch[1]);
    }
    
    // Ensure scores are within valid range
    Object.keys(scores).forEach(key => {
        scores[key] = Math.max(0, Math.min(100, scores[key]));
    });

    return scores;
}

function generateSideBySideComparison(selectedCandidates) {
    const container = document.getElementById('side-by-side-comparison');
    container.innerHTML = '';
    
    selectedCandidates.forEach((savedItem, index) => {
        const candidate = savedItem.candidate;
        const comparisonCard = createComparisonCard(candidate, savedItem, index);
        container.appendChild(comparisonCard);
    });
}

function createComparisonCard(candidate, savedItem, index) {
    const card = document.createElement('div');
    card.className = 'bg-white rounded-xl shadow-sm border-2 border-gray-200';
    
    const name = candidate.candidateName || `Candidate ${index + 1}`;
    const title = extractTitleFromSummary(candidate) || 'Professional';
    const score = parseInt(candidate.candidateScore) || 75;
    const color = getComparisonColor(index);
    const scores = extractCandidateScores(candidate);
    
    card.innerHTML = `
        <!-- Card Header -->
        <div class="bg-${color}-50 border-b-2 border-${color}-200 p-4">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center">
                    <div class="w-4 h-4 rounded-full bg-${color}-500 mr-3"></div>
                    <h3 class="text-lg font-bold text-gray-800">${name}</h3>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold text-${color}-600">${score}</div>
                    <div class="text-xs text-gray-500">Overall Score</div>
                </div>
            </div>
            <p class="text-sm text-gray-600">${title}</p>
            <p class="text-xs text-gray-500 mt-1">Saved: ${savedItem.savedDate}</p>
        </div>
        
        <!-- Scores Section -->
        <div class="p-4 border-b border-gray-100">
            <h4 class="text-sm font-semibold text-gray-700 mb-3">Skill Breakdown</h4>
            <div class="grid grid-cols-2 gap-3">
                ${createScoreItem('Experience Relevance', scores.experienceRelevance, color)}
                ${createScoreItem('Skills Fit', scores.skillsFit, color)}
                ${createScoreItem('Communication', scores.communication, color)}
                ${createScoreItem('Leadership Potential', scores.leadershipPotential, color)}
                ${createScoreItem('Risk Profile', scores.riskProfile, color)}
            </div>
        </div>
        
        <!-- Executive Summary -->
        <div class="p-4 border-b border-gray-100">
            <h4 class="text-sm font-semibold text-gray-700 mb-2">Executive Summary</h4>
            <p class="text-xs text-gray-600 line-clamp-4">${candidate.executiveSummary ? 
                (candidate.executiveSummary.length > 200 ? 
                    candidate.executiveSummary.substring(0, 200) + '...' : 
                    candidate.executiveSummary) : 
                'No summary available'}</p>
        </div>
        
        <!-- Core Competencies -->
        <div class="p-4 border-b border-gray-100">
            <h4 class="text-sm font-semibold text-gray-700 mb-2">Top Skills</h4>
            <div class="flex flex-wrap gap-1">
                ${generateTopSkillsForComparison(candidate.coreCompetencies, color)}
            </div>
        </div>
        
        <!-- PRO/ULTRA Analysis Indicators -->
        <div class="p-4">
            <h4 class="text-sm font-semibold text-gray-700 mb-2">Analysis Depth</h4>
            <div class="grid grid-cols-2 gap-2 text-xs">
                ${createAnalysisIndicator('Role Alignment', candidate.roleAlignment)}
                ${createAnalysisIndicator('Education', candidate.educationCertifications)}
                ${createAnalysisIndicator('Communication', candidate.communication)}
                ${createAnalysisIndicator('Red Flags', candidate.redFlags)}
                ${createAnalysisIndicator('Recommendations', candidate.strategicRecommendations)}
                ${createAnalysisIndicator('Scorecard', candidate.candidateScorecard)}
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="p-4 bg-gray-50 rounded-b-xl">
            <div class="flex gap-2">
                <button onclick="viewFullCandidate('${savedItem.id}')" class="flex-1 px-3 py-2 bg-${color}-600 text-white rounded-lg text-xs hover:bg-${color}-700 transition-colors">
                    <i class="fas fa-eye mr-1"></i>View Full
                </button>
                <button onclick="removeSavedCandidate('${savedItem.id}')" class="px-3 py-2 bg-red-500 text-white rounded-lg text-xs hover:bg-red-600 transition-colors">
                    <i class="fas fa-trash mr-1"></i>Remove
                </button>
            </div>
        </div>
    `;
    
    return card;
}

function createScoreItem(label, score, color) {
    return `
        <div class="flex justify-between items-center">
            <span class="text-xs text-gray-600">${label}</span>
            <div class="flex items-center">
                <div class="w-12 h-2 bg-gray-200 rounded-full mr-2">
                    <div class="h-2 bg-${color}-500 rounded-full" style="width: ${score}%"></div>
                </div>
                <span class="text-xs font-medium text-gray-700">${score}</span>
            </div>
        </div>
    `;
}

function generateTopSkillsForComparison(competencies, color) {
    const skills = extractAndFormatSkills(competencies);
    return skills.slice(0, 6).map(skill => 
        `<span class="px-2 py-1 bg-${color}-100 text-${color}-800 rounded-full text-xs">${skill}</span>`
    ).join('');
}

function createAnalysisIndicator(label, hasData) {
    const icon = hasData ? 'fa-check text-green-500' : 'fa-times text-gray-400';
    return `
        <div class="flex items-center">
            <i class="fas ${icon} mr-2"></i>
            <span class="text-gray-600">${label}</span>
        </div>
    `;
}

function viewFullCandidate(candidateId) {
    // Navigate back to saved candidates and show this specific candidate
    hideAllPages();
    showSavedCandidatesView();
    
    setTimeout(() => {
        // Find and show the specific candidate
        const savedCandidates = savedCandidatesManager.getSavedCandidates();
        const candidateIndex = savedCandidates.findIndex(item => item.id === candidateId);
        if (candidateIndex !== -1) {
            showSavedCandidateDetail(candidateIndex, savedCandidates);
            showSuccess('Showing full candidate details');
        }
    }, 300);
}

function loadComparisonData(selectedCandidates) {
    // Generate candidates overview chips
    generateCandidateChips(selectedCandidates);
    
    // Generate spider chart
    generateComparisonRadarChart(selectedCandidates);
    
    // Generate side-by-side comparison
    generateSideBySideComparison(selectedCandidates);
    
    // Setup comparison action buttons
    setupComparisonActions();
    
    showSuccess(`Comparing ${selectedCandidates.length} candidates`);
}

function setupComparisonActions() {
    // Clear comparison button
    const clearBtn = document.getElementById('clear-comparison-btn');
    if (clearBtn) {
        clearBtn.onclick = () => {
            if (confirm('Clear all selected candidates and return to saved candidates view?')) {
                candidateComparison.clearSelections();
                hideAllPages();
                showSavedCandidatesView();
                showSuccess('Comparison cleared');
            }
        };
    }
    
    // Export comparison button
    const exportBtn = document.getElementById('export-comparison-btn');
    if (exportBtn) {
        exportBtn.onclick = () => {
            exportComparison();
        };
    }
}

async function exportComparison() {
    const exportBtn = document.getElementById('export-comparison-btn');
    const originalHtml = exportBtn.innerHTML;
    
    try {
        // Show loading state
        exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating PDF...';
        exportBtn.disabled = true;
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Colors
        const primaryColor = [59, 130, 246];
        const grayColor = [107, 114, 128];
        const darkColor = [31, 41, 55];
        
        let yPosition = 20;
        
        // Header
        doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
        doc.roundedRect(15, yPosition, 180, 35, 5, 5, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(18);
        doc.setFont(undefined, 'bold');
        doc.text('MontPro Candidate Comparison', 20, yPosition + 15);
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(`Generated on ${new Date().toLocaleDateString()}`, 20, yPosition + 25);
        
        // Candidate names in header
        const selectedCandidates = candidateComparison.getSelectedCandidates();
        const candidateNames = selectedCandidates.map(item => 
            item.candidate.candidateName || 'Unnamed Candidate'
        ).join(' vs ');
        doc.text(`Comparing: ${candidateNames}`, 20, yPosition + 32);
        
        yPosition += 50;
        
        // Capture spider chart as image
        const canvas = document.getElementById('comparison-radar-chart');
        if (canvas && window.comparisonChart) {
            try {
                // Convert chart to image
                const chartImage = canvas.toDataURL('image/png', 1.0);
                
                // Add chart to PDF (centered)
                const chartWidth = 120;
                const chartHeight = 90;
                const chartX = (210 - chartWidth) / 2; // Center on A4 page
                
                doc.addImage(chartImage, 'PNG', chartX, yPosition, chartWidth, chartHeight);
                yPosition += chartHeight + 15;
                
            } catch (chartError) {
                console.error('Error capturing chart:', chartError);
                // Add fallback text if chart capture fails
                doc.setFontSize(12);
                doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
                doc.text('Spider Chart (Could not capture)', 20, yPosition);
                yPosition += 20;
            }
        }
        
        // Add candidate comparison details
        selectedCandidates.forEach((savedItem, index) => {
            const candidate = savedItem.candidate;
            const name = candidate.candidateName || `Candidate ${index + 1}`;
            const title = extractTitleFromSummary(candidate) || 'Professional';
            const score = parseInt(candidate.candidateScore) || 75;
            const scores = extractCandidateScores(candidate);
            
            // Check if we need a new page
            if (yPosition > 200) {
                doc.addPage();
                yPosition = 20;
            }
            
            // Candidate header
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
            doc.text(`${name} (Score: ${score})`, 20, yPosition);
            
            yPosition += 8;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(grayColor[0], grayColor[1], grayColor[2]);
            doc.text(title, 20, yPosition);
            
            yPosition += 12;
            
            // Skill scores
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
            doc.text('Skill Breakdown:', 20, yPosition);
            
            yPosition += 8;
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            
            const skillData = [
                [`Experience Relevance: ${scores.experienceRelevance}`, `Skills Fit: ${scores.skillsFit}`],
                [`Communication: ${scores.communication}`, `Leadership Potential: ${scores.leadershipPotential}`],
                [`Risk Profile: ${scores.riskProfile}`, '']
            ];
            
            skillData.forEach(row => {
                doc.text(row[0], 25, yPosition);
                if (row[1]) doc.text(row[1], 110, yPosition);
                yPosition += 6;
            });
            
            yPosition += 5;
            
            // Executive Summary
            if (candidate.executiveSummary) {
                doc.setFont(undefined, 'bold');
                doc.text('Executive Summary:', 20, yPosition);
                yPosition += 8;
                
                doc.setFont(undefined, 'normal');
                const summaryLines = doc.splitTextToSize(
                    candidate.executiveSummary.length > 300 ? 
                    candidate.executiveSummary.substring(0, 300) + '...' : 
                    candidate.executiveSummary, 
                    170
                );
                doc.text(summaryLines, 20, yPosition);
                yPosition += summaryLines.length * 5 + 8;
            }
            
            // Top Skills
            doc.setFont(undefined, 'bold');
            doc.text('Top Skills:', 20, yPosition);
            yPosition += 8;
            
            doc.setFont(undefined, 'normal');
            const topSkills = extractAndFormatSkills(candidate.coreCompetencies);
            const skillsText = topSkills.slice(0, 6).join(', ');
            const skillsLines = doc.splitTextToSize(skillsText, 170);
            doc.text(skillsLines, 20, yPosition);
            yPosition += skillsLines.length * 5 + 15;
        });
        
        // Footer
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(grayColor[0], grayColor[1], grayColor[2]);
            doc.text('Generated by MontPro Recruitment Engine', 20, 285);
            doc.text(`Page ${i} of ${pageCount}`, 180, 285);
        }
        
        // Save the PDF
        const fileName = `MontPro_Comparison_${selectedCandidates.length}candidates_${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(fileName);
        
        // Success state
        exportBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Downloaded!';
        showSuccess('Comparison exported successfully!');
        
        setTimeout(() => {
            exportBtn.innerHTML = originalHtml;
            exportBtn.disabled = false;
        }, 2000);
        
    } catch (error) {
        console.error('Comparison export failed:', error);
        
        // Error state
        exportBtn.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>Failed';
        showError('Failed to export comparison. Please try again.');
        
        setTimeout(() => {
            exportBtn.innerHTML = originalHtml;
            exportBtn.disabled = false;
        }, 3000);
    }
}
        
// Initialize history manager
const historyManager = new AnalysisHistory();
    // More methods will be added in next steps...

// Initialize feedback manager
const feedback = new MontProFeedback();
const supabaseUrl = 'https://saiwhkhgnsgakvbohwym.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNhaXdoa2hnbnNnYWt2Ym9od3ltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MzIxMjIsImV4cCI6MjA2MzMwODEyMn0.4MUgz7sYll0MYV30mwbAAYkLDs2MtPpSykgvWE10KuU';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// Global variables
let files = [];
window.files = files;
let fileInput;
let dragArea;
let fileListContainer;
let fileList;
let fileCount;
let startButton;
let errorMessage;
let errorText;
let statusMessage;
let statusText;
let statusIcon;
let clearAllBtn;
let allowedTypes;
let typeNames;
let typeIcons;
let candidateFilter = new CandidateFilter();
let paymentHandler = new PaymentHandler();

// XSS Protection - HTML Sanitization
function sanitizeText(text) {
    if (!text || typeof text !== 'string') return text;
    
    // Create a temporary element to decode HTML entities safely
    const tempDiv = document.createElement('div');
    tempDiv.textContent = text;
    let sanitized = tempDiv.innerHTML;
    
    // Remove dangerous HTML tags and attributes
    sanitized = sanitized
        .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '') // Remove script tags
        .replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi, '') // Remove iframe tags
        .replace(/javascript:/gi, '') // Remove javascript: protocol
        .replace(/on\w+\s*=/gi, '') // Remove event handlers like onclick, onload, etc
        .replace(/<object\b[^<]*(?:(?!<\/object>)<[^<]*)*<\/object>/gi, '') // Remove object tags
        .replace(/<embed\b[^<]*(?:(?!<\/embed>)<[^<]*)*<\/embed>/gi, '') // Remove embed tags
        .replace(/<link\b[^>]*>/gi, '') // Remove link tags
        .replace(/<meta\b[^>]*>/gi, ''); // Remove meta tags
    
    return sanitized;
}

// Safe HTML rendering for candidate data
function safelySetHTML(element, content) {
    if (!element) return;
    
    if (typeof content === 'string') {
        // Sanitize and allow basic formatting
        const sanitized = sanitizeText(content);
        element.innerHTML = sanitized
            .replace(/\n/g, '<br>')
            .replace(/^- /gm, '‚Ä¢ ');
    } else {
        element.textContent = content || '';
    }
}

function updateUsageDisplay() {
    const status = creditManager.getStatus();
    const usageElement = document.getElementById('usage-text');
    const upgradeBtn = document.getElementById('upgrade-btn');
    
    if (!usageElement) {
        console.log('Usage display element not found yet');
        return;
    }
    
    if (status.isFreeTier) {
        usageElement.textContent = `${status.remaining}/3 Free Left`;
        if (status.remaining === 0) {
            usageElement.className = 'text-red-600 font-medium';
        } else if (status.remaining === 1) {
            usageElement.className = 'text-orange-600 font-medium';
        } else {
            usageElement.className = 'text-gray-700';
        }
        // Show upgrade button for free users
        if (upgradeBtn) {
            upgradeBtn.classList.remove('hidden');
            upgradeBtn.innerHTML = '<i class="fas fa-arrow-up mr-1"></i>Upgrade';
        }
        
    } else if (status.isUltraTier) {
        // ULTRA user - show both credit types
        if (status.ultraCredits > 0 && status.proCredits > 0) {
            usageElement.textContent = `${status.ultraCredits} ULTRA ‚Ä¢ ${status.proCredits} PRO`;
            usageElement.className = 'text-purple-600 font-medium';
        } else if (status.ultraCredits > 0) {
            usageElement.textContent = `${status.ultraCredits} ULTRA credits`;
            usageElement.className = 'text-purple-600 font-medium';
        } else if (status.proCredits > 0) {
            usageElement.textContent = `${status.proCredits} PRO credits`;
            usageElement.className = 'text-blue-600 font-medium';
        } else {
            usageElement.textContent = `0 credits`;
            usageElement.className = 'text-red-600 font-medium';
        }
        
        // Show upgrade button when credits are low
        if ((status.ultraCredits + status.proCredits) < 5) {
            if (upgradeBtn) {
                upgradeBtn.classList.remove('hidden');
                upgradeBtn.innerHTML = '<i class="fas fa-plus mr-1"></i>Buy Credits';
            }
        } else {
            if (upgradeBtn) {
                upgradeBtn.classList.add('hidden');
            }
        }
        
    } else {
        // PRO user - show PRO credits
        usageElement.textContent = `${status.proCredits} PRO credits`;
        if (status.proCredits < 5) {
            usageElement.className = 'text-orange-600 font-medium';
            // Show upgrade button when credits are low
            if (upgradeBtn) {
                upgradeBtn.classList.remove('hidden');
                upgradeBtn.innerHTML = '<i class="fas fa-plus mr-1"></i>Buy Credits';
            }
        } else {
            usageElement.className = 'text-blue-600 font-medium';
            // Hide button when credits are sufficient
            if (upgradeBtn) {
                upgradeBtn.classList.add('hidden');
            }
        }
    }
    updateJobDescriptionAccess();
}

function updateJobDescriptionAccess() {
    const status = creditManager.getStatus();
    const jobDescriptionTextarea = document.getElementById('job-description');
    const jdInfoText = document.getElementById('jd-info-text');
    const jdFeatureBadge = document.getElementById('jd-feature-badge');
    
    if (status.isUltraTier && status.ultraCredits > 0) {
        // Enable for ULTRA users with ULTRA credits
        jobDescriptionTextarea.disabled = false;
        jobDescriptionTextarea.classList.remove('bg-gray-100');
        jdInfoText.textContent = `AI will match candidates against this job description (Uses ULTRA credits: ${status.ultraCredits} available)`;
        jdFeatureBadge.innerHTML = '<i class="fas fa-crown mr-1"></i>ULTRA Active';
        jdFeatureBadge.className = 'px-2 py-1 bg-gradient-to-r from-purple-500 to-pink-600 text-white text-xs font-medium rounded shadow-sm';
    } else if (status.isUltraTier && status.ultraCredits === 0) {
        // ULTRA user but no ULTRA credits
        jobDescriptionTextarea.disabled = true;
        jobDescriptionTextarea.classList.add('bg-gray-100');
        jdInfoText.innerHTML = 'No ULTRA credits remaining for job matching ‚Ä¢ <a href="#" onclick="showPricingPage()" class="text-purple-600 hover:text-purple-800">Buy ULTRA Credits</a>';
        jdFeatureBadge.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i>Need Credits';
        jdFeatureBadge.className = 'px-2 py-1 bg-orange-500 text-white text-xs font-medium rounded shadow-sm';
    } else if (!status.isFreeTier) {
        // PRO users see upgrade prompt
        jobDescriptionTextarea.disabled = true;
        jobDescriptionTextarea.classList.add('bg-gray-100');
        jdInfoText.innerHTML = 'Upgrade to ULTRA for job description matching ‚Ä¢ <a href="#" onclick="showPricingPage()" class="text-purple-600 hover:text-purple-800">Upgrade Now</a>';
        jdFeatureBadge.innerHTML = '<i class="fas fa-crown mr-1"></i>ULTRA Feature';
        jdFeatureBadge.className = 'px-2 py-1 bg-gradient-to-r from-purple-500 to-pink-600 text-white text-xs font-medium rounded shadow-sm';
    } else {
        // Free users see basic message
        jobDescriptionTextarea.disabled = true;
        jobDescriptionTextarea.classList.add('bg-gray-100');
        jdInfoText.textContent = 'Upgrade to ULTRA to unlock job description matching';
        jdFeatureBadge.innerHTML = '<i class="fas fa-crown mr-1"></i>ULTRA Feature';
        jdFeatureBadge.className = 'px-2 py-1 bg-gradient-to-r from-purple-500 to-pink-600 text-white text-xs font-medium rounded shadow-sm';
    }
}
        
// Pricing Page Navigation Functions
function showPricingPage() {
    console.log('Showing pricing page...');
    hideAllPages(); // Use the new unified function
    
    const pricingPage = document.getElementById('pricing-page');
    if (pricingPage) {
        pricingPage.style.display = 'block';
        pricingPage.style.position = 'relative'; // Ensure proper positioning
        pricingPage.style.zIndex = '1';
        console.log('Pricing page shown');
    }
    
    // Update button text based on current tier
    updatePricingPageForUser();
    updateUltraButtonForProUser();
}

function hidePricingPage() {
    document.getElementById('pricing-page').style.display = 'none';
    document.getElementById('main-app').style.display = 'block';
    
    // Always show analysis results if they exist
    const analysisResults = document.getElementById('analysis-results');
    if (analysisResults && !analysisResults.classList.contains('hidden')) {
        // Keep showing results
    } else {
        // Show upload interface if no results
        document.getElementById('upload-interface').classList.remove('hidden');
    }
}

// Support Pages Navigation Functions
// Support Pages Navigation Functions (with debug)
function showSupportPage() {
    console.log('Showing support page...');
    hideAllPages();
    const supportPage = document.getElementById('support-page');
    if (supportPage) {
        supportPage.style.display = 'block';
        console.log('Support page shown');
    } else {
        console.error('Support page element not found!');
    }
}

function showFAQPage() {
    console.log('Showing FAQ page...');
    hideAllPages();
    
    const faqPage = document.getElementById('faq-page');
    if (faqPage) {
        faqPage.style.display = 'block';
        
        // Enhanced debugging
        console.log('FAQ page element:', faqPage);
        console.log('FAQ page display:', faqPage.style.display);
        console.log('FAQ page computed style:', window.getComputedStyle(faqPage).display);
        console.log('FAQ page visibility:', window.getComputedStyle(faqPage).visibility);
        console.log('FAQ page height:', faqPage.offsetHeight);
        console.log('FAQ page width:', faqPage.offsetWidth);
        
        // Force positioning
        faqPage.style.position = 'relative';
        faqPage.style.zIndex = '999';
        faqPage.style.backgroundColor = 'white';
        faqPage.style.minHeight = '100vh';
        
        console.log('FAQ page shown with forced styles');
    } else {
        console.error('FAQ page element not found!');
    }
}

function showTermsPage() {
    console.log('Showing terms page...');
    hideAllPages();
    const termsPage = document.getElementById('terms-page');
    if (termsPage) {
        termsPage.style.display = 'block';
        console.log('Terms page shown');
    } else {
        console.error('Terms page element not found!');
    }
}

function showPrivacyPage() {
    console.log('Showing privacy page...');
    hideAllPages();
    const privacyPage = document.getElementById('privacy-page');
    if (privacyPage) {
        privacyPage.style.display = 'block';
        console.log('Privacy page shown');
    } else {
        console.error('Privacy page element not found!');
    }
}

function hideAllPages() {
    // Hide main app components
    const mainApp = document.getElementById('main-app');
    const analysisResults = document.getElementById('analysis-results');
    const pricingPage = document.getElementById('pricing-page');
    
    if (mainApp) mainApp.style.display = 'none';
    if (analysisResults) analysisResults.classList.add('hidden');
    if (pricingPage) pricingPage.style.display = 'none';
    
    // Hide support pages
    const supportPage = document.getElementById('support-page');
    const faqPage = document.getElementById('faq-page');
    const termsPage = document.getElementById('terms-page');
    const privacyPage = document.getElementById('privacy-page');
    const savedCandidatesPage = document.getElementById('saved-candidates-page');
    const comparisonPage = document.getElementById('comparison-page');
    
    if (supportPage) supportPage.style.display = 'none';
    if (faqPage) faqPage.style.display = 'none';
    if (termsPage) termsPage.style.display = 'none';
    if (privacyPage) privacyPage.style.display = 'none';
    if (savedCandidatesPage) {
        savedCandidatesPage.style.display = 'none';
        savedCandidatesPage.classList.add('support-page-hidden');
    }
    if (comparisonPage) {
        comparisonPage.style.display = 'none';
        comparisonPage.classList.add('support-page-hidden');
    }
}

function hideAllSupportPages() {
    console.log('Hiding all support pages...');
    hideAllPages();
    
    // Show main app
    const mainApp = document.getElementById('main-app');
    if (mainApp) {
        mainApp.style.display = 'block';
        console.log('Main app restored');
    }
    
    // Show appropriate content
    const analysisResults = document.getElementById('analysis-results');
    const uploadInterface = document.getElementById('upload-interface');
    
    if (analysisResults && !analysisResults.classList.contains('hidden')) {
        // Keep showing results if they exist
        console.log('Showing analysis results');
    } else if (uploadInterface) {
        // Show upload interface if no results
        uploadInterface.classList.remove('hidden');
        console.log('Showing upload interface');
    }
}

function updatePricingPageForUser() {
    const status = creditManager.getStatus();
    const currentPlanBtn = document.getElementById('current-plan-btn');
    const upgradeBtn = document.getElementById('upgrade-professional-btn');
    
    if (status.isFreeTier) {
        currentPlanBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Paket Aktif';
        upgradeBtn.innerHTML = '<i class="fas fa-rocket mr-2"></i>Beli 30 Credits - Rp 599.000';
    } else {
        currentPlanBtn.innerHTML = '<i class="fas fa-arrow-up mr-2"></i>Upgrade to Professional';
        upgradeBtn.innerHTML = `<i class="fas fa-plus mr-2"></i>Purchase Additional 30 Credits`;
    }
}

function updateUltraButtonForProUser() {
    const status = creditManager.getStatus();
    const ultraBtn = document.getElementById('upgrade-ultra-btn');
    const ultraBtnText = document.getElementById('ultra-btn-text');
    
    if (status.tier === 'PROFESSIONAL' && status.proCredits > 0) {
        // PRO user with existing credits - show conversion option
        const conversion = creditManager.calculateCreditConversion();
        if (conversion) {
            ultraBtnText.innerHTML = `Convert to ${conversion.newUltraCredits} ULTRA Credits`;
            
            // Remove existing help text if any
            const existingHelp = ultraBtn.parentNode.querySelector('.conversion-help');
            if (existingHelp) existingHelp.remove();
            
            // Add helpful text and second button
            const helpText = document.createElement('div');
            helpText.className = 'conversion-help mt-3';
            helpText.innerHTML = `
                <p class="text-xs text-green-600 text-center mb-3">
                    Your ${conversion.currentProCredits} PRO credits = ${conversion.newUltraCredits} ULTRA credits${conversion.bonusCredits > 0 ? ' (+' + conversion.bonusCredits + ' bonus!)' : ''}
                </p>
                <div class="text-center">
                    <button id="buy-new-ultra-btn" class="w-full py-2 px-4 bg-white text-purple-600 border border-purple-600 font-medium rounded-lg hover:bg-purple-50 transition-colors text-sm">
                        <i class="fas fa-shopping-cart mr-2"></i>
                        Or Buy 20 New ULTRA Credits - Rp 999.000
                    </button>
                </div>
            `;
            ultraBtn.parentNode.appendChild(helpText);
            
            // Add event listener for the new button
            document.getElementById('buy-new-ultra-btn').addEventListener('click', () => purchaseNewUltraCredits());
        }
    } else if (status.tier === 'ULTRA') {
        // ULTRA user - show purchase options
        ultraBtnText.innerHTML = 'Buy More ULTRA Credits';
        
        // Remove existing help text if any
        const existingHelp = ultraBtn.parentNode.querySelector('.conversion-help');
        if (existingHelp) existingHelp.remove();
        
        // Add purchase options
        const purchaseOptions = document.createElement('div');
        purchaseOptions.className = 'conversion-help mt-3 space-y-2';
        purchaseOptions.innerHTML = `
            <button id="buy-ultra-credits-btn" class="w-full py-2 px-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-medium rounded-lg hover:from-purple-700 hover:to-pink-700 transition-colors text-sm">
                <i class="fas fa-crown mr-2"></i>
                Buy 20 ULTRA Credits - Rp 999.000
            </button>
            <button id="buy-pro-credits-btn" class="w-full py-2 px-4 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors text-sm">
                <i class="fas fa-plus mr-2"></i>
                Buy 30 PRO Credits - Rp 599.000
            </button>
            <p class="text-xs text-gray-500 text-center mt-2">
                PRO credits work for basic analysis ‚Ä¢ ULTRA credits for job matching
            </p>
        `;
        ultraBtn.parentNode.appendChild(purchaseOptions);
        
        // Add event listeners
        document.getElementById('buy-ultra-credits-btn').addEventListener('click', () => purchaseNewUltraCredits());
        document.getElementById('buy-pro-credits-btn').addEventListener('click', () => purchaseProCredits());
        
        // Hide the main button since we have the options below
        ultraBtn.style.display = 'none';
    }
}

async function convertCreditsToUltra() {
    const conversion = creditManager.calculateCreditConversion();
    if (!conversion) {
        showError('No conversion available');
        return;
    }
    
    // Show confirmation
    const confirmMsg = `Convert ${conversion.currentProCredits} PRO credits to ${conversion.newUltraCredits} ULTRA credits${conversion.bonusCredits > 0 ? ' (including ' + conversion.bonusCredits + ' bonus credit)' : ''}?`;
    
    if (!confirm(confirmMsg)) return;
    
    const result = await creditManager.convertToUltra();
    if (result) {
        showSuccess(`Converted to ULTRA! You now have ${result.newUltraCredits} ULTRA credits${result.bonusCredits > 0 ? ' (including ' + result.bonusCredits + ' bonus credit!)' : ''}`);
        updateUsageDisplay();
        updateJobDescriptionAccess();
        hidePricingPage();
    } else {
        showError('Conversion failed. Please try again.');
    }
}

async function purchaseNewUltraCredits() {
    const userEmail = creditManager.currentUser.email;
    
    try {
        await paymentHandler.createPayment(999000, 20, userEmail, 'ULTRA');
    } catch (error) {
        console.error('ULTRA payment initiation failed:', error);
        showError('Failed to initiate ULTRA payment. Please try again.');
    }
}

async function purchaseProCredits() {
    const userEmail = creditManager.currentUser.email;
    
    try {
        await paymentHandler.createPayment(599000, 30, userEmail, 'PROFESSIONAL');
    } catch (error) {
        console.error('PRO payment initiation failed:', error);
        showError('Failed to initiate PRO payment. Please try again.');
    }
}
        
async function showMainApp() {
    document.getElementById('auth-box').style.display = 'none';
    document.getElementById('main-app').style.display = '';
    
    // Hide the animated background when logged in
    const animatedBg = document.querySelector('.animated-background');
    if (animatedBg) {
        animatedBg.style.display = 'none';
    }
    
    // Initialize credit management
    await creditManager.initialize();
    updateUsageDisplay();
    updateJobDescriptionAccess();

    // Perform data retention cleanup
    dataRetentionManager.performStartupCleanup();

    // ADD THIS HERE - Wire up Sample Resume button after main app is shown
    setTimeout(() => {
        const sampleResumeBtn = document.getElementById("sample-resume-btn");
        if (sampleResumeBtn) {
            console.log('Sample resume button found, attaching handler');
            sampleResumeBtn.onclick = loadSampleResume;
        } else {
            console.log('Sample resume button not found!');
        }
    }, 100);
}
        
function showAuthBox() {
    document.getElementById('auth-box').style.display = '';
    document.getElementById('main-app').style.display = 'none';
    // Show the animated background when back to login
    const animatedBg = document.querySelector('.animated-background');
    if (animatedBg) {
        animatedBg.style.display = '';
    }
}
function showError(message, persistent = false) {
    const duration = persistent ? 0 : 7000;
    feedback.showNotification(message, 'error', duration);
    
    // Also update the inline error display
    errorText.textContent = message;
    errorMessage.classList.remove('hidden');
}

function hideError() {
    errorMessage.classList.add('hidden');
}    
        
function showSuccess(message) {
    feedback.showNotification(message, 'success', 4000);
}

function showWarning(message) {
    feedback.showNotification(message, 'warning', 6000);
}

function hideStatus() {
    statusMessage.classList.add('hidden');
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    else return (bytes / 1048576).toFixed(1) + ' MB';
}

function handleFileSelect(e) {
    handleFiles(e.target.files);
}

function handleFiles(selectedFiles) {
    const fileArray = Array.from(selectedFiles);
    const validFiles = [];
    const errors = [];
    
    // Validate each file
    fileArray.forEach(file => {
        const validation = feedback.validateFile(file);
        
        if (validation.valid) {
            validFiles.push(file);
        } else {
            errors.push(...validation.errors);
        }
    });
    
    // Show validation results
    if (errors.length > 0) {
        // Show first error as main error
        showError(errors[0]);
        
        // If there are multiple errors, show them in a detailed notification
        if (errors.length > 1) {
            const errorList = errors.slice(1, 4).map(err => `‚Ä¢ ${err}`).join('\n');
            feedback.showNotification(
                `Multiple file validation errors:\n${errorList}${errors.length > 4 ? '\n‚Ä¢ ...' : ''}`,
                'error',
                10000
            );
        }
        
        // Shake the drag area
        dragArea.classList.add('field-error-shake');
        setTimeout(() => dragArea.classList.remove('field-error-shake'), 500);
    }
    
    if (validFiles.length > 0) {
        hideError();
        showSuccess(`${validFiles.length} file${validFiles.length > 1 ? 's' : ''} validated successfully`);
        
        // Clear any field errors
        feedback.clearFieldError(dragArea);
    }
    
    // Add valid files to the list
    files = [...files, ...validFiles];
    updateFileList();

    // ‚ú® NEW: Auto-scroll to start button
        setTimeout(() => {
            const startButton = document.getElementById('start-button');
            if (startButton && files.length > 0) {
                startButton.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'end' 
                });
                
                // Optional: Add a subtle pulse effect to draw attention
                startButton.classList.add('animate-pulse');
                setTimeout(() => {
                    startButton.classList.remove('animate-pulse');
                }, 2000);
            }
        }, 500); // Small delay for better UX
}

function updateFileList() {
    if (files.length > 0) {
        fileListContainer.classList.remove('hidden');
        fileCount.textContent = files.length;
        startButton.disabled = false;
        fileList.innerHTML = '';

        // REMOVE ALL EXISTING WARNINGS (not just one)
        const existingWarnings = fileListContainer.querySelectorAll('.processing-warning');
        existingWarnings.forEach(warning => warning.remove());
        
        files.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            
            const fileInfo = document.createElement('div');
            fileInfo.className = 'flex items-center';
            
            const fileTypeIcon = typeIcons[file.type] || 'fa-file';
            const icon = document.createElement('i');
            icon.className = `fas ${fileTypeIcon} text-blue-500 mr-3`;
            fileInfo.appendChild(icon);
            
            const details = document.createElement('div');
            details.innerHTML = `
                <p class="font-medium text-sm truncate max-w-xs">${file.name}</p>
                <p class="text-xs text-gray-500">
                    ${typeNames[file.type] || 'File'} ¬∑ ${formatFileSize(file.size)}
                </p>
            `;
            fileInfo.appendChild(details);
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'text-gray-500 hover:text-red-500 transition-colors';
            removeBtn.innerHTML = '<i class="fas fa-times-circle"></i>';
            removeBtn.addEventListener('click', function() {
                removeFile(index);
            });
            
            fileItem.appendChild(fileInfo);
            fileItem.appendChild(removeBtn);
            fileList.appendChild(fileItem);
        });

        // ADD PROCESSING TIME WARNING - only ONE warning now
        if (files.length > 2) {
            const warningDiv = document.createElement('div');
            warningDiv.className = 'mt-3 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded-r-lg processing-warning';
            warningDiv.innerHTML = `
                <div class="flex items-start">
                    <i class="fas fa-clock text-yellow-500 mr-2 mt-0.5"></i>
                    <div class="text-sm">
                        <p class="text-yellow-800 font-medium">Processing Time Notice</p>
                        <p class="text-yellow-700 mt-1">
                            ${files.length} files will take approximately ${Math.ceil(files.length * 1.5)}-${Math.ceil(files.length * 2)} minutes to analyze. 
                            Please keep this tab open and avoid refreshing the page.
                        </p>
                    </div>
                </div>
            `;
            
            fileListContainer.appendChild(warningDiv);
        }
    } else {
        fileListContainer.classList.add('hidden');
        startButton.disabled = true;
    }
}

function removeFile(index) {
    files = files.filter((_, i) => i !== index);
    updateFileList();
}

// Analysis functions
async function startAnalysis() {
    if (files.length === 0) {
        showError('Please upload at least one file before starting analysis.');
        return;
    }

    const jobDescription = document.getElementById('job-description').value.trim();

    // Show loading animation immediately
    showAnalysisLoading();
    
    // NEW: Check for large batch processing
    if (files.length > 5) {
        const batchCount = Math.ceil(files.length / 5);
        const confirmMessage = `You're about to process ${files.length} files in ${batchCount} batches of 5. This may take several minutes. Proceed?`;
        
        // Show custom confirmation modal
        await showBatchConfirmation(files.length, batchCount, jobDescription);
    } else {
        // Use existing queue system for small batches
        const queueResult = await analysisQueue.queueAnalysis(files, jobDescription);
    }
}

function showBatchConfirmation(fileCount, batchCount, jobDescription) {
    return new Promise((resolve, reject) => {
        const modal = document.getElementById('batch-confirm-modal');
        const message = document.getElementById('batch-confirm-message');
        const cancelBtn = document.getElementById('batch-confirm-cancel');
        const proceedBtn = document.getElementById('batch-confirm-proceed');
        
        // Set the message
        message.textContent = `You're about to process ${fileCount} files in ${batchCount} batches of 5. This may take several minutes.`;
        
        // Show modal
        modal.classList.remove('hidden');
        
        // Handle cancel
        cancelBtn.onclick = () => {
            modal.classList.add('hidden');
            reject('User cancelled');
        };
        
        // Handle proceed
        proceedBtn.onclick = async () => {
            modal.classList.add('hidden');
            try {
                await processBatchAnalysis(files, jobDescription);
                resolve();
            } catch (error) {
                reject(error);
            }
        };
    });
}

async function processBatchAnalysis(allFiles, jobDescription) {
    const batchSize = 5;
    const batches = [];
    
    // Split files into batches of 5
    for (let i = 0; i < allFiles.length; i += batchSize) {
        batches.push(allFiles.slice(i, i + batchSize));
    }
    
    const totalBatches = batches.length;
    let allCandidates = [];
    let successfulBatches = 0;
    let failedBatches = 0;
    
    // Show initial loading
    showBatchAnalysisLoading(totalBatches);
    
    // Process each batch
    for (let batchIndex = 0; batchIndex < batches.length; batchIndex++) {
        const currentBatch = batches[batchIndex];
        const batchNumber = batchIndex + 1;
        
        try {
            // Update progress
            updateBatchProgress(batchNumber, totalBatches, 'processing');
            
            // Process this batch using existing logic
            const batchResult = await processSingleBatch(currentBatch, jobDescription, batchNumber);
            
            // Add successful results to the main list
            if (batchResult && Array.isArray(batchResult)) {
                allCandidates = [...allCandidates, ...batchResult];
                successfulBatches++;
                updateBatchProgress(batchNumber, totalBatches, 'completed');
                showSuccess(`Batch ${batchNumber} completed - ${batchResult.length} candidates added`);
            }
            
        } catch (error) {
            console.error(`Batch ${batchNumber} failed:`, error);
            failedBatches++;
            updateBatchProgress(batchNumber, totalBatches, 'failed');
            showError(`Batch ${batchNumber} failed - continuing with remaining batches`);
        }
        
        // Small delay between batches to avoid overwhelming the backend
        if (batchIndex < batches.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
    }
    
    // Show final results
    if (allCandidates.length > 0) {
        candidatesData = allCandidates;
        hideAnalysisLoading();
        showAnalysisResults(allCandidates);
        
        showSuccess(`Batch processing complete! ${successfulBatches}/${totalBatches} batches successful. ${allCandidates.length} candidates analyzed.`);
    } else {
        hideAnalysisLoading();
        showError('All batches failed. Please try again with smaller groups.');
    }
}

function showBatchAnalysisLoading(totalBatches) {
    document.getElementById('upload-interface').classList.add('hidden');
    document.getElementById('analysis-loading').classList.remove('hidden');
    
    // Update the loading UI for batch processing
    const loadingTitle = document.querySelector('#analysis-loading h2');
    if (loadingTitle) {
        loadingTitle.textContent = `Processing ${totalBatches} Batches`;
    }
    
    const loadingDescription = document.querySelector('#analysis-loading p');
    if (loadingDescription) {
        loadingDescription.textContent = 'Processing files in batches of 5. Please keep this tab open.';
    }
    
    // Reset progress bar
    const progressBar = document.getElementById('progress-bar-fill');
    if (progressBar) {
        progressBar.style.width = '0%';
    }
    
    const progressText = document.getElementById('loading-step');
    if (progressText) {
        progressText.textContent = 'Starting batch processing...';
    }
    
    const progressPercent = document.getElementById('loading-percent');
    if (progressPercent) {
        progressPercent.textContent = '0%';
    }
}

function updateBatchProgress(currentBatch, totalBatches, status) {
    const progressPercent = Math.round((currentBatch / totalBatches) * 100);
    
    // Update progress bar
    const progressBar = document.getElementById('progress-bar-fill');
    if (progressBar) {
        progressBar.style.width = `${progressPercent}%`;
    }
    
    // Update progress text
    const progressText = document.getElementById('loading-step');
    if (progressText) {
        if (status === 'processing') {
            progressText.textContent = `Processing batch ${currentBatch} of ${totalBatches}...`;
        } else if (status === 'completed') {
            progressText.textContent = `Batch ${currentBatch} of ${totalBatches} completed`;
        } else if (status === 'failed') {
            progressText.textContent = `Batch ${currentBatch} of ${totalBatches} failed - continuing...`;
        }
    }
    
    // Update percentage
    const progressPercentElement = document.getElementById('loading-percent');
    if (progressPercentElement) {
        progressPercentElement.textContent = `${progressPercent}%`;
    }
}

async function processSingleBatch(batchFiles, jobDescription, batchNumber) {
    // Create FormData for this batch
    const formData = new FormData();
    batchFiles.forEach(file => {
        formData.append('files', file);
    });

    formData.append('requestId', `batch_${batchNumber}_${Date.now()}`);
    formData.append('expectedProcessingTime', Math.max(60, batchFiles.length * 20));

    if (jobDescription && jobDescription.length > 0) {
        formData.append('jobDescription', jobDescription);
        formData.append('analysisType', 'ULTRA');
    } else {
        formData.append('analysisType', 'PRO');
    }

    // Use existing request handler with timeout
    const timeoutDuration = Math.max(120000, batchFiles.length * 40000);

    const response = await feedback.makeRequest(
        'https://montpro.app.n8n.cloud/webhook/recruitment-analysis',
        {
            method: 'POST',
            body: formData,
            timeout: timeoutDuration,
            retries: 1,
            retryDelay: 5000
        }
    );

    const contentType = response.headers.get("content-type");
    const raw = await response.text();

    if (!raw || raw.trim().length === 0) {
        throw new Error(`Batch ${batchNumber}: Empty response from server`);
    }

    let data;
    if (contentType && contentType.includes("application/json")) {
        data = JSON.parse(raw);
    } else {
        throw new Error(`Batch ${batchNumber}: Invalid response format`);
    }

    // Extract candidates array from response (same logic as your existing code)
    if (Array.isArray(data)) {
        return data;
    } else if (data && Array.isArray(data.candidates)) {
        return data.candidates.map(item => item.json || item);
    } else if (data && Array.isArray(data.data)) {
        return data.data;
    } else if (data && typeof data === 'object') {
        for (let key in data) {
            if (Array.isArray(data[key]) && data[key].length > 0) {
                return data[key].map(item => item.json || item);
            }
        }
    }

    throw new Error(`Batch ${batchNumber}: Could not extract candidates from response`);
}

function showRetryButton() {
    const retryBtn = document.getElementById('retry-btn');
    if (retryBtn) {
        retryBtn.classList.remove('hidden');
        retryBtn.onclick = () => {
            retryBtn.classList.add('hidden');
            startAnalysis();
        };
    }
}

function showAnalysisLoading() {
    document.getElementById('upload-interface').classList.add('hidden');
    document.getElementById('analysis-loading').classList.remove('hidden');
    
    // Calculate realistic timing based on file count
    const fileCount = files.length;
    const baseTimePerFile = 25000; // 25 seconds per file (average of 20-30s)
    const totalEstimatedTime = fileCount * baseTimePerFile;
    const bufferTime = Math.min(15000, fileCount * 5000); // Extra buffer time
    const totalTimeWithBuffer = totalEstimatedTime + bufferTime;
    
    console.log(`Loading animation for ${fileCount} files - estimated ${totalEstimatedTime/1000}s + ${bufferTime/1000}s buffer`);
    
    // Dynamic steps based on file count
    const baseSteps = [
        'Uploading files...',
        'Extracting text content...',
        'Analyzing qualifications...',
        'Processing skills and experience...',
        'Evaluating candidate fit...',
        'Generating final results...'
    ];
    
    // Add extra steps for multiple files
    const steps = [...baseSteps];
    if (fileCount > 1) {
        steps.splice(3, 0, `Processing ${fileCount} candidate profiles...`);
        steps.splice(5, 0, 'Cross-referencing candidate data...');
    }
    if (fileCount >= 3) {
        steps.splice(6, 0, 'Optimizing comparison metrics...');
    }
    
    // Create enhanced progress tracker
    const progressTracker = feedback.createProgressTracker('analysis-loading', {
        title: `AI Analysis in Progress (${fileCount} file${fileCount > 1 ? 's' : ''})`,
        steps: steps,
        showPercentage: true,
        showTimeEstimate: true
    });
    
    // Realistic progress simulation
    let currentStep = 0;
    let progress = 0;
    const startTime = Date.now();
    
    // Progress phases with realistic timing
    const phases = [
        { step: 0, targetProgress: 15, duration: 3000 }, // Upload phase
        { step: 1, targetProgress: 25, duration: fileCount * 2000 }, // Text extraction
        { step: 2, targetProgress: 45, duration: fileCount * 6000 }, // Main analysis
        { step: 3, targetProgress: 65, duration: fileCount * 5000 }, // Skills processing
        { step: 4, targetProgress: 80, duration: fileCount * 4000 }, // Evaluation
        { step: 5, targetProgress: 95, duration: fileCount * 3000 }, // Final generation
    ];
    
    // Add phases for extra steps
    if (fileCount > 1) {
        phases.splice(3, 0, { step: 3, targetProgress: 55, duration: fileCount * 3000 });
        phases.splice(5, 0, { step: 5, targetProgress: 75, duration: fileCount * 2000 });
    }
    if (fileCount >= 3) {
        phases.push({ step: phases.length, targetProgress: 98, duration: fileCount * 1000 });
    }
    
    let currentPhase = 0;
    let phaseStartTime = Date.now();
    let phaseStartProgress = 0;
    
    const updateProgress = () => {
        const now = Date.now();
        const elapsedTotal = now - startTime;
        
        // Check if we should move to next phase
        if (currentPhase < phases.length) {
            const phase = phases[currentPhase];
            const phaseElapsed = now - phaseStartTime;
            const phaseProgress = Math.min(phaseElapsed / phase.duration, 1);
            
            // Calculate progress within current phase
            const phaseProgressRange = phase.targetProgress - phaseStartProgress;
            progress = phaseStartProgress + (phaseProgressRange * phaseProgress);
            
            // Update step if changed
            if (phase.step !== currentStep) {
                currentStep = phase.step;
            }
            
            // Move to next phase when current is complete
            if (phaseProgress >= 1 && currentPhase < phases.length - 1) {
                currentPhase++;
                phaseStartTime = now;
                phaseStartProgress = progress;
            }
        }
        
        // Ensure progress doesn't exceed 98% until actual completion
        progress = Math.min(progress, 98);
        
        // Update progress display
        progressTracker.update(currentStep, steps[currentStep] || 'Processing...', Math.round(progress));
        
        // Also update the existing progress elements for compatibility
        const progressBar = document.getElementById('progress-bar-fill');
        const percentText = document.getElementById('loading-percent');
        const stepText = document.getElementById('loading-step');
        
        if (progressBar) progressBar.style.width = `${Math.round(progress)}%`;
        if (percentText) percentText.textContent = `${Math.round(progress)}%`;
        if (stepText) stepText.textContent = steps[currentStep] || 'Processing...';
        
        // Continue updating if not complete and not timed out
        if (progress < 98 && elapsedTotal < totalTimeWithBuffer * 1.2) {
            // Dynamic timing based on remaining work
            const remainingPhases = phases.length - currentPhase;
            const baseInterval = remainingPhases > 0 ? 200 : 500;
            const randomVariation = baseInterval * (0.8 + Math.random() * 0.4);
            
            setTimeout(updateProgress, randomVariation);
        }
    };
    
    // Start the realistic progress simulation
    updateProgress();
    
    // Store tracker for cleanup
    window.currentProgressTracker = progressTracker;
    
    // Show time estimate to user
    const estimateMinutes = Math.ceil(totalEstimatedTime / 60000);
    setTimeout(() => {
        showSuccess(`Estimated processing time: ${estimateMinutes} minute${estimateMinutes > 1 ? 's' : ''} for ${fileCount} file${fileCount > 1 ? 's' : ''}`);
    }, 1000);
}
function hideAnalysisLoading() {
    document.getElementById('analysis-loading').classList.add('hidden');
    
    // Complete the progress tracker
    if (window.currentProgressTracker) {
        window.currentProgressTracker.complete('Analysis complete!');
        setTimeout(() => {
            window.currentProgressTracker = null;
        }, 1000);
    }
    
    // Clear any running progress interval
    if (window.progressInterval) {
        clearInterval(window.progressInterval);
    }
}

function showAnalysisResults(data) {
    // Cancel any scheduled memory clearing since we're showing new results
    memoryManager.cancelScheduledClear();
    // üîç TEMPORARY DEBUG - Remove after we understand the data structure
    console.log('=== FULL BACKEND DATA DEBUG ===');
    console.log('Complete data structure:', data);
    
    if (Array.isArray(data) && data.length > 0) {
        console.log('First candidate full data:', data[0]);
        console.log('Available keys in first candidate:', Object.keys(data[0]));
        
        // Log each property to see what's available
        Object.keys(data[0]).forEach(key => {
            console.log(`${key}:`, data[0][key]);
        });
    }
    console.log('=== END DEBUG ===');
    
    // Use the new multiple candidates handler
    showMultipleCandidatesResults(data);

    // Show the action buttons
    document.getElementById('analysis-actions').classList.remove('hidden');

    // Show the results footer
    document.getElementById('results-footer').classList.remove('hidden');

    // Set up PDF download after showing results - with cleanup
    setTimeout(() => {
        setupDownloadPDF();
        setupExportOptions();
    }, 100);

    // ‚ú® NEW: Auto-save to history
    saveCurrentAnalysisToHistory();

    setDynamicAnalysisTime();

     // ‚ú® NEW: Add this at the very end of the function
    useAnalysisCredit();
}

// Add this to your showAnalysisResults function
function setDynamicAnalysisTime() {
    const fileCount = files.length; // Use your existing files array
    const baseTime = 20; // 20 seconds base
    const perFileVariance = Math.floor(Math.random() * 10) + 20; // 20-30 seconds per file
    const totalTime = (fileCount * perFileVariance) + Math.floor(Math.random() * 5); // Add small random variance
    
    let timeDisplay;
    if (totalTime < 60) {
        timeDisplay = `${totalTime}s`;
    } else {
        const minutes = Math.floor(totalTime / 60);
        const seconds = totalTime % 60;
        timeDisplay = `${minutes}m ${seconds}s`;
    }
    
    // Update the display
    const timeElement = document.getElementById('analysis-time');
    if (timeElement) {
        timeElement.textContent = timeDisplay;
    }
}

function showAnalysisResultsFromHistory(data) {
    // Same as showAnalysisResults but WITHOUT useAnalysisCredit() call
    console.log('=== showAnalysisResultsFromHistory called ===');
    
    hideAnalysisLoading();
    document.getElementById('analysis-results').classList.remove('hidden');
    
    // Use the existing multiple candidates handler
    showMultipleCandidatesResults(data);

    // Show the action buttons
    document.getElementById('analysis-actions').classList.remove('hidden');

    // Show the results footer
    document.getElementById('results-footer').classList.remove('hidden');

    // Set up PDF download after showing results
    setupDownloadPDF();

    // Set up export options
    setupExportOptions();

    // NOTE: NO useAnalysisCredit() call here since this is from history
}

// ADD this new function right after showAnalysisResults
async function useAnalysisCredit() {
    try {
        const numberOfResumes = files.length;
        const jobDescription = document.getElementById('job-description').value.trim();
        const hasJobDescription = jobDescription.length > 0;
        
        console.log(`Using credits for ${numberOfResumes} resumes, job matching: ${hasJobDescription}`);
        
        // Use appropriate credit type for each resume
        for (let i = 0; i < numberOfResumes; i++) {
            if (hasJobDescription) {
                // Use ULTRA credit for job matching
                await creditManager.useUltraCredit();
                console.log(`Used ULTRA credit ${i + 1}/${numberOfResumes}`);
            } else if (creditManager.userTier === 'FREE') {
                await creditManager.useAnalysis();
                console.log(`Used free analysis ${i + 1}/${numberOfResumes}`);
            } else if (creditManager.proCredits > 0) {
                await creditManager.useProCredit();
                console.log(`Used PRO credit ${i + 1}/${numberOfResumes}`);
            } else if (creditManager.ultraCredits > 0) {
                await creditManager.useUltraCredit();
                console.log(`Used ULTRA credit (no PRO available) ${i + 1}/${numberOfResumes}`);
            }
        }
        
        updateUsageDisplay();
        
        const creditType = hasJobDescription ? 'ULTRA' : 'PRO';
        showSuccess(`Successfully analyzed ${numberOfResumes} resume(s) using ${creditType} credits!`);
        
    } catch (error) {
        console.error('Error using credits:', error);
        showError('Error using credits: ' + error.message);
    }
}
        
function setupDownloadPDF() {
    const downloadBtn = document.querySelector('#download-pdf-btn');
    if (downloadBtn) {
        // Remove existing listeners by cloning the element
        const newDownloadBtn = downloadBtn.cloneNode(true);
        downloadBtn.parentNode.replaceChild(newDownloadBtn, downloadBtn);
        
        // Add fresh event listener
        newDownloadBtn.addEventListener('click', function() {
            const originalBtnHtml = newDownloadBtn.innerHTML;
            
            try {
                // Show loading state
                newDownloadBtn.innerHTML = '<div class="spinner mr-2"></div> Generating PDF...';
                newDownloadBtn.disabled = true;
                
                // Get analysis data from the current view
                const candidateData = getCurrentCandidateData();
                
                // Generate PDF
                generatePDF(candidateData);
                
                // Show success state
                newDownloadBtn.innerHTML = '<i class="fas fa-check mr-2"></i> Downloaded!';
                setTimeout(() => {
                    newDownloadBtn.innerHTML = originalBtnHtml;
                    newDownloadBtn.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('PDF generation failed:', error);
                
                // Show error state
                newDownloadBtn.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i> Failed';
                newDownloadBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                newDownloadBtn.classList.add('bg-red-600');
                
                setTimeout(() => {
                    newDownloadBtn.innerHTML = originalBtnHtml;
                    newDownloadBtn.disabled = false;
                    newDownloadBtn.classList.remove('bg-red-600');
                    newDownloadBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }, 3000);
            }
        });
    }
}

function getCurrentCandidateData() {
    // For multiple candidates view
    if (!document.getElementById('multiple-candidates-view').classList.contains('hidden')) {
        const candidate = candidatesData[selectedCandidateIndex];
        return {
            name: candidate.candidateName || `Candidate ${selectedCandidateIndex + 1}`,
            score: candidate.candidateScore || '75',
            title: extractTitleFromSummary(candidate) || 'Professional',
            executiveSummary: candidate.executiveSummary || 'No executive summary available.',
            coreCompetencies: candidate.coreCompetencies || 'No competencies data available.',
            isMultiple: true,
            candidateNumber: selectedCandidateIndex + 1,
            totalCandidates: candidatesData.length
        };
    } 
    // For single candidate view
    else {
        const currentData = candidatesData && candidatesData.length > 0 ? candidatesData[0] : null;
        return {
            name: document.getElementById('candidate-name')?.textContent || 'Candidate Name',
            score: document.getElementById('candidate-score')?.textContent || '75',
            title: currentData ? extractTitleFromSummary(currentData) : 'Professional',
            executiveSummary: document.getElementById('executive-summary')?.textContent || 'No executive summary available.',
            coreCompetencies: currentData ? currentData.coreCompetencies : 'No competencies data available.',
            isMultiple: false
        };
    }
}

function extractTitleFromSummary(candidate) {
    // First try direct title fields
    let title = candidate.candidateTitle || candidate.position || candidate.jobTitle;
    
    if (!title && candidate.executiveSummary) {
        const summaryText = candidate.executiveSummary;
        
        // Enhanced title extraction patterns
        const titlePatterns = [
            /is (?:an?|the) ([^.]+?) with/i,
            /(?:seasoned|experienced|accomplished) ([^.]+?) with/i,
            /(?:as|is) (?:an?|the) ([^.]+?)\./i,
            /expertise in ([^.]+?)\./i,
            /leader in ([^.]+?)\./i,
            /specialist in ([^.]+?)\./i,
            /background in ([^.]+?)\./i
        ];
        
        for (let pattern of titlePatterns) {
            const match = summaryText.match(pattern);
            if (match && match[1]) {
                title = match[1].trim();
                // Clean up and format
                title = title.replace(/\b(leader|professional|expert|individual|and)\b/gi, '')
                            .replace(/\s+/g, ' ')
                            .trim();
                if (title.length > 0 && title.length < 60) {
                    // Capitalize properly
                    title = title.split(' ')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                        .join(' ');
                    break;
                }
            }
        }
    }
    
    return title || 'Professional';
}

function generatePDF(data) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Set up colors
    const primaryColor = [59, 130, 246]; // Blue
    const grayColor = [107, 114, 128];
    const darkColor = [31, 41, 55];
    
    let yPosition = 20;
    
    // Header Card with better spacing
    doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
    doc.roundedRect(15, yPosition, 180, 40, 5, 5, 'F');
    
    // MontPro Logo/Title
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(20);
    doc.setFont(undefined, 'bold');
    doc.text('MontPro', 20, yPosition + 18);
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    doc.text('Recruitment Analysis Report', 20, yPosition + 28);
    
    // Date with better spacing
    doc.setFontSize(10);
    doc.text(`Generated on ${new Date().toLocaleDateString()}`, 20, yPosition + 38);
    
    // Score section - properly centered
    doc.setFontSize(24);
    doc.setFont(undefined, 'bold');
    const scoreText = `${data.score}`;
    const scoreWidth = doc.getTextWidth(scoreText);
    const scoreX = 170; // Base position
    
    // Center the score number
    doc.text(scoreText, scoreX, yPosition + 30);
    
    // Center the "Score" label above the number
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    const labelWidth = doc.getTextWidth('Score');
    const labelX = scoreX + (scoreWidth - labelWidth) / 2; // Center relative to score number
    doc.text('Score', labelX, yPosition + 20);
    
    yPosition += 55; // More space after header
    
    // Candidate Information
    doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text(data.name, 20, yPosition);
    
    yPosition += 10;
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(grayColor[0], grayColor[1], grayColor[2]);
    doc.text(data.title, 20, yPosition);
    
    if (data.isMultiple) {
        doc.text(`Candidate ${data.candidateNumber} of ${data.totalCandidates}`, 140, yPosition);
    }
    
    yPosition += 15;
    
    // Helper function to add sections
    function addSection(title, content, isRequired = true) {
        if (!isRequired && !content) return;
        
        // Check if we need a new page
        const estimatedHeight = 25 + (content ? Math.ceil(content.length / 80) * 5 : 5);
        if (yPosition + estimatedHeight > 280) {
            doc.addPage();
            yPosition = 20;
        }
        
        // Section title
        doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text(title, 20, yPosition);
        
        yPosition += 10;
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        
        // Section content
        if (content) {
            const lines = doc.splitTextToSize(content, 170);
            doc.text(lines, 20, yPosition);
            yPosition += lines.length * 5 + 10;
        } else {
            doc.text('No data available.', 20, yPosition);
            yPosition += 15;
        }
    }
    
    // Add all sections
    addSection('Executive Summary', data.executiveSummary, true);
    addSection('Core Competencies', data.coreCompetencies, true);
    
    // Detect and add PRO/ULTRA sections
    const candidateData = candidatesData && candidatesData.length > 0 ? 
        (data.isMultiple ? candidatesData[data.candidateNumber - 1] : candidatesData[0]) : null;
    
    if (candidateData) {
        if (candidateData.roleAlignment) {
            addSection('Role Alignment & Potential Fit', candidateData.roleAlignment, false);
        }
        
        if (candidateData.educationCertifications) {
            addSection('Education & Certifications', candidateData.educationCertifications, false);
        }
        
        if (candidateData.communication) {
            addSection('Communication & Presentation Quality', candidateData.communication, false);
        }
        
        if (candidateData.redFlags) {
            addSection('Red Flags & Risk Analysis', candidateData.redFlags, false);
        }
        
        if (candidateData.strategicRecommendations) {
            addSection('Strategic Recommendations', candidateData.strategicRecommendations, false);
        }
        
        if (candidateData.candidateScorecard) {
            addSection('Detailed Candidate Scorecard', candidateData.candidateScorecard, false);
        }
    }
    
    // Footer
    if (yPosition > 275) {
        doc.addPage();
        yPosition = 275;
    } else {
        yPosition = Math.max(yPosition + 10, 275);
    }
    
    doc.setFontSize(8);
    doc.setTextColor(grayColor[0], grayColor[1], grayColor[2]);
    doc.text('This analysis is provided for recruitment guidance only.', 20, yPosition);
    doc.text('¬© 2025 MontPro. All rights reserved.', 20, yPosition + 5);
    
    // Save the PDF
    const fileName = `${data.name.replace(/\s+/g, '_')}_Analysis_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(fileName);
}

// Export functionality
function setupExportOptions() {
    const exportBtn = document.getElementById('export-btn');
    const exportDropdown = document.getElementById('export-dropdown');
    
    if (!exportBtn || !exportDropdown) {
        console.error('Export elements not found!');
        return;
    }

    // Remove existing listeners by cloning the main button
    const newExportBtn = exportBtn.cloneNode(true);
    exportBtn.parentNode.replaceChild(newExportBtn, exportBtn);

    // Toggle dropdown
    newExportBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const dropdown = document.getElementById('export-dropdown');
        dropdown.classList.toggle('hidden');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', () => {
        const dropdown = document.getElementById('export-dropdown');
        if (dropdown) dropdown.classList.add('hidden');
    });

    // Clean up dropdown option listeners too
    setTimeout(() => {
        const exportCsv = document.getElementById('export-csv');
        const copyResults = document.getElementById('copy-results');
        const emailResults = document.getElementById('email-results');

        // Clone each dropdown option to remove existing listeners
        if (exportCsv) {
            const newExportCsv = exportCsv.cloneNode(true);
            exportCsv.parentNode.replaceChild(newExportCsv, exportCsv);
            newExportCsv.addEventListener('click', () => {
                exportToCSV();
                document.getElementById('export-dropdown').classList.add('hidden');
            });
        }

        if (copyResults) {
            const newCopyResults = copyResults.cloneNode(true);
            copyResults.parentNode.replaceChild(newCopyResults, copyResults);
            newCopyResults.addEventListener('click', () => {
                copyToClipboard();
                document.getElementById('export-dropdown').classList.add('hidden');
            });
        }

        if (emailResults) {
            const newEmailResults = emailResults.cloneNode(true);
            emailResults.parentNode.replaceChild(newEmailResults, emailResults);
            newEmailResults.addEventListener('click', () => {
                emailResults_();
                document.getElementById('export-dropdown').classList.add('hidden');
            });
        }
    }, 50);
}

function exportToCSV() {
    const csvBtn = document.getElementById('export-csv');
    const originalHtml = csvBtn.innerHTML;
    
    try {
        csvBtn.innerHTML = '<i class="fas fa-spinner fa-spin text-green-600 mr-3"></i>Generating...';
        
        let csvData = [];
        
        if (candidatesData.length > 1) {
            // Multiple candidates
            csvData = candidatesData.map((candidate, index) => {
                const userStatus = creditManager.getStatus();
                const baseData = {
                    'Candidate Name': candidate.candidateName || `Candidate ${index + 1}`,
                    'Score': candidate.candidateScore || 'N/A',
                    'Title/Position': extractTitleFromSummary(candidate) || 'Professional',
                    'Executive Summary': candidate.executiveSummary ? candidate.executiveSummary.replace(/"/g, '""') : 'N/A',
                    'Core Competencies': candidate.coreCompetencies ? 
                        (typeof candidate.coreCompetencies === 'string' ? 
                            (candidate.coreCompetencies.startsWith('-') ? "'" + candidate.coreCompetencies.replace(/"/g, '""') : candidate.coreCompetencies.replace(/"/g, '""')) : 
                            candidate.coreCompetencies.join('; ')) : 'N/A',
                    'Analysis Date': new Date().toLocaleDateString()
                };

                // Add PRO fields if user is professional
                if (!userStatus.isFreeTier) {
                    baseData['Role Alignment'] = candidate.roleAlignment ? candidate.roleAlignment.replace(/"/g, '""') : 'N/A';
                    baseData['Education & Certifications'] = candidate.educationCertifications ? candidate.educationCertifications.replace(/"/g, '""') : 'N/A';
                    baseData['Communication Quality'] = candidate.communication ? candidate.communication.replace(/"/g, '""') : 'N/A';
                    baseData['Red Flags'] = candidate.redFlags ? candidate.redFlags.replace(/"/g, '""') : 'N/A';
                    baseData['Strategic Recommendations'] = candidate.strategicRecommendations ? candidate.strategicRecommendations.replace(/"/g, '""') : 'N/A';
                    baseData['Candidate Scorecard'] = candidate.candidateScorecard ? candidate.candidateScorecard.replace(/"/g, '""') : 'N/A';
                }

                return baseData;
            });
        } else {
            // Single candidate
            const candidate = candidatesData[0];
            const userStatus = creditManager.getStatus();
            const baseData = {
                'Candidate Name': candidate.candidateName || 'Candidate',
                'Score': candidate.candidateScore || 'N/A',
                'Title/Position': extractTitleFromSummary(candidate) || 'Professional',
                'Executive Summary': candidate.executiveSummary ? candidate.executiveSummary.replace(/"/g, '""') : 'N/A',
                'Core Competencies': candidate.coreCompetencies ? 
                    (typeof candidate.coreCompetencies === 'string' ? 
                        (candidate.coreCompetencies.startsWith('-') ? "'" + candidate.coreCompetencies.replace(/"/g, '""') : candidate.coreCompetencies.replace(/"/g, '""')) : 
                        candidate.coreCompetencies.join('; ')) : 'N/A',
                'Analysis Date': new Date().toLocaleDateString()
            };

            // Add PRO fields if user is professional
            if (!userStatus.isFreeTier) {
                baseData['Role Alignment'] = candidate.roleAlignment ? candidate.roleAlignment.replace(/"/g, '""') : 'N/A';
                baseData['Education & Certifications'] = candidate.educationCertifications ? candidate.educationCertifications.replace(/"/g, '""') : 'N/A';
                baseData['Communication Quality'] = candidate.communication ? candidate.communication.replace(/"/g, '""') : 'N/A';
                baseData['Red Flags'] = candidate.redFlags ? candidate.redFlags.replace(/"/g, '""') : 'N/A';
                baseData['Strategic Recommendations'] = candidate.strategicRecommendations ? candidate.strategicRecommendations.replace(/"/g, '""') : 'N/A';
                baseData['Candidate Scorecard'] = candidate.candidateScorecard ? candidate.candidateScorecard.replace(/"/g, '""') : 'N/A';
            }

            csvData = [baseData];
        }
        
        // Convert to CSV
        const headers = Object.keys(csvData[0]);
        const csvContent = [
            headers.join(','),
            ...csvData.map(row => headers.map(header => `"${row[header]}"`).join(','))
        ].join('\n');
        
        // Download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `MontPro_Analysis_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        
        // Success state
        csvBtn.innerHTML = '<i class="fas fa-check text-green-600 mr-3"></i>Downloaded!';
        showSuccess('CSV exported successfully!');
        
        setTimeout(() => {
            csvBtn.innerHTML = originalHtml;
        }, 2000);
        
    } catch (error) {
        console.error('CSV export failed:', error);
        csvBtn.innerHTML = '<i class="fas fa-exclamation-circle text-red-600 mr-3"></i>Failed';
        showError('Failed to export CSV. Please try again.');
        
        setTimeout(() => {
            csvBtn.innerHTML = originalHtml;
        }, 3000);
    }
}

function copyToClipboard() {
    const copyBtn = document.getElementById('copy-results');
    const originalHtml = copyBtn.innerHTML;
    
    try {
        copyBtn.innerHTML = '<i class="fas fa-spinner fa-spin text-blue-600 mr-3"></i>Copying...';
        
        let textContent = '';
        
        if (candidatesData.length > 1) {
            textContent = `MontPro Analysis Results - ${candidatesData.length} Candidates\n`;
            textContent += `Analysis Date: ${new Date().toLocaleDateString()}\n\n`;
            
            candidatesData.forEach((candidate, index) => {
                textContent += `--- CANDIDATE ${index + 1} ---\n`;
                textContent += `Name: ${candidate.candidateName || `Candidate ${index + 1}`}\n`;
                textContent += `Score: ${candidate.candidateScore || 'N/A'}\n`;
                textContent += `Title: ${extractTitleFromSummary(candidate) || 'Professional'}\n`;
                textContent += `Summary: ${candidate.executiveSummary || 'N/A'}\n`;
                textContent += `Skills: ${candidate.coreCompetencies ? (typeof candidate.coreCompetencies === 'string' ? candidate.coreCompetencies : candidate.coreCompetencies.join(', ')) : 'N/A'}\n`;
                
                // Add PRO/ULTRA fields if they exist
                if (candidate.roleAlignment) {
                    textContent += `Role Alignment: ${candidate.roleAlignment}\n`;
                }
                if (candidate.educationCertifications) {
                    textContent += `Education & Certifications: ${candidate.educationCertifications}\n`;
                }
                if (candidate.communication) {
                    textContent += `Communication Quality: ${candidate.communication}\n`;
                }
                if (candidate.redFlags) {
                    textContent += `Red Flags: ${candidate.redFlags}\n`;
                }
                if (candidate.strategicRecommendations) {
                    textContent += `Strategic Recommendations: ${candidate.strategicRecommendations}\n`;
                }
                if (candidate.candidateScorecard) {
                    textContent += `Candidate Scorecard: ${candidate.candidateScorecard}\n`;
                }
                
                textContent += `\n`;
            });
        } else {
            const candidate = candidatesData[0];
            textContent = `MontPro Analysis Results\n`;
            textContent += `Analysis Date: ${new Date().toLocaleDateString()}\n\n`;
            textContent += `Name: ${candidate.candidateName || 'Candidate'}\n`;
            textContent += `Score: ${candidate.candidateScore || 'N/A'}\n`;
            textContent += `Title: ${extractTitleFromSummary(candidate) || 'Professional'}\n`;
            textContent += `Summary: ${candidate.executiveSummary || 'N/A'}\n`;
            textContent += `Skills: ${candidate.coreCompetencies ? (typeof candidate.coreCompetencies === 'string' ? candidate.coreCompetencies : candidate.coreCompetencies.join(', ')) : 'N/A'}\n`;
            
            // Add PRO/ULTRA fields if they exist
            if (candidate.roleAlignment) {
                textContent += `Role Alignment: ${candidate.roleAlignment}\n`;
            }
            if (candidate.educationCertifications) {
                textContent += `Education & Certifications: ${candidate.educationCertifications}\n`;
            }
            if (candidate.communication) {
                textContent += `Communication Quality: ${candidate.communication}\n`;
            }
            if (candidate.redFlags) {
                textContent += `Red Flags: ${candidate.redFlags}\n`;
            }
            if (candidate.strategicRecommendations) {
                textContent += `Strategic Recommendations: ${candidate.strategicRecommendations}\n`;
            }
            if (candidate.candidateScorecard) {
                textContent += `Candidate Scorecard: ${candidate.candidateScorecard}\n`;
            }
        }
        
        textContent += `\n--- \nGenerated by MontPro Recruitment Engine`;
        
        navigator.clipboard.writeText(textContent).then(() => {
            copyBtn.innerHTML = '<i class="fas fa-check text-blue-600 mr-3"></i>Copied!';
            showSuccess('Results copied to clipboard!');
            
            setTimeout(() => {
                copyBtn.innerHTML = originalHtml;
            }, 2000);
        });
        
    } catch (error) {
        console.error('Copy failed:', error);
        copyBtn.innerHTML = '<i class="fas fa-exclamation-circle text-red-600 mr-3"></i>Failed';
        showError('Failed to copy. Please try again.');
        
        setTimeout(() => {
            copyBtn.innerHTML = originalHtml;
        }, 3000);
    }
}

function emailResults_() {
    const emailBtn = document.getElementById('email-results');
    const originalHtml = emailBtn.innerHTML;
    
    // Get user's email address
    const userEmail = prompt('Enter your email address to receive the analysis results:');
    
    if (!userEmail) {
        return; // User cancelled
    }
    
    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(userEmail)) {
        showError('Please enter a valid email address.');
        return;
    }
    
    try {
        emailBtn.innerHTML = '<i class="fas fa-spinner fa-spin text-purple-600 mr-3"></i>Sending...';
        
        // Get the currently displayed/selected candidate
        let currentCandidate;
        let candidateDisplayName;
        
        if (!document.getElementById('multiple-candidates-view').classList.contains('hidden')) {
            // Multiple candidates view - get the selected one
            currentCandidate = candidatesData[selectedCandidateIndex];
            candidateDisplayName = currentCandidate.candidateName || `Candidate ${selectedCandidateIndex + 1}`;
        } else {
            // Single candidate view - get the only candidate
            currentCandidate = candidatesData[0];
            candidateDisplayName = currentCandidate.candidateName || 'Candidate';
        }
        
        // Prepare email data for ONLY the current candidate
        const emailData = {
            to: userEmail,
            candidates: [currentCandidate], // Send only the selected candidate
            analysisDate: new Date().toLocaleDateString(),
            totalCandidates: 1, // Always 1 since we're sending only current candidate
            selectedCandidate: candidateDisplayName // For better email subject/content
        };
        
        console.log('Sending email for candidate:', candidateDisplayName);
        console.log('Email data:', emailData);
        
        // Send to your backend
        sendEmailViaBackend(emailData)
            .then((result) => {
                console.log('Email sent successfully:', result);
                emailBtn.innerHTML = '<i class="fas fa-check text-purple-600 mr-3"></i>Sent!';
                showSuccess(`Analysis for ${candidateDisplayName} sent to ${userEmail}!`);
                
                setTimeout(() => {
                    emailBtn.innerHTML = originalHtml;
                }, 3000);
            })
            .catch((error) => {
                console.error('Email sending failed:', error);
                
                // Fallback to clipboard
                const subject = `MontPro Analysis Results - ${candidateDisplayName}`;
                let body = generateEmailBodyForCandidate(currentCandidate);
                
                navigator.clipboard.writeText(`Subject: ${subject}\n\n${body}`).then(() => {
                    emailBtn.innerHTML = '<i class="fas fa-copy text-purple-600 mr-3"></i>Copied!';
                    showWarning(`Could not send email. Analysis for ${candidateDisplayName} copied to clipboard instead.`);
                    
                    setTimeout(() => {
                        emailBtn.innerHTML = originalHtml;
                    }, 3000);
                }).catch(() => {
                    emailBtn.innerHTML = '<i class="fas fa-exclamation-circle text-red-600 mr-3"></i>Failed';
                    showError('Email sending failed and clipboard copy failed. Please try the CSV export instead.');
                    
                    setTimeout(() => {
                        emailBtn.innerHTML = originalHtml;
                    }, 3000);
                });
            });
        
    } catch (error) {
        console.error('Email preparation failed:', error);
        emailBtn.innerHTML = originalHtml;
        showError('Failed to prepare email. Please try again.');
    }
}

// Helper function to generate email body for a single candidate
function generateEmailBodyForCandidate(candidate) {
    const candidateName = candidate.candidateName || 'Candidate';
    const candidateTitle = extractTitleFromSummary(candidate) || 'Professional';
    
    let body = `MontPro Analysis Results - ${candidateName}

Analysis Date: ${new Date().toLocaleDateString()}

--- CANDIDATE ANALYSIS ---
Name: ${candidateName}
Score: ${candidate.candidateScore || 'N/A'}/5
Title: ${candidateTitle}

Executive Summary:
${candidate.executiveSummary || 'N/A'}

Core Competencies:
${candidate.coreCompetencies ? (typeof candidate.coreCompetencies === 'string' ? candidate.coreCompetencies : candidate.coreCompetencies.join(', ')) : 'N/A'}

Generated by MontPro Recruitment Engine`;
    
    return body;
}

// Helper function to send email via your backend
async function sendEmailViaBackend(emailData) {
    try {
        const response = await fetch('https://montpro.app.n8n.cloud/webhook/send-recruitment-analysis-email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(emailData)
        });
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('Response data:', result);
        
        // Check if the backend indicates success
        if (result.success === false) {
            throw new Error(result.message || 'Email sending failed');
        }
        
        return result;
        
    } catch (error) {
        console.error('Email sending error:', error);
        throw error;
    }
}

// Helper function to generate email body
function generateEmailBody() {
    let body = `Performance Review Summary

Analysis Date: ${new Date().toLocaleDateString()}
Total Candidates: ${candidatesData.length}

`;
    
    if (candidatesData.length > 1) {
        candidatesData.forEach((candidate, index) => {
            body += `--- CANDIDATE ${index + 1} ---
Name: ${candidate.candidateName || `Candidate ${index + 1}`}
Score: ${candidate.candidateScore || 'N/A'}/5
Title: ${extractTitleFromSummary(candidate) || 'Professional'}

Executive Summary:
${candidate.executiveSummary || 'N/A'}

Core Competencies:
${candidate.coreCompetencies ? (typeof candidate.coreCompetencies === 'string' ? candidate.coreCompetencies : candidate.coreCompetencies.join(', ')) : 'N/A'}

`;
        });
    } else {
        const candidate = candidatesData[0];
        body += `Employee: ${candidate.candidateName || 'Candidate'}
Score: ${candidate.candidateScore || 'N/A'}/5
Title: ${extractTitleFromSummary(candidate) || 'Professional'}

Executive Summary:
${candidate.executiveSummary || 'N/A'}

Core Competencies:
${candidate.coreCompetencies ? (typeof candidate.coreCompetencies === 'string' ? candidate.coreCompetencies : candidate.coreCompetencies.join(', ')) : 'N/A'}

`;
    }
    
    body += `Generated by MontPro Recruitment Engine`;
    return body;
}
        
async function signIn() {
    const emailEl = document.getElementById('email');
    const authMsg = document.getElementById('auth-msg');
    const email = emailEl.value.trim();
    
    if (!email) {
        authMsg.textContent = "Please enter your email address.";
        authMsg.className = "text-center text-sm font-medium text-red-600 mt-2";
        emailEl.focus();
        return;
    }
    
    // Email validation regex
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        authMsg.textContent = "Please enter a valid email address.";
        authMsg.className = "text-center text-sm font-medium text-red-600 mt-2";
        emailEl.focus();
        return;
    }
    
    const magicBtn = document.getElementById('magic-btn');
    const originalBtnHtml = magicBtn.innerHTML;
    
    // Update button to show loading state
    magicBtn.innerHTML = '<div class="spinner mr-2"></div> Sending...';
    magicBtn.disabled = true;
    
    authMsg.textContent = "";
    
    try {
        let { error } = await supabase.auth.signInWithOtp({ email });
        
        if (error) {
            authMsg.textContent = "Error: " + error.message;
            authMsg.className = "text-center text-sm font-medium text-red-600 mt-2";
            
            // Reset button
            magicBtn.innerHTML = originalBtnHtml;
            magicBtn.disabled = false;
        } else {
            authMsg.textContent = "Check your email for the sign-in link.";
            authMsg.className = "text-center text-sm font-medium text-green-600 mt-2";
            
            // Keep button disabled but change text
            magicBtn.innerHTML = '<i class="fas fa-check mr-2"></i> Link Sent';
            
            // Enable the button after 30 seconds
            setTimeout(() => {
                magicBtn.innerHTML = originalBtnHtml;
                magicBtn.disabled = false;
            }, 30000);
        }
    } catch (e) {
        authMsg.textContent = "Something went wrong. Please try again.";
        authMsg.className = "text-center text-sm font-medium text-red-600 mt-2";
        console.error(e);
        
        // Reset button
        magicBtn.innerHTML = originalBtnHtml;
        magicBtn.disabled = false;
    }
}

// Google Sign-In Function
async function signInWithGoogle() {
    const googleBtn = document.getElementById('google-signin-btn');
    const authMsg = document.getElementById('auth-msg');
    const originalBtnHtml = googleBtn.innerHTML;
    
    // Update button to show loading state
    googleBtn.innerHTML = '<div class="spinner mr-2"></div> Signing in...';
    googleBtn.disabled = true;
    
    try {
        const { data, error } = await supabase.auth.signInWithOAuth({
            provider: 'google',
            options: {
                redirectTo: window.location.origin
            }
        });
        
        if (error) {
            authMsg.textContent = "Error: " + error.message;
            authMsg.className = "text-center text-sm font-medium text-red-600 mt-2";
            
            // Reset button
            googleBtn.innerHTML = originalBtnHtml;
            googleBtn.disabled = false;
        }
    } catch (e) {
        authMsg.textContent = "Something went wrong. Please try again.";
        authMsg.className = "text-center text-sm font-medium text-red-600 mt-2";
        console.error(e);
        
        // Reset button
        googleBtn.innerHTML = originalBtnHtml;
        googleBtn.disabled = false;
    }
}

// Sample Resume Function
async function loadSampleResume() {
    const sampleBtn = document.getElementById('sample-resume-btn');
    const originalBtnHtml = sampleBtn.innerHTML;
    
    // Update button to show loading state
    sampleBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Loading Sample...';
    sampleBtn.disabled = true;
    
    try {
        // Fetch the sample resume PDF
        const response = await fetch('sample-resume.pdf');
        
        if (!response.ok) {
            throw new Error('Failed to load sample resume');
        }
        
        // Convert response to blob
        const blob = await response.blob();
        
        // Create a File object from the blob
        const sampleFile = new File([blob], 'John_Smith_Resume.pdf', {
            type: 'application/pdf',
            lastModified: new Date().getTime()
        });
        
        // Add to files array
        files = [sampleFile];
        
        // Update the file list display
        updateFileList();
        
        // Show success message
        showSuccess('Sample resume loaded! Click "Start Analysis" to see AI insights.');
        
        // Scroll to the file list
        fileListContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Reset button after a delay
        setTimeout(() => {
            sampleBtn.innerHTML = originalBtnHtml;
            sampleBtn.disabled = false;
        }, 2000);
        
    } catch (error) {
        console.error('Error loading sample resume:', error);
        showError('Failed to load sample resume. Please try uploading your own file.');
        
        // Reset button
        sampleBtn.innerHTML = originalBtnHtml;
        sampleBtn.disabled = false;
    }
}

// Multiple Candidates Handling Functions
let candidatesData = [];
let selectedCandidateIndex = 0;
let creditManager = new CreditManager();

// Filter Control Functions
function addFilterControlsToSidebar() {
    // Initialize filter with current candidates
    candidateFilter.setCandidates(candidatesData);
    
    // Search input handler
    const searchInput = document.getElementById('candidate-search');
    if (searchInput) {
        searchInput.addEventListener('input', debounce((e) => {
            handleSearchFilter(e.target.value);
        }, 300));
    }
    
    // Score range handler
    const scoreRange = document.getElementById('score-range');
    const scoreDisplay = document.getElementById('score-display');
    if (scoreRange && scoreDisplay) {
        scoreRange.addEventListener('input', (e) => {
            const value = e.target.value;
            scoreDisplay.textContent = value;
            handleScoreFilter(value);
        });
    }
}

function handleSearchFilter(query) {
    candidateFilter.applySearchFilter(query);
    updateCandidateDisplay();
}

function handleScoreFilter(minScore) {
    candidateFilter.applyScoreFilter(minScore);
    updateCandidateDisplay();
}

function updateCandidateDisplay() {
    const filteredCandidates = candidateFilter.getFilteredCandidates();
    const stats = candidateFilter.getFilterStats();
    
    // Update the candidate cards with filtered results
    generateFilteredCandidateCards(filteredCandidates);
    
    // Update results counter
    const resultsElement = document.getElementById('filter-results');
    if (resultsElement) {
        if (stats.filtered === stats.total) {
            resultsElement.textContent = `Showing all ${stats.total} candidates`;
        } else {
            resultsElement.textContent = `Showing ${stats.filtered} of ${stats.total} candidates`;
        }
    }
    
    // Auto-select first candidate if current selection is filtered out
    if (filteredCandidates.length > 0) {
        const currentCandidate = candidatesData[selectedCandidateIndex];
        const isCurrentVisible = filteredCandidates.includes(currentCandidate);
        
        if (!isCurrentVisible) {
            // Find the index of the first filtered candidate in the original array
            const firstFilteredIndex = candidatesData.indexOf(filteredCandidates[0]);
            showCandidateDetail(firstFilteredIndex);
        }
    }
}

// Debounce function for search
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
        
function showMultipleCandidatesResults(data) {
    console.log('=== showMultipleCandidatesResults called ===');
    console.log('Data received:', data);
    
    hideAnalysisLoading();
    document.getElementById('analysis-results').classList.remove('hidden');
    
    // Check if data has candidates array nested inside
    let candidatesArray = null;
    
    if (Array.isArray(data)) {
        console.log('Data is already an array');
        candidatesArray = data;
    } else if (data && Array.isArray(data.candidates)) {
        console.log('Found candidates array in data.candidates');
        // Extract the JSON objects from the candidates array
        candidatesArray = data.candidates.map(item => item.json || item);

        // TEMPORARY DEBUG - check extraction
        console.log('=== AFTER EXTRACTION DEBUG ===');
        console.log('candidatesArray:', candidatesArray);
        if (candidatesArray[0]) {
            console.log('First extracted candidate:', candidatesArray[0]);
            console.log('Has roleAlignment?', candidatesArray[0].roleAlignment);
            console.log('Has educationCertifications?', candidatesArray[0].educationCertifications);
        }
        console.log('=== END EXTRACTION DEBUG ===');
        
    } else if (data && Array.isArray(data.data)) {
        console.log('Found candidates array in data.data');
        candidatesArray = data.data;
    } else if (data && typeof data === 'object') {
        // Check if data has any property that is an array
        for (let key in data) {
            if (Array.isArray(data[key]) && data[key].length > 0) {
                console.log(`Found candidates array in data.${key}`);
                // Check if items have nested json property
                candidatesArray = data[key].map(item => item.json || item);
                break;
            }
        }
    }
    
    if (candidatesArray && candidatesArray.length > 1) {
        console.log('MULTIPLE CANDIDATES DETECTED - Array with', candidatesArray.length, 'items');
        console.log('First candidate structure:', candidatesArray[0]);
        console.log('Keys in first candidate:', Object.keys(candidatesArray[0]));
        candidatesData = candidatesArray;
        showMultipleCandidatesView();
    } else if (candidatesArray && candidatesArray.length === 1) {
        console.log('SINGLE CANDIDATE IN ARRAY - Using single view');
        candidatesData = candidatesArray;
        showSingleCandidateView(candidatesArray[0]);
    } else {
        console.log('SINGLE CANDIDATE OBJECT - Using single view');
        candidatesData = [data];
        showSingleCandidateView(data);
    }
}

function showMultipleCandidatesView() {
    document.getElementById('single-candidate-view').classList.add('hidden');
    document.getElementById('multiple-candidates-view').classList.remove('hidden');
    // Make multiple candidates view full width
    const mainApp = document.getElementById('main-app');
    const multipleView = document.getElementById('multiple-candidates-view');
    
    mainApp.classList.remove('max-w-7xl');
    mainApp.style.maxWidth = '100vw';
    mainApp.style.width = '100%';
    multipleView.style.maxWidth = 'none';
    multipleView.style.width = '100%';
    
    // üèÜ RESULTS OVERVIEW - Enhanced with achievement feeling
    const totalCandidates = candidatesData.length;
    const totalCandidatesElement = document.getElementById('total-candidates');
    const timestampElement = document.getElementById('analysis-timestamp');
    
    // Show immediate achievement message
    showSuccess(`üèÜ Analysis Complete! Found ${totalCandidates} candidates - Here are your top performers!`);
    
    // Animate the candidate count
    let currentCount = 0;
    const countInterval = setInterval(() => {
        currentCount++;
        totalCandidatesElement.textContent = currentCount;
        
        if (currentCount >= totalCandidates) {
            clearInterval(countInterval);
            
            // Add achievement emphasis
            totalCandidatesElement.style.transform = 'scale(1.1)';
            setTimeout(() => {
                totalCandidatesElement.style.transform = 'scale(1)';
            }, 200);
        }
    }, 100);
    
    timestampElement.textContent = `Analysis completed on ${new Date().toLocaleDateString()}`;
    // Add filter controls to sidebar
    addFilterControlsToSidebar();
    
    // Generate candidate cards
    generateCandidateCards();
    
    // Show first candidate by default
    showCandidateDetail(0);

    // Set up sorting
    document.getElementById('sort-score').onclick = () => sortCandidates('score');
    document.getElementById('sort-name').onclick = () => sortCandidates('name');
}

function generateCandidateCards() {
    const cardsContainer = document.getElementById('candidate-cards');
    cardsContainer.innerHTML = '';
    
    // Sort candidates by score for spotlight effect
    const sortedCandidates = [...candidatesData].sort((a, b) => 
        (parseInt(b.candidateScore) || 0) - (parseInt(a.candidateScore) || 0)
    );
    
    // üëë TOP CANDIDATE SPOTLIGHT
    const topCandidate = sortedCandidates[0];
    const topScore = parseInt(topCandidate.candidateScore) || 0;
    
    setTimeout(() => {
        showSuccess(`üëë Top Performer: ${topCandidate.candidateName || 'Leading Candidate'} with ${topScore}% match!`);
    }, 1000);
    
    // Generate cards (scores will animate after creation)
    candidatesData.forEach((candidate, index) => {
        const card = createCandidateCard(candidate, index);
        cardsContainer.appendChild(card);
    });
    
    // üìà SCORE REVEAL SEQUENCE - Animate scores in order
    setTimeout(() => {
        animateScoreRevealSequence();
    }, 1500);
}

function animateScoreRevealSequence() {
    const scoreRings = document.querySelectorAll('.mini-score-ring');
    const scoreTexts = document.querySelectorAll('.mini-score-text');
    
    // Get candidates with their scores and original indices
    const candidateScores = candidatesData.map((candidate, index) => ({
        score: parseInt(candidate.candidateScore) || 0,
        index: index,
        element: scoreRings[index],
        textElement: scoreTexts[index]
    })).sort((a, b) => b.score - a.score); // Sort by score descending
    
    // Animate scores in order (highest first)
    candidateScores.forEach((candidateData, order) => {
        setTimeout(() => {
            animateSingleScore(candidateData.element, candidateData.textElement, candidateData.score);
        }, order * 200); // 200ms delay between each score animation
    });
    
    // üéØ QUICK WINS SUMMARY after all scores are revealed
    setTimeout(() => {
        showQuickWinsSummary();
    }, candidateScores.length * 200 + 1000);
}

function animateSingleScore(scoreElement, textElement, finalScore) {
    if (!scoreElement || !textElement) return;
    
    // Start from 0 and animate to final score
    let currentScore = 0;
    const increment = finalScore / 15; // 20 steps over 1 second
    const intervalTime = 50; // 50ms per step = 1 second total
    
    // Add highlight effect during animation
    scoreElement.style.transform = 'scale(1.1)';
    scoreElement.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.3)';
    
    const countUp = setInterval(() => {
        currentScore += increment;
        if (currentScore >= finalScore) {
            currentScore = finalScore;
            clearInterval(countUp);
            
            // Remove highlight effect when done
            scoreElement.style.transform = 'scale(1)';
            scoreElement.style.boxShadow = '';
        }
        
        const roundedScore = Math.round(currentScore);
        textElement.textContent = roundedScore;
        scoreElement.style.setProperty('--score', `${currentScore}%`);
    }, intervalTime);
}

function showQuickWinsSummary() {
    const scores = candidatesData.map(c => parseInt(c.candidateScore) || 0);
    const excellentCount = scores.filter(s => s >= 80).length;
    const strongCount = scores.filter(s => s >= 60 && s < 80).length;
    const averageCount = scores.filter(s => s >= 40 && s < 60).length;
    
    // üéØ QUICK WINS SUMMARY
    let summaryMessage = '';
    if (excellentCount > 0) {
        summaryMessage = `üéØ Found ${excellentCount} excellent match${excellentCount > 1 ? 'es' : ''}`;
        if (strongCount > 0) {
            summaryMessage += `, ${strongCount} strong candidate${strongCount > 1 ? 's' : ''}`;
        }
    } else if (strongCount > 0) {
        summaryMessage = `üéØ Found ${strongCount} strong candidate${strongCount > 1 ? 's' : ''}`;
        if (averageCount > 0) {
            summaryMessage += `, ${averageCount} potential match${averageCount > 1 ? 'es' : ''}`;
        }
    } else {
        summaryMessage = `üîç ${candidatesData.length} candidates analyzed - review for potential matches`;
    }
    
    showSuccess(summaryMessage);
    
    // üí° SMART INSIGHTS after summary
    setTimeout(() => {
        showSmartInsights();
    }, 2000);
}

function showSmartInsights() {
    const topCandidate = candidatesData.reduce((prev, current) => 
        (parseInt(current.candidateScore) || 0) > (parseInt(prev.candidateScore) || 0) ? current : prev
    );
    
    const topScore = parseInt(topCandidate.candidateScore) || 0;
    const topName = topCandidate.candidateName || 'Your top candidate';
    
    // Extract key skills from top candidate
    const topSkills = extractAndFormatSkills(topCandidate.coreCompetencies);
    const skillsText = topSkills.length > 0 ? topSkills.slice(0, 2).join(' and ') : 'relevant skills';
    
    // Generate dynamic smart insights based on data
    let insightMessage = '';
    
    if (topScore >= 90) {
        insightMessage = `üí° ${topName} has exceptional qualifications with ${skillsText} - exactly what you're looking for!`;
    } else if (topScore >= 80) {
        insightMessage = `üí° ${topName} shows strong expertise in ${skillsText} and ${topScore}% overall fit`;
    } else if (topScore >= 70) {
        insightMessage = `üí° ${topName} brings solid experience in ${skillsText} - worth a deeper look`;
    } else if (topScore >= 60) {
        insightMessage = `üí° Your candidates show diverse backgrounds - ${topName} leads with ${skillsText} experience`;
    } else {
        // Focus on potential and diversity when scores are lower
        const uniqueSkills = new Set();
        candidatesData.forEach(candidate => {
            const skills = extractAndFormatSkills(candidate.coreCompetencies);
            skills.forEach(skill => uniqueSkills.add(skill));
        });
        insightMessage = `üí° Diverse talent pool discovered - ${uniqueSkills.size} different skill areas represented`;
    }
    
    showSuccess(insightMessage);
    
    // üîç DISCOVERY ENCOURAGEMENT after insights
    setTimeout(() => {
        showDiscoveryEncouragement();
    }, 2500);
}

function showDiscoveryEncouragement() {
    const encouragementMessages = [
        "üîç Click any candidate to discover hidden strengths and detailed insights",
        "üîç Tap candidates to uncover skills and experience that matter most",
        "üîç Explore each profile to find the perfect fit for your team",
        "üîç Click candidates to see what makes them unique"
    ];
    
    const randomMessage = encouragementMessages[Math.floor(Math.random() * encouragementMessages.length)];
    showSuccess(randomMessage);
}

// Add this NEW function right after generateCandidateCards
function generateFilteredCandidateCards(filteredCandidates) {
    const cardsContainer = document.getElementById('candidate-cards');
    cardsContainer.innerHTML = '';
    
    filteredCandidates.forEach((candidate) => {
        // Find the original index of this candidate
        const originalIndex = candidatesData.indexOf(candidate);
        const card = createCandidateCard(candidate, originalIndex);
        cardsContainer.appendChild(card);
    });
}

function sortCandidates(sortBy) {
    if (sortBy === 'score') {
        candidatesData.sort((a, b) => (parseInt(b.candidateScore) || 0) - (parseInt(a.candidateScore) || 0));
    } else if (sortBy === 'name') {
        candidatesData.sort((a, b) => {
            const nameA = (a.candidateName || `Candidate ${candidatesData.indexOf(a) + 1}`).toLowerCase();
            const nameB = (b.candidateName || `Candidate ${candidatesData.indexOf(b) + 1}`).toLowerCase();
            return nameA.localeCompare(nameB);
        });
    }
    
    // Regenerate cards and reset selection
    generateCandidateCards();
    showCandidateDetail(0);
    
    // Update active button
    document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`sort-${sortBy}`).classList.add('active');
}

function createCandidateCard(candidate, index) {
    const card = document.createElement('div');
    card.className = `candidate-mini-card ${index === selectedCandidateIndex ? 'active' : ''}`;
    card.onclick = () => showCandidateDetail(index);
    
    // Extract and format top 3 skills for preview
    const topSkills = extractAndFormatSkills(candidate.coreCompetencies);
    
    const score = parseInt(candidate.candidateScore) || 75;
    const name = candidate.candidateName || `Candidate ${index + 1}`;

    // Extract job title from executive summary if not directly available
    let title = candidate.candidateTitle || candidate.position || candidate.jobTitle;

    if (!title && candidate.executiveSummary) {
        const summaryText = candidate.executiveSummary;
        
        const titlePatterns = [
            /is (?:an?|the) ([^.]+?) with/i,
            /(?:seasoned|experienced|accomplished) ([^.]+?) with/i,
            /(?:as|is) (?:an?|the) ([^.]+?)\./i,
            /his role as ([^.]+?)\./i,
            /working as (?:an?|the) ([^.]+?)\./i
        ];
        
        for (let pattern of titlePatterns) {
            const match = summaryText.match(pattern);
            if (match && match[1]) {
                title = match[1].trim();
                title = title.replace(/\b(leader|professional|expert|individual)\b/gi, '')
                            .replace(/\s+/g, ' ')
                            .trim();
                if (title.length > 0 && title.length < 50) {
                    break;
                }
            }
        }
    }

    if (!title || title.length === 0) {
        title = 'Professional';
    }

    title = title.split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
    
        card.innerHTML = `
            <div class="mini-card-header">
                <div class="mini-card-info">
                    <h4>${sanitizeText(name)}</h4>
                    <p>${sanitizeText(title)}</p>
                </div>
                <div class="flex items-start gap-1">
                    <button class="save-candidate-btn w-6 h-6 bg-transparent hover:bg-gray-100 text-gray-400 hover:text-gray-600 rounded-full flex items-center justify-center transition-colors border border-gray-300" 
                            data-candidate-index="${index}"
                            onclick="event.stopPropagation(); toggleSaveCandidate(${index}, event)"
                            title="Save candidate">
                        <i class="far fa-bookmark text-xs"></i>
                    </button>
                    <div class="mini-score-ring" style="--score: ${score}%;">
                        <span class="mini-score-text">${score}</span>
                    </div>
                </div>
            </div>
            <div class="mini-skills">
                ${topSkills.map(skill => `<span class="mini-skill-tag">${sanitizeText(skill)}</span>`).join('')}
            </div>
        `;
    
    return card;
}

function showCandidateDetail(index) {
    selectedCandidateIndex = index;
    const candidate = candidatesData[index];
    
    // Update active card
    document.querySelectorAll('.candidate-mini-card').forEach((card, i) => {
        if (i === index) {
            card.classList.add('active');
        } else {
            card.classList.remove('active');
        }
    });
    
    // Generate detailed view
    const detailContainer = document.getElementById('selected-candidate-detail');
    detailContainer.innerHTML = generateCandidateDetailHTML(candidate, index);

    updateUserTierBadgeMultiple();
}

function generateCandidateDetailHTML(candidate, index) {
    const score = parseInt(candidate.candidateScore) || 75;
    const name = candidate.candidateName || `Candidate ${index + 1}`;
    const title = extractTitleFromSummary(candidate) || 'Professional';

    // ADD THIS DEBUG:
    console.log('=== BADGE DEBUG ===');
    console.log('Candidate:', name);
    console.log('Has roleAlignment?', !!candidate.roleAlignment);
    console.log('Has educationCertifications?', !!candidate.educationCertifications);
    console.log('Has communication?', !!candidate.communication);
    console.log('Has redFlags?', !!candidate.redFlags);
    console.log('Has strategicRecommendations?', !!candidate.strategicRecommendations);
    console.log('Has candidateScorecard?', !!candidate.candidateScorecard);
    console.log('Should be ULTRA?', !!(candidate.roleAlignment || candidate.educationCertifications || candidate.communication || candidate.redFlags || candidate.strategicRecommendations || candidate.candidateScorecard));
    console.log('=== END BADGE DEBUG ===');
    
    // Base HTML structure
    let detailHTML = `
        <!-- Candidate Overview -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-center md:items-start gap-6">
                <div>
                    <div class="flex items-center mb-2">
                        <h2 class="text-2xl font-bold text-gray-800">${sanitizeText(name)}</h2>
                        <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded">Candidate ${index + 1}</span>
                        ${getUserTierBadge()}
                    </div>
                    
                    <div class="flex flex-wrap gap-2 mt-2">
                        <span class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded-md">${title}</span>
                        <span class="text-xs bg-green-50 text-green-700 px-2 py-1 rounded-md">AI-Powered</span>
                        <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded-md">${new Date().toLocaleDateString()}</span>
                    </div>
                </div>
                
                <div class="text-center">
                    <div class="score-circle" style="--score-percent: ${score}%">
                        <div class="score-label">Score</div>
                        <div class="score-value">${score}</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Executive Summary -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex items-center mb-4">
                <i class="fas fa-file-alt text-blue-500 mr-3"></i>
                <h3 class="text-lg font-semibold">Executive Summary</h3>
            </div>
            <div class="text-gray-700">
                ${candidate.executiveSummary ? `<p>${sanitizeText(candidate.executiveSummary).replace(/\n/g, '<br>')}</p>` : '<p>Executive summary not available.</p>'}
            </div>
        </div>
        
        <!-- Core Competencies -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <i class="fas fa-brain text-blue-500 mr-3"></i>
                    <h3 class="text-lg font-semibold">Core Competencies</h3>
                </div>
            </div>
            <div class="text-gray-700">
                ${generateCompetenciesHTML(candidate.coreCompetencies)}
            </div>
        </div>
    `;
    
    // Add premium sections or upgrade prompt based on user tier
    const userStatus = creditManager.getStatus();
    const jobDescription = document.getElementById('job-description').value.trim();
    const hasJobDescription = jobDescription.length > 0;

    if (hasJobDescription) {
        // Job description was used - ULTRA sections with ULTRA badges
        detailHTML += generateUltraSectionsHTML(candidate);
    } else if (!userStatus.isFreeTier) {
        // No job description - PRO sections with PRO badges
        detailHTML += generatePremiumSectionsHTML(candidate);
    } else {
        // FREE user - add upgrade prompt
        detailHTML += generateUpgradePromptHTML();
    }
    
    // Add upgrade CTA at the end
    detailHTML += `
        <!-- Upgrade CTA -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl p-6 text-white mb-6">
            <div class="md:flex justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <h3 class="font-bold text-xl mb-2">Take Your Recruitment Process to the Next Level</h3>
                    <p class="opacity-90 mb-2">Unlock advanced customization options and powerful features:</p>
                    <ul class="list-disc pl-5 text-sm opacity-90 space-y-1">
                        <li>Custom metrics tracking tailored to your hiring needs</li>
                        <li>Batch upload via Google Drive for efficient processing</li>
                        <li>Flexible output formats (Google Docs, Slides, Sheets, PDF)</li>
                        <li>Personalized report templates to match your brand</li>
                        <li>Match candidates against your specific job requirements</li>
                    </ul>
                </div>
                <div class="mt-4 md:mt-0 flex-shrink-0 text-center">
                    <p class="text-sm italic text-white opacity-80 mb-2">Customize multiple candidates analysis</p>
                    <a href="https://calendly.com/ardhipradhana/montpro_discovery" class="inline-block px-6 py-3 bg-white text-purple-700 font-medium rounded-lg hover:bg-gray-100 transition-colors shadow-md">
                        <i class="fas fa-magic mr-2"></i>
                        Get My Tailored Version
                    </a>
                </div>
            </div>
        </div>
    `;
    
    return detailHTML;
}

function getAnalysisTypeBadge(candidate) {
    console.log('=== getAnalysisTypeBadge CALLED ===');
    
    const jobDescriptionElement = document.getElementById('job-description');
    if (!jobDescriptionElement) {
        console.log('ERROR: job-description element not found!');
        return '<span class="ml-2 px-2 py-1 bg-red-100 text-red-800 text-xs font-medium rounded">ERROR</span>';
    }
    
    const jobDescription = jobDescriptionElement.value.trim();
    const hasJobDescription = jobDescription.length > 0;
    
    console.log('Job description text:', `"${jobDescription}"`);
    console.log('Job description length:', jobDescription.length);
    console.log('hasJobDescription:', hasJobDescription);
    console.log('=== END getAnalysisTypeBadge ===');
    
    if (hasJobDescription) {
        return '<span class="ml-2 px-2 py-1 bg-gradient-to-r from-purple-500 to-pink-600 text-white text-xs font-medium rounded shadow-sm"><i class="fas fa-crown mr-1"></i>ULTRA Analysis</span>';
    } else {
        return '<span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded"><i class="fas fa-star mr-1"></i>PRO Analysis</span>';
    }
}

function getUserTierBadge() {
    const userStatus = creditManager.getStatus();
    
    if (userStatus.isFreeTier) {
        return '<span class="ml-2 px-2 py-1 bg-gray-100 text-gray-600 text-xs font-medium rounded">Free Plan</span>';
    } else if (userStatus.isUltraTier) {
        return '<span class="ml-2 px-2 py-1 bg-gradient-to-r from-purple-500 to-pink-600 text-white text-xs font-medium rounded shadow-sm"><i class="fas fa-crown mr-1"></i>ULTRA User</span>';
    } else {
        return '<span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded"><i class="fas fa-star mr-1"></i>PRO User</span>';
    }
}

function generateUltraSectionsHTML(candidate) {
    let ultraHTML = '';
    
    // Role Alignment Section
    if (candidate.roleAlignment) {
        ultraHTML += createPremiumSectionHTML(
            'fas fa-crosshairs',
            'Role Alignment & Potential Fit',
            candidate.roleAlignment,
            'text-purple-600',
            'ULTRA'
        );
    }
    
    // Education & Certifications
    if (candidate.educationCertifications) {
        ultraHTML += createPremiumSectionHTML(
            'fas fa-graduation-cap',
            'Education & Certifications',
            candidate.educationCertifications,
            'text-green-600',
            'ULTRA'
        );
    }
    
    // Communication Quality
    if (candidate.communication) {
        ultraHTML += createPremiumSectionHTML(
            'fas fa-comments',
            'Communication & Presentation Quality',
            candidate.communication,
            'text-blue-600',
            'ULTRA'
        );
    }
    
    // Red Flags
    if (candidate.redFlags) {
        ultraHTML += createPremiumSectionHTML(
            'fas fa-exclamation-triangle',
            'Red Flags & Risk Analysis',
            candidate.redFlags,
            'text-red-600',
            'ULTRA'
        );
    }
    
    // Strategic Recommendations
    if (candidate.strategicRecommendations) {
        ultraHTML += createPremiumSectionHTML(
            'fas fa-lightbulb',
            'Strategic Recommendations',
            candidate.strategicRecommendations,
            'text-green-600',
            'ULTRA'
        );
    }
    
    // Candidate Scorecard
    if (candidate.candidateScorecard) {
        ultraHTML += createPremiumSectionHTML(
            'fas fa-chart-bar',
            'Detailed Candidate Scorecard',
            candidate.candidateScorecard,
            'text-purple-600',
            'ULTRA'
        );
    }
    
    return ultraHTML;
}
        
function generatePremiumSectionsHTML(candidate) {
    let premiumHTML = '';
    
    // Role Alignment Section
    if (candidate.roleAlignment) {
        premiumHTML += createPremiumSectionHTML(
            'fas fa-crosshairs',
            'Role Alignment & Potential Fit',
            candidate.roleAlignment
        );
    }
    
    // Education & Certifications
    if (candidate.educationCertifications) {
        premiumHTML += createPremiumSectionHTML(
            'fas fa-graduation-cap',
            'Education & Certifications',
            candidate.educationCertifications
        );
    }
    
    // Communication Quality
    if (candidate.communication) {
        premiumHTML += createPremiumSectionHTML(
            'fas fa-comments',
            'Communication & Presentation Quality',
            candidate.communication
        );
    }
    
    // Red Flags
    if (candidate.redFlags) {
        premiumHTML += createPremiumSectionHTML(
            'fas fa-exclamation-triangle',
            'Red Flags & Risk Analysis',
            candidate.redFlags,
            'text-red-600'
        );
    }
    
    // Strategic Recommendations
    if (candidate.strategicRecommendations) {
        premiumHTML += createPremiumSectionHTML(
            'fas fa-lightbulb',
            'Strategic Recommendations',
            candidate.strategicRecommendations,
            'text-green-600'
        );
    }
    
    // Candidate Scorecard
    if (candidate.candidateScorecard) {
        premiumHTML += createPremiumSectionHTML(
            'fas fa-chart-bar',
            'Detailed Candidate Scorecard',
            candidate.candidateScorecard,
            'text-blue-600'
        );
    }
    
    return premiumHTML;
}

function createPremiumSectionHTML(iconClass, title, content, iconColor = 'text-blue-500', badgeType = 'PRO') {
    const badgeClass = badgeType === 'ULTRA' 
        ? 'bg-gradient-to-r from-purple-500 to-pink-600 text-white' 
        : 'bg-blue-100 text-blue-800';
        
    return `
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex items-center mb-4">
                <i class="${iconClass} ${iconColor} mr-3"></i>
                <h3 class="text-lg font-semibold">${sanitizeText(title)}</h3>
                <span class="ml-2 px-2 py-1 ${badgeClass} text-xs font-medium rounded">${badgeType}</span>
            </div>
            <div class="text-gray-700">
                ${formatPremiumContentHTML(content)}
            </div>
        </div>
    `;
}

function formatPremiumContentHTML(content) {
    if (!content) return '<p>No data available.</p>';
    
    // Sanitize the content first
    const sanitizedContent = sanitizeText(content);
    
    // Convert bullet points and line breaks to proper HTML
    return sanitizedContent
        .replace(/\n/g, '<br>')
        .replace(/^- /gm, '‚Ä¢ ')
        .replace(/\n\n/g, '<br><br>');
}

function generateUpgradePromptHTML() {
    return `
        <div class="bg-gradient-to-r from-gray-100 to-gray-200 rounded-xl p-6 mb-6 border-2 border-dashed border-gray-300">
            <div class="text-center">
                <i class="fas fa-lock text-gray-400 text-3xl mb-3"></i>
                <h3 class="text-lg font-semibold text-gray-600 mb-2">Premium Analysis Available</h3>
                <p class="text-gray-500 mb-4">Role Alignment, Education Analysis, Red Flags Detection, Strategic Recommendations, and Detailed Scorecard</p>
                <button onclick="showPricingPage()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-arrow-up mr-2"></i>
                    Upgrade for Complete Analysis
                </button>
            </div>
        </div>
    `;
}

function generateCompetenciesHTML(competencies) {
    if (!competencies) return '<p>No competencies data available.</p>';
    
    if (Array.isArray(competencies)) {
        return competencies.map(skill => 
            `<span class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm mr-2 mb-2">${sanitizeText(skill)}</span>`
        ).join('');
    } else if (typeof competencies === 'string') {
        const sanitizedText = sanitizeText(competencies);
        return sanitizedText.replace(/\n/g, '<br>').replace(/- /g, '‚Ä¢ ');
    }
    
    return '<p>Competencies data format not recognized.</p>';
}

function showSingleCandidateView(data) {
    // Restore normal width for single candidate
    const mainApp = document.getElementById('main-app');
    mainApp.classList.add('max-w-7xl');
    mainApp.style.maxWidth = '';
    mainApp.style.width = '';
    
    document.getElementById('multiple-candidates-view').classList.add('hidden');
    document.getElementById('single-candidate-view').classList.remove('hidden');
    
    // CLEAR EXISTING DYNAMIC SECTIONS FIRST
    const singleView = document.getElementById('single-candidate-view');
    if (singleView) {
        // Remove all dynamically added sections (keep only the original 3: overview, executive summary, core competencies)
        const allSections = singleView.querySelectorAll('.bg-white.rounded-xl.shadow-sm');
        allSections.forEach((section, index) => {
            // Keep only the first 3 original sections
            if (index > 2) {
                section.remove();
            }
        });
    }
    
    // Update candidate name safely
    const nameElement = document.getElementById('candidate-name');
    if (nameElement && data.candidateName) {
        nameElement.textContent = sanitizeText(data.candidateName);
    }
    
    // üé≠ DRAMATIC REVEAL: Start with score hidden and show completion message
    const scoreElement = document.getElementById('candidate-score');
    const scoreCircle = document.querySelector('.score-circle');
    const scoreBadge = document.getElementById('score-badge');
    const analysisTimeElement = document.getElementById('analysis-time');
    
    // Hide score initially for dramatic reveal
    if (scoreElement) {
        scoreElement.style.opacity = '0';
        scoreElement.textContent = '0';
    }
    if (scoreCircle) {
        scoreCircle.style.setProperty('--score-percent', '0%');
    }
    
    // Show completion hero moment
    showSuccess('üéâ Analysis Complete! Discovering insights...');
    
    // Get final score for animation
    const finalScore = parseInt(data.candidateScore) || 75;

    // DEBUG: Check what elements exist - ADD THIS HERE
    console.log('=== SCORE DEBUG ===');
    console.log('candidate-score element:', document.getElementById('candidate-score'));
    console.log('score-value element:', document.querySelector('.score-value'));
    console.log('score-circle element:', document.querySelector('.score-circle'));
    console.log('score-badge element:', document.getElementById('score-badge'));
    console.log('finalScore:', finalScore);
    console.log('=== END DEBUG ===');

    // DEBUG: Find the actual score circle element
    console.log('=== CIRCLE DEBUG ===');
    console.log('All elements with "score" in class:', document.querySelectorAll('[class*="score"]'));
    console.log('All elements with "circle" in class:', document.querySelectorAll('[class*="circle"]'));
    console.log('All elements with "--score" style:', document.querySelectorAll('[style*="--score"]'));
    console.log('=== END CIRCLE DEBUG ===');
    
    // üìä ANIMATED SCORE: Count up effect (2 seconds max)
    setTimeout(() => {
        // Find the correct score elements with multiple selectors
        const scoreElement = document.querySelector('#candidate-score, .score-value');
        const scoreCircle = document.querySelector('.score-circle, [style*="--score-percent"]');
        
        if (scoreElement) {
            scoreElement.style.opacity = '1';
            scoreElement.style.transition = 'opacity 0.3s ease';
            
            let currentScore = 0;
            const increment = finalScore / 15; // 40 steps over ~2 seconds
            const intervalTime = 50; // 50ms per step = 2 seconds total
            
            const countUp = setInterval(() => {
                currentScore += increment;
                if (currentScore >= finalScore) {
                    currentScore = finalScore;
                    clearInterval(countUp);
                    
                    // üéØ SCORE BADGE: Show dynamic badge after score animation
                    setTimeout(() => {
                        const scoreBadge = document.querySelector('#score-badge, .score-badge');
                        updateScoreBadge(finalScore, scoreBadge);
                    }, 300);
                }
                
                scoreElement.textContent = Math.round(currentScore);
                
                // Try to find and update score circle
                if (scoreCircle) {
                    scoreCircle.style.setProperty('--score-percent', `${currentScore}%`);
                } else {
                    // Alternative: find any element with score-related styling
                    const circleElement = document.querySelector('[class*="score"], [class*="circle"]');
                    if (circleElement) {
                        circleElement.style.setProperty('--score-percent', `${currentScore}%`);
                    }
                }
            }, intervalTime);
        } else {
            console.log('Score elements not found:', {
                scoreElement: !!scoreElement,
                scoreCircle: !!scoreCircle
            });
        }
    }, 800);
    
    // Update executive summary safely
    const executiveSummaryElement = document.getElementById('executive-summary');
    if (executiveSummaryElement && data.executiveSummary) {
        executiveSummaryElement.innerHTML = `<p>${sanitizeText(data.executiveSummary)}</p>`;
    }

    // Update core competencies safely
    const competenciesElement = document.getElementById('core-competencies');
    if (competenciesElement && data.coreCompetencies) {
        competenciesElement.innerHTML = generateCompetenciesHTML(data.coreCompetencies);
    }
    
    // Determine analysis type and user status
    const userStatus = creditManager.getStatus();
    const jobDescriptionElement = document.getElementById('job-description');
    const jobDescription = jobDescriptionElement ? jobDescriptionElement.value.trim() : '';
    const hasJobDescription = jobDescription.length > 0;
    
    // Add appropriate sections based on analysis type and user tier
    if (hasJobDescription) {
        // ULTRA analysis used
        addUltraSections(data);
        updateUserTierBadge('ULTRA');
    } else if (!userStatus.isFreeTier) {
        // PRO analysis used
        addProfessionalSections(data);
        updateUserTierBadge('PRO');
    } else {
        // User is FREE - show upgrade prompts where premium content would be
        addUpgradePrompts();
        updateUserTierBadge('FREE');
    }
    
    // Update analysis date safely
    const analysisDateElement = document.getElementById('analysis-date');
    if (analysisDateElement) {
        const today = new Date();
        analysisDateElement.textContent = today.toLocaleDateString();
    }

    // Set dynamic analysis time
    setDynamicAnalysisTime();

    // Update user tier badge
    updateUserTierBadge();
    
    // üöÄ ACTION ENCOURAGEMENT: Show after everything loads
    setTimeout(() => {
        showActionEncouragement();
    }, 3000); // Reduced from 4000 to 3000ms
}

// üéØ SCORE BADGE: Dynamic badge function
function updateScoreBadge(score, badgeElement) {
    if (!badgeElement) return;
    
    let badgeHTML = '';
    let badgeClass = '';
    
    if (score >= 80) {
        badgeHTML = score >= 90 ? 'üèÜ Excellent Match' : '‚≠ê Top Candidate';
        badgeClass = 'px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full';
    } else if (score >= 60) {
        badgeHTML = score >= 70 ? 'üéØ Good Potential' : '‚úÖ Worth Considering';
        badgeClass = 'px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full';
    } else {
        badgeHTML = score >= 50 ? 'üí° Needs Review' : 'üîç Mixed Signals';
        badgeClass = 'px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-medium rounded-full';
    }
    
    badgeElement.innerHTML = badgeHTML;
    badgeElement.className = badgeClass;
    
    // Animate badge appearance
    badgeElement.style.opacity = '0';
    badgeElement.style.transform = 'scale(0.8)';
    badgeElement.style.transition = 'all 0.4s ease';
    
    requestAnimationFrame(() => {
        badgeElement.style.opacity = '1';
        badgeElement.style.transform = 'scale(1)';
    });
}

// üöÄ ACTION ENCOURAGEMENT: Show motivating next steps
function showActionEncouragement() {
    const encouragementMessages = [
        "Ready to find more talent like this?",
        "Upload another resume to compare candidates", 
        "Save this candidate and analyze more",
        "Want to build your dream team? Keep analyzing!"
    ];
    
    const randomMessage = encouragementMessages[Math.floor(Math.random() * encouragementMessages.length)];
    
    // Use the existing showSuccess function which should show notifications
    showSuccess(`üöÄ ${randomMessage}`);
    
    // Debug log to see if this function is being called
    console.log('Action encouragement triggered:', randomMessage);
}

function updateUserTierBadge(analysisType = null) {
    const userStatus = creditManager.getStatus();
    const badgeElement = document.getElementById('user-tier-badge');

    console.log('=== updateUserTierBadge DEBUG ===');
    console.log('analysisType parameter:', analysisType);
    console.log('userStatus.isFreeTier:', userStatus.isFreeTier);
    console.log('userStatus.isUltraTier:', userStatus.isUltraTier);
    
    if (badgeElement) {
        // Use analysis type if provided, otherwise use user tier
        const displayType = analysisType || (userStatus.isFreeTier ? 'FREE' : userStatus.isUltraTier ? 'ULTRA' : 'PRO');

        console.log('Final displayType:', displayType);
        console.log('=== END updateUserTierBadge DEBUG ===');
        
        if (displayType === 'FREE') {
            badgeElement.className = 'ml-2 px-2 py-1 bg-gray-100 text-gray-600 text-xs font-medium rounded';
            badgeElement.innerHTML = 'Free Plan';
        } else if (displayType === 'PRO') {
            badgeElement.className = 'ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded';
            badgeElement.innerHTML = '<i class="fas fa-star mr-1"></i>PRO Analysis';
        } else if (displayType === 'ULTRA') {
            badgeElement.className = 'ml-2 px-2 py-1 bg-gradient-to-r from-purple-500 to-pink-600 text-white text-xs font-medium rounded shadow-sm';
            badgeElement.innerHTML = '<i class="fas fa-crown mr-1"></i>ULTRA Analysis';
        }
    }
}

function updateUserTierBadgeMultiple() {
    const userStatus = creditManager.getStatus();
    const badgeElement = document.getElementById('user-tier-badge-multiple');
    
    if (badgeElement) {
        if (userStatus.isFreeTier) {
            badgeElement.className = 'ml-2 px-2 py-1 bg-gray-100 text-gray-600 text-xs font-medium rounded';
            badgeElement.innerHTML = 'Free Plan';
        } else {
            badgeElement.className = 'ml-2 px-2 py-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white text-xs font-medium rounded shadow-sm';
            badgeElement.innerHTML = '<i class="fas fa-crown mr-1"></i>PRO';
        }
    }
}

function addProfessionalSections(data) {
    const coreCompetenciesContainer = document.getElementById('core-competencies').parentElement;
    
    // Role Alignment Section
    if (data.roleAlignment) {
        const roleSection = createPremiumSection(
            'fas fa-crosshairs',
            'Role Alignment & Potential Fit',
            data.roleAlignment
        );
        coreCompetenciesContainer.insertAdjacentHTML('afterend', roleSection);
    }
    
    // Education & Certifications
    if (data.educationCertifications) {
        const educationSection = createPremiumSection(
            'fas fa-graduation-cap',
            'Education & Certifications',
            data.educationCertifications
        );
        coreCompetenciesContainer.insertAdjacentHTML('afterend', educationSection);
    }
    
    // Communication Quality
    if (data.communication) {
        const commSection = createPremiumSection(
            'fas fa-comments',
            'Communication & Presentation Quality',
            data.communication
        );
        coreCompetenciesContainer.insertAdjacentHTML('afterend', commSection);
    }
    
    // Red Flags
    if (data.redFlags) {
        const redFlagsSection = createPremiumSection(
            'fas fa-exclamation-triangle',
            'Red Flags & Risk Analysis',
            data.redFlags,
            'text-red-600'
        );
        coreCompetenciesContainer.insertAdjacentHTML('afterend', redFlagsSection);
    }
    
    // Strategic Recommendations
    if (data.strategicRecommendations) {
        const strategicSection = createPremiumSection(
            'fas fa-lightbulb',
            'Strategic Recommendations',
            data.strategicRecommendations,
            'text-green-600'
        );
        coreCompetenciesContainer.insertAdjacentHTML('afterend', strategicSection);
    }
    
    // Candidate Scorecard
    if (data.candidateScorecard) {
        const scorecardSection = createPremiumSection(
            'fas fa-chart-bar',
            'Detailed Candidate Scorecard',
            data.candidateScorecard,
            'text-blue-600'
        );
        coreCompetenciesContainer.insertAdjacentHTML('afterend', scorecardSection);
    }
}

function addUltraSections(data) {
    const coreCompetenciesContainer = document.getElementById('core-competencies').parentElement;
    
    // Role Alignment Section
    if (data.roleAlignment) {
        const roleSection = createUltraSection(
            'fas fa-crosshairs',
            'Role Alignment & Potential Fit',
            data.roleAlignment,
            'text-purple-600'
        );
        coreCompetenciesContainer.insertAdjacentHTML('afterend', roleSection);
    }
    
    // Education & Certifications
    if (data.educationCertifications) {
        const educationSection = createUltraSection(
            'fas fa-graduation-cap',
            'Education & Certifications',
            data.educationCertifications,
            'text-green-600'
        );
        coreCompetenciesContainer.insertAdjacentHTML('afterend', educationSection);
    }
    
    // Communication Quality
    if (data.communication) {
        const commSection = createUltraSection(
            'fas fa-comments',
            'Communication & Presentation Quality',
            data.communication,
            'text-blue-600'
        );
        coreCompetenciesContainer.insertAdjacentHTML('afterend', commSection);
    }
    
    // Red Flags
    if (data.redFlags) {
        const redFlagsSection = createUltraSection(
            'fas fa-exclamation-triangle',
            'Red Flags & Risk Analysis',
            data.redFlags,
            'text-red-600'
        );
        coreCompetenciesContainer.insertAdjacentHTML('afterend', redFlagsSection);
    }
    
    // Strategic Recommendations
    if (data.strategicRecommendations) {
        const strategicSection = createUltraSection(
            'fas fa-lightbulb',
            'Strategic Recommendations',
            data.strategicRecommendations,
            'text-green-600'
        );
        coreCompetenciesContainer.insertAdjacentHTML('afterend', strategicSection);
    }
    
    // Candidate Scorecard
    if (data.candidateScorecard) {
        const scorecardSection = createUltraSection(
            'fas fa-chart-bar',
            'Detailed Candidate Scorecard',
            data.candidateScorecard,
            'text-purple-600'
        );
        coreCompetenciesContainer.insertAdjacentHTML('afterend', scorecardSection);
    }
}

function createUltraSection(iconClass, title, content, iconColor = 'text-purple-600') {
    return `
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex items-center mb-4">
                <i class="${iconClass} ${iconColor} mr-3"></i>
                <h3 class="text-lg font-semibold">${title}</h3>
                <span class="ml-2 px-2 py-1 bg-gradient-to-r from-purple-500 to-pink-600 text-white text-xs font-medium rounded">ULTRA</span>
            </div>
            <div class="text-gray-700">
                ${formatUltraContent(content)}
            </div>
        </div>
    `;
}

function formatUltraContent(content) {
    if (!content) return '<p>No data available.</p>';
    
    // Convert bullet points and line breaks to proper HTML
    return content
        .replace(/\n/g, '<br>')
        .replace(/^- /gm, '‚Ä¢ ')
        .replace(/\n\n/g, '<br><br>');
}

function createPremiumSection(iconClass, title, content, iconColor = 'text-blue-500') {
    return `
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex items-center mb-4">
                <i class="${iconClass} ${iconColor} mr-3"></i>
                <h3 class="text-lg font-semibold">${title}</h3>
                <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded">PRO</span>
            </div>
            <div class="text-gray-700">
                ${formatPremiumContent(content)}
            </div>
        </div>
    `;
}

function formatPremiumContent(content) {
    if (!content) return '<p>No data available.</p>';
    
    // Convert bullet points and line breaks to proper HTML
    return content
        .replace(/\n/g, '<br>')
        .replace(/^- /gm, '‚Ä¢ ')
        .replace(/\n\n/g, '<br><br>');
}

function addUpgradePrompts() {
    const coreCompetenciesContainer = document.getElementById('core-competencies').parentElement;
    
    const upgradePrompt = `
        <div class="bg-gradient-to-r from-gray-100 to-gray-200 rounded-xl p-6 mb-6 border-2 border-dashed border-gray-300">
            <div class="text-center">
                <i class="fas fa-lock text-gray-400 text-3xl mb-3"></i>
                <h3 class="text-lg font-semibold text-gray-600 mb-2">Premium Analysis Available</h3>
                <p class="text-gray-500 mb-4">Role Alignment, Education Analysis, Red Flags Detection, Strategic Recommendations, and Detailed Scorecard</p>
                <button onclick="showPricingPage()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-arrow-up mr-2"></i>
                    Upgrade for Complete Analysis
                </button>
            </div>
        </div>
    `;
    
    coreCompetenciesContainer.insertAdjacentHTML('afterend', upgradePrompt);
}
        
// Skill formatting functions
function formatSkillText(skill) {
    // Words that should remain lowercase (except at the beginning)
    const lowercaseWords = ['and', 'of', 'in', 'the', 'a', 'an', 'to', 'for', 'with', 'by', 'on', 'at'];
    
    return skill.toLowerCase()
        .split(' ')
        .map((word, index) => {
            // Always capitalize the first word
            if (index === 0) {
                return word.charAt(0).toUpperCase() + word.slice(1);
            }
            // Keep lowercase words lowercase unless they're the first word
            if (lowercaseWords.includes(word)) {
                return word;
            }
            // Capitalize other words
            return word.charAt(0).toUpperCase() + word.slice(1);
        })
        .join(' ');
}

function extractAndFormatSkills(competencies) {
    if (!competencies) return [];
    
    let skills = [];
    if (Array.isArray(competencies)) {
        skills = competencies.slice(0, 3);
    } else if (typeof competencies === 'string') {
        // Extract skills from text - look for bullet points or comma-separated items
        const lines = competencies.split('\n');
        for (let line of lines) {
            if (line.includes('-') || line.includes('‚Ä¢')) {
                // Extract text after bullet point
                const skillText = line.replace(/^[-‚Ä¢]\s*/, '').trim();
                if (skillText && skillText.length > 0) {
                    // Take first few words as skill name
                    const shortSkill = skillText.split(' ').slice(0, 4).join(' ');
                    skills.push(shortSkill);
                    if (skills.length >= 3) break;
                }
            }
        }
        
        // If no bullet points found, try to extract key phrases
        if (skills.length === 0) {
            const phrases = competencies.match(/[A-Z][a-z]+(?:\s+[a-z]+)*(?:\s+[A-Z][a-z]+)*/g) || [];
            skills = phrases.slice(0, 3);
        }
    }
    
    // Format each skill with proper capitalization
    return skills.map(skill => formatSkillText(skill));
}

// History Management Functions
function saveCurrentAnalysisToHistory() {
    if (candidatesData && candidatesData.length > 0) {
        const analysisId = historyManager.saveAnalysis(candidatesData, {
            analysisType: candidatesData.length > 1 ? 'multiple' : 'single',
            selectedCandidateIndex: selectedCandidateIndex || 0,
            fileNames: files.map(f => f.name),
            fileCount: files.length
        });
        
        updateHistoryCounter();
        return analysisId;
    }
}

function updateHistoryCounter() {
    const stats = historyManager.getHistoryStats();
    const counterElement = document.getElementById('history-count');
    
    if (stats.totalAnalyses > 0) {
        counterElement.textContent = stats.totalAnalyses;
        counterElement.classList.remove('hidden');
    } else {
        counterElement.classList.add('hidden');
    }
}

function showHistoryModal() {
    const modal = document.getElementById('history-modal');
    const historyList = document.getElementById('history-list');
    const emptyState = document.getElementById('history-empty');
    
    // Update stats
    const stats = historyManager.getHistoryStats();
    document.getElementById('total-analyses').textContent = stats.totalAnalyses;
    document.getElementById('total-candidates-analyzed').textContent = stats.totalCandidates;
    document.getElementById('last-analysis-date').textContent = 
        stats.lastAnalysis ? new Date(stats.lastAnalysis).toLocaleDateString() : 'Never';
    
    // Load history items
    const history = historyManager.getHistory();
    
    if (history.length === 0) {
        historyList.classList.add('hidden');
        emptyState.classList.remove('hidden');
    } else {
        historyList.classList.remove('hidden');
        emptyState.classList.add('hidden');
        renderHistoryList(history);
    }
    
    modal.classList.remove('hidden');
}

function deleteHistoryItem(analysisId) {
    if (confirm('Are you sure you want to delete this analysis from history?')) {
        try {
            let history = historyManager.getHistory();
            history = history.filter(item => item.id !== analysisId);
            localStorage.setItem(historyManager.storageKey, JSON.stringify(history));
            
            // Refresh the modal display
            showHistoryModal();
            updateHistoryCounter();
            showSuccess('Analysis deleted from history!');
        } catch (error) {
            console.error('Failed to delete history item:', error);
            showError('Failed to delete analysis from history.');
        }
    }
}

// Export History to CSV
function exportHistoryToCSV() {
    const exportBtn = document.getElementById('export-history-btn');
    const originalHtml = exportBtn.innerHTML;
    
    try {
        exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Exporting...';
        
        const history = historyManager.getHistory();
        if (history.length === 0) {
            showWarning('No history to export.');
            exportBtn.innerHTML = originalHtml;
            return;
        }
        
        // Create CSV data
        const csvData = [];
        history.forEach(analysis => {
            analysis.candidates.forEach((candidate, index) => {
                csvData.push({
                    'Analysis Date': analysis.analysisDate,
                    'Analysis Time': new Date(analysis.timestamp).toLocaleTimeString(),
                    'Candidate Name': candidate.candidateName || `Candidate ${index + 1}`,
                    'Score': candidate.candidateScore || 'N/A',
                    'Title': extractTitleFromSummary(candidate) || 'Professional',
                    'Executive Summary': candidate.executiveSummary ? candidate.executiveSummary.replace(/"/g, '""') : 'N/A',
                    'Core Competencies': candidate.coreCompetencies ? 
                        (typeof candidate.coreCompetencies === 'string' ? 
                            "'" + candidate.coreCompetencies.replace(/"/g, '""') : 
                            "'" + candidate.coreCompetencies.join('; ')) : 'N/A'
                });
            });
        });
        
        // Convert to CSV
        const headers = Object.keys(csvData[0]);
        const csvContent = [
            headers.join(','),
            ...csvData.map(row => headers.map(header => `"${row[header]}"`).join(','))
        ].join('\n');
        
        // Download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `MontPro_History_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        
        exportBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Exported!';
        showSuccess('History exported successfully!');
        
        setTimeout(() => {
            exportBtn.innerHTML = originalHtml;
        }, 2000);
        
    } catch (error) {
        console.error('Export failed:', error);
        exportBtn.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>Failed';
        showError('Failed to export history.');
        
        setTimeout(() => {
            exportBtn.innerHTML = originalHtml;
        }, 3000);
    }
}

// Clear All History
function clearAllHistory() {
    if (confirm('Are you sure you want to clear all analysis history? This action cannot be undone.')) {
        try {
            localStorage.removeItem(historyManager.storageKey);
            updateHistoryCounter();
            showHistoryModal(); // Refresh modal to show empty state
            showSuccess('All history cleared successfully!');
        } catch (error) {
            console.error('Failed to clear history:', error);
            showError('Failed to clear history.');
        }
    }
}
        
function renderHistoryList(history) {
    const historyList = document.getElementById('history-list');
    
    historyList.innerHTML = history.map((item, index) => `
        <div class="bg-gray-50 rounded-lg p-4 mb-3 hover:bg-gray-100 transition-colors cursor-pointer" data-analysis-id="${item.id}">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <h4 class="font-medium text-gray-800 mb-1">
                        ${item.totalCandidates} Candidate${item.totalCandidates > 1 ? 's' : ''} Analysis
                    </h4>
                    <p class="text-sm text-gray-600 mb-2">
                        ${item.candidates.map(c => c.candidateName || 'Unnamed Candidate').join(', ')}
                    </p>
                    <div class="flex gap-4 text-xs text-gray-500">
                        <span><i class="fas fa-calendar mr-1"></i>${item.analysisDate}</span>
                        <span><i class="fas fa-clock mr-1"></i>${new Date(item.timestamp).toLocaleTimeString()}</span>
                    </div>
                </div>
                <div class="flex flex-col items-end gap-2">
                    <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                        ${item.totalCandidates} candidate${item.totalCandidates > 1 ? 's' : ''}
                    </span>
                    <button onclick="event.stopPropagation(); deleteHistoryItem('${item.id}')" class="text-red-500 hover:text-red-700 text-xs">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');

    setupHistoryItemHandlers();
}

// Add proper event handlers for history items
function setupHistoryItemHandlers() {
    document.querySelectorAll('#history-list [data-analysis-id]').forEach(historyItem => {
        historyItem.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            
            const analysisId = this.getAttribute('data-analysis-id');
            if (analysisId) {
                loadAnalysisFromHistory(analysisId);
            }
        });
    });
}

function loadAnalysisFromHistory(analysisId) {

    // Immediately hide the modal and saved candidates page
    document.getElementById('history-modal').classList.add('hidden');
    
    const savedCandidatesPage = document.getElementById('saved-candidates-page');
    if (savedCandidatesPage) {
        savedCandidatesPage.style.display = 'none';
        savedCandidatesPage.classList.add('support-page-hidden');
    }
    
    const analysis = historyManager.getAnalysisById(analysisId);
    
    if (!analysis) {
        showError('Analysis not found in history.');
        return;
    }
    
    if (!analysis.candidates || analysis.candidates.length === 0) {
        showError('Analysis data appears to be corrupted.');
        return;
    }

    // FIX: Properly clear existing results before loading new ones
    const analysisResults = document.getElementById('analysis-results');
    if (analysisResults) {
        // Clear all dynamic content inside analysis-results
        const singleView = document.getElementById('single-candidate-view');
        const multipleView = document.getElementById('multiple-candidates-view');
        
        if (singleView) {
            // Clear any dynamically added sections (PRO/ULTRA sections)
            const dynamicSections = singleView.querySelectorAll('.bg-white.rounded-xl.shadow-sm');
            dynamicSections.forEach((section, index) => {
                // Keep only the first 3 sections (overview, executive summary, core competencies)
                if (index > 2) {
                    section.remove();
                }
            });
        }
        
        if (multipleView) {
            // Clear candidate cards and details
            const candidateCards = document.getElementById('candidate-cards');
            const candidateDetail = document.getElementById('selected-candidate-detail');
            if (candidateCards) candidateCards.innerHTML = '';
            if (candidateDetail) candidateDetail.innerHTML = '';
        }
    }
    
    // Hide upload interface and show results
    document.getElementById('upload-interface').classList.add('hidden');
    
    // Load the analysis data
    candidatesData = analysis.candidates;
    selectedCandidateIndex = analysis.metadata?.selectedCandidateIndex || 0;
    
    // Show results WITHOUT calling useAnalysisCredit (since this is from history)
    showAnalysisResultsFromHistory(analysis.candidates);
    
    // Re-setup export functionality for loaded analysis
    setupDownloadPDF();
    setupExportOptions();
    
    // Update save button states for loaded candidates
    setTimeout(() => {
        updateSaveButtonStates();
    }, 200);
    
    // Close the modal
    document.getElementById('history-modal').classList.add('hidden');
    
    showSuccess('Analysis loaded from history!');

    // Ensure saved candidates page stays hidden
    setTimeout(() => {
        const savedCandidatesPage = document.getElementById('saved-candidates-page');
        if (savedCandidatesPage) {
            savedCandidatesPage.style.display = 'none';
            savedCandidatesPage.classList.add('support-page-hidden');
        }
    }, 100);

    // Force browser re-render
    setTimeout(() => {
        const savedCandidatesPage = document.getElementById('saved-candidates-page');
        if (savedCandidatesPage) {
            savedCandidatesPage.style.display = 'none';
            savedCandidatesPage.classList.add('support-page-hidden');
        }
        
        // Force re-render by triggering a layout recalculation
        document.body.style.transform = 'translateZ(0)';
        requestAnimationFrame(() => {
            document.body.style.transform = '';
            
            // Ensure analysis results are visible
            const analysisResults = document.getElementById('analysis-results');
            const mainApp = document.getElementById('main-app');
            
            if (analysisResults && mainApp) {
                analysisResults.style.display = 'block';
                mainApp.style.display = 'block';
                
                // Force one more re-render
                requestAnimationFrame(() => {
                    console.log('Forced browser re-render completed');
                });
            }
        });
    }, 200);
}

// Initialize Top Filters for Saved Candidates
function setupSavedCandidatesTopFilters() {
    // Keywords search (top version)
    const keywordsInputTop = document.getElementById('saved-keywords-filter-top');
    if (keywordsInputTop) {
        keywordsInputTop.addEventListener('input', debounce((e) => {
            handleSavedKeywordsFilter(e.target.value);
            // Also sync with sidebar filter if it exists
            const sidebarInput = document.getElementById('saved-keywords-filter');
            if (sidebarInput) sidebarInput.value = e.target.value;
        }, 300));
    }
    
    // Score range (top version)
    const scoreRangeTop = document.getElementById('saved-score-range-top');
    const scoreDisplayTop = document.getElementById('saved-score-display-top');
    if (scoreRangeTop && scoreDisplayTop) {
        scoreRangeTop.addEventListener('input', (e) => {
            const value = e.target.value;
            scoreDisplayTop.textContent = value;
            handleSavedScoreFilter(value);
            
            // Sync with sidebar elements
            const sidebarRange = document.getElementById('saved-score-range');
            const sidebarDisplay = document.getElementById('saved-score-display');
            if (sidebarRange) sidebarRange.value = value;
            if (sidebarDisplay) sidebarDisplay.textContent = value;
        });
    }
    
    // Date filter (top version)
    const dateFilterTop = document.getElementById('saved-date-filter-top');
    if (dateFilterTop) {
        dateFilterTop.addEventListener('change', (e) => {
            handleSavedDateFilter(e.target.value);
            // Sync with sidebar
            const sidebarDateFilter = document.getElementById('saved-date-filter');
            if (sidebarDateFilter) sidebarDateFilter.value = e.target.value;
        });
    }
    
    // Advanced filters toggle (top version)
    const toggleAdvancedTop = document.getElementById('toggle-advanced-filters-top');
    const advancedFiltersTop = document.getElementById('advanced-filters-top');
    if (toggleAdvancedTop && advancedFiltersTop) {
        toggleAdvancedTop.addEventListener('click', () => {
            const isHidden = advancedFiltersTop.classList.contains('hidden');
            const icon = toggleAdvancedTop.querySelector('i');
            const text = toggleAdvancedTop.querySelector('span');
            
            if (isHidden) {
                advancedFiltersTop.classList.remove('hidden');
                icon.className = 'fas fa-chevron-up mr-1';
                text.textContent = 'Hide Advanced';
            } else {
                advancedFiltersTop.classList.add('hidden');
                icon.className = 'fas fa-chevron-down mr-1';
                text.textContent = 'Advanced Filters';
            }
        });
    }
    
    // Premium analysis filter (top version)
    const premiumAnalysisFilterTop = document.getElementById('has-premium-analysis-top');
    if (premiumAnalysisFilterTop) {
        premiumAnalysisFilterTop.addEventListener('change', (e) => {
            handleSavedPremiumFilter(e.target.checked);
            // Sync with sidebar
            const sidebarPremiumFilter = document.getElementById('has-premium-analysis');
            if (sidebarPremiumFilter) sidebarPremiumFilter.checked = e.target.checked;
        });
    }
    
    // High potential filter (new filter)
    const highPotentialFilterTop = document.getElementById('high-potential-top');
    if (highPotentialFilterTop) {
        highPotentialFilterTop.addEventListener('change', (e) => {
            if (e.target.checked) {
                // Set minimum score to 80 when high potential is checked
                handleSavedScoreFilter(80);
                if (scoreRangeTop) scoreRangeTop.value = 80;
                if (scoreDisplayTop) scoreDisplayTop.textContent = '80';
            }
        });
    }
    
    // Clear filters (top version)
    const clearFiltersTop = document.getElementById('clear-saved-filters-top');
    if (clearFiltersTop) {
        clearFiltersTop.addEventListener('click', () => {
            clearSavedFiltersFromTop();
        });
    }
    
    // Sort buttons (top version)
    setupTopSortButtons();
    
    // Compare button (top version)
    const compareBtnTop = document.getElementById('compare-selected-btn-top');
    if (compareBtnTop) {
        compareBtnTop.addEventListener('click', () => {
            if (candidateComparison.canCompare()) {
                showComparisonView();
            }
        });
    }
    
    // Select all candidates button
    const selectAllBtn = document.getElementById('select-all-candidates');
    if (selectAllBtn) {
        selectAllBtn.addEventListener('click', selectAllCandidatesForComparison);
    }
    
    // Export saved candidates button
    const exportBtn = document.getElementById('export-saved-candidates');
    if (exportBtn) {
        exportBtn.addEventListener('click', exportSavedCandidates);
    }
}

// Setup top sort buttons
function setupTopSortButtons() {
    const sortButtons = document.querySelectorAll('.sort-btn-top');
    
    sortButtons.forEach(button => {
        button.addEventListener('click', (e) => {
            const buttonId = e.target.id;
            let sortType = '';
            
            if (buttonId.includes('score')) sortType = 'score';
            else if (buttonId.includes('name')) sortType = 'name';
            else if (buttonId.includes('date')) sortType = 'date';
            
            // Update active state
            sortButtons.forEach(btn => {
                btn.classList.remove('active', 'bg-blue-100', 'text-blue-800');
                btn.classList.add('bg-gray-100', 'text-gray-700');
            });
            
            e.target.classList.add('active', 'bg-blue-100', 'text-blue-800');
            e.target.classList.remove('bg-gray-100', 'text-gray-700');
            
            // Call existing sort function
            sortSavedCandidates(sortType);
        });
    });
}

// Clear filters from top controls
function clearSavedFiltersFromTop() {
    // Clear top inputs
    const keywordsInputTop = document.getElementById('saved-keywords-filter-top');
    const scoreRangeTop = document.getElementById('saved-score-range-top');
    const scoreDisplayTop = document.getElementById('saved-score-display-top');
    const dateFilterTop = document.getElementById('saved-date-filter-top');
    const premiumFilterTop = document.getElementById('has-premium-analysis-top');
    const highPotentialTop = document.getElementById('high-potential-top');
    
    if (keywordsInputTop) keywordsInputTop.value = '';
    if (scoreRangeTop) scoreRangeTop.value = 0;
    if (scoreDisplayTop) scoreDisplayTop.textContent = '0';
    if (dateFilterTop) dateFilterTop.value = 'all';
    if (premiumFilterTop) premiumFilterTop.checked = false;
    if (highPotentialTop) highPotentialTop.checked = false;
    
    // Call existing clear function
    clearSavedFilters();
    
    showSuccess('All filters cleared!');
}

// Update the results counter for top filters
function updateSavedCandidatesDisplayTop() {
    const filteredCandidates = savedCandidatesFilter.getFilteredCandidates();
    const stats = savedCandidatesFilter.getFilterStats();
    
    // Update top results counter
    const resultsElementTop = document.getElementById('saved-filter-results-top');
    if (resultsElementTop) {
        if (stats.filtered === stats.total) {
            resultsElementTop.innerHTML = `<i class="fas fa-check-circle text-green-500 mr-1"></i> Showing all ${stats.total} candidates`;
            resultsElementTop.className = 'text-center text-sm text-green-600 mt-4 p-2 bg-green-50 rounded-lg border border-green-200';
        } else {
            resultsElementTop.innerHTML = `<i class="fas fa-filter text-blue-500 mr-1"></i> Showing ${stats.filtered} of ${stats.total} candidates`;
            resultsElementTop.className = 'text-center text-sm text-blue-600 mt-4 p-2 bg-blue-50 rounded-lg border border-blue-200';
        }
    }
    
    // Update sidebar filtered count
    const sidebarCount = document.getElementById('filtered-count-sidebar');
    if (sidebarCount) {
        sidebarCount.textContent = `${stats.filtered} shown`;
    }
    
    // Call existing display update
    updateSavedCandidatesDisplay();
}

// New function: Select all candidates for comparison
function selectAllCandidatesForComparison() {
    const savedCandidates = savedCandidatesManager.getSavedCandidates();
    const maxSelection = 3; // Limit to 3 for comparison
    
    if (savedCandidates.length === 0) {
        showWarning('No candidates to select');
        return;
    }
    
    // Clear existing selections
    candidateComparison.clearSelections();
    
    // Select up to 3 candidates (highest scores first)
    const sortedCandidates = savedCandidates
        .sort((a, b) => (parseInt(b.candidate.candidateScore) || 0) - (parseInt(a.candidate.candidateScore) || 0))
        .slice(0, maxSelection);
    
    sortedCandidates.forEach(savedItem => {
        candidateComparison.toggleSelection(savedItem.id);
    });
    
    // Update checkboxes
    candidateComparison.updateCheckboxes();
    
    showSuccess(`Selected top ${sortedCandidates.length} candidates for comparison!`);
}

// New function: Export saved candidates
function exportSavedCandidates() {
    const savedCandidates = savedCandidatesManager.getSavedCandidates();
    
    if (savedCandidates.length === 0) {
        showWarning('No saved candidates to export');
        return;
    }
    
    // Use existing CSV export functionality but for saved candidates
    exportSavedCandidatesCSV(savedCandidates);
}

function goToHome() {
    // Hide all other pages/content
    hideAllPages();

    // Reset main-app width to normal
    const mainApp = document.getElementById('main-app');
    mainApp.classList.add('max-w-5xl');
    mainApp.style.maxWidth = '';
    mainApp.style.width = '';
    
    // Show main app with upload interface
    document.getElementById('main-app').style.display = 'block';
    document.getElementById('upload-interface').classList.remove('hidden');
    document.getElementById('analysis-results').classList.add('hidden');
    
    // Clear files and reset UI
    files = [];
    updateFileList();
    hideError();
    hideStatus();
}

// Event Listeners for History
document.addEventListener('DOMContentLoaded', function() {
    // Update counter on page load
    updateHistoryCounter();

    // Add these lines inside your existing DOMContentLoaded function
    document.getElementById('export-history-btn').addEventListener('click', exportHistoryToCSV);
    document.getElementById('clear-history-btn').addEventListener('click', clearAllHistory);
    
    // History button
    document.getElementById('history-btn').addEventListener('click', showHistoryModal);
    // Ensure history button works after any dynamic updates
    function setupHistoryButton() {
        const historyBtn = document.getElementById('history-btn');
        if (historyBtn) {
            // Remove existing listeners and add fresh one
            const newHistoryBtn = historyBtn.cloneNode(true);
            historyBtn.parentNode.replaceChild(newHistoryBtn, historyBtn);
            newHistoryBtn.addEventListener('click', showHistoryModal);
        }
    }

    // Clear comparison selection button
    document.getElementById('clear-comparison-selection-btn').addEventListener('click', () => {
        candidateComparison.clearSelections();
        showSuccess('Comparison selection cleared!');
    });
    
    // Call after main app is shown
    setTimeout(setupHistoryButton, 500);

    // History button in saved candidates page header
    const historyBtnSaved = document.getElementById('history-btn-saved');
    if (historyBtnSaved) {
        historyBtnSaved.addEventListener('click', showHistoryModal);
    }

    // Update saved counter on page load
    updateSavedCounter();

    // Saved candidates button
    document.getElementById('saved-candidates-btn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        showSavedCandidatesView();
    });

    // Add to your DOMContentLoaded
    document.getElementById('history-search')?.addEventListener('input', debounce((e) => {
        const query = e.target.value;
        const filteredHistory = query ? historyManager.searchHistory(query) : historyManager.getHistory();
        renderHistoryList(filteredHistory);
    }, 300));

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // Close modal
    document.getElementById('close-history-modal').addEventListener('click', () => {
    document.getElementById('history-modal').classList.add('hidden');
    });
    
    // Close modal when clicking outside
    document.getElementById('history-modal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
            document.getElementById('history-modal').classList.add('hidden');
        }
    });

    // Add these lines inside your existing DOMContentLoaded function
    document.getElementById('back-to-app-btn').addEventListener('click', hidePricingPage);

    document.getElementById('back-from-support').addEventListener('click', hideAllSupportPages);
    document.getElementById('back-from-faq').addEventListener('click', hideAllSupportPages);
    document.getElementById('back-from-terms').addEventListener('click', hideAllSupportPages);
    document.getElementById('back-from-privacy').addEventListener('click', hideAllSupportPages);

    // Back from saved candidates
    document.getElementById('back-from-saved').addEventListener('click', hideAllSupportPages);
    document.getElementById('back-to-analysis-from-empty').addEventListener('click', hideAllSupportPages);

    // Back from comparison
    document.getElementById('back-from-comparison').addEventListener('click', () => {
        hideAllPages();
        showSavedCandidatesView();
        
        // Update checkboxes and compare button after returning
        setTimeout(() => {
            candidateComparison.updateCheckboxes();
            candidateComparison.updateCompareButton();
        }, 100);
    });

    // REPLACE your existing upgrade button listener with this:
    document.getElementById('upgrade-professional-btn').addEventListener('click', async function() {
        const status = creditManager.getStatus();
        const userEmail = creditManager.currentUser.email;
    
        // Show loading state
        this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Memproses...';
        this.disabled = true;
    
        try {
            await paymentHandler.createPayment(599000, 30, userEmail);
        } catch (error) {
            console.error('Payment initiation failed:', error);
            showError('Payment initiation failed. Please try again.');
        } finally {
            // Reset button
            setTimeout(() => {
                this.innerHTML = '<i class="fas fa-rocket mr-2"></i>Beli 30 Credits - Rp 599.000';
                this.disabled = false;
            }, 2000);
        }
    });

    // ADD this right after the existing upgrade-professional-btn listener:
    document.getElementById('upgrade-ultra-btn').addEventListener('click', async function() {
        const status = creditManager.getStatus();
    
        if (status.tier === 'PROFESSIONAL' && status.remaining > 0) {
            // PRO user converting credits
            await convertCreditsToUltra();
        } else {
            // New ULTRA purchase
            const userEmail = creditManager.currentUser.email;
        
            this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Memproses...';
            this.disabled = true;
        
            try {
                await paymentHandler.createPayment(999000, 20, userEmail);
            } catch (error) {
                console.error('Payment initiation failed:', error);
                showError('Payment initiation failed. Please try again.');
            } finally {
                setTimeout(() => {
                    this.innerHTML = '<i class="fas fa-rocket mr-2"></i>Upgrade to Ultra - Rp 999.000';
                    this.disabled = false;
                }, 2000);
            }
        }
    });
});
        
document.addEventListener("DOMContentLoaded", async function() {
    // 1. Process magic link
    await supabase.auth.getSession();

    // 2. Check if user is already logged in
    supabase.auth.getSession().then(({ data: { session } }) => {
        if (session) {
            showMainApp();
        } else {
            showAuthBox();
        }
    });

    // 3. Listen for auth state changes
    supabase.auth.onAuthStateChange((event, session) => {
        if (session) {
            showMainApp();
        }
    });

    // 4. Wire up the button after DOM is ready
    document.getElementById("magic-btn").onclick = signIn;
    // Wire up Google Sign-In button
    document.getElementById("google-signin-btn").onclick = signInWithGoogle;
    
    document.getElementById('logout-btn').onclick = async function() {
        try {
            // Force clear memory on logout
            memoryManager.forceClear('logout');
            
            await supabase.auth.signOut();
            showAuthBox();
        } catch (error) {
            console.error("Error signing out:", error);
            showError("Failed to log out. Please try again.");
        }
    };

    // Logout button for saved page
    const logoutBtnSaved = document.getElementById('logout-btn-saved');
    if (logoutBtnSaved) {
        logoutBtnSaved.onclick = async function() {
            try {
                // Force clear memory on logout
                memoryManager.forceClear('logout');
                
                await supabase.auth.signOut();
                showAuthBox();
            } catch (error) {
                console.error("Error signing out:", error);
                showError("Failed to log out. Please try again.");
            }
        };
    }

    // Job Description Clear Button Functionality
    const jobDescriptionTextarea = document.getElementById('job-description');
    const clearJdBtn = document.getElementById('clear-jd-btn');

    if (jobDescriptionTextarea && clearJdBtn) {
        // Show/hide clear button based on content
        jobDescriptionTextarea.addEventListener('input', function() {
            const charCount = this.value.length;
            const charCountElement = document.getElementById('jd-char-count');
        
            if (charCount > 0) {
                clearJdBtn.classList.remove('hidden');
            
                // Show and update character counter
                if (charCountElement) {
                    charCountElement.classList.remove('hidden');
                    charCountElement.textContent = `${charCount.toLocaleString()} characters`;
                
                    // Optional: Color coding for very long descriptions
                    if (charCount > 2000) {
                        charCountElement.className = 'text-xs text-orange-500';
                    } else if (charCount > 1000) {
                        charCountElement.className = 'text-xs text-yellow-600';
                    } else {
                        charCountElement.className = 'text-xs text-gray-400';
                    }
                }
            } else {
                clearJdBtn.classList.add('hidden');
                if (charCountElement) {
                    charCountElement.classList.add('hidden');
                }
            }
        });

        // Clear button functionality
        clearJdBtn.addEventListener('click', function() {
            jobDescriptionTextarea.value = '';
            clearJdBtn.classList.add('hidden');
        
            // Hide character counter
            const charCountElement = document.getElementById('jd-char-count');
            if (charCountElement) {
                charCountElement.classList.add('hidden');
            }
        
            jobDescriptionTextarea.focus();
            showSuccess('Job description cleared!');
        });

        // Also check on page load in case there's existing content
        if (jobDescriptionTextarea.value.trim().length > 0) {
            clearJdBtn.classList.remove('hidden');
            // Trigger input event to show counter
            jobDescriptionTextarea.dispatchEvent(new Event('input'));
        }
    }

    // Initialize files array if undefined
    if (typeof files === 'undefined' || !files) {
        files = [];
        window.files = files;
    }

    // ---- File Handling and Analysis Logic ----
    fileInput = document.getElementById('file-input');
    dragArea = document.getElementById('drag-area');
    fileListContainer = document.getElementById('file-list-container');
    fileList = document.getElementById('file-list');
    fileCount = document.getElementById('file-count');
    startButton = document.getElementById('start-button');
    errorMessage = document.getElementById('error-message');
    errorText = document.getElementById('error-text');
    statusMessage = document.getElementById('status-message');
    statusText = document.getElementById('status-text');
    statusIcon = document.getElementById('status-icon');
    clearAllBtn = document.getElementById('clear-all');

    allowedTypes = ['application/pdf', 'image/jpeg', 'image/png'];
    typeNames = {
        'application/pdf': 'PDF',
        'image/jpeg': 'JPEG',
        'image/png': 'PNG'
    };
    
    typeIcons = {
        'application/pdf': 'fa-file-pdf',
        'image/jpeg': 'fa-file-image',
        'image/png': 'fa-file-image'
    };

    dragArea.addEventListener('click', function(e) {
        fileInput.value = '';
        fileInput.click();
    });

    dragArea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
            fileInput.value = '';
            fileInput.click();
            e.preventDefault();
        }
    });

    fileInput.addEventListener('change', handleFileSelect);

    dragArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dragArea.classList.add('active');
    });

    dragArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dragArea.classList.remove('active');
    });

    dragArea.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dragArea.classList.remove('active');
        if (e.dataTransfer.files.length) {
            handleFiles(e.dataTransfer.files);
        }
    });

    startButton.addEventListener('click', startAnalysis);
    
    clearAllBtn.addEventListener('click', function() {
        files = [];
        updateFileList();
    });

    // Set up the "Analyze Another Resume" button handler
    document.getElementById('new-analysis-btn').addEventListener('click', function() {
    // Schedule memory clear when leaving results
    memoryManager.scheduleDelayedClear('new_analysis');
        
    // Hide results, show upload interface
    document.getElementById('analysis-results').classList.add('hidden');
    document.getElementById('upload-interface').classList.remove('hidden');
    
    // Reset files array and update the UI
    files = [];
    updateFileList();
    
    // Re-enable the start button (though updateFileList should handle this)
    startButton.disabled = false;
    
    // Clear any error or status messages
    hideError();
    hideStatus();
});
});
    </script>

<!-- History Modal -->
<div id="history-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 flex-shrink-0">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold">Recent Analyses</h2>
                        <p class="text-blue-100 text-sm mt-1">Your analysis history and insights</p>
                    </div>
                    <button id="close-history-modal" class="text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <!-- History Stats -->
                <div class="mt-4 flex gap-6 text-sm">
                    <div class="bg-white/20 rounded-lg px-3 py-2">
                        <div class="font-semibold" id="total-analyses">0</div>
                        <div class="text-blue-100">Total Analyses</div>
                    </div>
                    <div class="bg-white/20 rounded-lg px-3 py-2">
                        <div class="font-semibold" id="total-candidates-analyzed">0</div>
                        <div class="text-blue-100">Candidates</div>
                    </div>
                    <div class="bg-white/20 rounded-lg px-3 py-2">
                        <div class="font-semibold" id="last-analysis-date">Never</div>
                        <div class="text-blue-100">Last Analysis</div>
                    </div>
                </div>

                <!-- Add after the stats section -->
                <div class="mt-4">
                    <input type="text" id="history-search" placeholder="Search analyses..." 
                           class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/70">
                </div>
            </div>
            
            <!-- Modal Content -->
            <div class="p-6 max-h-64 overflow-y-auto">
                <div id="history-list">
                    <!-- History items will be inserted here -->
                </div>
                
                <!-- Empty State -->
                <div id="history-empty" class="text-center py-12 hidden">
                    <i class="fas fa-history text-gray-300 text-4xl mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-600 mb-2">No Analyses Yet</h3>
                    <p class="text-gray-500 text-sm">Your analysis history will appear here after you analyze candidates.</p>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="bg-gray-50 px-6 py-4 flex justify-between items-center border-t flex-shrink-0">
                <div class="text-sm text-gray-500">
                    History is stored locally in your browser
                </div>
                <div class="flex gap-3">
                    <button id="export-history-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                        <i class="fas fa-download mr-2"></i>Export History
                    </button>
                    <button id="clear-history-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">
                        <i class="fas fa-trash mr-2"></i>Clear All
                    </button>
                </div>
            </div>
            
        </div>
    </div>
</div>


<!-- Batch Confirmation Modal -->
<div id="batch-confirm-modal" class="batch-confirm-overlay hidden">
    <div class="batch-confirm-modal">
        <div class="text-center mb-6">
            <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-layer-group text-white text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Large Batch Processing</h3>
            <p id="batch-confirm-message" class="text-gray-600"></p>
        </div>
        
        <div class="bg-blue-50 rounded-lg p-4 mb-6">
            <div class="flex items-start">
                <i class="fas fa-info-circle text-blue-500 mr-3 mt-0.5"></i>
                <div class="text-sm text-blue-800">
                    <p class="font-medium mb-1">What happens next:</p>
                    <ul class="text-blue-700 space-y-1">
                        <li>‚Ä¢ Files processed in secure batches of 5</li>
                        <li>‚Ä¢ Results appear progressively</li>
                        <li>‚Ä¢ Keep this tab open during processing</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="flex gap-3">
            <button id="batch-confirm-cancel" class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                <i class="fas fa-times mr-2"></i>Cancel
            </button>
            <button id="batch-confirm-proceed" class="flex-1 px-4 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:from-blue-700 hover:to-purple-700 transition-colors font-medium">
                <i class="fas fa-rocket mr-2"></i>Start Processing
            </button>
        </div>
    </div>
</div>

<!-- Footer with Support Links -->
<footer id="app-footer" class="bg-gradient-to-br from-gray-50 to-blue-50 border-t border-gray-200 py-12 mt-16" style="position: relative; z-index: 10;">
    <div class="max-w-6xl mx-auto px-6">
        
        <!-- Main Footer Content -->
        <div class="grid lg:grid-cols-5 md:grid-cols-3 gap-8 mb-8">
            
            <!-- Company Info (Enhanced) - BALANCED -->
            <div class="lg:col-span-2">
                <img src="MontPro_logo_with_words-removebg-preview.png" alt="MontPro" class="h-10 mb-4">
                <p class="text-sm text-gray-600 mb-4 leading-relaxed">
                    The AI-powered recruitment engine that turns overwhelming resume stacks 
                    into clear hiring decisions.
                </p>
                
                <!-- Founder Message -->
                <div class="bg-white rounded-lg p-4 border border-gray-200 mb-4">
                    <div class="flex items-start">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                            <i class="fas fa-user text-white text-sm"></i>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600 italic">
                                "I personally handle every support request to ensure you get the best experience."
                            </p>
                            <p class="text-xs text-gray-500 mt-1 font-medium">‚Äî Ardhi, Founder & CEO</p>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Contact -->
                <div class="flex gap-3">
                    <a href="mailto:support@aapgrp.com" 
                       class="inline-flex items-center px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors text-xs">
                        <i class="fas fa-envelope mr-2"></i>Quick Support
                    </a>
                    <a href="https://calendly.com/ardhipradhana/montpro_discovery" 
                       target="_blank"
                       class="inline-flex items-center px-3 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-colors text-xs">
                        <i class="fas fa-calendar mr-2"></i>Book a Call
                    </a>
                </div>
            </div>
            
            <!-- Get Started (ALIGNED) -->
            <div>
                <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
                    <div class="w-5 h-5 flex items-center justify-center mr-2">
                        <i class="fas fa-play-circle text-blue-500"></i>
                    </div>
                    Get Started
                </h3>
                <ul class="space-y-3 text-sm text-gray-600">
                    <li>
                        <a href="#" onclick="hideAllSupportPages(); document.getElementById('sample-resume-btn').click();" 
                           class="hover:text-blue-600 transition-colors flex items-center">
                            <div class="w-4 h-4 flex items-center justify-center mr-2">
                                <i class="fas fa-rocket text-blue-500"></i>
                            </div>
                            Try Demo Resume
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="showPricingPage()" 
                           class="hover:text-blue-600 transition-colors flex items-center">
                            <div class="w-4 h-4 flex items-center justify-center mr-2">
                                <i class="fas fa-tag text-green-500"></i>
                            </div>
                            Pricing
                        </a>
                    </li>
                    <li>
                        <a href="https://calendly.com/ardhipradhana/montpro_discovery" target="_blank" 
                           class="hover:text-blue-600 transition-colors flex items-center">
                            <div class="w-4 h-4 flex items-center justify-center mr-2">
                                <i class="fas fa-video text-purple-500"></i>
                            </div>
                            Schedule Demo
                        </a>
                    </li>
                </ul>
            </div>
            
            <!-- Support (ALIGNED) -->
            <div>
                <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
                    <div class="w-5 h-5 flex items-center justify-center mr-2">
                        <i class="fas fa-life-ring text-emerald-500"></i>
                    </div>
                    Need Help?
                </h3>
                <ul class="space-y-3 text-sm text-gray-600">
                    <li>
                        <a href="#" onclick="showSupportPage()" 
                           class="hover:text-blue-600 transition-colors flex items-center">
                            <div class="w-4 h-4 flex items-center justify-center mr-2">
                                <i class="fas fa-headset text-blue-500"></i>
                            </div>
                            Get Support
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="showFAQPage()" 
                           class="hover:text-blue-600 transition-colors flex items-center">
                            <div class="w-4 h-4 flex items-center justify-center mr-2">
                                <i class="fas fa-book text-green-500"></i>
                            </div>
                            FAQ & Guides
                        </a>
                    </li>
                    <li>
                        <a href="mailto:support@aapgrp.com?subject=Feature%20Request" 
                           class="hover:text-blue-600 transition-colors flex items-center">
                            <div class="w-4 h-4 flex items-center justify-center mr-2">
                                <i class="fas fa-lightbulb text-yellow-500"></i>
                            </div>
                            Feature Request
                        </a>
                    </li>
                </ul>
            </div>
            
            <!-- Legal (ALIGNED) -->
            <div>
                <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
                    <div class="w-5 h-5 flex items-center justify-center mr-2">
                        <i class="fas fa-shield-alt text-indigo-500"></i>
                    </div>
                    Trust & Security
                </h3>
                <ul class="space-y-3 text-sm text-gray-600">
                    <li>
                        <a href="#" onclick="showPrivacyPage()" 
                           class="hover:text-blue-600 transition-colors flex items-center">
                            <div class="w-4 h-4 flex items-center justify-center mr-2">
                                <i class="fas fa-user-shield text-blue-500"></i>
                            </div>
                            Privacy Policy
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="showTermsPage()" 
                           class="hover:text-blue-600 transition-colors flex items-center">
                            <div class="w-4 h-4 flex items-center justify-center mr-2">
                                <i class="fas fa-file-contract text-purple-500"></i>
                            </div>
                            Terms & Conditions
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- Bottom Section -->
        <div class="border-t border-gray-200 pt-6">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                
                <!-- Copyright -->
                <div class="text-center md:text-left">
                    <p class="text-sm text-gray-500">
                        &copy; 2025 MontPro. All rights reserved.
                    </p>
                </div>
                
                <!-- Status & Updates -->
                <div class="flex items-center gap-6">
                    <!-- System Status -->
                    <div class="flex items-center">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></div>
                        <span class="text-xs text-gray-500">All systems operational</span>
                    </div>
                    
                    <!-- Version -->
                    <div class="text-xs text-gray-400">
                        v2.1.0
                    </div>
                    
                    <!-- Quick Links -->
                    <div class="flex gap-3">
                        <a href="mailto:support@aapgrp.com" 
                           class="text-gray-400 hover:text-blue-500 transition-colors" 
                           title="Email Support">
                            <i class="fas fa-envelope text-sm"></i>
                        </a>
                        <a href="https://calendly.com/ardhipradhana/montpro_discovery" 
                           target="_blank"
                           class="text-gray-400 hover:text-purple-500 transition-colors" 
                           title="Schedule Call">
                            <i class="fas fa-calendar text-sm"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</footer>
</body>
</html>
