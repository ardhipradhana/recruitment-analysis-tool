<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MontPro - Recruitment Analysis Tool</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <!-- Add this after your other script tags -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .drag-area {
            border: 2px dashed #cbd5e1;
            border-radius: 0.75rem;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .drag-area.active {
            border-color: #3b82f6;
            background-color: #f0f9ff;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
        }
        
        .file-item:hover {
            background-color: #f8fafc;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .spinner {
            border: 3px solid rgba(59, 130, 246, 0.1);
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .btn-primary:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
        }
        
        .auth-form {
            background: linear-gradient(145deg, #ffffff, #f9fafb);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .score-circle {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: conic-gradient(#3b82f6 0%, #3b82f6 var(--score-percent), #e2e8f0 var(--score-percent), #e2e8f0 100%);
        position: relative;
    }
    
    .score-circle::before {
        content: '';
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background-color: white;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    
    .score-value {
        position: relative;
        z-index: 1;
        font-weight: bold;
        font-size: 28px;
        color: #1e40af;
        order: 2;
    }
    
    .score-label {
        position: relative;
        z-index: 1;
        font-size: 14px;
        color: #64748b;
        order: 1;
        margin-bottom: 2px;
    }
    
    /* Typing effect for loading animation */
    .typingEffect::after {
        content: '...';
        animation: dots 1.5s infinite;
        display: inline-block;
        width: 24px;
    }
    
    @keyframes dots {
        0%, 20% { content: '.'; }
        40% { content: '..'; }
        60%, 100% { content: '...'; }
    }
    
    /* Loading shimmer effect */
    @keyframes shimmer {
        0% { background-position: -1000px 0; }
        100% { background-position: 1000px 0; }
    }
    
    .loading-shimmer {
        background: linear-gradient(90deg, #f3f4f6 0%, #e5e7eb 50%, #f3f4f6 100%);
        background-size: 1000px 100%;
        animation: shimmer 2s infinite linear;
    }
        
/* Background Animation Styles */
.animated-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    overflow: hidden;
    z-index: 0;
}

.floating-card {
    position: absolute;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    animation: float 8s ease-in-out infinite;
}

.resume-card {
    width: 280px;
    padding: 20px;
    animation-delay: var(--delay);
}

.stats-card {
    width: 200px;
    padding: 16px;
    animation-delay: var(--delay);
}

.skill-floating {
    display: inline-block;
    background: linear-gradient(45deg, #3b82f6, #8b5cf6);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    margin: 2px;
    animation: skillPulse 3s ease-in-out infinite;
    animation-delay: var(--skill-delay);
}

.score-ring {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: conic-gradient(#10b981 0%, #10b981 var(--score), #e5e7eb var(--score), #e5e7eb 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.score-ring::before {
    content: '';
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: white;
    position: absolute;
}

.score-text {
    position: relative;
    z-index: 1;
    font-weight: bold;
    font-size: 14px;
    color: #059669;
}

@keyframes float {
    0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.7; }
    25% { transform: translateY(-20px) rotate(1deg); opacity: 1; }
    50% { transform: translateY(-10px) rotate(-1deg); opacity: 0.8; }
    75% { transform: translateY(-15px) rotate(0.5deg); opacity: 1; }
}

@keyframes skillPulse {
    0%, 100% { transform: scale(1); opacity: 0.8; }
    50% { transform: scale(1.05); opacity: 1; }
}

@keyframes slideIn {
    0% { transform: translateX(-100%); opacity: 0; }
    100% { transform: translateX(0); opacity: 1; }
}

@keyframes fadeInUp {
    0% { transform: translateY(20px); opacity: 0; }
    100% { transform: translateY(0); opacity: 1; }
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
    20%, 40%, 60%, 80% { transform: translateX(10px); }
}
        
.animate-slide-in {
    animation: slideIn 0.8s ease-out forwards;
    animation-delay: var(--anim-delay);
}

.animate-fade-up {
    animation: fadeInUp 0.6s ease-out forwards;
    animation-delay: var(--anim-delay);
}

/* Auth form styles */
.auth-container {
    position: relative;
    z-index: 10;
}
/* Multiple Candidates Layout */
.candidates-overview {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 24px;
    align-items: start;
    margin-left: 24px;
    margin-right: 24px;
}

.candidates-sidebar {
    position: sticky;
    top: 20px;
}

.candidate-summary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    text-align: center;
}

.sort-btn {
    transition: all 0.2s ease;
    font-weight: 500;
}

.sort-btn.active {
    background: rgba(255, 255, 255, 0.4) !important;
    font-weight: 600;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.sort-btn:hover {
    transform: translateY(-1px);
}

.candidate-grid {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 60vh;
    overflow-y: auto;
    padding-right: 8px;
}

/* Scrollbar styling for the candidate list */
.candidate-grid::-webkit-scrollbar {
    width: 6px;
}

.candidate-grid::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
}

.candidate-grid::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

.candidate-grid::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

.candidate-mini-card {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.candidate-mini-card:hover {
    border-color: #3b82f6;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    transform: translateY(-2px);
}

.candidate-mini-card.active {
    border-color: #3b82f6;
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
}

.candidate-mini-card.active::before {
    content: '';
    position: absolute;
    left: 0;
    top: 4px;
    bottom: 4px;
    width: 4px;
    background: #3b82f6;
    border-radius: 0 4px 4px 0;
}

.mini-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
}

.mini-card-info h4 {
    font-weight: 600;
    font-size: 14px;
    color: #1f2937;
    margin: 0 0 2px 0;
}

.mini-card-info p {
    font-size: 12px;
    color: #6b7280;
    margin: 0;
}

.mini-score-ring {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: conic-gradient(#10b981 0%, #10b981 var(--score), #e5e7eb var(--score), #e5e7eb 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    flex-shrink: 0;
}

.mini-score-ring::before {
    content: '';
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: white;
    position: absolute;
}

.mini-score-text {
    position: relative;
    z-index: 1;
    font-weight: bold;
    font-size: 11px;
    color: #059669;
}

.mini-skills {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
}

.mini-skill-tag {
    background: linear-gradient(45deg, #3b82f6, #8b5cf6);
    color: white;
    padding: 3px 10px;
    border-radius: 15px;
    font-size: 10px;
    font-weight: 500;
    display: inline-block;
    margin: 1px;
    box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
}

.candidate-detail-view {
    flex: 1;
}

/* Progress bar styles */
.progress-bar {
    width: 100%;
    height: 8px;
    background-color: #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
}

.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #3b82f6, #8b5cf6);
    border-radius: 4px;
    transition: width 0.3s ease;
}

/* Single candidate view margins */
#single-candidate-view {
    margin-left: 24px;
    margin-right: 24px;
}
.connection-status {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        font-weight: 500;
    }

    .connection-status.online {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }

    .connection-status.offline {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
    }
        
/* Responsive design */
@media (max-width: 1024px) {
    .candidates-overview {
        grid-template-columns: 1fr;
        gap: 16px;
        margin-left: 20px;
        margin-right: 20px;
    }
    
    .candidates-sidebar {
        position: static;
        order: 2;
    }
    
    .candidate-detail-view {
        order: 1;
    }
    
    .candidate-grid {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 50vh;
    overflow-y: auto;
    }
    
    /* Responsive margins for single candidate view */
    #single-candidate-view {
        margin-left: 20px;
        margin-right: 20px;
    }
    /* Enhanced Error Handling Styles */
    .montpro-notification {
        position: fixed;
        top: 70px;
        right: 20px;
        z-index: 9999;
        max-width: 400px;
        transform: translateX(calc(100% + 20px));
        transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        border-radius: 12px;
    }

    .montpro-notification.show { transform: translateX(0); }
    .montpro-notification.success { background: linear-gradient(135deg, #10b981, #059669); }
    .montpro-notification.error { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .montpro-notification.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .montpro-notification.info { 
    background: linear-gradient(135deg, #3b82f6, #2563eb); 
    }

    .field-error-shake {
        animation: shake 0.5s ease-in-out;
        border: 2px solid #ef4444 !important;
        background: #fef2f2 !important;
    }
}
/* Enhanced Progress Styles */
.enhanced-loading {
    position: relative;
    overflow: hidden;
}

.enhanced-spinner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1;
}

.enhanced-progress-bar {
    background: linear-gradient(90deg, #e5e7eb 0%, #f3f4f6 50%, #e5e7eb 100%);
    background-size: 200% 100%;
    animation: shimmer 2s infinite linear;
}

.enhanced-progress-bar-fill {
    background: linear-gradient(90deg, #3b82f6, #8b5cf6);
    box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
    transition: all 0.3s ease;
}

.progress-modal-overlay {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Button loading states */
.btn-loading {
    position: relative;
    color: transparent !important;
}

.btn-loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top: 2px solid white;
    animation: spin 1s linear infinite;
}
</style>
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-purple-50 min-h-screen">
    <!-- Animated Background -->
    <div class="animated-background">
        <!-- Resume Card 1 -->
        <div class="floating-card resume-card" style="--delay: 0s; top: 10%; left: 5%;">
            <div class="flex items-start justify-between mb-3">
                <div>
                    <h3 class="font-semibold text-gray-800 text-sm">Sarah Johnson</h3>
                    <p class="text-xs text-gray-500">Software Engineer</p>
                </div>
                <div class="score-ring" style="--score: 85%;">
                    <span class="score-text">85</span>
                </div>
            </div>
            <div class="mb-2">
                <span class="skill-floating" style="--skill-delay: 0.5s;">React</span>
                <span class="skill-floating" style="--skill-delay: 1s;">Python</span>
                <span class="skill-floating" style="--skill-delay: 1.5s;">AWS</span>
            </div>
            <div class="text-xs text-gray-600">
                <div class="flex items-center mb-1">
                    <i class="fas fa-briefcase text-blue-500 mr-2"></i>
                    <span>5+ years experience</span>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-graduation-cap text-green-500 mr-2"></i>
                    <span>CS Degree</span>
                </div>
            </div>
        </div>

        <!-- Resume Card 2 -->
        <div class="floating-card resume-card" style="--delay: 2s; top: 60%; right: 8%;">
            <div class="flex items-start justify-between mb-3">
                <div>
                    <h3 class="font-semibold text-gray-800 text-sm">Michael Chen</h3>
                    <p class="text-xs text-gray-500">Product Manager</p>
                </div>
                <div class="score-ring" style="--score: 92%;">
                    <span class="score-text">92</span>
                </div>
            </div>
            <div class="mb-2">
                <span class="skill-floating" style="--skill-delay: 0.3s;">Strategy</span>
                <span class="skill-floating" style="--skill-delay: 0.8s;">Analytics</span>
                <span class="skill-floating" style="--skill-delay: 1.3s;">Leadership</span>
            </div>
            <div class="text-xs text-gray-600">
                <div class="flex items-center mb-1">
                    <i class="fas fa-briefcase text-blue-500 mr-2"></i>
                    <span>8+ years experience</span>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-star text-yellow-500 mr-2"></i>
                    <span>Top 10% match</span>
                </div>
            </div>
        </div>

        <!-- Stats Card 1 -->
        <div class="floating-card stats-card" style="--delay: 1s; top: 20%; right: 15%;">
            <div class="text-center">
                <div class="text-2xl font-bold text-blue-600 mb-1">247</div>
                <div class="text-xs text-gray-600 mb-2">Resumes Analyzed</div>
                <div class="w-full bg-gray-200 h-2 rounded-full">
                    <div class="bg-blue-500 h-2 rounded-full" style="width: 73%; animation: slideIn 2s ease-out;"></div>
                </div>
            </div>
        </div>

        <!-- Stats Card 2 -->
        <div class="floating-card stats-card" style="--delay: 3s; bottom: 30%; left: 10%;">
            <div class="text-center">
                <div class="text-2xl font-bold text-green-600 mb-1">94%</div>
                <div class="text-xs text-gray-600 mb-2">Accuracy Rate</div>
                <div class="flex justify-center">
                    <i class="fas fa-check-circle text-green-500 mr-1"></i>
                    <span class="text-xs text-gray-600">AI Verified</span>
                </div>
            </div>
        </div>

        <!-- Resume Card 3 -->
        <div class="floating-card resume-card" style="--delay: 4s; bottom: 5%; left: 15%;">
            <div class="flex items-start justify-between mb-3">
                <div>
                    <h3 class="font-semibold text-gray-800 text-sm">Emma Rodriguez</h3>
                    <p class="text-xs text-gray-500">UX Designer</p>
                </div>
                <div class="score-ring" style="--score: 78%;">
                    <span class="score-text">78</span>
                </div>
            </div>
            <div class="mb-2">
                <span class="skill-floating" style="--skill-delay: 0.7s;">Figma</span>
                <span class="skill-floating" style="--skill-delay: 1.2s;">UI/UX</span>
                <span class="skill-floating" style="--skill-delay: 1.7s;">Research</span>
            </div>
            <div class="text-xs text-gray-600">
                <div class="flex items-center mb-1">
                    <i class="fas fa-palette text-purple-500 mr-2"></i>
                    <span>Design Portfolio</span>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-users text-blue-500 mr-2"></i>
                    <span>Team Lead</span>
                </div>
            </div>
        </div>

        <!-- Filter Dropdown Animation -->
        <div class="floating-card" style="--delay: 1.5s; top: 40%; left: 3%; width: 180px; padding: 12px;">
            <div class="text-xs font-medium text-gray-700 mb-2">Quick Filters</div>
            <div class="space-y-1">
                <div class="flex items-center animate-fade-up" style="--anim-delay: 0.2s;">
                    <input type="checkbox" class="mr-2" checked>
                    <span class="text-xs text-gray-600">5+ Years Exp</span>
                </div>
                <div class="flex items-center animate-fade-up" style="--anim-delay: 0.4s;">
                    <input type="checkbox" class="mr-2">
                    <span class="text-xs text-gray-600">Remote OK</span>
                </div>
                <div class="flex items-center animate-fade-up" style="--anim-delay: 0.6s;">
                    <input type="checkbox" class="mr-2" checked>
                    <span class="text-xs text-gray-600">Tech Skills</span>
                </div>
            </div>
        </div>

        <!-- Search Results Preview -->
        <div class="floating-card" style="--delay: 2.5s; top: 35%; left: 70%; width: 200px; padding: 16px;">
            <div class="flex items-center mb-2">
                <i class="fas fa-search text-blue-500 mr-2"></i>
                <span class="text-xs font-medium text-gray-700">Search Results</span>
            </div>
            <div class="space-y-2">
                <div class="animate-slide-in" style="--anim-delay: 0.5s;">
                    <div class="text-xs text-gray-800 font-medium">Frontend Developer</div>
                    <div class="text-xs text-green-600">12 matches found</div>
                </div>
                <div class="animate-slide-in" style="--anim-delay: 1s;">
                    <div class="text-xs text-gray-800 font-medium">Product Manager</div>
                    <div class="text-xs text-blue-600">8 matches found</div>
                </div>
            </div>
        </div>
    </div>
    <!-- Authentication Box -->
    <div class="auth-container">
    <div id="auth-box" class="max-w-md mx-auto my-16 p-8 rounded-xl auth-form relative z-10">
        <div class="flex justify-center mb-6">
            <img src="MontPro_logo_with_words-removebg-preview.png" alt="MontPro Logo" class="h-16 w-auto" />
        </div>
        <h2 class="text-2xl font-bold mb-2 text-center text-gray-800">Sign in to MontPro</h2>
        <p class="text-center text-gray-600 mb-6 text-sm">Unlock AI-powered recruitment insights</p>
        <div class="space-y-4">
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email address</label>
                <input id="email" type="email" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="name@company.com" required />
            </div>
            <button id="magic-btn" class="w-full py-3 px-4 btn-primary font-medium rounded-lg flex items-center justify-center">
                <i class="fas fa-magic mr-2"></i>
                <span>Send Magic Link</span>
            </button>
            <div id="auth-msg" class="text-center text-sm font-medium"></div>
        </div>
        
        <!-- Feature Preview -->
        <div class="mt-6 pt-6 border-t border-gray-200">
            <div class="text-center text-xs text-gray-500 mb-3">What you'll get inside:</div>
            <div class="grid grid-cols-2 gap-3 text-xs">
                <div class="flex items-center">
                    <div class="w-4 flex justify-center mr-2">
                        <i class="fas fa-robot text-blue-500"></i>
                    </div>
                    <span class="text-gray-600">AI Analysis</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 flex justify-center mr-2">
                        <i class="fas fa-chart-line text-green-500"></i>
                    </div>
                    <span class="text-gray-600">Match Scoring</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 flex justify-center mr-2">
                        <i class="fas fa-tags text-purple-500"></i>
                    </div>
                    <span class="text-gray-600">Skill Extraction</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 flex justify-center mr-2">
                        <i class="fas fa-users text-orange-500"></i>
                    </div>
                    <span class="text-gray-600">Batch Processing</span>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Main App (hidden until authenticated) -->
    <div id="main-app" class="max-w-5xl mx-auto p-6" style="display: none;">
        <!-- Header with Logo and Logout button -->
        <header class="flex justify-between items-center mb-8 pb-4 border-b border-gray-200">
            <div class="flex items-center space-x-4">
                <img src="MontPro_logo_with_words-removebg-preview.png" alt="MontPro Logo" class="h-12 w-auto" />
                <h1 class="text-2xl font-bold text-gray-800">Recruitment Analysis Tool</h1>
            </div>
            <button id="logout-btn" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white rounded-lg border border-gray-300 hover:bg-gray-50 hover:text-gray-900 transition-colors shadow-sm">
                <span>Log Out</span>
                <i class="fas fa-sign-out-alt ml-2"></i>
            </button>
        </header>

        <div id="upload-interface" class="bg-white rounded-xl shadow-sm p-8 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-2">Upload Candidate Documents</h2>
            <p class="text-gray-600 mb-6">Upload resumes and CVs for automated analysis and candidate evaluation</p>

            <!-- Hidden File Input -->
            <input type="file" id="file-input" multiple accept=".pdf,.jpg,.jpeg,.png" class="hidden">

            <!-- File Upload Area -->
            <div id="drag-area" class="drag-area bg-gray-50 hover:bg-gray-100 mb-6" tabindex="0">
                <i class="fas fa-cloud-upload-alt text-blue-500 text-4xl mb-4"></i>
                <h3 class="text-lg font-medium mb-1">Drag & drop files or click to browse</h3>
                <p class="text-sm text-gray-500">Supported formats: PDF</p>
            </div>
            
            <!-- File List -->
            <div id="file-list-container" class="mb-6 hidden">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-medium">Uploaded Documents (<span id="file-count">0</span>)</h3>
                    <button id="clear-all" class="text-sm text-gray-600 hover:text-red-600">
                        <i class="fas fa-trash-alt mr-1"></i> Clear all
                    </button>
                </div>
                <div id="file-list" class="space-y-2 max-h-64 overflow-y-auto pr-2"></div>
            </div>
            
            <!-- Error Message -->
            <div id="error-message" class="p-4 mb-4 bg-red-50 border-l-4 border-red-500 rounded-lg flex items-start hidden">
                <i class="fas fa-exclamation-circle text-red-500 mr-3 mt-0.5"></i>
                <div class="flex-1">
                    <p id="error-text" class="text-red-700 text-sm mb-3"></p>
                    <button id="retry-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg flex items-center hover:bg-red-700 transition-colors text-sm hidden">
                        <i class="fas fa-redo mr-2"></i>
                        Retry Analysis
                    </button>
                </div>
            </div>
            
            <!-- Status Message -->
            <div id="status-message" class="p-4 mb-4 bg-blue-50 border-l-4 border-blue-500 rounded-lg flex items-start hidden">
                <div id="status-icon" class="mr-3 mt-0.5">
                    <div class="spinner"></div>
                </div>
                <p id="status-text" class="text-blue-700 text-sm"></p>
            </div>
            
            <!-- Start Analysis Button -->
            <button id="start-button" class="w-full py-3.5 px-4 btn-primary font-medium rounded-lg flex items-center justify-center disabled:opacity-70 disabled:cursor-not-allowed transition-all" disabled>
                <i class="fas fa-chart-line mr-2"></i>
                <span>Start Analysis</span>
            </button>

            <div class="text-center text-sm text-gray-500 mt-8">
                <p>This tool will analyze your candidate documents and extract relevant information for recruitment purposes.</p>
                <p class="mt-1">© 2025 MontPro. All rights reserved.</p>
            </div>
        </div>
    </div>

    <!-- 1. Add the loading UI section right after your upload-interface section -->
<div id="analysis-loading" class="hidden">
    <div class="bg-white rounded-xl shadow-sm p-8 mb-8 text-center">
        <div class="mb-6">
            <div class="w-24 h-24 mx-auto mb-6 flex items-center justify-center relative">
                <!-- Outer ring animation -->
                <div class="absolute inset-0 border-4 border-blue-100 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-transparent border-t-blue-500 rounded-full animate-spin"></div>
                
                <!-- Inner icon -->
                <i class="fas fa-robot text-blue-500 text-3xl"></i>
            </div>
            <h2 class="text-xl font-semibold text-gray-800 mb-2">AI Analyzing Resume</h2>
            <p class="text-gray-600 typingEffect">Processing candidate information</p>
        </div>
        
        <div class="max-w-md mx-auto mb-8">
            <div class="flex justify-between text-sm text-gray-600 mb-1">
                <span id="loading-step">Extracting qualifications</span>
                <span id="loading-percent">25%</span>
            </div>
            <div class="progress-bar">
                <div id="progress-bar-fill" class="progress-bar-fill" style="width: 25%"></div>
            </div>
        </div>
        
        <div class="text-center text-sm text-gray-500 space-y-3">
            <div class="flex items-center justify-center">
                <div class="w-4 h-4 bg-green-500 rounded-full mr-2 flex items-center justify-center">
                    <i class="fas fa-check text-white text-xs"></i>
                </div>
                <span>Document uploaded successfully</span>
            </div>
            <div class="flex items-center justify-center">
                <div class="w-4 h-4 bg-green-500 rounded-full mr-2 flex items-center justify-center">
                    <i class="fas fa-check text-white text-xs"></i>
                </div>
                <span>Text extraction complete</span>
            </div>
            <div class="flex items-center justify-center">
                <div class="w-4 h-4 bg-blue-500 rounded-full mr-2 flex items-center justify-center animate-pulse">
                    <div class="w-2 h-2 bg-white rounded-full"></div>
                </div>
                <span>Skills and experience analysis in progress</span>
            </div>
            <div class="flex items-center justify-center opacity-50">
                <div class="w-4 h-4 border border-gray-300 rounded-full mr-2"></div>
                <span>Generating outputs</span>
            </div>
        </div>
    </div>
</div>

<!-- Replace your existing analysis-results div with this -->
<div id="analysis-results" class="hidden">
    <!-- Single Candidate View (existing) -->
    <div id="single-candidate-view">
        <!-- Your existing single candidate HTML stays exactly the same -->
        <!-- Candidate Overview -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-center md:items-start gap-6">
                <div>
                    <div class="flex items-center mb-2">
                        <h2 id="candidate-name" class="text-2xl font-bold text-gray-800">Candidate Name</h2>
                        <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded">Free Trial</span>
                    </div>
                    
                    <div class="flex flex-wrap gap-2 mt-2">
                        <span class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded-md">Resume Analysis</span>
                        <span class="text-xs bg-green-50 text-green-700 px-2 py-1 rounded-md">AI-Powered</span>
                        <span id="analysis-date" class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded-md">May 21, 2025</span>
                    </div>
                </div>
                
                <div class="text-center">
                    <div class="score-circle" style="--score-percent: 75%">
                        <div class="score-label">Score</div>
                        <div class="score-value" id="candidate-score">75</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Executive Summary -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex items-center mb-4">
                <i class="fas fa-file-alt text-blue-500 mr-3"></i>
                <h3 class="text-lg font-semibold">Executive Summary</h3>
            </div>
            <div id="executive-summary" class="text-gray-700">
                <!-- Executive summary will be inserted here -->
            </div>
        </div>
        
        <!-- Core Competencies Preview -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <i class="fas fa-brain text-blue-500 mr-3"></i>
                    <h3 class="text-lg font-semibold">Core Competencies</h3>
                </div>
                <span class="text-sm text-gray-500">Top Skills Preview</span>
            </div>
            <div id="core-competencies" class="flex flex-wrap gap-1.5">
                <!-- Top skills will be inserted here -->
            </div>
        </div>
        
        <!-- Upgrade CTA -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl p-6 text-white mb-6">
            <div class="md:flex justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <h3 class="font-bold text-xl mb-2">Take Your Recruitment Process to the Next Level</h3>
                    <p class="opacity-90 mb-2">Unlock advanced customization options and powerful features:</p>
                    <ul class="list-disc pl-5 text-sm opacity-90 space-y-1">
                        <li>Custom metrics tracking tailored to your hiring needs</li>
                        <li>Batch upload via Google Drive for efficient processing</li>
                        <li>Flexible output formats (Google Docs, Slides, Sheets, PDF)</li>
                        <li>Personalized report templates to match your brand</li>
                        <li>Match candidates against your specific job requirements</li>
                    </ul>
                </div>
                <div class="mt-4 md:mt-0 flex-shrink-0 text-center">
                    <p class="text-sm italic text-white opacity-80 mb-2">You've tried it, now make it yours.</p>
                    <a href="https://calendly.com/ardhipradhana/montpro_discovery" class="inline-block px-6 py-3 bg-white text-purple-700 font-medium rounded-lg hover:bg-gray-100 transition-colors shadow-md">
                        <i class="fas fa-magic mr-2"></i>
                        Get My Tailored Version
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Multiple Candidates View (new) -->
    <div id="multiple-candidates-view" class="hidden">
        <div class="candidates-overview">
            <!-- Candidates Sidebar -->
            <div class="candidates-sidebar">
                <!-- Summary Header -->
                <div class="candidate-summary">
                    <div class="text-2xl font-bold mb-1" id="total-candidates">5</div>
                    <div class="text-sm opacity-90">Candidates Analyzed</div>
                    <div class="mt-3 text-xs opacity-75" id="analysis-timestamp">
                        Analysis completed on May 22, 2025
                    </div>

                    <div class="mt-4 pt-3 border-t border-white/30">
                        <div class="text-xs opacity-75 mb-2">Sort by:</div>
                        <div class="flex gap-2">
                            <button id="sort-score" class="sort-btn active px-2 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors">
                                Score ↓
                            </button>
                            <button id="sort-name" class="sort-btn px-2 py-1 bg-white/20 rounded text-xs hover:bg-white/30 transition-colors">
                                Name
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Candidate Cards Grid -->
                <div class="candidate-grid" id="candidate-cards">
                    <!-- Cards will be dynamically inserted here -->
                </div>
            </div>

            <!-- Detailed View -->
            <div class="candidate-detail-view">
                <div id="selected-candidate-detail">
                    <!-- Selected candidate details will be shown here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Actions -->
    <div id="analysis-actions" class="flex flex-col md:flex-row justify-between gap-4 mt-6 hidden" style="margin-left: 20px; margin-bottom: 20px; margin-right: 20px;">
        <button id="new-analysis-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg flex items-center justify-center hover:bg-gray-300 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>
            Analyze Another Resume
        </button>
    
        <div class="flex flex-col md:flex-row gap-3">
            <!-- Export Dropdown -->
            <div class="relative">
                <button id="export-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg flex items-center justify-center hover:bg-green-700 transition-colors">
                    <i class="fas fa-download mr-2"></i>
                    Export Results
                    <i class="fas fa-chevron-down ml-2 text-xs"></i>
                </button>
            
                <!-- Dropdown Menu -->
                <div id="export-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-10 hidden">
                    <button id="export-csv" class="w-full px-4 py-2 text-left hover:bg-gray-50 rounded-t-lg flex items-center">
                        <i class="fas fa-file-csv text-green-600 mr-3"></i>
                        Export to CSV
                    </button>
                    <button id="copy-results" class="w-full px-4 py-2 text-left hover:bg-gray-50 flex items-center">
                        <i class="fas fa-copy text-blue-600 mr-3"></i>
                        Copy to Clipboard
                    </button>
                    <button id="email-results" class="w-full px-4 py-2 text-left hover:bg-gray-50 rounded-b-lg flex items-center">
                        <i class="fas fa-envelope text-purple-600 mr-3"></i>
                        Email Results
                    </button>
                </div>
            </div>
        
            <button id="download-pdf-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg flex items-center justify-center hover:bg-blue-700 transition-colors">
                <i class="fas fa-file-pdf mr-2"></i>
                Download PDF
            </button>
        </div>
    </div>

    <!-- Footer text also here for results page with bottom margin -->
    <div id="results-footer" class="text-center text-sm text-gray-500 mt-8 mb-8 hidden">
        <p>Results are provided for recruitment guidance only. Final hiring decisions should consider multiple factors beyond this analysis.</p>
        <p class="mt-1">© 2025 MontPro. All rights reserved.</p>
    </div>
</div>

    <script>
        class MontProFeedback {
    constructor() {
        this.retryAttempts = new Map();
        this.maxRetries = 3;
        this.setupConnectionMonitoring();
    }
    
    showNotification(message, type = 'info', duration = 5000) {
        const notification = document.createElement('div');
        notification.className = `montpro-notification ${type} text-white p-4`;
        
        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };
        
        notification.innerHTML = `
            <div class="flex items-start">
                <i class="fas ${icons[type]} text-xl mr-3 mt-0.5"></i>
                <div class="flex-1">
                    <div class="text-sm">${message}</div>
                </div>
                <button class="ml-3 text-white/70 hover:text-white" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        document.body.appendChild(notification);
        requestAnimationFrame(() => notification.classList.add('show'));
        
        if (duration > 0) {
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 400);
            }, duration);
        }
    }
    // Add these methods inside your MontProFeedback class

validateFile(file, options = {}) {
    const {
        maxSize = 10 * 1024 * 1024, // 10MB default
        allowedTypes = ['application/pdf', 'image/jpeg', 'image/png'],
        allowedExtensions = ['.pdf', '.jpg', '.jpeg', '.png']
    } = options;
    
    const errors = [];
    
    // Size validation
    if (file.size > maxSize) {
        errors.push(`File "${file.name}" is too large (${this.formatFileSize(file.size)}). Maximum size allowed: ${this.formatFileSize(maxSize)}`);
    }
    
    // Type validation
    if (!allowedTypes.includes(file.type)) {
        errors.push(`File "${file.name}" has unsupported format. Supported formats: PDF`);
    }
    
    // Extension validation
    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
    if (!allowedExtensions.includes(fileExtension)) {
        errors.push(`File "${file.name}" has invalid extension "${fileExtension}"`);
    }
    
    // Empty file check
    if (file.size === 0) {
        errors.push(`File "${file.name}" appears to be empty`);
    }
    
    // Corrupted file check (basic)
    if (file.name.includes('~') || file.name.startsWith('.')) {
        errors.push(`File "${file.name}" may be corrupted or is a system file`);
    }
    
    return {
        valid: errors.length === 0,
        errors,
        file
    };
}

formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1048576).toFixed(1) + ' MB';
}

showFieldError(fieldElement, message) {
    fieldElement.classList.add('field-error-shake');
    
    // Remove existing error message
    const existingError = fieldElement.parentNode.querySelector('.field-error-message');
    if (existingError) existingError.remove();
    
    // Add error message below the field
    const errorDiv = document.createElement('div');
    errorDiv.className = 'field-error-message text-red-600 text-sm mt-2 flex items-center';
    errorDiv.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${message}`;
    fieldElement.parentNode.appendChild(errorDiv);
    
    // Remove shake animation after it completes
    setTimeout(() => fieldElement.classList.remove('field-error-shake'), 500);
}

clearFieldError(fieldElement) {
    fieldElement.classList.remove('field-error-shake');
    const errorDiv = fieldElement.parentNode.querySelector('.field-error-message');
    if (errorDiv) errorDiv.remove();
}
// Add inside your MontProFeedback class

async makeRequest(url, options = {}) {
    const {
        timeout = 30000,
        retries = this.maxRetries,
        retryDelay = 2000,
        onRetry = null
    } = options;
    
    const requestKey = url + JSON.stringify(options.body || {});
    let attempt = this.retryAttempts.get(requestKey) || 0;
    
    try {
        // Create timeout promise
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);
        
        // Make request with timeout
        const response = await fetch(url, {
            ...options,
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error(`Server error: ${response.status} ${response.statusText}`);
        }
        
        // Reset retry counter on success
        this.retryAttempts.delete(requestKey);
        return response;
        
    } catch (error) {
        attempt++;
        this.retryAttempts.set(requestKey, attempt);
        
        // Determine error type
        const errorType = this.categorizeError(error);
        
        if (attempt <= retries && errorType.retryable) {
            if (onRetry) onRetry(attempt, retries + 1, error);
            
            // Show retry notification
            this.showNotification(
                `${errorType.message} (attempt ${attempt}/${retries + 1}). Retrying in ${retryDelay/1000}s...`,
                'warning',
                retryDelay
            );
            
            await new Promise(resolve => setTimeout(resolve, retryDelay));
            return this.makeRequest(url, options);
        } else {
            this.retryAttempts.delete(requestKey);
            throw new Error(`${errorType.message}${attempt > retries ? ` (failed after ${retries + 1} attempts)` : ''}`);
        }
    }
}

categorizeError(error) {
    if (error.name === 'AbortError') {
        return {
            message: 'Request timed out',
            retryable: true,
            type: 'timeout'
        };
    } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
        return {
            message: 'Network connection failed',
            retryable: true,
            type: 'network'
        };
    } else if (error.message.includes('Server error: 5')) {
        return {
            message: 'Server temporarily unavailable',
            retryable: true,
            type: 'server'
        };
    } else if (error.message.includes('Server error: 4')) {
        return {
            message: 'Request error - please check your data',
            retryable: false,
            type: 'client'
        };
    } else {
        return {
            message: error.message || 'Unknown error occurred',
            retryable: true,
            type: 'unknown'
        };
    }
}

setupConnectionMonitoring() {
    // Monitor online/offline status
    window.addEventListener('online', () => {
        this.showNotification('Connection restored', 'success', 3000);
        this.updateConnectionStatus(true);
    });
    
    window.addEventListener('offline', () => {
        this.showNotification('Connection lost - working in offline mode', 'warning', 0);
        this.updateConnectionStatus(false);
    });
    
    // Initial status
    this.updateConnectionStatus(navigator.onLine);
}

updateConnectionStatus(isOnline) {
    let statusElement = document.getElementById('connection-status');
    
    if (!statusElement) {
        statusElement = document.createElement('div');
        statusElement.id = 'connection-status';
        statusElement.className = 'connection-status';
        document.body.appendChild(statusElement);
    }
    
    if (isOnline) {
        statusElement.className = 'connection-status online';
        statusElement.innerHTML = '<i class="fas fa-wifi mr-2"></i>Online';
    } else {
        statusElement.className = 'connection-status offline';
        statusElement.innerHTML = '<i class="fas fa-wifi-slash mr-2"></i>Offline';
    }
}
// Add inside your MontProFeedback class

createProgressTracker(containerId, options = {}) {
    const {
        title = 'Processing...',
        steps = ['Initializing...'],
        showPercentage = true,
        showTimeEstimate = false
    } = options;
    
    const container = document.getElementById(containerId);
    if (!container) return null;
    
    const tracker = {
        container,
        currentStep: 0,
        totalSteps: steps.length,
        startTime: Date.now(),
        progress: 0,
        
        update: function(stepIndex, customMessage = null, progressPercent = null) {
            this.currentStep = stepIndex;
            this.progress = progressPercent !== null ? progressPercent : Math.round((stepIndex / this.totalSteps) * 100);
            
            const message = customMessage || steps[stepIndex] || 'Processing...';
            const progressBar = container.querySelector('.enhanced-progress-bar-fill');
            const progressText = container.querySelector('.enhanced-progress-text');
            const progressPercentElement = container.querySelector('.enhanced-progress-percent');
            const timeEstimate = container.querySelector('.enhanced-time-estimate');

            if (progressBar) progressBar.style.width = `${this.progress}%`;
            if (progressText) progressText.textContent = message;
            if (progressPercentElement && showPercentage) progressPercentElement.textContent = `${this.progress}%`;
            
            if (timeEstimate && showTimeEstimate && this.progress > 10) {
                const elapsed = Date.now() - this.startTime;
                const estimated = (elapsed / this.progress) * (100 - this.progress);
                const minutes = Math.floor(estimated / 60000);
                const seconds = Math.floor((estimated % 60000) / 1000);
                timeEstimate.textContent = minutes > 0 ? `~${minutes}m ${seconds}s remaining` : `~${seconds}s remaining`;
            }
        },
        
        complete: function(message = 'Complete!') {
            this.update(this.totalSteps - 1, message, 100);
            setTimeout(() => {
                const progressBar = container.querySelector('.enhanced-progress-bar-fill');
                if (progressBar) progressBar.style.backgroundColor = '#10b981';
            }, 200);
        },
        
        error: function(message = 'Error occurred') {
            const progressBar = container.querySelector('.enhanced-progress-bar-fill');
            const progressText = container.querySelector('.enhanced-progress-text');
            
            if (progressBar) progressBar.style.backgroundColor = '#ef4444';
            if (progressText) progressText.textContent = message;
        }
    };
    
    return tracker;
}

enhanceLoadingState(elementId, options = {}) {
    const {
        pulseColor = '#3b82f6',
        showSpinner = true,
        showShimmer = true
    } = options;
    
    const element = document.getElementById(elementId);
    if (!element) return;
    
    // Add enhanced loading classes
    element.classList.add('enhanced-loading');
    
    if (showShimmer) {
        element.style.background = `linear-gradient(90deg, #f3f4f6 0%, #e5e7eb 50%, #f3f4f6 100%)`;
        element.style.backgroundSize = '200% 100%';
        element.style.animation = 'shimmer 1.5s infinite linear';
    }
    
    if (showSpinner) {
        const spinner = document.createElement('div');
        spinner.className = 'enhanced-spinner';
        spinner.innerHTML = '<div class="spinner"></div>';
        element.appendChild(spinner);
    }
}

removeLoadingState(elementId) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    element.classList.remove('enhanced-loading');
    element.style.background = '';
    element.style.backgroundSize = '';
    element.style.animation = '';
    
    const spinner = element.querySelector('.enhanced-spinner');
    if (spinner) spinner.remove();
}

showProgressModal(title, steps, onCancel = null) {
    // Create modal overlay
    const overlay = document.createElement('div');
    overlay.className = 'progress-modal-overlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
    `;
    
    // Create modal content
    const modal = document.createElement('div');
    modal.className = 'progress-modal';
    modal.style.cssText = `
        background: white;
        border-radius: 16px;
        padding: 32px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    `;
    
    modal.innerHTML = `
        <div class="text-center mb-6">
            <div class="w-16 h-16 mx-auto mb-4 flex items-center justify-center relative">
                <div class="absolute inset-0 border-4 border-blue-100 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-transparent border-t-blue-500 rounded-full animate-spin"></div>
                <i class="fas fa-cog text-blue-500 text-2xl"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">${title}</h3>
        </div>
        
        <div class="mb-6">
            <div class="flex justify-between text-sm text-gray-600 mb-2">
                <span class="enhanced-progress-text">Initializing...</span>
                <span class="enhanced-progress-percent">0%</span>
            </div>
            <div class="enhanced-progress-bar w-full h-3 bg-gray-200 rounded-full overflow-hidden">
                <div class="enhanced-progress-bar-fill h-full bg-blue-500 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <div class="enhanced-time-estimate text-xs text-gray-500 mt-1 text-center"></div>
        </div>
        
        ${onCancel ? '<div class="text-center"><button class="cancel-btn px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">Cancel</button></div>' : ''}
    `;
    
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    
    // Set up cancel functionality
    if (onCancel) {
        const cancelBtn = modal.querySelector('.cancel-btn');
        cancelBtn.addEventListener('click', () => {
            onCancel();
            document.body.removeChild(overlay);
        });
    }
    
    // Create and return progress tracker
    const tracker = this.createProgressTracker('progress-modal', {
        title,
        steps,
        showPercentage: true,
        showTimeEstimate: true
    });
    
    tracker.close = () => {
        if (document.body.contains(overlay)) {
            document.body.removeChild(overlay);
        }
    };
    
    return tracker;
}
    // More methods will be added in next steps...
}

// Initialize feedback manager
const feedback = new MontProFeedback();
const supabaseUrl = 'https://saiwhkhgnsgakvbohwym.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNhaXdoa2hnbnNnYWt2Ym9od3ltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MzIxMjIsImV4cCI6MjA2MzMwODEyMn0.4MUgz7sYll0MYV30mwbAAYkLDs2MtPpSykgvWE10KuU';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// Global variables
let files = [];
let fileInput;
let dragArea;
let fileListContainer;
let fileList;
let fileCount;
let startButton;
let errorMessage;
let errorText;
let statusMessage;
let statusText;
let statusIcon;
let clearAllBtn;
let allowedTypes;
let typeNames;
let typeIcons;

function showMainApp() {
    document.getElementById('auth-box').style.display = 'none';
    document.getElementById('main-app').style.display = '';
    // Hide the animated background when logged in
    const animatedBg = document.querySelector('.animated-background');
    if (animatedBg) {
        animatedBg.style.display = 'none';
    }
}
function showAuthBox() {
    document.getElementById('auth-box').style.display = '';
    document.getElementById('main-app').style.display = 'none';
    // Show the animated background when back to login
    const animatedBg = document.querySelector('.animated-background');
    if (animatedBg) {
        animatedBg.style.display = '';
    }
}
function showError(message, persistent = false) {
    const duration = persistent ? 0 : 7000;
    feedback.showNotification(message, 'error', duration);
    
    // Also update the inline error display
    errorText.textContent = message;
    errorMessage.classList.remove('hidden');
}

function hideError() {
    errorMessage.classList.add('hidden');
}    
        
function showSuccess(message) {
    feedback.showNotification(message, 'success', 4000);
}

function showWarning(message) {
    feedback.showNotification(message, 'warning', 6000);
}

function hideStatus() {
    statusMessage.classList.add('hidden');
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    else return (bytes / 1048576).toFixed(1) + ' MB';
}

function handleFileSelect(e) {
    handleFiles(e.target.files);
}

function handleFiles(selectedFiles) {
    const fileArray = Array.from(selectedFiles);
    const validFiles = [];
    const errors = [];
    
    // Validate each file
    fileArray.forEach(file => {
        const validation = feedback.validateFile(file);
        
        if (validation.valid) {
            validFiles.push(file);
        } else {
            errors.push(...validation.errors);
        }
    });
    
    // Show validation results
    if (errors.length > 0) {
        // Show first error as main error
        showError(errors[0]);
        
        // If there are multiple errors, show them in a detailed notification
        if (errors.length > 1) {
            const errorList = errors.slice(1, 4).map(err => `• ${err}`).join('\n');
            feedback.showNotification(
                `Multiple file validation errors:\n${errorList}${errors.length > 4 ? '\n• ...' : ''}`,
                'error',
                10000
            );
        }
        
        // Shake the drag area
        dragArea.classList.add('field-error-shake');
        setTimeout(() => dragArea.classList.remove('field-error-shake'), 500);
    }
    
    if (validFiles.length > 0) {
        hideError();
        showSuccess(`${validFiles.length} file${validFiles.length > 1 ? 's' : ''} validated successfully`);
        
        // Clear any field errors
        feedback.clearFieldError(dragArea);
    }
    
    // Add valid files to the list
    files = [...files, ...validFiles];
    updateFileList();
}

function updateFileList() {
    if (files.length > 0) {
        fileListContainer.classList.remove('hidden');
        fileCount.textContent = files.length;
        startButton.disabled = false;
        fileList.innerHTML = '';
        
        files.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            
            const fileInfo = document.createElement('div');
            fileInfo.className = 'flex items-center';
            
            const fileTypeIcon = typeIcons[file.type] || 'fa-file';
            const icon = document.createElement('i');
            icon.className = `fas ${fileTypeIcon} text-blue-500 mr-3`;
            fileInfo.appendChild(icon);
            
            const details = document.createElement('div');
            details.innerHTML = `
                <p class="font-medium text-sm truncate max-w-xs">${file.name}</p>
                <p class="text-xs text-gray-500">
                    ${typeNames[file.type] || 'File'} · ${formatFileSize(file.size)}
                </p>
            `;
            fileInfo.appendChild(details);
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'text-gray-500 hover:text-red-500 transition-colors';
            removeBtn.innerHTML = '<i class="fas fa-times-circle"></i>';
            removeBtn.addEventListener('click', function() {
                removeFile(index);
            });
            
            fileItem.appendChild(fileInfo);
            fileItem.appendChild(removeBtn);
            fileList.appendChild(fileItem);
        });
    } else {
        fileListContainer.classList.add('hidden');
        startButton.disabled = true;
    }
}

function removeFile(index) {
    files = files.filter((_, i) => i !== index);
    updateFileList();
}

// Analysis functions
async function startAnalysis() {
    if (files.length === 0) {
        showError('Please upload at least one file before starting analysis.');
        return;
    }

    console.log('=== STARTING ANALYSIS ===');
    console.log('Number of files:', files.length);

    startButton.disabled = true;
    hideError();
    showAnalysisLoading();

    try {
        const formData = new FormData();
        files.forEach(file => {
            formData.append('files', file);
        });

        console.log('Sending request to backend...');

        // Use enhanced request method with retry logic
        const response = await feedback.makeRequest(
            'https://montpro.app.n8n.cloud/webhook/recruitment-analysis',
            {
                method: 'POST',
                body: formData,
                timeout: 60000, // 60 seconds for file upload
                retries: 2,
                retryDelay: 3000,
                onRetry: (attempt, maxAttempts, error) => {
                    console.log(`Retry attempt ${attempt}/${maxAttempts}:`, error.message);
                    // Update loading message during retry
                    document.getElementById('loading-step').textContent = `Retrying... (${attempt}/${maxAttempts})`;
                }
            }
        );

        console.log('Response received, status:', response.status);

        let data;
        const contentType = response.headers.get("content-type");
        const raw = await response.text();

        console.log('Raw response text:', raw);

        if (!raw || raw.trim().length === 0) {
            throw new Error("Empty response from server");
        }

        if (contentType && contentType.includes("application/json")) {
            data = JSON.parse(raw);
            console.log('=== PARSED DATA DEBUG ===');
            console.log('Parsed data:', data);
            console.log('========================');
        } else {
            throw new Error("Invalid content-type or response format");
        }

        sessionStorage.setItem('analysisResults', JSON.stringify(data));
        showSuccess('Analysis completed successfully!');
        showAnalysisResults(data);

    } catch (err) {
        console.error("Analysis failed:", err);
        
        // Enhanced error handling
        if (err.message.includes('timeout')) {
            showError('Analysis timed out. Your files may be too large or complex. Please try with smaller files or check your connection.', true);
        } else if (err.message.includes('Network')) {
            showError('Network error occurred. Please check your internet connection and try again.', true);
        } else if (err.message.includes('Server')) {
            showError('Server is temporarily unavailable. Please try again in a few minutes.', true);
        } else {
            showError(`Analysis failed: ${err.message}. Please try again.`, true);
        }
        
        showRetryButton();
        hideAnalysisLoading();
    }
}

function showRetryButton() {
    const retryBtn = document.getElementById('retry-btn');
    if (retryBtn) {
        retryBtn.classList.remove('hidden');
        retryBtn.onclick = () => {
            retryBtn.classList.add('hidden');
            startAnalysis();
        };
    }
}

function showAnalysisLoading() {
    document.getElementById('upload-interface').classList.add('hidden');
    document.getElementById('analysis-loading').classList.remove('hidden');
    
    // Create enhanced progress tracker
    const steps = [
        'Uploading files...',
        'Extracting text content...',
        'Analyzing qualifications...',
        'Processing skills and experience...',
        'Evaluating candidate fit...',
        'Generating final results...'
    ];
    
    const progressTracker = feedback.createProgressTracker('analysis-loading', {
        title: 'AI Analysis in Progress',
        steps: steps,
        showPercentage: true,
        showTimeEstimate: true
    });
    
    // Enhanced progress simulation
    const baseTime = 2000; // 2 seconds per step base
    const timePerFile = 1500; // 1.5 seconds per additional file
    const totalTime = baseTime * steps.length + (files.length - 1) * timePerFile;
    
    let currentStep = 0;
    let progress = 0;
    
    const updateProgress = () => {
        if (progress < 100) {
            // More realistic progress increments
            const increment = Math.floor(Math.random() * 4) + 1; // 1-4% increments
            progress = Math.min(progress + increment, 100);
            
            // Update step based on progress
            const newStep = Math.floor((progress / 100) * steps.length);
            if (newStep !== currentStep && newStep < steps.length) {
                currentStep = newStep;
            }
            
            // Update progress display
            progressTracker.update(currentStep, steps[currentStep], progress);
            
            // Also update the existing progress elements for compatibility
            const progressBar = document.getElementById('progress-bar-fill');
            const percentText = document.getElementById('loading-percent');
            const stepText = document.getElementById('loading-step');
            
            if (progressBar) progressBar.style.width = `${progress}%`;
            if (percentText) percentText.textContent = `${progress}%`;
            if (stepText) stepText.textContent = steps[currentStep] || 'Processing...';
            
            // Dynamic timing - slower at start, faster near end
            const baseInterval = (totalTime / 100) * (1.8 - progress/100);
            const randomVariation = baseInterval * (0.8 + Math.random() * 0.4);
            
            setTimeout(updateProgress, randomVariation);
        }
    };
    
    // Start the enhanced progress
    updateProgress();
    
    // Store tracker for cleanup
    window.currentProgressTracker = progressTracker;
}

function hideAnalysisLoading() {
    document.getElementById('analysis-loading').classList.add('hidden');
    
    // Complete the progress tracker
    if (window.currentProgressTracker) {
        window.currentProgressTracker.complete('Analysis complete!');
        setTimeout(() => {
            window.currentProgressTracker = null;
        }, 1000);
    }
    
    // Clear any running progress interval
    if (window.progressInterval) {
        clearInterval(window.progressInterval);
    }
}

function showAnalysisResults(data) {
    // DEBUG: Check what we received
    console.log('=== showAnalysisResults called ===');
    console.log('Raw data:', data);
    console.log('Type of data:', typeof data);
    console.log('Is array?', Array.isArray(data));
    if (Array.isArray(data)) {
        console.log('Array length:', data.length);
    }
    console.log('================================');
    
    // Use the new multiple candidates handler
    showMultipleCandidatesResults(data);

    // Show the action buttons
    document.getElementById('analysis-actions').classList.remove('hidden');

    // Show the results footer
    document.getElementById('results-footer').classList.remove('hidden');

    // Set up PDF download after showing results
    setupDownloadPDF();

    // Set up export options
    setupExportOptions();
}

function setupDownloadPDF() {
    const downloadBtn = document.querySelector('#download-pdf-btn');
    if (downloadBtn) {
        downloadBtn.addEventListener('click', function() {
            const originalBtnHtml = downloadBtn.innerHTML;
            
            try {
                // Show loading state
                downloadBtn.innerHTML = '<div class="spinner mr-2"></div> Generating PDF...';
                downloadBtn.disabled = true;
                
                // Get analysis data from the current view
                const candidateData = getCurrentCandidateData();
                
                // Generate PDF
                generatePDF(candidateData);
                
                // Show success state
                downloadBtn.innerHTML = '<i class="fas fa-check mr-2"></i> Downloaded!';
                setTimeout(() => {
                    downloadBtn.innerHTML = originalBtnHtml;
                    downloadBtn.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('PDF generation failed:', error);
                
                // Show error state
                downloadBtn.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i> Failed';
                downloadBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                downloadBtn.classList.add('bg-red-600');
                
                setTimeout(() => {
                    downloadBtn.innerHTML = originalBtnHtml;
                    downloadBtn.disabled = false;
                    downloadBtn.classList.remove('bg-red-600');
                    downloadBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }, 3000);
            }
        });
    }
}

function getCurrentCandidateData() {
    // For multiple candidates view
    if (!document.getElementById('multiple-candidates-view').classList.contains('hidden')) {
        const candidate = candidatesData[selectedCandidateIndex];
        return {
            name: candidate.candidateName || `Candidate ${selectedCandidateIndex + 1}`,
            score: candidate.candidateScore || '75',
            title: extractTitleFromSummary(candidate) || 'Professional',
            executiveSummary: candidate.executiveSummary || 'No executive summary available.',
            coreCompetencies: candidate.coreCompetencies || 'No competencies data available.',
            isMultiple: true,
            candidateNumber: selectedCandidateIndex + 1,
            totalCandidates: candidatesData.length
        };
    } 
    // For single candidate view
    else {
        const currentData = candidatesData && candidatesData.length > 0 ? candidatesData[0] : null;
        return {
            name: document.getElementById('candidate-name')?.textContent || 'Candidate Name',
            score: document.getElementById('candidate-score')?.textContent || '75',
            title: currentData ? extractTitleFromSummary(currentData) : 'Professional',
            executiveSummary: document.getElementById('executive-summary')?.textContent || 'No executive summary available.',
            coreCompetencies: currentData ? currentData.coreCompetencies : 'No competencies data available.',
            isMultiple: false
        };
    }
}

function extractTitleFromSummary(candidate) {
    // First try direct title fields
    let title = candidate.candidateTitle || candidate.position || candidate.jobTitle;
    
    if (!title && candidate.executiveSummary) {
        const summaryText = candidate.executiveSummary;
        
        // Enhanced title extraction patterns
        const titlePatterns = [
            /is (?:an?|the) ([^.]+?) with/i,
            /(?:seasoned|experienced|accomplished) ([^.]+?) with/i,
            /(?:as|is) (?:an?|the) ([^.]+?)\./i,
            /expertise in ([^.]+?)\./i,
            /leader in ([^.]+?)\./i,
            /specialist in ([^.]+?)\./i,
            /background in ([^.]+?)\./i
        ];
        
        for (let pattern of titlePatterns) {
            const match = summaryText.match(pattern);
            if (match && match[1]) {
                title = match[1].trim();
                // Clean up and format
                title = title.replace(/\b(leader|professional|expert|individual|and)\b/gi, '')
                            .replace(/\s+/g, ' ')
                            .trim();
                if (title.length > 0 && title.length < 60) {
                    // Capitalize properly
                    title = title.split(' ')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                        .join(' ');
                    break;
                }
            }
        }
    }
    
    return title || 'Professional';
}

function generatePDF(data) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Set up colors
    const primaryColor = [59, 130, 246]; // Blue
    const grayColor = [107, 114, 128];
    const darkColor = [31, 41, 55];
    
    let yPosition = 20;
    
    // Header Card with better spacing
    doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
    doc.roundedRect(15, yPosition, 180, 40, 5, 5, 'F');
    
    // MontPro Logo/Title
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(20);
    doc.setFont(undefined, 'bold');
    doc.text('MontPro', 20, yPosition + 18);
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    doc.text('Recruitment Analysis Report', 20, yPosition + 28);
    
    // Date with better spacing
    doc.setFontSize(10);
    doc.text(`Generated on ${new Date().toLocaleDateString()}`, 20, yPosition + 38);
    
    // Score section - properly centered
    doc.setFontSize(24);
    doc.setFont(undefined, 'bold');
    const scoreText = `${data.score}`;
    const scoreWidth = doc.getTextWidth(scoreText);
    const scoreX = 170; // Base position
    
    // Center the score number
    doc.text(scoreText, scoreX, yPosition + 30);
    
    // Center the "Score" label above the number
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    const labelWidth = doc.getTextWidth('Score');
    const labelX = scoreX + (scoreWidth - labelWidth) / 2; // Center relative to score number
    doc.text('Score', labelX, yPosition + 20);
    
    yPosition += 55; // More space after header
    
    // Candidate Information
    doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text(data.name, 20, yPosition);
    
    yPosition += 10;
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(grayColor[0], grayColor[1], grayColor[2]);
    doc.text(data.title, 20, yPosition); // Now using dynamic title
    
    if (data.isMultiple) {
        doc.text(`Candidate ${data.candidateNumber} of ${data.totalCandidates}`, 140, yPosition);
    }
    
    yPosition += 15; // 15 spacing before Executive Summary
    
    // Executive Summary Section
    doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('Executive Summary', 20, yPosition);
    
    yPosition += 10;
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
    
    // Split long text into multiple lines with proper margins
    const summaryLines = doc.splitTextToSize(data.executiveSummary, 170); // Keep 20px margins (210-20-20=170)
    doc.text(summaryLines, 20, yPosition);
    yPosition += summaryLines.length * 5 + 6; // Reduced spacing before Core Competencies (from 10 to 6)
    
    // Core Competencies Section - Enhanced with bullet formatting
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('Core Competencies', 20, yPosition);
    
    yPosition += 10;
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    
    // Handle competencies with better formatting and optimized page usage
    if (data.coreCompetencies && typeof data.coreCompetencies === 'string') {
        // Split by bullet points or line breaks
        const competencies = data.coreCompetencies
            .split(/[•\n]/)
            .map(item => item.replace(/^[-•]\s*/, '').trim())
            .filter(item => item.length > 0);
        
        competencies.forEach((competency, index) => {
            if (competency.length > 0) {
                // Calculate space needed for this competency
                const competencyLines = doc.splitTextToSize(competency, 165); // Keep 20px left + 5px for bullet + 20px right margins
                const competencyHeight = competencyLines.length * 5 + 2;
                
                // More aggressive page usage - only break if really necessary
                // Leave space for footer (15) + some buffer (5) = 20
                if (yPosition + competencyHeight > 280) {
                    // Not enough space, start a new page
                    doc.addPage();
                    yPosition = 20;
                }
                
                // Add bullet point
                doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                doc.circle(22, yPosition - 1, 1, 'F');
                
                // Add competency text with proper wrapping
                doc.text(competencyLines, 27, yPosition);
                yPosition += competencyHeight; // Tighter spacing between bullet points
            }
        });
    } else {
        const competenciesText = 'Core competencies data available in detailed view.';
        const competenciesLines = doc.splitTextToSize(competenciesText, 170);
        doc.text(competenciesLines, 20, yPosition);
        yPosition += competenciesLines.length * 5;
    }
    
    // Ensure footer has enough space but use more of the page
    if (yPosition > 275) {
        doc.addPage();
        yPosition = 275; // Position footer near bottom of new page
    } else {
        yPosition = Math.max(yPosition + 10, 275); // Minimal gap before footer
    }
    
    // Footer
    doc.setFontSize(8);
    doc.setTextColor(grayColor[0], grayColor[1], grayColor[2]);
    doc.text('This analysis is provided for recruitment guidance only.', 20, yPosition);
    doc.text('© 2025 MontPro. All rights reserved.', 20, yPosition + 5);
    
    // Save the PDF
    const fileName = `${data.name.replace(/\s+/g, '_')}_Analysis_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(fileName);
}

// Export functionality
function setupExportOptions() {
    const exportBtn = document.getElementById('export-btn');
    const exportDropdown = document.getElementById('export-dropdown');
    const exportCsv = document.getElementById('export-csv');
    const copyResults = document.getElementById('copy-results');
    const emailResults = document.getElementById('email-results');

    // Toggle dropdown
    exportBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        exportDropdown.classList.toggle('hidden');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', () => {
        exportDropdown.classList.add('hidden');
    });

    // Export to CSV
    exportCsv.addEventListener('click', () => {
        exportToCSV();
        exportDropdown.classList.add('hidden');
    });

    // Copy to clipboard
    copyResults.addEventListener('click', () => {
        copyToClipboard();
        exportDropdown.classList.add('hidden');
    });

    // Email results
    emailResults.addEventListener('click', () => {
        emailResults_();
        exportDropdown.classList.add('hidden');
    });
}

function exportToCSV() {
    const csvBtn = document.getElementById('export-csv');
    const originalHtml = csvBtn.innerHTML;
    
    try {
        csvBtn.innerHTML = '<i class="fas fa-spinner fa-spin text-green-600 mr-3"></i>Generating...';
        
        let csvData = [];
        
        if (candidatesData.length > 1) {
            // Multiple candidates
            csvData = candidatesData.map((candidate, index) => ({
                'Candidate Name': candidate.candidateName || `Candidate ${index + 1}`,
                'Score': candidate.candidateScore || 'N/A',
                'Title/Position': extractTitleFromSummary(candidate) || 'Professional',
                'Executive Summary': candidate.executiveSummary ? candidate.executiveSummary.replace(/"/g, '""') : 'N/A',
                'Core Competencies': candidate.coreCompetencies ? 
                    (typeof candidate.coreCompetencies === 'string' ? 
                        (candidate.coreCompetencies.startsWith('-') ? "'" + candidate.coreCompetencies.replace(/"/g, '""') : candidate.coreCompetencies.replace(/"/g, '""')) : 
                        candidate.coreCompetencies.join('; ')) : 'N/A',
                'Analysis Date': new Date().toLocaleDateString()
            }));
        } else {
            // Single candidate
            const candidate = candidatesData[0];
            csvData = [{
                'Candidate Name': candidate.candidateName || 'Candidate',
                'Score': candidate.candidateScore || 'N/A',
                'Title/Position': extractTitleFromSummary(candidate) || 'Professional',
                'Executive Summary': candidate.executiveSummary ? candidate.executiveSummary.replace(/"/g, '""') : 'N/A',
                'Core Competencies': candidate.coreCompetencies ? 
                    (typeof candidate.coreCompetencies === 'string' ? 
                        (candidate.coreCompetencies.startsWith('-') ? "'" + candidate.coreCompetencies.replace(/"/g, '""') : candidate.coreCompetencies.replace(/"/g, '""')) : 
                        candidate.coreCompetencies.join('; ')) : 'N/A',
                'Analysis Date': new Date().toLocaleDateString()
            }];
        }
        
        // Convert to CSV
        const headers = Object.keys(csvData[0]);
        const csvContent = [
            headers.join(','),
            ...csvData.map(row => headers.map(header => `"${row[header]}"`).join(','))
        ].join('\n');
        
        // Download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `MontPro_Analysis_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        
        // Success state
        csvBtn.innerHTML = '<i class="fas fa-check text-green-600 mr-3"></i>Downloaded!';
        showSuccess('CSV exported successfully!');
        
        setTimeout(() => {
            csvBtn.innerHTML = originalHtml;
        }, 2000);
        
    } catch (error) {
        console.error('CSV export failed:', error);
        csvBtn.innerHTML = '<i class="fas fa-exclamation-circle text-red-600 mr-3"></i>Failed';
        showError('Failed to export CSV. Please try again.');
        
        setTimeout(() => {
            csvBtn.innerHTML = originalHtml;
        }, 3000);
    }
}

function copyToClipboard() {
    const copyBtn = document.getElementById('copy-results');
    const originalHtml = copyBtn.innerHTML;
    
    try {
        copyBtn.innerHTML = '<i class="fas fa-spinner fa-spin text-blue-600 mr-3"></i>Copying...';
        
        let textContent = '';
        
        if (candidatesData.length > 1) {
            textContent = `MontPro Analysis Results - ${candidatesData.length} Candidates\n`;
            textContent += `Analysis Date: ${new Date().toLocaleDateString()}\n\n`;
            
            candidatesData.forEach((candidate, index) => {
                textContent += `--- CANDIDATE ${index + 1} ---\n`;
                textContent += `Name: ${candidate.candidateName || `Candidate ${index + 1}`}\n`;
                textContent += `Score: ${candidate.candidateScore || 'N/A'}\n`;
                textContent += `Title: ${extractTitleFromSummary(candidate) || 'Professional'}\n`;
                textContent += `Summary: ${candidate.executiveSummary || 'N/A'}\n`;
                textContent += `Skills: ${candidate.coreCompetencies ? (typeof candidate.coreCompetencies === 'string' ? candidate.coreCompetencies : candidate.coreCompetencies.join(', ')) : 'N/A'}\n\n`;
            });
        } else {
            const candidate = candidatesData[0];
            textContent = `MontPro Analysis Results\n`;
            textContent += `Analysis Date: ${new Date().toLocaleDateString()}\n\n`;
            textContent += `Name: ${candidate.candidateName || 'Candidate'}\n`;
            textContent += `Score: ${candidate.candidateScore || 'N/A'}\n`;
            textContent += `Title: ${extractTitleFromSummary(candidate) || 'Professional'}\n`;
            textContent += `Summary: ${candidate.executiveSummary || 'N/A'}\n`;
            textContent += `Skills: ${candidate.coreCompetencies ? (typeof candidate.coreCompetencies === 'string' ? candidate.coreCompetencies : candidate.coreCompetencies.join(', ')) : 'N/A'}\n`;
        }
        
        textContent += `\n--- \nGenerated by MontPro Recruitment Analysis Tool`;
        
        navigator.clipboard.writeText(textContent).then(() => {
            copyBtn.innerHTML = '<i class="fas fa-check text-blue-600 mr-3"></i>Copied!';
            showSuccess('Results copied to clipboard!');
            
            setTimeout(() => {
                copyBtn.innerHTML = originalHtml;
            }, 2000);
        });
        
    } catch (error) {
        console.error('Copy failed:', error);
        copyBtn.innerHTML = '<i class="fas fa-exclamation-circle text-red-600 mr-3"></i>Failed';
        showError('Failed to copy. Please try again.');
        
        setTimeout(() => {
            copyBtn.innerHTML = originalHtml;
        }, 3000);
    }
}

function emailResults_() {
    const emailBtn = document.getElementById('email-results');
    const originalHtml = emailBtn.innerHTML;
    
    // Get user's email address
    const userEmail = prompt('Enter your email address to receive the analysis results:');
    
    if (!userEmail) {
        return; // User cancelled
    }
    
    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(userEmail)) {
        showError('Please enter a valid email address.');
        return;
    }
    
    try {
        emailBtn.innerHTML = '<i class="fas fa-spinner fa-spin text-purple-600 mr-3"></i>Sending...';
        
        // Prepare email data
        const emailData = {
            to: userEmail,
            candidates: candidatesData,
            analysisDate: new Date().toLocaleDateString(),
            totalCandidates: candidatesData.length
        };
        
        console.log('Sending email data:', emailData);
        
        // Send to your backend
        sendEmailViaBackend(emailData)
            .then((result) => {
                console.log('Email sent successfully:', result);
                emailBtn.innerHTML = '<i class="fas fa-check text-purple-600 mr-3"></i>Sent!';
                showSuccess(`Analysis results sent to ${userEmail}!`);
                
                setTimeout(() => {
                    emailBtn.innerHTML = originalHtml;
                }, 3000);
            })
            .catch((error) => {
                console.error('Email sending failed:', error);
                
                // Fallback to clipboard
                const subject = `MontPro Analysis Results - ${candidatesData.length} Candidate${candidatesData.length > 1 ? 's' : ''}`;
                let body = generateEmailBody();
                
                navigator.clipboard.writeText(`Subject: ${subject}\n\n${body}`).then(() => {
                    emailBtn.innerHTML = '<i class="fas fa-copy text-purple-600 mr-3"></i>Copied!';
                    showWarning(`Could not send email to ${userEmail}. Content copied to clipboard instead.`);
                    
                    setTimeout(() => {
                        emailBtn.innerHTML = originalHtml;
                    }, 3000);
                }).catch(() => {
                    emailBtn.innerHTML = '<i class="fas fa-exclamation-circle text-red-600 mr-3"></i>Failed';
                    showError('Email sending failed and clipboard copy failed. Please try the CSV export instead.');
                    
                    setTimeout(() => {
                        emailBtn.innerHTML = originalHtml;
                    }, 3000);
                });
            });
        
    } catch (error) {
        console.error('Email preparation failed:', error);
        emailBtn.innerHTML = originalHtml;
        showError('Failed to prepare email. Please try again.');
    }
}

// Helper function to send email via your backend
async function sendEmailViaBackend(emailData) {
    try {
        const response = await fetch('https://montpro.app.n8n.cloud/webhook/send-recruitment-analysis-email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(emailData)
        });
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('Response data:', result);
        
        // Check if the backend indicates success
        if (result.success === false) {
            throw new Error(result.message || 'Email sending failed');
        }
        
        return result;
        
    } catch (error) {
        console.error('Email sending error:', error);
        throw error;
    }
}

// Helper function to generate email body
function generateEmailBody() {
    let body = `Performance Review Summary

Analysis Date: ${new Date().toLocaleDateString()}
Total Candidates: ${candidatesData.length}

`;
    
    if (candidatesData.length > 1) {
        candidatesData.forEach((candidate, index) => {
            body += `--- CANDIDATE ${index + 1} ---
Name: ${candidate.candidateName || `Candidate ${index + 1}`}
Score: ${candidate.candidateScore || 'N/A'}/5
Title: ${extractTitleFromSummary(candidate) || 'Professional'}

Executive Summary:
${candidate.executiveSummary || 'N/A'}

Core Competencies:
${candidate.coreCompetencies ? (typeof candidate.coreCompetencies === 'string' ? candidate.coreCompetencies : candidate.coreCompetencies.join(', ')) : 'N/A'}

`;
        });
    } else {
        const candidate = candidatesData[0];
        body += `Employee: ${candidate.candidateName || 'Candidate'}
Score: ${candidate.candidateScore || 'N/A'}/5
Title: ${extractTitleFromSummary(candidate) || 'Professional'}

Executive Summary:
${candidate.executiveSummary || 'N/A'}

Core Competencies:
${candidate.coreCompetencies ? (typeof candidate.coreCompetencies === 'string' ? candidate.coreCompetencies : candidate.coreCompetencies.join(', ')) : 'N/A'}

`;
    }
    
    body += `Generated by MontPro Recruitment Analysis Tool`;
    return body;
}
        
async function signIn() {
    const emailEl = document.getElementById('email');
    const authMsg = document.getElementById('auth-msg');
    const email = emailEl.value.trim();
    
    if (!email) {
        authMsg.textContent = "Please enter your email address.";
        authMsg.className = "text-center text-sm font-medium text-red-600 mt-2";
        emailEl.focus();
        return;
    }
    
    // Email validation regex
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        authMsg.textContent = "Please enter a valid email address.";
        authMsg.className = "text-center text-sm font-medium text-red-600 mt-2";
        emailEl.focus();
        return;
    }
    
    const magicBtn = document.getElementById('magic-btn');
    const originalBtnHtml = magicBtn.innerHTML;
    
    // Update button to show loading state
    magicBtn.innerHTML = '<div class="spinner mr-2"></div> Sending...';
    magicBtn.disabled = true;
    
    authMsg.textContent = "";
    
    try {
        let { error } = await supabase.auth.signInWithOtp({ email });
        
        if (error) {
            authMsg.textContent = "Error: " + error.message;
            authMsg.className = "text-center text-sm font-medium text-red-600 mt-2";
            
            // Reset button
            magicBtn.innerHTML = originalBtnHtml;
            magicBtn.disabled = false;
        } else {
            authMsg.textContent = "Check your email for the sign-in link.";
            authMsg.className = "text-center text-sm font-medium text-green-600 mt-2";
            
            // Keep button disabled but change text
            magicBtn.innerHTML = '<i class="fas fa-check mr-2"></i> Link Sent';
            
            // Enable the button after 30 seconds
            setTimeout(() => {
                magicBtn.innerHTML = originalBtnHtml;
                magicBtn.disabled = false;
            }, 30000);
        }
    } catch (e) {
        authMsg.textContent = "Something went wrong. Please try again.";
        authMsg.className = "text-center text-sm font-medium text-red-600 mt-2";
        console.error(e);
        
        // Reset button
        magicBtn.innerHTML = originalBtnHtml;
        magicBtn.disabled = false;
    }
}

// Multiple Candidates Handling Functions
let candidatesData = [];
let selectedCandidateIndex = 0;

function showMultipleCandidatesResults(data) {
    console.log('=== showMultipleCandidatesResults called ===');
    console.log('Data received:', data);
    
    hideAnalysisLoading();
    document.getElementById('analysis-results').classList.remove('hidden');
    
    // Check if data has candidates array nested inside
    let candidatesArray = null;
    
    if (Array.isArray(data)) {
        console.log('Data is already an array');
        candidatesArray = data;
    } else if (data && Array.isArray(data.candidates)) {
        console.log('Found candidates array in data.candidates');
        // Extract the JSON objects from the candidates array
        candidatesArray = data.candidates.map(item => item.json || item);
    } else if (data && Array.isArray(data.data)) {
        console.log('Found candidates array in data.data');
        candidatesArray = data.data;
    } else if (data && typeof data === 'object') {
        // Check if data has any property that is an array
        for (let key in data) {
            if (Array.isArray(data[key]) && data[key].length > 0) {
                console.log(`Found candidates array in data.${key}`);
                // Check if items have nested json property
                candidatesArray = data[key].map(item => item.json || item);
                break;
            }
        }
    }
    
    if (candidatesArray && candidatesArray.length > 1) {
        console.log('MULTIPLE CANDIDATES DETECTED - Array with', candidatesArray.length, 'items');
        console.log('First candidate structure:', candidatesArray[0]);
        console.log('Keys in first candidate:', Object.keys(candidatesArray[0]));
        candidatesData = candidatesArray;
        showMultipleCandidatesView();
    } else if (candidatesArray && candidatesArray.length === 1) {
        console.log('SINGLE CANDIDATE IN ARRAY - Using single view');
        candidatesData = candidatesArray;
        showSingleCandidateView(candidatesArray[0]);
    } else {
        console.log('SINGLE CANDIDATE OBJECT - Using single view');
        candidatesData = [data];
        showSingleCandidateView(data);
    }
}

function showMultipleCandidatesView() {
    document.getElementById('single-candidate-view').classList.add('hidden');
    document.getElementById('multiple-candidates-view').classList.remove('hidden');
    
    // Update summary
    document.getElementById('total-candidates').textContent = candidatesData.length;
    document.getElementById('analysis-timestamp').textContent = 
        `Analysis completed on ${new Date().toLocaleDateString()}`;
    
    // Generate candidate cards
    generateCandidateCards();
    
    // Show first candidate by default
    showCandidateDetail(0);

    // Set up sorting
    document.getElementById('sort-score').onclick = () => sortCandidates('score');
    document.getElementById('sort-name').onclick = () => sortCandidates('name');
}

function generateCandidateCards() {
    const cardsContainer = document.getElementById('candidate-cards');
    cardsContainer.innerHTML = '';
    
    candidatesData.forEach((candidate, index) => {
        const card = createCandidateCard(candidate, index);
        cardsContainer.appendChild(card);
    });
}

function sortCandidates(sortBy) {
    if (sortBy === 'score') {
        candidatesData.sort((a, b) => (parseInt(b.candidateScore) || 0) - (parseInt(a.candidateScore) || 0));
    } else if (sortBy === 'name') {
        candidatesData.sort((a, b) => {
            const nameA = (a.candidateName || `Candidate ${candidatesData.indexOf(a) + 1}`).toLowerCase();
            const nameB = (b.candidateName || `Candidate ${candidatesData.indexOf(b) + 1}`).toLowerCase();
            return nameA.localeCompare(nameB);
        });
    }
    
    // Regenerate cards and reset selection
    generateCandidateCards();
    showCandidateDetail(0);
    
    // Update active button
    document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`sort-${sortBy}`).classList.add('active');
}

function createCandidateCard(candidate, index) {
    const card = document.createElement('div');
    card.className = `candidate-mini-card ${index === selectedCandidateIndex ? 'active' : ''}`;
    card.onclick = () => showCandidateDetail(index);
    
    // Extract and format top 3 skills for preview
    const topSkills = extractAndFormatSkills(candidate.coreCompetencies);
    
    const score = parseInt(candidate.candidateScore) || 75;
const name = candidate.candidateName || `Candidate ${index + 1}`;

// Extract job title from executive summary if not directly available
let title = candidate.candidateTitle || candidate.position || candidate.jobTitle;

if (!title && candidate.executiveSummary) {
    // Try to extract title from executive summary
    const summaryText = candidate.executiveSummary;
    
    // Look for common title patterns
    const titlePatterns = [
        /is (?:an?|the) ([^.]+?) with/i,  // "is a Senior Manager with"
        /(?:seasoned|experienced|accomplished) ([^.]+?) with/i,  // "seasoned Finance Director with"
        /(?:as|is) (?:an?|the) ([^.]+?)\./i,  // "as a Product Manager."
        /his role as ([^.]+?)\./i,  // "his role as CFO."
        /working as (?:an?|the) ([^.]+?)\./i  // "working as a Team Lead."
    ];
    
    for (let pattern of titlePatterns) {
        const match = summaryText.match(pattern);
        if (match && match[1]) {
            title = match[1].trim();
            // Clean up common words and make it more title-like
            title = title.replace(/\b(leader|professional|expert|individual)\b/gi, '')
                        .replace(/\s+/g, ' ')
                        .trim();
            if (title.length > 0 && title.length < 50) {
                break;
            }
        }
    }
}

// Fallback if no title found
if (!title || title.length === 0) {
    title = 'Professional';
}

// Format the title properly (capitalize first letters)
title = title.split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join(' ');
    
    card.innerHTML = `
        <div class="mini-card-header">
            <div class="mini-card-info">
                <h4>${name}</h4>
                <p>${title}</p>
            </div>
            <div class="mini-score-ring" style="--score: ${score}%;">
                <span class="mini-score-text">${score}</span>
            </div>
        </div>
        <div class="mini-skills">
            ${topSkills.map(skill => `<span class="mini-skill-tag">${skill}</span>`).join('')}
        </div>
    `;
    
    return card;
}

function showCandidateDetail(index) {
    selectedCandidateIndex = index;
    const candidate = candidatesData[index];
    
    // Update active card
    document.querySelectorAll('.candidate-mini-card').forEach((card, i) => {
        if (i === index) {
            card.classList.add('active');
        } else {
            card.classList.remove('active');
        }
    });
    
    // Generate detailed view
    const detailContainer = document.getElementById('selected-candidate-detail');
    detailContainer.innerHTML = generateCandidateDetailHTML(candidate, index);
}

function generateCandidateDetailHTML(candidate, index) {
    const score = parseInt(candidate.candidateScore) || 75;
    const name = candidate.candidateName || `Candidate ${index + 1}`;
    const title = candidate.candidateTitle || candidate.position || 'Professional';
    
    return `
        <!-- Candidate Overview -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-center md:items-start gap-6">
                <div>
                    <div class="flex items-center mb-2">
                        <h2 class="text-2xl font-bold text-gray-800">${name}</h2>
                        <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded">Candidate ${index + 1}</span>
                    </div>
                    
                    <div class="flex flex-wrap gap-2 mt-2">
                        <span class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded-md">${title}</span>
                        <span class="text-xs bg-green-50 text-green-700 px-2 py-1 rounded-md">AI-Powered</span>
                        <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded-md">${new Date().toLocaleDateString()}</span>
                    </div>
                </div>
                
                <div class="text-center">
                    <div class="score-circle" style="--score-percent: ${score}%">
                        <div class="score-label">Score</div>
                        <div class="score-value">${score}</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Executive Summary -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex items-center mb-4">
                <i class="fas fa-file-alt text-blue-500 mr-3"></i>
                <h3 class="text-lg font-semibold">Executive Summary</h3>
            </div>
            <div class="text-gray-700">
                ${candidate.executiveSummary ? `<p>${candidate.executiveSummary}</p>` : '<p>Executive summary not available.</p>'}
            </div>
        </div>
        
        <!-- Core Competencies -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <i class="fas fa-brain text-blue-500 mr-3"></i>
                    <h3 class="text-lg font-semibold">Core Competencies</h3>
                </div>
            </div>
            <div class="text-gray-700">
                ${generateCompetenciesHTML(candidate.coreCompetencies)}
            </div>
        </div>
        
        <!-- Upgrade CTA -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl p-6 text-white mb-6">
            <div class="md:flex justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <h3 class="font-bold text-xl mb-2">Take Your Recruitment Process to the Next Level</h3>
                    <p class="opacity-90 mb-2">Unlock advanced customization options and powerful features:</p>
                    <ul class="list-disc pl-5 text-sm opacity-90 space-y-1">
                        <li>Custom metrics tracking tailored to your hiring needs</li>
                        <li>Batch upload via Google Drive for efficient processing</li>
                        <li>Flexible output formats (Google Docs, Slides, Sheets, PDF)</li>
                        <li>Personalized report templates to match your brand</li>
                        <li>Match candidates against your specific job requirements</li>
                    </ul>
                </div>
                <div class="mt-4 md:mt-0 flex-shrink-0 text-center">
                    <p class="text-sm italic text-white opacity-80 mb-2">Customize multiple candidates analysis</p>
                    <a href="https://calendly.com/ardhipradhana/montpro_discovery" class="inline-block px-6 py-3 bg-white text-purple-700 font-medium rounded-lg hover:bg-gray-100 transition-colors shadow-md">
                        <i class="fas fa-magic mr-2"></i>
                        Get My Tailored Version
                    </a>
                </div>
            </div>
        </div>
    `;
}

function generateCompetenciesHTML(competencies) {
    if (!competencies) return '<p>No competencies data available.</p>';
    
    if (Array.isArray(competencies)) {
        return competencies.map(skill => 
            `<span class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm mr-2 mb-2">${skill}</span>`
        ).join('');
    } else if (typeof competencies === 'string') {
        return competencies.replace(/\n/g, '<br>').replace(/- /g, '• ');
    }
    
    return '<p>Competencies data format not recognized.</p>';
}

function showSingleCandidateView(data) {
    document.getElementById('multiple-candidates-view').classList.add('hidden');
    document.getElementById('single-candidate-view').classList.remove('hidden');
    
    // Use existing single candidate display logic
    if (data.candidateName) {
        document.getElementById('candidate-name').textContent = data.candidateName;
    }
    
    if (data.candidateScore) {
        const scoreValue = parseInt(data.candidateScore);
        document.getElementById('candidate-score').textContent = `${scoreValue}`;
        document.querySelector('.score-circle').style.setProperty('--score-percent', `${scoreValue}%`);
    }
    
    if (data.executiveSummary) {
        document.getElementById('executive-summary').innerHTML = `<p>${data.executiveSummary}</p>`;
    }
    
    if (data.coreCompetencies) {
        const skillsContainer = document.getElementById('core-competencies');
        skillsContainer.innerHTML = generateCompetenciesHTML(data.coreCompetencies);
    }
    
    const today = new Date();
    document.getElementById('analysis-date').textContent = today.toLocaleDateString();
}

// Skill formatting functions
function formatSkillText(skill) {
    // Words that should remain lowercase (except at the beginning)
    const lowercaseWords = ['and', 'of', 'in', 'the', 'a', 'an', 'to', 'for', 'with', 'by', 'on', 'at'];
    
    return skill.toLowerCase()
        .split(' ')
        .map((word, index) => {
            // Always capitalize the first word
            if (index === 0) {
                return word.charAt(0).toUpperCase() + word.slice(1);
            }
            // Keep lowercase words lowercase unless they're the first word
            if (lowercaseWords.includes(word)) {
                return word;
            }
            // Capitalize other words
            return word.charAt(0).toUpperCase() + word.slice(1);
        })
        .join(' ');
}

function extractAndFormatSkills(competencies) {
    if (!competencies) return [];
    
    let skills = [];
    if (Array.isArray(competencies)) {
        skills = competencies.slice(0, 3);
    } else if (typeof competencies === 'string') {
        // Extract skills from text - look for bullet points or comma-separated items
        const lines = competencies.split('\n');
        for (let line of lines) {
            if (line.includes('-') || line.includes('•')) {
                // Extract text after bullet point
                const skillText = line.replace(/^[-•]\s*/, '').trim();
                if (skillText && skillText.length > 0) {
                    // Take first few words as skill name
                    const shortSkill = skillText.split(' ').slice(0, 4).join(' ');
                    skills.push(shortSkill);
                    if (skills.length >= 3) break;
                }
            }
        }
        
        // If no bullet points found, try to extract key phrases
        if (skills.length === 0) {
            const phrases = competencies.match(/[A-Z][a-z]+(?:\s+[a-z]+)*(?:\s+[A-Z][a-z]+)*/g) || [];
            skills = phrases.slice(0, 3);
        }
    }
    
    // Format each skill with proper capitalization
    return skills.map(skill => formatSkillText(skill));
}
        
document.addEventListener("DOMContentLoaded", async function() {
    // 1. Process magic link
    await supabase.auth.getSession();

    // 2. Check if user is already logged in
    supabase.auth.getSession().then(({ data: { session } }) => {
        if (session) {
            showMainApp();
        } else {
            showAuthBox();
        }
    });

    // 3. Listen for auth state changes
    supabase.auth.onAuthStateChange((event, session) => {
        if (session) {
            showMainApp();
        }
    });

    // 4. Wire up the button after DOM is ready
    document.getElementById("magic-btn").onclick = signIn;
    document.getElementById('logout-btn').onclick = async function() {
        try {
            await supabase.auth.signOut();
            showAuthBox();
        } catch (error) {
            console.error("Error signing out:", error);
            showError("Failed to log out. Please try again.");
        }
    };

    // ---- File Handling and Analysis Logic ----
    fileInput = document.getElementById('file-input');
    dragArea = document.getElementById('drag-area');
    fileListContainer = document.getElementById('file-list-container');
    fileList = document.getElementById('file-list');
    fileCount = document.getElementById('file-count');
    startButton = document.getElementById('start-button');
    errorMessage = document.getElementById('error-message');
    errorText = document.getElementById('error-text');
    statusMessage = document.getElementById('status-message');
    statusText = document.getElementById('status-text');
    statusIcon = document.getElementById('status-icon');
    clearAllBtn = document.getElementById('clear-all');

    allowedTypes = ['application/pdf', 'image/jpeg', 'image/png'];
    typeNames = {
        'application/pdf': 'PDF',
        'image/jpeg': 'JPEG',
        'image/png': 'PNG'
    };
    
    typeIcons = {
        'application/pdf': 'fa-file-pdf',
        'image/jpeg': 'fa-file-image',
        'image/png': 'fa-file-image'
    };

    dragArea.addEventListener('click', function(e) {
        fileInput.value = '';
        fileInput.click();
    });

    dragArea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
            fileInput.value = '';
            fileInput.click();
            e.preventDefault();
        }
    });

    fileInput.addEventListener('change', handleFileSelect);

    dragArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dragArea.classList.add('active');
    });

    dragArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dragArea.classList.remove('active');
    });

    dragArea.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dragArea.classList.remove('active');
        if (e.dataTransfer.files.length) {
            handleFiles(e.dataTransfer.files);
        }
    });

    startButton.addEventListener('click', startAnalysis);
    
    clearAllBtn.addEventListener('click', function() {
        files = [];
        updateFileList();
    });

    // Set up the "Analyze Another Resume" button handler
document.getElementById('new-analysis-btn').addEventListener('click', function() {
    // Hide results, show upload interface
    document.getElementById('analysis-results').classList.add('hidden');
    document.getElementById('upload-interface').classList.remove('hidden');
    
    // Reset files array and update the UI
    files = [];
    updateFileList();
    
    // Re-enable the start button (though updateFileList should handle this)
    startButton.disabled = false;
    
    // Clear any error or status messages
    hideError();
    hideStatus();
});
});
    </script>
</body>
</html>
